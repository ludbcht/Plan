<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modificateur de plan</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Supprimer temporairement console.warn pour Ã©viter le warning de jsPDF
const originalWarn = console.warn;
console.warn = function(...args) {
  if (args[0] && args[0].includes && args[0].includes('Setting up fake worker')) return;
  originalWarn.apply(console, args);
};
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// Restaurer console.warn aprÃ¨s chargement de jsPDF
setTimeout(() => { console.warn = originalWarn; }, 100);
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
:root {
  --bg:#0b0d12; --surface:#121520; --card:#181d2a; --card2:#1e2436;
  --border:#252c3f; --border2:#2e3650;
  --accent:#4f8aff; --accent2:#00e5cc; --warn:#ff5f57; --warn2:#ff6b35;
  --text:#e8ecf5; --muted:#6b7494; --success:#3ddc97;
  --font-display:'Syne',sans-serif; --font-mono:'JetBrains Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--font-display);display:flex;flex-direction:column;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header{
  height:56px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;flex-shrink:0;z-index:200;
}
.logo{display:flex;align-items:center;gap:10px;}
.logo-mark{
  width:32px;height:32px;border-radius:8px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
}
.logo-mark svg{width:16px;height:16px;}
.logo-name{font-size:17px;font-weight:800;letter-spacing:-0.5px;}
.logo-name em{color:var(--accent2);font-style:normal;}
.header-right{display:flex;align-items:center;gap:8px;}

.chip{
  font-family:var(--font-mono);font-size:10px;
  padding:3px 10px;border-radius:20px;
  background:rgba(79,138,255,.12);color:var(--accent);
  border:1px solid rgba(79,138,255,.25);
}

/* â”€â”€ TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar{
  height:48px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:6px;padding:0 16px;flex-shrink:0;overflow:visible;
  position:relative;z-index:100;
}
.tg{display:flex;gap:4px;align-items:center;padding-right:12px;border-right:1px solid var(--border);}
.tg:last-child{border-right:none;padding-right:0;}

.btn{
  display:flex;align-items:center;gap:6px;
  font-family:var(--font-display);font-size:12px;font-weight:700;
  padding:6px 12px;border-radius:7px;border:1px solid var(--border2);
  background:var(--card);color:var(--text);cursor:pointer;
  transition:all .15s;white-space:nowrap;
}
.btn:hover{background:var(--card2);border-color:var(--accent);color:var(--accent);}
.btn.active{background:rgba(79,138,255,.15);border-color:var(--accent);color:var(--accent);}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
.btn.primary:hover{background:#6b9fff;}
.btn.success{background:rgba(61,220,151,.12);border-color:rgba(61,220,151,.35);color:var(--success);}
.btn.success:hover{background:rgba(61,220,151,.22);}
.btn.danger{background:rgba(255,95,87,.1);border-color:rgba(255,95,87,.3);color:var(--warn);}
.btn.danger:hover{background:rgba(255,95,87,.2);}
.btn svg{width:14px;height:14px;flex-shrink:0;}

/* â”€â”€ DROPDOWN MENUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dropdown{position:relative;}
.dropdown-toggle{cursor:pointer;}
.dropdown-menu{
  display:none;position:absolute;top:100%;left:0;
  padding-top:6px; /* invisible bridge to prevent hover gap */
  z-index:9999;
}
.dropdown-menu-inner{
  background:var(--surface);border:1px solid var(--border);border-radius:8px;
  box-shadow:0 8px 24px rgba(0,0,0,.35);min-width:200px;
  padding:4px 0;
}
.dropdown.open .dropdown-menu{display:block;}
.dropdown-menu button{
  width:100%;display:flex;align-items:center;gap:8px;
  padding:8px 16px;border:none;background:none;
  font-size:13px;font-weight:600;color:var(--text);
  text-align:left;cursor:pointer;transition:background .12s;
}
.dropdown-menu button:hover{background:var(--card2);}
.dropdown-menu button svg{width:16px;height:16px;color:var(--accent);}

/* â”€â”€ FLOORS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.floors-bar{
  height:42px;background:var(--card);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:0;padding:0 16px;flex-shrink:0;overflow-x:auto;
}
.floor-tab{
  display:flex;align-items:center;gap:8px;
  font-size:12px;font-weight:700;padding:6px 16px;
  cursor:pointer;border-radius:6px 6px 0 0;
  border:1px solid transparent;border-bottom:none;
  color:var(--muted);transition:all .15s;white-space:nowrap;
  position:relative;bottom:-1px;
}
.floor-tab:hover{color:var(--text);background:rgba(255,255,255,.04);}
.floor-tab.active{
  color:var(--accent2);background:var(--surface);
  border-color:var(--border);border-bottom-color:var(--surface);
}
.floor-tab .ft-del{
  width:16px;height:16px;border-radius:50%;
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:14px;line-height:1;transition:all .15s;
}
.floor-tab .ft-del:hover{background:rgba(255,95,87,.2);color:var(--warn);}
.add-floor-btn{
  font-size:13px;font-weight:700;color:var(--muted);
  cursor:pointer;padding:4px 10px;border-radius:6px;
  transition:all .15s;white-space:nowrap;
  display:flex;align-items:center;gap:5px;
}
.add-floor-btn:hover{color:var(--accent2);background:rgba(0,229,204,.08);}

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{display:flex;flex:1;overflow:hidden;}

/* â”€â”€ CANVAS AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.canvas-area{
  flex:1;position:relative;overflow:hidden;
  background:var(--bg);
  background-image:
    linear-gradient(rgba(79,138,255,.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(79,138,255,.03) 1px,transparent 1px);
  background-size:32px 32px;
}

.rli-retired { opacity:0.6; text-decoration:line-through; }
.rli-retired .rli-name::after { content:' (retirÃ©)'; color:#8b1a1a; font-size:9px; font-style:italic; text-decoration:none; }
.canvas-area.mode-draw{cursor:crosshair;}
.canvas-area.mode-nav{cursor:default;}
.canvas-area.mode-drag-elements{cursor:grab;}
.canvas-area.mode-drag-elements [data-type]{cursor:grab;}
.canvas-area.mode-drag-elements [data-type]:active{cursor:grabbing;}
.canvas-area.mode-nav [data-type]{cursor:pointer;}
.canvas-area.mode-copier{cursor:copy;}
.canvas-area.mode-printer{cursor:crosshair;}
.canvas-area.mode-meeting{cursor:cell;}
.canvas-area.mode-move{cursor:move;}
.canvas-area.mode-edit-shape{cursor:pointer;}
.canvas-area.mode-screen{cursor:copy;}
.canvas-area.mode-techroom{cursor:crosshair;}
.canvas-area.mode-display{cursor:copy;}
.canvas-area.mode-socket{cursor:copy;}
.canvas-area.mode-projector{cursor:copy;}
.canvas-area.mode-plotter{cursor:copy;}
.canvas-area.mode-freezone{cursor:crosshair;}

#canvas-root{position:absolute;top:0;left:0;transform-origin:0 0;}
#plan-img{position:absolute;top:0;left:0;user-select:none;pointer-events:none;opacity:.88;}
#svg-layer{position:absolute;top:0;left:0;overflow:visible;}

/* Drop zone */
#drop-zone{
  position:absolute;inset:0;display:flex;
  align-items:center;justify-content:center;z-index:10;
}
.dz-card{
  background:var(--surface);border:2px dashed var(--border2);
  border-radius:20px;padding:48px 64px;
  display:flex;flex-direction:column;align-items:center;gap:14px;
  cursor:pointer;transition:all .2s;text-align:center;
}
.dz-card:hover,.dz-card.over{border-color:var(--accent);background:rgba(79,138,255,.05);}
.dz-icon{opacity:.35;}
.dz-title{font-size:18px;font-weight:800;}
.dz-sub{font-size:13px;color:var(--muted);line-height:1.6;}

/* Drawing rect */
#draw-ghost{
  position:absolute;pointer-events:none;display:none;
  border:2px solid var(--accent2);background:rgba(0,229,204,.08);border-radius:3px;
}

/* Zoom HUD */
.zoom-hud{
  position:absolute;bottom:16px;right:16px;
  display:flex;flex-direction:column;align-items:center;gap:3px;
}
.zbtn{
  width:34px;height:34px;border-radius:8px;
  background:var(--card);border:1px solid var(--border2);
  color:var(--text);font-size:18px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.zbtn:hover{border-color:var(--accent);color:var(--accent);}
.zpct{font-family:var(--font-mono);font-size:10px;color:var(--muted);padding:2px;}

/* Coords HUD */
.coords-hud{
  position:absolute;bottom:16px;left:16px;
  font-family:var(--font-mono);font-size:10px;color:var(--muted);
  background:rgba(18,21,32,.7);padding:5px 10px;border-radius:6px;
  pointer-events:none;
}

/* â”€â”€ SIDE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.side{
  width:340px;background:var(--surface);
  border-left:1px solid var(--border);
  display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;
}
.tabs{display:flex;border-bottom:1px solid var(--border);}
.tab{
  flex:1;padding:11px 6px;text-align:center;
  font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:var(--muted);cursor:pointer;
  border-bottom:2px solid transparent;transition:all .15s;
}
.tab.on{color:var(--accent2);border-bottom-color:var(--accent2);}
.tab-body{display:none;flex:1;overflow-y:auto;padding:14px;}
.tab-body.on{display:block;}

/* Empty state */
.es{display:flex;flex-direction:column;align-items:center;gap:10px;padding:32px 16px;text-align:center;color:var(--muted);}
.es-title{font-size:14px;font-weight:700;color:var(--text);opacity:.45;}
.es-sub{font-size:12px;line-height:1.6;}

/* Room list item */
.rli{
  display:flex;align-items:center;gap:8px;
  background:var(--card);border:1px solid var(--border);
  border-radius:9px;padding:9px 10px;margin-bottom:5px;
  cursor:pointer;transition:all .15s;
}
.rli:hover{border-color:var(--accent);}
.rli.on{border-color:var(--accent2);background:rgba(0,229,204,.06);}
.rli-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.rli-icon{width:20px;height:20px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.rli-icon svg{width:16px;height:16px;}
.rli-name{flex:1;font-size:13px;font-weight:600;}
.rli-cnt{font-family:var(--font-mono);font-size:10px;color:var(--muted);}
.rli-acts{display:flex;gap:2px;}
.ib{
  width:26px;height:26px;border-radius:6px;
  background:var(--card2);border:1px solid var(--border2);
  color:var(--muted);font-size:14px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.ib:hover{border-color:var(--accent);color:var(--accent);}
.ib.danger:hover{border-color:var(--warn);color:var(--warn);}

/* Editor */
.ed-title{font-size:14px;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.ed-close{
  width:24px;height:24px;margin-left:auto;border-radius:6px;
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:18px;transition:all .15s;
}
.ed-close:hover{background:rgba(255,95,87,.12);color:var(--warn);}
.fg{margin-bottom:14px;}
.lb{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;color:var(--muted);}
.inp,.txa{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:7px;padding:9px 11px;
  font-family:var(--font-display);font-size:13px;color:var(--text);
  transition:all .15s;
}
.inp:focus,.txa:focus{outline:none;border-color:var(--accent);background:var(--card2);}
.txa{min-height:70px;resize:vertical;font-family:var(--font-mono);font-size:11px;}
.sock-list{display:flex;flex-direction:column;gap:5px;margin-top:6px;}
.sock-it{
  display:flex;align-items:center;gap:6px;
  background:var(--card2);border:1px solid var(--border);
  border-radius:6px;padding:6px 8px;
}
.sock-name{flex:1;font-family:var(--font-mono);font-size:11px;}
.sock-del{
  width:22px;height:22px;border-radius:5px;
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:14px;transition:all .15s;
}
.sock-del:hover{background:rgba(255,95,87,.15);color:var(--warn);}
.add-sock{
  display:flex;gap:4px;margin-top:6px;
}
.add-sock .inp{flex:1;}
.add-sock .btn{padding:8px 14px;}
.del-room-btn{width:100%;margin-top:8px;}

/* Check group */
.check-group{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.check-group input[type="checkbox"]{
  width:16px;height:16px;cursor:pointer;
  accent-color:var(--accent);
}
.check-group label{font-size:12px;cursor:pointer;}

/* Select */
.sel{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:7px;padding:9px 11px;
  font-family:var(--font-display);font-size:13px;color:var(--text);
  cursor:pointer;transition:all .15s;
}
.sel:focus{outline:none;border-color:var(--accent);background:var(--card2);}

/* Move people list */
.move-people-list{display:flex;flex-direction:column;gap:5px;margin-top:6px;}
.move-person{
  display:flex;align-items:center;gap:6px;
  background:var(--card2);border:1px solid var(--border);
  border-radius:6px;padding:6px 8px;
}
.move-person-name{flex:1;font-size:12px;}
.move-person-pc{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted);}
.move-person-pc input{width:14px;height:14px;cursor:pointer;accent-color:var(--success);}
.add-person{display:flex;gap:4px;margin-top:6px;}
.add-person .inp{flex:1;}
.add-person .btn{padding:8px 14px;}

/* Stats cards */
.sc{
  display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;
}
.scard{
  background:var(--card);border:1px solid var(--border);
  border-radius:9px;padding:12px;text-align:center;
}
.scard-val{font-size:24px;font-weight:800;color:var(--accent2);}
.scard-lab{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-top:4px;}

/* Modal */
.modal{
  position:fixed;inset:0;z-index:300;
  background:rgba(11,13,18,.85);backdrop-filter:blur(8px);
  display:none;align-items:center;justify-content:center;
  animation:fadeIn .15s;
}
.modal.on{display:flex;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.md{
  background:var(--surface);border:1px solid var(--border2);
  border-radius:14px;padding:22px 24px;width:90%;max-width:420px;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.md-title{font-size:16px;font-weight:800;margin-bottom:14px;}
.md-acts{display:flex;gap:6px;margin-top:16px;}
.md-acts .btn{flex:1;justify-content:center;}

/* Tooltip */
#tt{
  position:absolute;z-index:250;pointer-events:none;
  background:var(--card);border:1px solid var(--border2);
  border-radius:10px;padding:12px 14px;opacity:0;
  transition:opacity .12s;box-shadow:0 8px 28px rgba(0,0,0,.5);
  max-width:260px;min-width:160px;
}
#tt.on{opacity:1;}
.tt-badge{
  display:inline-block;font-size:9px;font-weight:800;text-transform:uppercase;
  letter-spacing:1px;padding:2px 8px;border-radius:20px;margin-bottom:6px;
}
.tt-name{font-size:14px;font-weight:800;margin-bottom:6px;line-height:1.3;}
.tt-row{
  display:flex;align-items:flex-start;gap:6px;
  font-size:11px;color:var(--muted);margin-top:3px;
}
.tt-row-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;flex-shrink:0;color:var(--border2);}
.tt-row-val{font-size:11px;color:var(--text);word-break:break-word;white-space:pre-line;}
.tt-divider{height:1px;background:var(--border);margin:6px 0;}

/* Notif */
#notif{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--card);border:1px solid var(--accent);
  border-radius:10px;padding:12px 20px;
  font-size:13px;font-weight:700;color:var(--accent2);
  box-shadow:0 8px 24px rgba(0,0,0,.4);
  transition:transform .25s cubic-bezier(.34,1.56,.64,1);
  z-index:400;
}
#notif.on{transform:translateX(-50%) translateY(0);}

/* Progress */
#progress{
  position:fixed;top:0;left:0;width:100%;height:3px;
  background:var(--accent2);transform:scaleX(0);
  transform-origin:0 0;transition:transform .2s;z-index:500;
}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
    </div>
    <div class="logo-name">Modificateur de <em>plan</em></div>
  </div>
  <div class="header-right">
    <div style="display:flex;align-items:center;gap:6px;">
      <input type="text" id="plan-search" class="inp" placeholder="ğŸ” Rechercher..." style="width:200px;font-size:12px;height:30px;padding:0 8px;border-radius:6px;" oninput="onPlanSearch(this.value)">
      <button class="btn" style="height:30px;padding:0 8px;font-size:11px;" onclick="document.getElementById('plan-search').value='';onPlanSearch('');">âœ•</button>
    </div>
    <div class="chip" id="mode-chip">NAVIGATION</div>
  </div>
</header>

<!-- Toolbar -->
<div class="toolbar">
  <div class="tg">
    <button class="btn" id="btn-nav" onclick="setMode('nav')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
      Navigation
    </button>
    <button class="btn" id="btn-drag-elements" onclick="setMode('drag-elements')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="12" y1="2" x2="12" y2="22"/></svg>
      DÃ©placer
    </button>
    <button class="btn" id="btn-edit-shape" onclick="setMode('edit-shape')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m6.36 6.36l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m6.36-6.36l4.24-4.24"/></svg>
      Ã‰diter forme
    </button>
    
    <!-- CatÃ©gorie: Tracer une zone -->
    <div class="dropdown" id="dropdown-zone">
      <button class="btn dropdown-toggle" onclick="toggleDropdown('dropdown-zone')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2z"/><polyline points="7 10 12 15 17 10"/></svg>
        Tracer une zone â–¼
      </button>
      <div class="dropdown-menu">
        <div class="dropdown-menu-inner">
        <button onclick="setMode('meeting'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3h2v4M8 3H6v4"/></svg>
          Salle de rÃ©union
        </button>
        <button onclick="setMode('techroom'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><line x1="6" y1="6" x2="6" y2="6"/><line x1="6" y1="18" x2="6" y2="18"/></svg>
          Local technique
        </button>
        <button onclick="setMode('draw'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
          Bureau
        </button>
        <button onclick="setMode('move'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M9 22V12h6v10"/></svg>
          DÃ©mÃ©nagement
        </button>
        <button onclick="setMode('freezone'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" stroke-dasharray="4,3"/><path d="M12 8v8M8 12h8"/></svg>
          Zone libre
        </button>
        </div>
      </div>
    </div>
    
    <!-- CatÃ©gorie: Ressource -->
    <div class="dropdown" id="dropdown-resource">
      <button class="btn dropdown-toggle" onclick="toggleDropdown('dropdown-resource')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m6.36 6.36l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m6.36-6.36l4.24-4.24"/></svg>
        Ressource â–¼
      </button>
      <div class="dropdown-menu">
        <div class="dropdown-menu-inner">
        <button onclick="setMode('copier'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="2" width="12" height="6" rx="1"/><path d="M18 8v10a2 2 0 01-2 2H8a2 2 0 01-2-2V8"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="18" y2="16"/></svg>
          Copieur
        </button>
        <button onclick="setMode('printer'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Imprimante
        </button>
        <button onclick="setMode('screen'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          Ã‰cran TV
        </button>
        <button onclick="setMode('display'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="14" rx="2"/><path d="M7 21h10M12 17v4"/><circle cx="8" cy="11" r="1" fill="currentColor"/><path d="M12 8v6M15 9l-3 5-3-5"/></svg>
          Ã‰cran d'information
        </button>
        <button onclick="setMode('socket'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="7" width="14" height="12" rx="2"/><circle cx="10" cy="12" r="1.5" fill="currentColor"/><circle cx="14" cy="12" r="1.5" fill="currentColor"/><path d="M10 7V5m4 2V5"/></svg>
          Prises rÃ©seau
        </button>
        <button onclick="setMode('projector'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="16" cy="12" r="3"/><circle cx="7" cy="12" r="1.5" fill="currentColor"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="6" y1="22" x2="18" y2="22"/></svg>
          VidÃ©oprojecteur
        </button>
        <button onclick="setMode('plotter'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="14" rx="2"/><path d="M6 18v3h12v-3"/><line x1="6" y1="10" x2="18" y2="10"/><path d="M2 14h20"/><circle cx="17" cy="7" r="1" fill="currentColor"/></svg>
          Traceur
        </button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="tg">
    <button class="btn" onclick="zoomIn()" title="Zoom +">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    </button>
    <button class="btn" onclick="zoomOut()" title="Zoom -">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    </button>
    <button class="btn" onclick="zoomReset()" title="RÃ©initialiser (100%)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      100%
    </button>
    <button class="btn" onclick="zoomFit()" title="Ajuster au plan">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg>
      Ajuster
    </button>
  </div>
  
  <div class="tg">
    <div class="dropdown" id="dropdown-export">
      <button class="btn success dropdown-toggle" onclick="toggleDropdown('dropdown-export')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Exporter â–¼
      </button>
      <div class="dropdown-menu">
        <div class="dropdown-menu-inner">
        <button onclick="exportJSON(); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          JSON
        </button>
        <button onclick="exportExcel(); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Excel
        </button>
        <button onclick="exportPNG(); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          PNG
        </button>
        <button onclick="exportPDF(); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 13h6M9 17h4"/></svg>
          PDF
        </button>
        </div>
      </div>
    </div>
    <button class="btn danger" onclick="clearFloor()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
      Vider
    </button>
  </div>
</div>

<!-- Floors bar -->
<div class="floors-bar" id="floors-bar"></div>

<!-- Main -->
<div class="main">
  <!-- Canvas -->
  <div class="canvas-area" id="canvas-area">
    <div id="drop-zone">
      <div class="dz-card" id="dz-card">
        <div class="dz-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
        </div>
        <div class="dz-title">Importer un plan</div>
        <div class="dz-sub">DÃ©posez ou cliquez pour choisir un fichier<br>Image (PNG, JPG, SVG), PDF ou projet JSON</div>
      </div>
    </div>
    <div id="canvas-root">
      <img id="plan-img">
      <svg id="svg-layer"></svg>
    </div>
    <div id="draw-ghost"></div>
    <div class="zoom-hud">
      <button class="zbtn" onclick="zoomIn()">+</button>
      <div class="zpct" id="zpct">100%</div>
      <button class="zbtn" onclick="zoomOut()">âˆ’</button>
      <button class="zbtn" onclick="zoomReset()" title="RÃ©initialiser (100%)">âŠ™</button>
      <button class="zbtn" onclick="zoomFit()" title="Ajuster Ã  l'Ã©cran" style="font-size:12px;">â¤¢</button>
    </div>
    <div class="coords-hud" id="coords">x:0 y:0</div>
  </div>

  <!-- Side panel -->
  <div class="side">
    <div class="tabs">
      <div class="tab on" id="tab-list-btn" onclick="switchTab('list')">Liste</div>
      <div class="tab" id="tab-edit-btn" onclick="switchTab('edit')">Ã‰dition</div>
      <div class="tab" id="tab-equip-btn" onclick="switchTab('equip')">Ã‰quipements</div>
      <div class="tab" id="tab-move-btn" onclick="switchTab('move')">DÃ©mÃ©nagements</div>
      <div class="tab" id="tab-stats-btn" onclick="switchTab('stats')">Stats</div>
    </div>

    <!-- Liste -->
    <div class="tab-body on" id="tab-list"></div>

    <!-- Ã‰dition -->
    <div class="tab-body" id="tab-edit"></div>

    <!-- Ã‰quipements -->
    <div class="tab-body" id="tab-equip"></div>

    <!-- DÃ©mÃ©nagements -->
    <div class="tab-body" id="tab-move"></div>

    <!-- Stats -->
    <div class="tab-body" id="tab-stats">
      <div class="sc">
        <div class="scard"><div class="scard-val" id="st-floors">0</div><div class="scard-lab">Ã‰tages</div></div>
        <div class="scard"><div class="scard-val" id="st-rooms">0</div><div class="scard-lab">Bureaux</div></div>
        <div class="scard"><div class="scard-val" id="st-copiers">0</div><div class="scard-lab">Copieurs</div></div>
      </div>
      <div class="sc">
        <div class="scard"><div class="scard-val" id="st-printers">0</div><div class="scard-lab">Imprimantes</div></div>
        <div class="scard"><div class="scard-val" id="st-meetings">0</div><div class="scard-lab">Salles</div></div>
      </div>
      <div id="st-detail"></div>
    </div>
  </div>
</div>

<!-- Modal Floor -->
<div class="modal" id="modal-floor">
  <div class="md">
    <div class="md-title">Nouvel Ã©tage</div>
    <div class="fg">
      <label class="lb">Site</label>
      <select class="sel" id="modal-floor-site">
        <option value="">-- Choisir un site --</option>
      </select>
    </div>
    <div class="fg" id="modal-floor-subsite-group" style="display:none;">
      <label class="lb">Sous-site COM</label>
      <select class="sel" id="modal-floor-subsite">
        <option value="">-- Choisir un sous-site --</option>
      </select>
    </div>
    <div class="fg">
      <label class="lb">Ã‰tage</label>
      <select class="sel" id="modal-floor-level">
        <option value="">-- Choisir un Ã©tage --</option>
      </select>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelFloor()">Annuler</button>
      <button class="btn primary" onclick="confirmFloor()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Room -->
<div class="modal" id="modal-room">
  <div class="md" style="max-width:480px;">
    <div class="md-title">Nouveau bureau</div>
    <div class="fg">
      <label class="lb">Nom du bureau</label>
      <input type="text" class="inp" id="modal-room-name" placeholder="ex: Bureau 101">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-room-retired" onchange="const g=document.getElementById('modal-room-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-room-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-room-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-room-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-room-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg">
      <label class="lb">Personnes</label>
      <div class="move-people-list" id="modal-room-people"></div>
      <div class="add-person">
        <input type="text" class="inp" id="modal-room-person-input" placeholder="ex: Jean Dupont">
        <button class="btn" onclick="addRoomPerson()">+</button>
      </div>
    </div>
    <div class="fg">
      <label class="lb">NÂ° prises rÃ©seau</label>
      <input type="text" class="inp" id="modal-room-sockets" placeholder="ex: PR-101, PR-102">
    </div>
    <div class="fg">
      <label class="lb">Notes / infos complÃ©mentaires</label>
      <textarea class="txa" id="modal-room-notes" placeholder="Informations libres..."></textarea>
    </div>
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-room-color" value="#4f8aff" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
    <div class="md-acts">
      <button class="btn" onclick="cancelRoom()">Annuler</button>
      <button class="btn primary" onclick="confirmRoom()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Copier -->
<div class="modal" id="modal-copier">
  <div class="md">
    <div class="md-title">Nouveau copieur</div>
    <div class="fg">
      <label class="lb">Nom du copieur</label>
      <input type="text" class="inp" id="modal-copier-name" placeholder="ex: Copieur RDC">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-copier-retired" onchange="const g=document.getElementById('modal-copier-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-copier-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-copier-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-copier-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-copier-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg">
      <label class="lb">Informations rÃ©seau</label>
      <textarea class="txa" id="modal-copier-network" placeholder="IP, VLAN, etc."></textarea>
    </div>
    <div class="md-acts">
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-copier-color" value="#ff6b35" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
      <button class="btn" onclick="cancelCopier()">Annuler</button>
      <button class="btn primary" onclick="confirmCopier()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Printer -->
<div class="modal" id="modal-printer">
  <div class="md">
    <div class="md-title">Nouvelle imprimante</div>
    <div class="fg">
      <label class="lb">Nom de l'imprimante</label>
      <input type="text" class="inp" id="modal-printer-name" placeholder="ex: Imprimante Bureau 1">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-printer-retired" onchange="const g=document.getElementById('modal-printer-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-printer-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-printer-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-printer-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-printer-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg">
      <label class="lb">Informations rÃ©seau</label>
      <textarea class="txa" id="modal-printer-network" placeholder="IP, VLAN, etc."></textarea>
    </div>
    <div class="md-acts">
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-printer-color" value="#4f8aff" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
      <button class="btn" onclick="cancelPrinter()">Annuler</button>
      <button class="btn primary" onclick="confirmPrinter()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Meeting Room -->
<div class="modal" id="modal-meeting">
  <div class="md">
    <div class="md-title">Nouvelle salle de rÃ©union</div>
    <div class="fg">
      <label class="lb">Nom de la salle</label>
      <input type="text" class="inp" id="modal-meeting-name" placeholder="ex: Salle RÃ©union A">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-meeting-retired" onchange="const g=document.getElementById('modal-meeting-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-meeting-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-meeting-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-meeting-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-meeting-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg">
      <label class="lb">CapacitÃ© (nombre de places)</label>
      <input type="number" class="inp" id="modal-meeting-capacity" min="1" max="200" placeholder="ex: 10" style="max-width:120px;">
    </div>
    <div class="fg">
      <label class="lb">Type d'Ã©cran</label>
      <div class="check-group">
        <input type="radio" name="screen-type" id="screen-tactile" value="tactile" checked>
        <label for="screen-tactile">Ã‰cran tactile</label>
      </div>
      <div class="check-group">
        <input type="radio" name="screen-type" id="screen-classic" value="classique">
        <label for="screen-classic">Ã‰cran classique</label>
      </div>
      <div class="check-group">
        <input type="radio" name="screen-type" id="screen-projector" value="videoprojecteur">
        <label for="screen-projector">VidÃ©oprojecteur</label>
      </div>
    </div>
    <div class="fg">
      <label class="lb">Taille de l'Ã©cran</label>
      <select class="sel" id="modal-meeting-size">
        <option value="49">49 pouces</option>
        <option value="55" selected>55 pouces</option>
        <option value="65">65 pouces</option>
        <option value="75">75 pouces</option>
        <option value="85">85 pouces</option>
        <option value="98">98 pouces</option>
      </select>
    </div>
    <div class="fg">
      <div class="check-group">
        <input type="checkbox" id="modal-meeting-mtr">
        <label for="modal-meeting-mtr">Ã‰quipement MTR (Microsoft Teams Rooms)</label>
      </div>
      <div class="check-group">
        <input type="checkbox" id="modal-meeting-clickshare">
        <label for="modal-meeting-clickshare">ClickShare</label>
      </div>
      <div class="check-group">
        <input type="checkbox" id="modal-meeting-wepresent">
        <label for="modal-meeting-wepresent">WePresent</label>
      </div>
    </div>
    <div class="md-acts">
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-meeting-color" value="#3ddc97" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
      <button class="btn" onclick="cancelMeeting()">Annuler</button>
      <button class="btn primary" onclick="confirmMeeting()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Move -->
<div class="modal" id="modal-move">
  <div class="md">
    <div class="md-title">Nouveau dÃ©mÃ©nagement</div>
    <div class="fg">
      <label class="lb">Nom du dÃ©mÃ©nagement</label>
      <input type="text" class="inp" id="modal-move-name" placeholder="ex: DÃ©mÃ©nagement Bureau 201 â†’ 305">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-move-retired" onchange="const g=document.getElementById('modal-move-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-move-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-move-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-move-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-move-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg">
      <label class="lb">Date du dÃ©mÃ©nagement</label>
      <input type="date" class="inp" id="modal-move-date">
    </div>
    <div class="fg">
      <label class="lb">Personnes concernÃ©es</label>
      <div class="move-people-list" id="modal-move-people"></div>
      <div class="add-person">
        <input type="text" class="inp" id="modal-move-person-input" placeholder="Nom de la personne">
        <button class="btn" onclick="addMovePerson()">+</button>
      </div>
    </div>
    <div class="md-acts">
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-move-color" value="#00e5cc" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
      <button class="btn" onclick="cancelMove()">Annuler</button>
      <button class="btn primary" onclick="confirmMove()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Confirmation -->
<div class="modal" id="modal-confirm" onclick="if(event.target===this)closeConfirmModal()">
  <div class="md" style="max-width:380px;text-align:center;">
    <div class="md-title" id="confirm-title" style="font-size:16px;"></div>
    <div id="confirm-body" style="font-size:13px;color:var(--muted);margin:-4px 0 16px;min-height:0;"></div>
    <div class="md-acts" style="justify-content:center;">
      <button class="btn" onclick="closeConfirmModal()">Annuler</button>
      <button class="btn danger" onclick="doConfirm()">Confirmer</button>
    </div>
  </div>
</div>

<!-- Modal Warning Before Leaving -->
<div class="modal" id="modal-leave-warning" style="z-index:10000;">
  <div class="md" style="max-width:520px;">
    <div class="md-title">âš ï¸ Attention - DonnÃ©es non sauvegardÃ©es</div>
    <p style="margin:16px 0;line-height:1.6;color:#555;font-size:14px;">
      Vous Ãªtes sur le point de quitter cette page. Vos modifications seront perdues si vous ne les exportez pas.
    </p>
    <p style="margin:16px 0;font-weight:600;color:#333;font-size:14px;">
      Voulez-vous exporter votre travail avant de partir ?
    </p>
    <div style="display:flex;gap:8px;margin-top:20px;flex-wrap:wrap;">
      <button class="btn success" onclick="exportJSONAndStay()" style="flex:1;min-width:140px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:16px;height:16px;margin-right:4px;vertical-align:middle;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        JSON
      </button>
      <button class="btn success" onclick="exportPNGAndStay()" style="flex:1;min-width:140px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:16px;height:16px;margin-right:4px;vertical-align:middle;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        PNG
      </button>
      <button class="btn success" onclick="exportPDFAndStay()" style="flex:1;min-width:140px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:16px;height:16px;margin-right:4px;vertical-align:middle;"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        PDF
      </button>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn" onclick="cancelLeave()" style="flex:1;">Rester sur la page</button>
      <button class="btn danger" onclick="confirmLeave()" style="flex:1;">Quitter sans exporter</button>
    </div>
  </div>
</div>

<!-- Modal Export Options -->
<div class="modal" id="modal-export-options">
  <div class="md" style="max-width:480px;">
    <div class="md-title" id="export-options-title">Options d'export</div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">SÃ©lectionnez les Ã©lÃ©ments Ã  inclure dans l'export :</p>
    
    <div style="margin-bottom:16px;">
      <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:4px;transition:background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" id="export-all" onchange="toggleAllExportOptions()" style="margin-right:10px;width:18px;height:18px;cursor:pointer;">
        <strong style="font-size:14px;">Tout sÃ©lectionner</strong>
      </label>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;">
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="rooms" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Bureaux</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="copiers" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Copieurs</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="printers" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Imprimantes</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="meetings" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Salles de rÃ©union</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="screens" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Ã‰crans</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="displays" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Affichages dyn.</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="techrooms" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Locaux tech.</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="sockets" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Prises rÃ©seau</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="projectors" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">VidÃ©oprojecteurs</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="plotters" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Traceurs</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="moves" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">DÃ©mÃ©nagements</span>
      </label>
    </div>
    
    <div class="md-acts">
      <button class="btn" onclick="cancelExportOptions()">Annuler</button>
      <button class="btn primary" onclick="confirmExportOptions()">Exporter</button>
    </div>
  </div>
</div>

<!-- Modal Locations -->
<div class="modal" id="modal-locations">
  <div class="md" style="max-width:520px;">
    <div class="md-title">GÃ©rer les lieux</div>
    <div class="fg">
      <label class="lb">Lieux disponibles</label>
      <div id="locations-list" style="max-height:300px;overflow-y:auto;"></div>
      <div class="add-person" style="margin-top:10px;">
        <input type="text" class="inp" id="location-input" placeholder="Nouveau lieu (ex: Bureau Paris, Ã‰tage 2...)">
        <button class="btn" onclick="addLocation()">+</button>
      </div>
    </div>
    <div class="md-acts">
      <button class="btn primary" onclick="closeLocationsModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- Modal Screen -->
<div class="modal" id="modal-screen">
  <div class="md">
    <div class="md-title">Nouvel Ã©cran</div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="modal-screen-name" placeholder="ex: Ã‰cran Accueil">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-screen-retired" onchange="const g=document.getElementById('modal-screen-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-screen-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-screen-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-screen-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-screen-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg">
      <label class="lb">Taille</label>
      <select class="sel" id="modal-screen-size">
        <option value="49">49 pouces</option>
        <option value="55" selected>55 pouces</option>
        <option value="65">65 pouces</option>
        <option value="75">75 pouces</option>
        <option value="98">98 pouces</option>
      </select>
    </div>
    <div class="fg">
      <label class="lb">Marque</label>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:6px;">
        <label class="check-group"><input type="radio" name="screen-brand" value="Samsung" checked> Samsung</label>
        <label class="check-group"><input type="radio" name="screen-brand" value="NEC"> NEC</label>
        <label class="check-group"><input type="radio" name="screen-brand" value="Grundig"> Grundig</label>
        <label class="check-group"><input type="radio" name="screen-brand" value="LG"> LG</label>
        <label class="check-group"><input type="radio" name="screen-brand" value="autre" id="modal-screen-brand-autre"> Autre</label>
      </div>
      <input type="text" class="inp" id="modal-screen-brand-custom" placeholder="PrÃ©ciser la marque..." style="display:none;margin-top:4px;">
    </div>
    <div class="fg">
      <label class="lb">Informations rÃ©seau</label>
      <textarea class="txa" id="modal-screen-network" placeholder="IP, VLAN, etc."></textarea>
    </div>
    <div class="md-acts">
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-screen-color" value="#9b87f5" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
      <button class="btn" onclick="cancelScreen()">Annuler</button>
      <button class="btn primary" onclick="confirmScreen()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Zone Libre -->

<!-- Modal Projector -->
<div class="modal" id="modal-projector">
  <div class="md">
    <div class="md-title">Ajouter un vidÃ©oprojecteur</div>
    <div class="fg"><label class="lb">Nom / Emplacement</label>
      <input type="text" class="inp" id="modal-projector-name" placeholder="ex: VidÃ©oprojecteur Salle A"></div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-projector-retired" onchange="const g=document.getElementById('modal-projector-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-projector-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-projector-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-projector-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-projector-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg"><label class="lb">Marque / ModÃ¨le</label>
      <input type="text" class="inp" id="modal-projector-brand" placeholder="ex: Epson EB-L260F"></div>
    <div class="fg"><label class="lb">RÃ©solution</label>
      <select class="sel" id="modal-projector-resolution">
        <option value="HD">HD (1280Ã—720)</option>
        <option value="Full HD" selected>Full HD (1920Ã—1080)</option>
        <option value="4K">4K (3840Ã—2160)</option>
      </select></div>
    <div class="fg"><label class="lb">RÃ©seau</label>
      <textarea class="txa" id="modal-projector-network" placeholder="IP, VLAN, etc."></textarea></div>
    <div class="md-acts">
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-projector-color" value="#e066ff" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
      <button class="btn" onclick="cancelProjector()">Annuler</button>
      <button class="btn primary" onclick="confirmProjector()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Plotter -->
<div class="modal" id="modal-plotter">
  <div class="md">
    <div class="md-title">Ajouter un traceur</div>
    <div class="fg"><label class="lb">Nom / Emplacement</label>
      <input type="text" class="inp" id="modal-plotter-name" placeholder="ex: Traceur Bureau Ã©tudes"></div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-plotter-retired" onchange="const g=document.getElementById('modal-plotter-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-plotter-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-plotter-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-plotter-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-plotter-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg"><label class="lb">Marque / ModÃ¨le</label>
      <input type="text" class="inp" id="modal-plotter-brand" placeholder="ex: HP DesignJet T630"></div>
    <div class="fg"><label class="lb">Format max</label>
      <select class="sel" id="modal-plotter-format">
        <option value="A1">A1</option>
        <option value="A0" selected>A0</option>
        <option value="A0+">A0+</option>
      </select></div>
    <div class="fg"><label class="lb">RÃ©seau</label>
      <textarea class="txa" id="modal-plotter-network" placeholder="IP, VLAN, etc."></textarea></div>
    <div class="md-acts">
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-plotter-color" value="#00acc1" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
      <button class="btn" onclick="cancelPlotter()">Annuler</button>
      <button class="btn primary" onclick="confirmPlotter()">CrÃ©er</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-freezone">
  <div class="md" style="max-width:520px;">
    <div class="md-title">Nouvelle zone libre</div>
    <div class="fg">
      <label class="lb">Nom de la zone</label>
      <input type="text" class="inp" id="modal-freezone-name" placeholder="ex: Salle de pause, Stockage, Accueil...">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-freezone-retired" onchange="const g=document.getElementById('modal-freezone-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-freezone-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-freezone-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-freezone-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-freezone-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg">
      <label class="lb">Couleur</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;" id="freezone-color-picker">
        <div class="fz-color on" data-color="#a78bfa" style="background:#a78bfa;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border .15s;"></div>
        <div class="fz-color" data-color="#fb7185" style="background:#fb7185;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#f59e0b" style="background:#f59e0b;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#34d399" style="background:#34d399;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#38bdf8" style="background:#38bdf8;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#f97316" style="background:#f97316;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#e879f9" style="background:#e879f9;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#94a3b8" style="background:#94a3b8;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
      </div>
    </div>
    <div class="fg">
      <label class="lb">IcÃ´ne</label>
      <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;" id="freezone-icon-picker"></div>
    </div>
    <div class="md-acts">
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-freezone-color" value="#a78bfa" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
      <button class="btn" onclick="cancelFreezone()">Annuler</button>
      <button class="btn primary" onclick="confirmFreezone()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Tech Room -->
<div class="modal" id="modal-techroom">
  <div class="md">
    <div class="md-title">Nouveau local technique</div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="modal-techroom-name" placeholder="ex: Local Tech RDC">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-techroom-retired" onchange="const g=document.getElementById('modal-techroom-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-techroom-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-techroom-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-techroom-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-techroom-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg">
      <label class="lb">Description</label>
      <textarea class="txa" id="modal-techroom-desc" placeholder="Contenu, Ã©quipements, notes..."></textarea>
    </div>
    <div class="md-acts">
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-techroom-color" value="#2196f3" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
      <button class="btn" onclick="cancelTechroom()">Annuler</button>
      <button class="btn primary" onclick="confirmTechroom()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Display (Affichage dynamique) -->
<div class="modal" id="modal-display">
  <div class="md">
    <div class="md-title">Nouvel affichage dynamique</div>
    <div class="fg">
      <label class="lb">Nom / Emplacement</label>
      <input type="text" class="inp" id="modal-display-name" placeholder="ex: Hall d'entrÃ©e, Salle de pause...">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-display-retired" onchange="const g=document.getElementById('modal-display-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-display-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-display-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-display-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-display-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg">
      <label class="lb">Taille de l'Ã©cran</label>
      <select class="sel" id="modal-display-size">
        <option value="32">32 pouces</option>
        <option value="43">43 pouces</option>
        <option value="49">49 pouces</option>
        <option value="55" selected>55 pouces</option>
        <option value="65">65 pouces</option>
        <option value="75">75 pouces</option>
        <option value="98">98 pouces</option>
      </select>
    </div>
    <div class="fg">
      <label class="lb">Contenu diffusÃ©</label>
      <input type="text" class="inp" id="modal-display-content" placeholder="ex: ActualitÃ©s, Planning, SignalÃ©tique...">
    </div>
    <div class="fg">
      <label class="lb">Informations rÃ©seau</label>
      <textarea class="txa" id="modal-display-network" placeholder="IP, VLAN, etc."></textarea>
    </div>
    <div class="md-acts">
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-display-color" value="#ffaa33" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
      <button class="btn" onclick="cancelDisplay()">Annuler</button>
      <button class="btn primary" onclick="confirmDisplay()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Socket (Network Outlets) -->
<div class="modal" id="modal-socket">
  <div class="md">
    <div class="md-title">Prises rÃ©seau</div>
    <div class="fg">
      <label class="lb">Nom de l'emplacement</label>
      <input type="text" class="inp" id="modal-socket-name" placeholder="ex: Bureau 201, Salle de conf...">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="modal-socket-retired" onchange="const g=document.getElementById('modal-socket-retireddate').parentElement;g.style.display=this.checked?'block':'none';document.getElementById('modal-socket-retired-msg').style.display=this.checked?'block':'none';">
        <label for="modal-socket-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="modal-socket-retired-msg" style="display:none;margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:none;margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="modal-socket-retireddate" style="max-width:180px;">
      </div>
    </div>
    <div class="fg">
      <label class="lb">Prises rÃ©seau</label>
      <div class="move-people-list" id="modal-socket-outlets"></div>
      <div class="add-person">
        <input type="text" class="inp" id="modal-socket-outlet-input" placeholder="ex: Prise 1 - IP 192.168.1.10">
        <button class="btn" onclick="addSocketOutlet()">+</button>
      </div>
    </div>
    <div class="fg">
      <label class="lb">Couleur</label>
      <input type="color" class="inp" id="modal-socket-color" value="#00bfa5" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    
    <div class="md-acts">
      <button class="btn" onclick="cancelSocket()">Annuler</button>
      <button class="btn primary" onclick="confirmSocket()">CrÃ©er</button>
    </div>
  </div>
</div>

<!-- Modal Export Options -->
<div class="modal" id="modal-export">
  <div class="md" style="max-width:400px;">
    <div class="md-title">Options d'export</div>
    <div style="margin-bottom:16px;font-size:13px;color:var(--muted);">SÃ©lectionnez les Ã©lÃ©ments Ã  inclure dans l'export</div>
    
    <div style="margin-bottom:12px;">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;border-radius:6px;background:var(--card2);">
        <input type="checkbox" id="export-all" onchange="toggleAllExport()" checked style="width:18px;height:18px;cursor:pointer;">
        <span style="font-weight:700;">Tout sÃ©lectionner</span>
      </label>
    </div>
    
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px;">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="rooms" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Bureaux</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="copiers" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Copieurs</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="printers" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Imprimantes</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="meetings" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Salles de rÃ©union</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="screens" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Ã‰crans</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="displays" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Affichages dynamiques</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="techrooms" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Locaux techniques</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="sockets" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Prises rÃ©seau</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="moves" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>DÃ©mÃ©nagements</span>
      </label>
    </div>
    
    <div class="md-acts">
      <button class="btn" onclick="closeExportModal()">Annuler</button>
      <button class="btn success" onclick="confirmExport()">Exporter</button>
    </div>
  </div>
</div>

<div id="tt"></div>

<div id="notif"></div>
<div id="progress"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _id = 1;
const S = {
  floors: [],
  locations: ['Pfaffenhoffen', 'Haguenau', 'Rittershoffen', 'Reichshoffen', 'Soultz-sous-ForÃªts', 'COM', 'AVA', 'ARM', 'RBG', 'Molsheim', 'Erstein', 'Huningue', 'Planigy'],
  comSubSites: ['Loge ASA', 'BS', 'BTI', 'BI', 'BE'],
  comSubSiteLevels: {
    'Loge ASA': ['RDC'],
    'BS': ['RDC'],
    'BI': ['Sous-sol', 'RDC', '1er'],
    'BTI': ['Sous-sol', 'RDC', '1er', '2Ã¨me', '3Ã¨me', '4Ã¨me', '5Ã¨me', '6Ã¨me'],
    'BE': ['Sous-sol', 'RDC', '1er', '2Ã¨me', '3Ã¨me', '4Ã¨me', '5Ã¨me', '6Ã¨me']
  },
  floorLevels: ['Sous-sol', 'RDC', '1er', '2Ã¨me', '3Ã¨me', '4Ã¨me', '5Ã¨me', '6Ã¨me'],
  activeFloor: null,
  selectedRoom: null,
  mode: 'nav',
  zoom: 1,
  pan: {x:0, y:0},
  drawing: null,
  dragging: null,
  editingShape: null,
  tempMove: {people: []},
  tempCopierPos: null,
  tempPrinterPos: null,
  tempMeetingPos: null,
  tempMovePos: null,
  tempScreenPos: null,
  tempTechroomPos: null,
  tempDisplayPos: null,
  tempSocketPos: null,
  tempSocket: {outlets: []},
  tempProjectorPos: null,
  tempPlotterPos: null
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLOOR MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function activeFloor() { return S.floors.find(f => f.id === S.activeFloor) || null; }

function addFloor(site, level, subSite) {
  const name = subSite ? `${site} - ${subSite} - ${level}` : `${site} - ${level}`;
  const f = {
    id: _id++, name, site, level, subSite: subSite || null,
    imageB64: null, imageW: 0, imageH: 0,
    rooms: [], copiers: [], printers: [], meetings: [], moves: [],
    screens: [], techrooms: [], displays: [], sockets: [], projectors: [], plotters: [], freezones: []
  };
  S.floors.push(f);
  S.activeFloor = f.id;
  renderFloorsBar(); renderCanvas(); renderRoomsList();
  renderEquipmentsList(); renderMovesList(); editorOpen(null); updateStats();
}

// Convert old rectangle format to polygon format
function ensurePolygon(item) {
  if (!item.points && item.x !== undefined && item.w !== undefined) {
    // Convert rectangle to polygon
    item.points = [
      {x: item.x, y: item.y},
      {x: item.x + item.w, y: item.y},
      {x: item.x + item.w, y: item.y + item.h},
      {x: item.x, y: item.y + item.h}
    ];
    // Keep x, y, w, h for backward compatibility and bounds calculation
  }
  return item;
}

// Calculate bounds from points
function calculateBounds(points) {
  if (!points || points.length === 0) return {x: 0, y: 0, w: 0, h: 0};
  const xs = points.map(p => p.x);
  const ys = points.map(p => p.y);
  const minX = Math.min(...xs);
  const minY = Math.min(...ys);
  const maxX = Math.max(...xs);
  const maxY = Math.max(...ys);
  return {
    x: minX,
    y: minY,
    w: maxX - minX,
    h: maxY - minY
  };
}

function selectFloor(fid) {
  S.activeFloor = fid;
  S.selectedRoom = null;
  renderFloorsBar();
  renderCanvas();
  renderRoomsList();
  renderEquipmentsList();
  renderMovesList();
  editorOpen(null);
}

function removeFloor(fid) {
  const f = S.floors.find(x => x.id === fid);
  if (!f) return;
  showConfirmModal(`Supprimer l'Ã©tage "${f.name}" ?`, 'Cette action est irrÃ©versible.', () => {
    S.floors = S.floors.filter(x => x.id !== fid);
    if (S.activeFloor === fid) S.activeFloor = S.floors[0]?.id ?? null;
    S.selectedRoom = null;
    renderFloorsBar(); renderCanvas(); renderRoomsList();
    renderEquipmentsList(); renderMovesList(); editorOpen(null); updateStats();
    notify(`Ã‰tage "${f.name}" supprimÃ©.`);
  });
}

function editFloorName(fid, spanElement) {
  const f = S.floors.find(x => x.id === fid);
  if (!f) return;
  
  const input = document.createElement('input');
  input.type = 'text';
  input.value = f.name;
  input.style.cssText = 'background:var(--card2);border:1px solid var(--accent);color:var(--text);padding:4px 8px;border-radius:4px;font-size:12px;font-weight:700;font-family:var(--font-display);width:120px;';
  
  spanElement.replaceWith(input);
  input.focus();
  input.select();
  
  const save = () => {
    const newName = input.value.trim() || f.name;
    f.name = newName;
    renderFloorsBar();
    updateStats();
    notify(`Ã‰tage renommÃ© en "${newName}"`);
  };
  
  input.onblur = save;
  input.onkeydown = (e) => {
    if (e.key === 'Enter') save();
    if (e.key === 'Escape') { f.name = f.name; renderFloorsBar(); }
  };
}

function renderFloorsBar() {
  const bar = document.getElementById('floors-bar');
  bar.innerHTML = '';
  S.floors.forEach(f => {
    const tab = document.createElement('div');
    tab.className = 'floor-tab';
    if (f.id === S.activeFloor) tab.classList.add('active');
    const span = document.createElement('span');
    span.textContent = f.name;
    span.onclick = () => selectFloor(f.id);
    span.ondblclick = (e) => { 
      e.stopPropagation(); 
      editFloorName(f.id, span); 
    };
    span.title = 'Double-cliquez pour renommer';
    tab.appendChild(span);
    if (S.floors.length > 1) {
      const del = document.createElement('button');
      del.className = 'ft-del'; del.textContent = 'Ã—';
      del.onclick = e => { e.stopPropagation(); removeFloor(f.id); };
      tab.appendChild(del);
    }
    bar.appendChild(tab);
  });
  const add = document.createElement('div');
  add.className = 'add-floor-btn';
  add.innerHTML = '<span>+</span><span>Ajouter</span>';
  add.onclick = () => {
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'image/*,.pdf,.json,application/json,application/pdf';
    inp.style.display = 'none';
    inp.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      // JSON â†’ import projet complet
      if (file.type === 'application/json' || file.name.toLowerCase().endsWith('.json')) {
        const fakeEvent = { target: { files: [file], value: '' } };
        importJSON(fakeEvent);
      } else {
        // Image/PDF â†’ stocker puis ouvrir modale Ã©tage
        handlePlanFile(file);
      }
      inp.remove();
    };
    document.body.appendChild(inp);
    inp.click();
  };
  bar.appendChild(add);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCanvas() {
  const f = activeFloor();
  const img = document.getElementById('plan-img');
  const svg = document.getElementById('svg-layer');
  const dz = document.getElementById('drop-zone');

  if (!f || !f.imageB64) {
    img.src = ''; img.style.display = 'none';
    svg.innerHTML = ''; dz.style.display = 'flex';
    return;
  }

  dz.style.display = 'none';
  img.src = f.imageB64;
  img.style.display = 'block';
  img.style.width = f.imageW + 'px';
  img.style.height = f.imageH + 'px';

  svg.setAttribute('width', f.imageW);
  svg.setAttribute('height', f.imageH);
  svg.innerHTML = '';

  // Draw rooms
  f.rooms.forEach((r,i) => {
    ensurePolygon(r);
    const col = matchesSearch(r) ? SEARCH_HIGHLIGHT_COLOR : r.retired ? RETIRED_COLOR : (r.customColor || roomColor(f.id, i));
    
    // Create polygon from points
    const pointsStr = r.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', col);
    poly.setAttribute('fill-opacity', matchesSearch(r) ? '0.45' : S.selectedRoom === r.id ? '0.35' : '0.15');
    poly.setAttribute('stroke-width', matchesSearch(r) ? '4' : S.selectedRoom === r.id ? '3' : '2');
    poly.setAttribute('stroke', col);
    poly.style.cursor = 'move';
    poly.setAttribute('data-type', 'room');
    poly.setAttribute('data-id', r.id);
    poly.addEventListener('click', (e) => { 
      e.stopPropagation();
      S.selectedRoom = r.id; 
      renderCanvas(); 
      renderRoomsList(); 
      editorOpen(r); 
    });
    poly.addEventListener('mouseenter', e => showTT(e.clientX, e.clientY, f, r));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);
    
    // Update bounds
    const bounds = calculateBounds(r.points);
    r.x = bounds.x;
    r.y = bounds.y;
    r.w = bounds.w;
    r.h = bounds.h;
    
    // Add text info in room if big enough
    if (r.w > 80 && r.h > 40) {
      const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
      textG.style.pointerEvents = 'none';
      const cx = r.x + r.w/2, cy = r.y + r.h/2;

      // Desk icon (monitor + keyboard) above text
      if (r.h > 55) {
        const ico = document.createElementNS('http://www.w3.org/2000/svg','g');
        ico.style.pointerEvents = 'none';
        // Background disc
        const bg = document.createElementNS('http://www.w3.org/2000/svg','circle');
        bg.setAttribute('cx', cx); bg.setAttribute('cy', cy - 12);
        bg.setAttribute('r','16');
        bg.setAttribute('fill', col); bg.setAttribute('fill-opacity','0.18');
        ico.appendChild(bg);
        // Monitor
        const mon = document.createElementNS('http://www.w3.org/2000/svg','g');
        mon.setAttribute('transform', `translate(${cx-12},${cy-22})`);
        const scrn = document.createElementNS('http://www.w3.org/2000/svg','rect');
        scrn.setAttribute('x','0'); scrn.setAttribute('y','0'); scrn.setAttribute('width','24'); scrn.setAttribute('height','15');
        scrn.setAttribute('rx','2'); scrn.setAttribute('fill','none');
        scrn.setAttribute('stroke', col); scrn.setAttribute('stroke-width','2.2');
        mon.appendChild(scrn);
        // Stand
        const s1 = document.createElementNS('http://www.w3.org/2000/svg','line');
        s1.setAttribute('x1','12'); s1.setAttribute('y1','15'); s1.setAttribute('x2','12'); s1.setAttribute('y2','19');
        s1.setAttribute('stroke', col); s1.setAttribute('stroke-width','2.2');
        mon.appendChild(s1);
        const s2 = document.createElementNS('http://www.w3.org/2000/svg','line');
        s2.setAttribute('x1','6'); s2.setAttribute('y1','19'); s2.setAttribute('x2','18'); s2.setAttribute('y2','19');
        s2.setAttribute('stroke', col); s2.setAttribute('stroke-width','2.2'); s2.setAttribute('stroke-linecap','round');
        mon.appendChild(s2);
        ico.appendChild(mon);
        textG.appendChild(ico);
      }

      // Room name
      let yOff = r.h > 55 ? cy + 10 : cy;
      if (r.name) {
        const nameText = document.createElementNS('http://www.w3.org/2000/svg','text');
        nameText.setAttribute('x', cx);
        nameText.setAttribute('y', yOff);
        nameText.setAttribute('text-anchor', 'middle');
        nameText.setAttribute('dominant-baseline', 'middle');
        nameText.setAttribute('fill', '#fff');
        nameText.setAttribute('font-size', '12');
        nameText.setAttribute('font-weight', '700');
        nameText.setAttribute('stroke', '#000');
        nameText.setAttribute('stroke-width', '3');
        nameText.setAttribute('paint-order', 'stroke');
        nameText.textContent = r.name.length > 15 ? r.name.substring(0,13)+'...' : r.name;
        textG.appendChild(nameText);
        yOff += 14;
      }
      
      // People names
      if (r.people && r.people.length > 0) {
        const maxShow = Math.min(r.people.length, Math.floor((r.y + r.h - yOff - 4) / 12));
        r.people.slice(0, maxShow).forEach(p => {
          const pt = document.createElementNS('http://www.w3.org/2000/svg','text');
          pt.setAttribute('x', cx); pt.setAttribute('y', yOff);
          pt.setAttribute('text-anchor','middle'); pt.setAttribute('dominant-baseline','middle');
          pt.setAttribute('fill','#fff'); pt.setAttribute('font-size','9'); pt.setAttribute('font-weight','400');
          pt.setAttribute('stroke','#000'); pt.setAttribute('stroke-width','2'); pt.setAttribute('paint-order','stroke');
          pt.textContent = p.length > 18 ? p.substring(0,16)+'â€¦' : p;
          textG.appendChild(pt);
          yOff += 12;
        });
        if (r.people.length > maxShow && maxShow > 0) {
          const more = document.createElementNS('http://www.w3.org/2000/svg','text');
          more.setAttribute('x', cx); more.setAttribute('y', yOff);
          more.setAttribute('text-anchor','middle'); more.setAttribute('dominant-baseline','middle');
          more.setAttribute('fill','#ccc'); more.setAttribute('font-size','8'); more.setAttribute('font-style','italic');
          more.setAttribute('stroke','#000'); more.setAttribute('stroke-width','2'); more.setAttribute('paint-order','stroke');
          more.textContent = `+${r.people.length - maxShow} autres`;
          textG.appendChild(more);
          yOff += 11;
        }
      }
      
      // Socket numbers
      if (r.socketNums) {
        const st = document.createElementNS('http://www.w3.org/2000/svg','text');
        st.setAttribute('x', cx); st.setAttribute('y', yOff);
        st.setAttribute('text-anchor','middle'); st.setAttribute('dominant-baseline','middle');
        st.setAttribute('fill','#80ffea'); st.setAttribute('font-size','8'); st.setAttribute('font-weight','600');
        st.setAttribute('stroke','#000'); st.setAttribute('stroke-width','2'); st.setAttribute('paint-order','stroke');
        st.textContent = ('ğŸ”Œ ' + r.socketNums).substring(0, 22);
        textG.appendChild(st);
        yOff += 11;
      }
      
      // Notes
      if (r.notes) {
        const nt = document.createElementNS('http://www.w3.org/2000/svg','text');
        nt.setAttribute('x', cx); nt.setAttribute('y', yOff);
        nt.setAttribute('text-anchor','middle'); nt.setAttribute('dominant-baseline','middle');
        nt.setAttribute('fill','#ffd580'); nt.setAttribute('font-size','8'); nt.setAttribute('font-style','italic');
        nt.setAttribute('stroke','#000'); nt.setAttribute('stroke-width','2'); nt.setAttribute('paint-order','stroke');
        nt.textContent = r.notes.substring(0, 22);
        textG.appendChild(nt);
      }
      
      // RETIRÃ‰ badge
      if (r.retired) {
        const rb = document.createElementNS('http://www.w3.org/2000/svg','text');
        rb.setAttribute('x', cx); rb.setAttribute('y', r.y + 12);
        rb.setAttribute('text-anchor','middle'); rb.setAttribute('dominant-baseline','middle');
        rb.setAttribute('fill','#ff4444'); rb.setAttribute('font-size','11'); rb.setAttribute('font-weight','900');
        rb.setAttribute('stroke','#000'); rb.setAttribute('stroke-width','3'); rb.setAttribute('paint-order','stroke');
        rb.setAttribute('letter-spacing','2');
        rb.textContent = 'â›” RetirÃ©(e)' + (r.retiredDate ? ' â€” ' + new Date(r.retiredDate).toLocaleDateString('fr-FR') : '');
        textG.appendChild(rb);
      }
      
      svg.appendChild(textG);
    }
  });

  // Draw copiers
  f.copiers.forEach(c => {
    renderResourceSVG(svg, c, 'copier', '#ff6b35', editCopier, f.name, drawCopierIcon);
  });

  // Draw printers
  f.printers.forEach(p => {
    renderResourceSVG(svg, p, 'printer', '#4f8aff', editPrinter, f.name, drawPrinterIcon);
  });

  // Draw meeting rooms
  f.meetings.forEach(m => {
    ensurePolygon(m);
    const mClr = matchesSearch(m) ? SEARCH_HIGHLIGHT_COLOR : m.retired ? RETIRED_COLOR : (m.customColor || '#3ddc97');
    
    const pointsStr = m.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', mClr);
    poly.setAttribute('fill-opacity', matchesSearch(m) ? '0.45' : '0.15');
    poly.setAttribute('stroke', mClr);
    poly.setAttribute('stroke-width', matchesSearch(m) ? '4' : '2');
    poly.style.cursor = 'move';
    poly.setAttribute('data-type', 'meeting');
    poly.setAttribute('data-id', m.id);
    poly.addEventListener('click', (e) => { 
      e.stopPropagation();
      editMeeting(m); 
    });
    poly.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'meeting', m, f.name));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);
    
    // Update bounds
    const bounds = calculateBounds(m.points);
    m.x = bounds.x;
    m.y = bounds.y;
    m.w = bounds.w;
    m.h = bounds.h;

    // Add text info in meeting room
    const centerX = m.x + m.w / 2;
    const centerY = m.y + m.h / 2;
    
    const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
    textG.style.pointerEvents = 'none';

    // People icon above name
    if (m.w > 80 && m.h > 55) {
      const ico = document.createElementNS('http://www.w3.org/2000/svg','g');
      ico.style.pointerEvents = 'none';
      // Background disc
      const bg = document.createElementNS('http://www.w3.org/2000/svg','circle');
      bg.setAttribute('cx', centerX); bg.setAttribute('cy', centerY - 12);
      bg.setAttribute('r','16');
      bg.setAttribute('fill',mClr); bg.setAttribute('fill-opacity','0.18');
      ico.appendChild(bg);
      // People group
      const pg = document.createElementNS('http://www.w3.org/2000/svg','g');
      pg.setAttribute('transform', `translate(${centerX-12},${centerY-23})`);
      // Person 1
      const h1 = document.createElementNS('http://www.w3.org/2000/svg','circle');
      h1.setAttribute('cx','7'); h1.setAttribute('cy','3.5'); h1.setAttribute('r','3');
      h1.setAttribute('fill','none'); h1.setAttribute('stroke',mClr); h1.setAttribute('stroke-width','2');
      pg.appendChild(h1);
      const b1 = document.createElementNS('http://www.w3.org/2000/svg','path');
      b1.setAttribute('d','M1 15 C1 10 13 10 13 15');
      b1.setAttribute('fill','none'); b1.setAttribute('stroke',mClr); b1.setAttribute('stroke-width','2');
      b1.setAttribute('stroke-linecap','round');
      pg.appendChild(b1);
      // Person 2
      const h2 = document.createElementNS('http://www.w3.org/2000/svg','circle');
      h2.setAttribute('cx','17'); h2.setAttribute('cy','3.5'); h2.setAttribute('r','3');
      h2.setAttribute('fill','none'); h2.setAttribute('stroke',mClr); h2.setAttribute('stroke-width','2');
      pg.appendChild(h2);
      const b2 = document.createElementNS('http://www.w3.org/2000/svg','path');
      b2.setAttribute('d','M11 15 C11 10 23 10 23 15');
      b2.setAttribute('fill','none'); b2.setAttribute('stroke',mClr); b2.setAttribute('stroke-width','2');
      b2.setAttribute('stroke-linecap','round');
      pg.appendChild(b2);
      ico.appendChild(pg);
      textG.appendChild(ico);
    }
    
    // Room name
    if (m.name) {
      const nameText = document.createElementNS('http://www.w3.org/2000/svg','text');
      nameText.setAttribute('x', centerX);
      nameText.setAttribute('y', (m.w > 80 && m.h > 55) ? centerY + 4 : centerY - 8);
      nameText.setAttribute('text-anchor', 'middle');
      nameText.setAttribute('fill', mClr);
      nameText.setAttribute('font-size', '12');
      nameText.setAttribute('font-weight', '700');
      nameText.setAttribute('stroke', '#000');
      nameText.setAttribute('stroke-width', '3');
      nameText.setAttribute('paint-order', 'stroke');
      nameText.textContent = m.name.length > 18 ? m.name.substring(0,16)+'...' : m.name;
      textG.appendChild(nameText);
    }
    
    // Screen info
    const capInfo = m.capacity ? `ğŸ‘¥ ${m.capacity} places` : '';
    const screenInfo = `${(m.screenType==='tactile'?'Tactile':m.screenType==='videoprojecteur'?'VidÃ©oproj.':'Classique')} ${m.screenSize}"${m.hasMTR?' + MTR':''}${m.hasClickshare?' + CS':''}${m.hasWepresent?' + WP':''}`;
    const infoText = document.createElementNS('http://www.w3.org/2000/svg','text');
    infoText.setAttribute('x', centerX);
    infoText.setAttribute('y', (m.w > 80 && m.h > 55) ? centerY + 16 : centerY + 6);
    infoText.setAttribute('text-anchor', 'middle');
    infoText.setAttribute('fill', mClr);
    infoText.setAttribute('font-size', '9');
    infoText.setAttribute('opacity', '0.9');
    infoText.setAttribute('stroke', '#000');
    infoText.setAttribute('stroke-width', '2.5');
    infoText.setAttribute('paint-order', 'stroke');
    infoText.textContent = screenInfo;
    textG.appendChild(infoText);
    
    // RETIRÃ‰ badge on meeting
    if (m.retired) {
      const rb = document.createElementNS('http://www.w3.org/2000/svg','text');
      rb.setAttribute('x', centerX); rb.setAttribute('y', m.y + 12);
      rb.setAttribute('text-anchor','middle'); rb.setAttribute('dominant-baseline','middle');
      rb.setAttribute('fill','#ff4444'); rb.setAttribute('font-size','11'); rb.setAttribute('font-weight','900');
      rb.setAttribute('stroke','#000'); rb.setAttribute('stroke-width','3'); rb.setAttribute('paint-order','stroke');
      rb.textContent = 'â›” RetirÃ©(e)' + (m.retiredDate ? ' â€” ' + new Date(m.retiredDate).toLocaleDateString('fr-FR') : '');
      textG.appendChild(rb);
    }
    
    svg.appendChild(textG);
  });

  // Draw moves
  f.moves.forEach(mv => {
    ensurePolygon(mv);
    const isHighlighted = S._moveFilterDate && mv.date === S._moveFilterDate;
    const mvSearchMatch = matchesSearch(mv);
    const mvClr = mv.retired ? RETIRED_COLOR : (isHighlighted || mvSearchMatch) ? SEARCH_HIGHLIGHT_COLOR : (mv.customColor || '#00e5cc');
    
    const pointsStr = mv.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', mvClr);
    poly.setAttribute('fill-opacity', (isHighlighted || mvSearchMatch) ? '0.4' : '0.15');
    poly.setAttribute('stroke', mvClr);
    poly.setAttribute('stroke-width', (isHighlighted || mvSearchMatch) ? '4' : '3');
    poly.setAttribute('stroke-dasharray', (isHighlighted || mvSearchMatch) ? '' : '8,4');
    poly.style.cursor = 'move';
    poly.setAttribute('data-type', 'move');
    poly.setAttribute('data-id', mv.id);
    poly.addEventListener('click', (e) => { 
      e.stopPropagation();
      editMove(mv); 
    });
    poly.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'move', mv, f.name));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);
    
    // Update bounds
    const bounds = calculateBounds(mv.points);
    mv.x = bounds.x;
    mv.y = bounds.y;
    mv.w = bounds.w;
    mv.h = bounds.h;
    
    // Add text info in move zone
    if (mv.w > 100 && mv.h > 60) {
      const centerX = mv.x + mv.w / 2;
      const centerY = mv.y + mv.h / 2;
      
      const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
      textG.style.pointerEvents = 'none';

      // Moving box icon
      if (mv.h > 70) {
        const ico = document.createElementNS('http://www.w3.org/2000/svg','g');
        ico.style.pointerEvents = 'none';
        // Background disc
        const bg = document.createElementNS('http://www.w3.org/2000/svg','circle');
        bg.setAttribute('cx', centerX); bg.setAttribute('cy', centerY - 12);
        bg.setAttribute('r','18');
        bg.setAttribute('fill',mvClr); bg.setAttribute('fill-opacity','0.18');
        ico.appendChild(bg);
        // Box group
        const bx = document.createElementNS('http://www.w3.org/2000/svg','g');
        bx.setAttribute('transform', `translate(${centerX-14},${centerY-24})`);
        // Box body
        const box = document.createElementNS('http://www.w3.org/2000/svg','rect');
        box.setAttribute('x','0'); box.setAttribute('y','6'); box.setAttribute('width','28'); box.setAttribute('height','16');
        box.setAttribute('rx','1.5'); box.setAttribute('fill','none');
        box.setAttribute('stroke',mvClr); box.setAttribute('stroke-width','2.2');
        bx.appendChild(box);
        // Box flaps
        const flap = document.createElementNS('http://www.w3.org/2000/svg','path');
        flap.setAttribute('d','M0 6 L5 0 L14 4 L23 0 L28 6');
        flap.setAttribute('fill','none'); flap.setAttribute('stroke',mvClr); flap.setAttribute('stroke-width','2');
        flap.setAttribute('stroke-linecap','round'); flap.setAttribute('stroke-linejoin','round');
        bx.appendChild(flap);
        // Arrow
        const arrow = document.createElementNS('http://www.w3.org/2000/svg','path');
        arrow.setAttribute('d','M8 14 L20 14 M16 10 L20 14 L16 18');
        arrow.setAttribute('fill','none'); arrow.setAttribute('stroke',mvClr); arrow.setAttribute('stroke-width','2');
        arrow.setAttribute('stroke-linecap','round'); arrow.setAttribute('stroke-linejoin','round');
        bx.appendChild(arrow);
        ico.appendChild(bx);
        textG.appendChild(ico);
      }
      
      const hasIcon = mv.h > 70;
      let yOff = hasIcon ? 8 : 0;
      
      // Move name
      if (mv.name) {
        const nameText = document.createElementNS('http://www.w3.org/2000/svg','text');
        nameText.setAttribute('x', centerX);
        nameText.setAttribute('y', centerY - 12 + yOff);
        nameText.setAttribute('text-anchor', 'middle');
        nameText.setAttribute('fill', '#fff');
        nameText.setAttribute('font-size', '12');
        nameText.setAttribute('font-weight', '700');
        nameText.setAttribute('stroke', '#000');
        nameText.setAttribute('stroke-width', '3');
        nameText.setAttribute('paint-order', 'stroke');
        nameText.textContent = mv.name.length > 18 ? mv.name.substring(0,16)+'â€¦' : mv.name;
        textG.appendChild(nameText);
        yOff += 14;
      }
      
      // Date
      if (mv.date) {
        const dateText = document.createElementNS('http://www.w3.org/2000/svg','text');
        dateText.setAttribute('x', centerX);
        dateText.setAttribute('y', centerY - 12 + yOff);
        dateText.setAttribute('text-anchor', 'middle');
        dateText.setAttribute('fill', mvClr);
        dateText.setAttribute('font-size', '11');
        dateText.setAttribute('font-weight', '700');
        dateText.setAttribute('stroke', '#000');
        dateText.setAttribute('stroke-width', '3');
        dateText.setAttribute('paint-order', 'stroke');
        dateText.textContent = new Date(mv.date).toLocaleDateString('fr-FR');
        textG.appendChild(dateText);
      }
      
      // People count
      if (mv.people.length > 0) {
        const peopleText = document.createElementNS('http://www.w3.org/2000/svg','text');
        peopleText.setAttribute('x', centerX);
        peopleText.setAttribute('y', centerY + 2 + yOff);
        peopleText.setAttribute('text-anchor', 'middle');
        peopleText.setAttribute('fill', mvClr);
        peopleText.setAttribute('font-size', '10');
        peopleText.setAttribute('opacity', '0.9');
        peopleText.setAttribute('stroke', '#000');
        peopleText.setAttribute('stroke-width', '2.5');
        peopleText.setAttribute('paint-order', 'stroke');
        const pcCount = mv.people.filter(p => p.needsPC).length;
        peopleText.textContent = `${mv.people.length} personne${mv.people.length>1?'s':''}`;
        textG.appendChild(peopleText);
        
        // PC count
        if (pcCount > 0) {
          const pcText = document.createElementNS('http://www.w3.org/2000/svg','text');
          pcText.setAttribute('x', centerX);
          pcText.setAttribute('y', centerY + 14 + yOff);
          pcText.setAttribute('text-anchor', 'middle');
          pcText.setAttribute('fill', mvClr);
          pcText.setAttribute('font-size', '9');
          pcText.setAttribute('opacity', '0.8');
          pcText.setAttribute('stroke', '#000');
          pcText.setAttribute('stroke-width', '2.5');
          pcText.setAttribute('paint-order', 'stroke');
          pcText.textContent = `${pcCount} PC`;
          textG.appendChild(pcText);
        }
      }
      
      // RETIRÃ‰ badge on move
      if (mv.retired) {
        const rb = document.createElementNS('http://www.w3.org/2000/svg','text');
        rb.setAttribute('x', centerX); rb.setAttribute('y', mv.y + 12);
        rb.setAttribute('text-anchor','middle'); rb.setAttribute('dominant-baseline','middle');
        rb.setAttribute('fill','#ff4444'); rb.setAttribute('font-size','11'); rb.setAttribute('font-weight','900');
        rb.setAttribute('stroke','#000'); rb.setAttribute('stroke-width','3'); rb.setAttribute('paint-order','stroke');
        rb.textContent = 'â›” RetirÃ©(e)' + (mv.retiredDate ? ' â€” ' + new Date(mv.retiredDate).toLocaleDateString('fr-FR') : '');
        textG.appendChild(rb);
      }
      
      svg.appendChild(textG);
    }
  });

  // Draw screens
  (f.screens||[]).forEach(sc => {
    renderResourceSVG(svg, sc, 'screen', '#9b87f5', editScreen, f.name, drawScreenIcon);
  });

  // Draw tech rooms (polygon zones, red)
  (f.techrooms||[]).forEach(tr => {
    const trClr = matchesSearch(tr) ? SEARCH_HIGHLIGHT_COLOR : tr.retired ? RETIRED_COLOR : (tr.customColor || '#2196f3');
    ensurePolygon(tr);

    const COLOR = trClr;
    const pointsStr = tr.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', COLOR);
    poly.setAttribute('fill-opacity', '0.15');
    poly.setAttribute('stroke', COLOR);
    poly.setAttribute('stroke-width', '2.5');
    poly.style.cursor = 'move';
    poly.setAttribute('data-type','techroom'); poly.setAttribute('data-id', tr.id);
    poly.addEventListener('click', e => { e.stopPropagation(); editTechroom(tr); });
    poly.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'techroom', tr, f.name));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);

    // Update bounds
    const bounds = calculateBounds(tr.points);
    tr.x = bounds.x; tr.y = bounds.y; tr.w = bounds.w; tr.h = bounds.h;

    // Label: rack icon + name centered
    const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
    textG.style.pointerEvents = 'none';

    // Rack icon centered
    const cx = tr.x + tr.w/2, cy = tr.y + tr.h/2;
    const ico = document.createElementNS('http://www.w3.org/2000/svg','g');
    ico.setAttribute('transform', `translate(${cx-9},${cy-12})`);
    [0,6,12].forEach(yy => {
      const rack = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rack.setAttribute('x','0'); rack.setAttribute('y', yy+'');
      rack.setAttribute('width','18'); rack.setAttribute('height','4');
      rack.setAttribute('rx','1'); rack.setAttribute('fill','none');
      rack.setAttribute('stroke', COLOR); rack.setAttribute('stroke-width','1.5');
      ico.appendChild(rack);
      const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('cx','2.5'); dot.setAttribute('cy', (yy+2)+'');
      dot.setAttribute('r','1'); dot.setAttribute('fill', COLOR);
      ico.appendChild(dot);
    });
    textG.appendChild(ico);

    if (tr.name && tr.w > 60 && tr.h > 40) {
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', cx); lbl.setAttribute('y', cy + 16);
      lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('dominant-baseline','middle');
      lbl.setAttribute('fill', COLOR); lbl.setAttribute('font-size','11'); lbl.setAttribute('font-weight','700');
      lbl.setAttribute('stroke','#000'); lbl.setAttribute('stroke-width','2.5'); lbl.setAttribute('paint-order','stroke');
      lbl.textContent = tr.name.length>16 ? tr.name.substring(0,14)+'â€¦' : tr.name;
      textG.appendChild(lbl);
    }
    // RETIRÃ‰ badge on techroom
    if (tr.retired) {
      const rb = document.createElementNS('http://www.w3.org/2000/svg','text');
      const tcx = tr.x + tr.w/2;
      rb.setAttribute('x', tcx); rb.setAttribute('y', tr.y + 12);
      rb.setAttribute('text-anchor','middle'); rb.setAttribute('dominant-baseline','middle');
      rb.setAttribute('fill','#ff4444'); rb.setAttribute('font-size','11'); rb.setAttribute('font-weight','900');
      rb.setAttribute('stroke','#000'); rb.setAttribute('stroke-width','3'); rb.setAttribute('paint-order','stroke');
      rb.textContent = 'â›” RetirÃ©(e)' + (tr.retiredDate ? ' â€” ' + new Date(tr.retiredDate).toLocaleDateString('fr-FR') : '');
      textG.appendChild(rb);
    }
    svg.appendChild(textG);
  });

  // Draw dynamic displays
  (f.displays||[]).forEach(dp => {
    renderResourceSVG(svg, dp, 'display', '#ffaa33', editDisplay, f.name, drawDisplayIcon);
  });


  (f.sockets||[]).forEach(sock => {
    renderResourceSVG(svg, sock, 'socket', '#00bfa5', editSocket, f.name, drawSocketIcon);
  });


  // Draw projectors
  (f.projectors||[]).forEach(pj => {
    renderResourceSVG(svg, pj, 'projector', '#e066ff', editProjector, f.name, drawProjectorIcon);
  });


  // Draw plotters
  (f.plotters||[]).forEach(pl => {
    renderResourceSVG(svg, pl, 'plotter', '#00acc1', editPlotter, f.name, drawPlotterIcon);
  });


  (f.freezones||[]).forEach(fz => {
    ensurePolygon(fz);
    const COLOR = fz.color || '#a78bfa';
    const pointsStr = fz.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', COLOR);
    poly.setAttribute('fill-opacity', matchesSearch(fz) ? '0.45' : '0.15');
    poly.setAttribute('stroke', COLOR);
    poly.setAttribute('stroke-width', matchesSearch(fz) ? '4' : '2');
    poly.setAttribute('stroke-dasharray', matchesSearch(fz) ? '' : '6,3');
    poly.style.cursor = 'pointer';
    poly.setAttribute('data-type','freezone');
    poly.setAttribute('data-id', fz.id);
    poly.addEventListener('click', e => { e.stopPropagation(); editFreezone(fz); });
    poly.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'freezone', fz, f.name));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);

    const bounds = calculateBounds(fz.points);
    fz.x = bounds.x; fz.y = bounds.y; fz.w = bounds.w; fz.h = bounds.h;
    const cx = fz.x + fz.w/2, cy = fz.y + fz.h/2;

    const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
    textG.style.pointerEvents = 'none';

    if (fz.icon) {
      const fo = document.createElementNS('http://www.w3.org/2000/svg','foreignObject');
      fo.setAttribute('x', cx-12); fo.setAttribute('y', cy-18);
      fo.setAttribute('width','24'); fo.setAttribute('height','24');
      const div = document.createElement('div');
      div.style.cssText = 'font-size:20px;text-align:center;line-height:24px;';
      div.textContent = fz.icon;
      fo.appendChild(div);
      textG.appendChild(fo);
    }

    if (fz.name && fz.w > 40 && fz.h > 30) {
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', cx);
      lbl.setAttribute('y', fz.icon ? cy + 14 : cy + 4);
      lbl.setAttribute('text-anchor','middle');
      lbl.setAttribute('fill', COLOR);
      lbl.setAttribute('font-size','12'); lbl.setAttribute('font-weight','700');
      lbl.setAttribute('stroke','#000'); lbl.setAttribute('stroke-width','2.5');
      lbl.setAttribute('paint-order','stroke');
      lbl.textContent = fz.name.length>18 ? fz.name.substring(0,16)+'â€¦' : fz.name;
      textG.appendChild(lbl);
    }
    // RETIRÃ‰ badge on freezone
    if (fz.retired) {
      const rb = document.createElementNS('http://www.w3.org/2000/svg','text');
      rb.setAttribute('x', cx); rb.setAttribute('y', fz.y + 12);
      rb.setAttribute('text-anchor','middle'); rb.setAttribute('dominant-baseline','middle');
      rb.setAttribute('fill','#ff4444'); rb.setAttribute('font-size','11'); rb.setAttribute('font-weight','900');
      rb.setAttribute('stroke','#000'); rb.setAttribute('stroke-width','3'); rb.setAttribute('paint-order','stroke');
      rb.textContent = 'â›” RetirÃ©(e)' + (fz.retiredDate ? ' â€” ' + new Date(fz.retiredDate).toLocaleDateString('fr-FR') : '');
      textG.appendChild(rb);
    }
    svg.appendChild(textG);
  });

  // Show anchor points in edit-shape mode
  if (S.mode === 'edit-shape' && S.editingShape) {
    const item = getEditableItem(S.editingShape.type, S.editingShape.id);
    if (item) {
      drawAnchorPoints(item, S.editingShape.type);
    }
  }
}

function roomColor(fid, idx) {
  const colors = ['#4f8aff','#00e5cc','#3ddc97','#ff6b35','#ff5f57','#9b87f5','#ffaa33','#ff4d9a'];
  return colors[(fid + idx) % colors.length];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHAPE EDITING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getEditableItem(type, id) {
  const f = activeFloor();
  if (!f) return null;
  
  if (type === 'room') return f.rooms.find(r => r.id === id);
  else if (type === 'meeting') return f.meetings.find(m => m.id === id);
  else if (type === 'move') return f.moves.find(m => m.id === id);
  else if (type === 'techroom') return (f.techrooms||[]).find(t => t.id === id);
  return null;
}

function drawAnchorPoints(item, type) {
  const svg = document.getElementById('svg-layer');
  
  ensurePolygon(item);
  
  // Draw all polygon points
  item.points.forEach((pt, idx) => {
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx', pt.x);
    circle.setAttribute('cy', pt.y);
    circle.setAttribute('r', '7');
    circle.setAttribute('fill', '#fff');
    circle.setAttribute('stroke', '#4f8aff');
    circle.setAttribute('stroke-width', '2.5');
    circle.style.cursor = 'move';
    circle.setAttribute('data-anchor', idx);
    circle.setAttribute('data-point-type', 'vertex');
    
    const title = document.createElementNS('http://www.w3.org/2000/svg','title');
    title.textContent = `Point ${idx + 1} (clic droit pour supprimer)`;
    circle.appendChild(title);
    
    // Right-click to delete point
    circle.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      if (item.points.length > 3) {
        item.points.splice(idx, 1);
        renderCanvas();
        notify('Point supprimÃ©');
      } else {
        notify('Minimum 3 points requis');
      }
    });
    
    svg.appendChild(circle);
  });
  
  // Draw midpoints for adding new points
  for (let i = 0; i < item.points.length; i++) {
    const p1 = item.points[i];
    const p2 = item.points[(i + 1) % item.points.length];
    const midX = (p1.x + p2.x) / 2;
    const midY = (p1.y + p2.y) / 2;
    
    const midCircle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    midCircle.setAttribute('cx', midX);
    midCircle.setAttribute('cy', midY);
    midCircle.setAttribute('r', '5');
    midCircle.setAttribute('fill', '#00e5cc');
    midCircle.setAttribute('stroke', '#4f8aff');
    midCircle.setAttribute('stroke-width', '2');
    midCircle.style.cursor = 'pointer';
    midCircle.setAttribute('data-midpoint', i);
    midCircle.setAttribute('data-point-type', 'midpoint');
    
    const midTitle = document.createElementNS('http://www.w3.org/2000/svg','title');
    midTitle.textContent = `Cliquer pour ajouter un point`;
    midCircle.appendChild(midTitle);
    
    // Click to add point
    midCircle.addEventListener('click', (e) => {
      e.stopPropagation();
      item.points.splice(i + 1, 0, {x: midX, y: midY});
      renderCanvas();
      notify('Point ajoutÃ©');
    });
    
    svg.appendChild(midCircle);
  }
}

function selectShapeForEditing(type, id) {
  S.editingShape = {type, id, selectedPoint: null};
  renderCanvas();
  notify(`Cliquez sur les points d'ancrage pour redimensionner`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROOMS LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRoomsList() {
  const list = document.getElementById('tab-list');
  const f = activeFloor();
  if (!f || f.rooms.length === 0) {
    list.innerHTML = '<div class="es"><div class="es-title">Aucun bureau</div><div class="es-sub">Tracez des bureaux sur le plan</div></div>';
    return;
  }
  list.innerHTML = '';
  f.rooms.forEach((r,i) => {
    const col = matchesSearch(r) ? SEARCH_HIGHLIGHT_COLOR : r.retired ? RETIRED_COLOR : (r.customColor || roomColor(f.id, i));
    const d = document.createElement('div');
    d.className = 'rli';
    if (S.selectedRoom === r.id) d.classList.add('on');
    d.innerHTML = `
      <div class="rli-dot" style="background:${col}"></div>
      <div class="rli-name">${esc(r.name||'Bureau '+(i+1))}</div>
      <div class="rli-acts">
        <button class="ib" onclick="event.stopPropagation();editRoom(${r.id})" title="Modifier">âœ</button>
        <button class="ib danger" onclick="event.stopPropagation();deleteRoom(${r.id})" title="Supprimer">Ã—</button>
      </div>
    `;
    d.onclick = () => { S.selectedRoom = r.id; renderCanvas(); renderRoomsList(); editorOpen(r); };
    list.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EQUIPMENTS LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEquipmentsList() {
  const list = document.getElementById('tab-equip');
  const f = activeFloor();
  if (!f || (f.copiers.length === 0 && f.printers.length === 0 && f.meetings.length === 0
    && (f.screens||[]).length === 0 && (f.techrooms||[]).length === 0 && (f.displays||[]).length === 0 && (f.projectors||[]).length === 0 && (f.plotters||[]).length === 0)) {
    list.innerHTML = '<div class="es"><div class="es-title">Aucun Ã©quipement</div><div class="es-sub">Ajoutez des copieurs, imprimantes, salles de rÃ©union, Ã©crans, affichages dynamiques ou locaux techniques</div></div>';
    return;
  }
  list.innerHTML = '';

  // Copiers
  if (f.copiers.length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:10px 0 8px;';
    h.textContent = 'COPIEURS';
    list.appendChild(h);

    f.copiers.forEach((c,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#ff6b35;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="2" width="12" height="6" rx="1"/><path d="M18 8v10a2 2 0 01-2 2H8a2 2 0 01-2-2V8"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="18" y2="16"/></svg>
        </div>
        <div class="rli-name">${esc(c.name||'Copieur '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editCopier(${JSON.stringify(c).replace(/"/g,'&quot;')})" title="Modifier">âœ</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteCopier(${c.id})" title="Supprimer">Ã—</button>
        </div>
      `;
      d.onclick = () => editCopier(c);
      list.appendChild(d);
    });
  }

  // Printers
  if (f.printers.length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'IMPRIMANTES';
    list.appendChild(h);

    f.printers.forEach((p,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#4f8aff;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        </div>
        <div class="rli-name">${esc(p.name||'Imprimante '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editPrinter(${JSON.stringify(p).replace(/"/g,'&quot;')})" title="Modifier">âœ</button>
          <button class="ib danger" onclick="event.stopPropagation();deletePrinter(${p.id})" title="Supprimer">Ã—</button>
        </div>
      `;
      d.onclick = () => editPrinter(p);
      list.appendChild(d);
    });
  }

  // Meeting rooms
  if (f.meetings.length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'SALLES DE RÃ‰UNION';
    list.appendChild(h);

    f.meetings.forEach((m,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#3ddc97;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3h2v4M8 3H6v4"/></svg>
        </div>
        <div class="rli-name">${esc(m.name||'Salle '+(i+1))}</div>
        <div class="rli-cnt" style="font-size:9px;">${m.screenSize}"</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editMeeting(${JSON.stringify(m).replace(/"/g,'&quot;')})" title="Modifier">âœ</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteMeeting(${m.id})" title="Supprimer">Ã—</button>
        </div>
      `;
      d.onclick = () => editMeeting(m);
      list.appendChild(d);
    });
  }

  // Screens
  if ((f.screens||[]).length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'Ã‰CRANS';
    list.appendChild(h);
    f.screens.forEach((sc,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#9b87f5;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        </div>
        <div class="rli-name">${esc(sc.name||'Ã‰cran '+(i+1))}</div>
        <div class="rli-cnt" style="font-size:9px;">${sc.size}" ${sc.brand||''}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editScreen({id:${sc.id}})" title="Modifier">âœ</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteScreen(${sc.id})" title="Supprimer">Ã—</button>
        </div>`;
      d.onclick = () => editScreen(sc);
      list.appendChild(d);
    });
  }

  // Tech rooms
  if ((f.techrooms||[]).length > 0) {    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'LOCAUX TECHNIQUES';
    list.appendChild(h);
    f.techrooms.forEach((tr,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#ff6b35;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
        </div>
        <div class="rli-name">${esc(tr.name||'Local Tech '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editTechroom({id:${tr.id}})" title="Modifier">âœ</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteTechroom(${tr.id})" title="Supprimer">Ã—</button>
        </div>`;
      d.onclick = () => editTechroom(tr);
      list.appendChild(d);
    });
  }

  // Dynamic Displays
  if ((f.displays||[]).length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'AFFICHAGES DYNAMIQUES';
    list.appendChild(h);
    f.displays.forEach((dp,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#ffaa33;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="4" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/><line x1="6" y1="9" x2="18" y2="9"/><line x1="6" y1="13" x2="14" y2="13"/></svg>
        </div>
        <div class="rli-name">${esc(dp.name||'Affichage '+(i+1))}</div>
        <div class="rli-cnt" style="font-size:9px;">${dp.size}"</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editDisplay({id:${dp.id}})" title="Modifier">âœ</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteDisplay(${dp.id})" title="Supprimer">Ã—</button>
        </div>`;
      d.onclick = () => editDisplay(dp);
      list.appendChild(d);
    });
  }

  // Projectors
  if ((f.projectors||[]).length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'VIDÃ‰OPROJECTEURS';
    list.appendChild(h);
    f.projectors.forEach((pj,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#e066ff;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="16" cy="12" r="3"/><circle cx="7" cy="12" r="1.5" fill="currentColor"/></svg>
        </div>
        <div class="rli-name">${esc(pj.name||'VidÃ©oprojecteur '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editProjector({id:${pj.id}})" title="Modifier">âœ</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteProjector(${pj.id})" title="Supprimer">Ã—</button>
        </div>`;
      d.onclick = () => editProjector(pj);
      list.appendChild(d);
    });
  }

  // Plotters
  if ((f.plotters||[]).length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'TRACEURS';
    list.appendChild(h);
    f.plotters.forEach((pl,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#ff4d6a;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="14" rx="2"/><path d="M6 18v3h12v-3"/><line x1="6" y1="10" x2="18" y2="10"/><path d="M2 14h20"/></svg>
        </div>
        <div class="rli-name">${esc(pl.name||'Traceur '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editPlotter({id:${pl.id}})" title="Modifier">âœ</button>
          <button class="ib danger" onclick="event.stopPropagation();deletePlotter(${pl.id})" title="Supprimer">Ã—</button>
        </div>`;
      d.onclick = () => editPlotter(pl);
      list.appendChild(d);
    });
  }

  // Free zones
  if ((f.freezones||[]).length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'ZONES LIBRES';
    list.appendChild(h);
    f.freezones.forEach((fz,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:${fz.color||'#a78bfa'};font-size:16px;">${fz.icon||'ğŸ“¦'}</div>
        <div class="rli-name">${esc(fz.name||'Zone '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editFreezone(${JSON.stringify(fz).replace(/"/g,'&quot;')})" title="Modifier">âœ</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteFreezone(${fz.id})" title="Supprimer">Ã—</button>
        </div>`;
      d.onclick = () => editFreezone(fz);
      list.appendChild(d);
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOVES LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMovesList() {
  const list = document.getElementById('tab-move');
  const f = activeFloor();
  if (!f || f.moves.length === 0) {
    list.innerHTML = '<div class="es"><div class="es-title">Aucun dÃ©mÃ©nagement</div><div class="es-sub">CrÃ©ez des zones de dÃ©mÃ©nagement</div></div>';
    return;
  }
  list.innerHTML = '';
  
  // Date filter
  const allDates = [...new Set(f.moves.filter(m => m.date).map(m => m.date))].sort();
  if (allDates.length > 0) {
    const filterDiv = document.createElement('div');
    filterDiv.style.cssText = 'padding:6px 8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px;';
    filterDiv.innerHTML = `
      <label style="font-size:11px;color:var(--muted);white-space:nowrap;">ğŸ“… Filtrer :</label>
      <select class="sel" id="move-date-filter" style="font-size:11px;flex:1;">
        <option value="">Tous les dÃ©mÃ©nagements</option>
        ${allDates.map(d => `<option value="${d}" ${S._moveFilterDate===d?'selected':''}>${new Date(d).toLocaleDateString('fr-FR')}</option>`).join('')}
      </select>
    `;
    list.appendChild(filterDiv);
    document.getElementById('move-date-filter').onchange = e => {
      S._moveFilterDate = e.target.value;
      renderCanvas();
      renderMovesList();
    };
  }
  
  const filterDate = S._moveFilterDate || '';
  const filtered = filterDate ? f.moves.filter(mv => mv.date === filterDate) : f.moves;
  
  if (filtered.length === 0) {
    const empty = document.createElement('div');
    empty.style.cssText = 'padding:12px;font-size:11px;color:var(--muted);font-style:italic;text-align:center;';
    empty.textContent = 'Aucun dÃ©mÃ©nagement Ã  cette date';
    list.appendChild(empty);
    return;
  }

  filtered.forEach((mv,i) => {
    const d = document.createElement('div');
    d.className = 'rli';
    const dateStr = mv.date ? new Date(mv.date).toLocaleDateString('fr-FR') : '';
    d.innerHTML = `
      <div class="rli-icon" style="color:#00e5cc;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M9 22V12h6v10"/></svg>
      </div>
      <div style="flex:1;min-width:0;">
        <div class="rli-name">${mv.name || 'Sans nom'}</div>
        ${dateStr ? `<div style="font-size:9px;color:var(--muted);">${dateStr} Â· ${mv.people.length} pers.</div>` : `<div style="font-size:9px;color:var(--muted);">${mv.people.length} pers.</div>`}
      </div>
      <div class="rli-acts">
        <button class="ib" onclick="event.stopPropagation();editMove(${JSON.stringify(mv).replace(/"/g,'&quot;')})" title="Modifier">âœ</button>
        <button class="ib danger" onclick="event.stopPropagation();deleteMove(${mv.id})" title="Supprimer">Ã—</button>
      </div>
    `;
    d.onclick = () => editMove(mv);
    list.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDITOR PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editorOpen(room) {
  const ed = document.getElementById('tab-edit');
  if (!room) {
    ed.innerHTML = '<div class="es"><div class="es-title">Aucune sÃ©lection</div><div class="es-sub">SÃ©lectionnez un bureau pour le modifier</div></div>';
    return;
  }

  const peopleHtml = (room.people||[]).map((p,i) => 
    `<div class="move-person"><div class="move-person-name">${esc(p)}</div><button class="sock-del" onclick="removeEditRoomPerson(${room.id},${i})">Ã—</button></div>`
  ).join('') || '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune personne</div>';
  
  ed.innerHTML = `
    <div class="ed-title">
      Ã‰diter bureau
      <button class="ed-close" onclick="editorClose()">Ã—</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="ed-name" value="${esc(room.name||'')}" placeholder="Bureau 101">
    </div>
    <div class="fg">
      <label class="lb">Personnes</label>
      <div class="move-people-list" id="ed-room-people">${peopleHtml}</div>
      <div class="add-person">
        <input type="text" class="inp" id="ed-room-person-input" placeholder="ex: Jean Dupont">
        <button class="btn" onclick="addEditRoomPerson(${room.id})">+</button>
      </div>
    </div>
    <div class="fg">
      <label class="lb">NÂ° prises rÃ©seau</label>
      <input type="text" class="inp" id="ed-room-sockets" value="${esc(room.socketNums||'')}" placeholder="ex: PR-101, PR-102">
    </div>
    <div class="fg">
      <label class="lb">Notes / infos complÃ©mentaires</label>
      <textarea class="txa" id="ed-room-notes" placeholder="Informations libres...">${esc(room.notes||'')}</textarea>
    </div>
    <div class="fg"><label class="lb">Couleur</label>
      <input type="color" id="ed-room-color" value="${room.customColor||'#4f8aff'}" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    <div class="fg"><div class="check-group">
      <input type="checkbox" id="ed-room-retired" onchange="document.getElementById('ed-room-retireddate').parentElement.style.display=this.checked?'block':'none'" ${room.retired?'checked':''}>
      <label for="ed-room-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      <div style="display:${room.retired?'block':'none'};margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="ed-room-retireddate" value="${room.retiredDate||''}" style="max-width:180px;">
      </div>
    </div></div>
    <button class="btn danger del-room-btn" onclick="deleteRoom(${room.id})">Supprimer le bureau</button>
  `;

  document.getElementById('ed-name').oninput = e => { room.name = e.target.value; renderRoomsList(); renderCanvas(); };
  document.getElementById('ed-room-sockets').oninput = e => { room.socketNums = e.target.value; renderCanvas(); };
  document.getElementById('ed-room-notes').oninput = e => { room.notes = e.target.value; renderCanvas(); };
  document.getElementById('ed-room-retired').onchange = e => { room.retired = e.target.checked; if (!e.target.checked) room.retiredDate = ''; renderCanvas(); renderRoomsList(); editorOpen(room); };
  document.getElementById('ed-room-retireddate').onchange = e => { room.retiredDate = e.target.value; renderCanvas(); };
  document.getElementById('ed-room-color').onchange = e => { room.customColor = e.target.value; renderCanvas(); };
  document.getElementById('ed-room-person-input').onkeydown = e => { if (e.key==='Enter') addEditRoomPerson(room.id); };
}

function addEditRoomPerson(rid) {
  const f = activeFloor(); if (!f) return;
  const r = f.rooms.find(x => x.id === rid); if (!r) return;
  const inp = document.getElementById('ed-room-person-input');
  const v = inp.value.trim(); if (!v) return;
  if (!r.people) r.people = [];
  r.people.push(v);
  inp.value = '';
  editorOpen(r); renderCanvas();
}
function removeEditRoomPerson(rid, idx) {
  const f = activeFloor(); if (!f) return;
  const r = f.rooms.find(x => x.id === rid); if (!r) return;
  r.people.splice(idx, 1);
  editorOpen(r); renderCanvas();
}

function editorClose() {
  S.selectedRoom = null;
  renderCanvas();
  renderRoomsList();
  editorOpen(null);
}

function editRoom(rid) {
  const f = activeFloor(); if (!f) return;
  const r = f.rooms.find(x => x.id === rid); if (!r) return;
  S.selectedRoom = rid;
  renderCanvas();
  renderRoomsList();
  editorOpen(r);
  switchTab('edit');
}

function deleteRoom(rid) {
  const f = activeFloor(); if (!f) return;
  const r = f.rooms.find(x => x.id === rid); if (!r) return;
  showConfirmModal(`Supprimer "${r.name || 'ce bureau'}" ?`, '', () => {
    f.rooms = f.rooms.filter(x => x.id !== rid);
    if (S.selectedRoom === rid) S.selectedRoom = null;
    renderCanvas(); renderRoomsList(); editorOpen(null); updateStats();
    notify('Bureau supprimÃ©.');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COPIER MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editCopier(c) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">
      Ã‰diter copieur
      <button class="ed-close" onclick="renderEquipmentsList()">Ã—</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="edit-copier-name" value="${esc(c.name||'')}" placeholder="Copieur RDC">
    </div>
    <div class="fg">
      <label class="lb">Informations rÃ©seau</label>
      <textarea class="txa" id="edit-copier-network" placeholder="IP, VLAN, etc.">${esc(c.network||'')}</textarea>
    </div>
    
    <div class="fg"><label class="lb">Couleur</label>
      <input type="color" id="edit-cop-color" value="${c.customColor||'#ff6b35'}" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    <div class="fg"><div class="check-group">
      <input type="checkbox" id="edit-cop-retired" onchange="document.getElementById('edit-cop-retireddate').parentElement.style.display=this.checked?'block':'none'" ${c.retired?'checked':''}>
      <label for="edit-cop-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      <div style="display:${c.retired?'block':'none'};margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="edit-cop-retireddate" value="${c.retiredDate||''}" style="max-width:180px;">
      </div>
    </div></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveCopier(${c.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteCopier(${c.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  switchTab('equip');
}

function saveCopier(cid) {
  const f = activeFloor(); if (!f) return;
  const c = f.copiers.find(x => x.id === cid); if (!c) return;
  c.name = document.getElementById('edit-copier-name').value.trim();
  c.network = document.getElementById('edit-copier-network').value.trim();
  c.customColor = document.getElementById('edit-cop-color')?.value || '';
  c.retired = document.getElementById('edit-cop-retired')?.checked || false;
  c.retiredDate = c.retired ? (document.getElementById('edit-cop-retireddate')?.value||'') : '';
  renderEquipmentsList();
  renderCanvas();
  updateStats();
  notify('Copieur mis Ã  jour.');
}

function deleteCopier(cid) {
  const f = activeFloor(); if (!f) return;
  const c = f.copiers.find(x => x.id === cid); if (!c) return;
  showConfirmModal(`Supprimer "${c.name || 'ce copieur'}" ?`, '', () => {
    f.copiers = f.copiers.filter(x => x.id !== cid);
    renderCanvas(); renderEquipmentsList(); updateStats();
    notify('Copieur supprimÃ©.');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRINTER MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editPrinter(p) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">
      Ã‰diter imprimante
      <button class="ed-close" onclick="renderEquipmentsList()">Ã—</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="edit-printer-name" value="${esc(p.name||'')}" placeholder="Imprimante Bureau 1">
    </div>
    <div class="fg">
      <label class="lb">Informations rÃ©seau</label>
      <textarea class="txa" id="edit-printer-network" placeholder="IP, VLAN, etc.">${esc(p.network||'')}</textarea>
    </div>
    
    <div class="fg"><label class="lb">Couleur</label>
      <input type="color" id="edit-prn-color" value="${p.customColor||'#4f8aff'}" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    <div class="fg"><div class="check-group">
      <input type="checkbox" id="edit-prn-retired" onchange="document.getElementById('edit-prn-retireddate').parentElement.style.display=this.checked?'block':'none'" ${p.retired?'checked':''}>
      <label for="edit-prn-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      <div style="display:${p.retired?'block':'none'};margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="edit-prn-retireddate" value="${p.retiredDate||''}" style="max-width:180px;">
      </div>
    </div></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="savePrinter(${p.id})">Enregistrer</button>
      <button class="btn danger" onclick="deletePrinter(${p.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  switchTab('equip');
}

function savePrinter(pid) {
  const f = activeFloor(); if (!f) return;
  const p = f.printers.find(x => x.id === pid); if (!p) return;
  p.name = document.getElementById('edit-printer-name').value.trim();
  p.network = document.getElementById('edit-printer-network').value.trim();
  p.customColor = document.getElementById('edit-prn-color')?.value || '';
  p.retired = document.getElementById('edit-prn-retired')?.checked || false;
  p.retiredDate = p.retired ? (document.getElementById('edit-prn-retireddate')?.value||'') : '';
  renderEquipmentsList();
  renderCanvas();
  updateStats();
  notify('Imprimante mise Ã  jour.');
}

function deletePrinter(pid) {
  const f = activeFloor(); if (!f) return;
  const p = f.printers.find(x => x.id === pid); if (!p) return;
  showConfirmModal(`Supprimer "${p.name || 'cette imprimante'}" ?`, '', () => {
    f.printers = f.printers.filter(x => x.id !== pid);
    renderCanvas(); renderEquipmentsList(); updateStats();
    notify('Imprimante supprimÃ©e.');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEETING ROOM MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editMeeting(m) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">
      Ã‰diter salle de rÃ©union
      <button class="ed-close" onclick="renderEquipmentsList()">Ã—</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="edit-meeting-name" value="${esc(m.name||'')}" placeholder="Salle RÃ©union A">
    </div>
    <div class="fg">
      <label class="lb">CapacitÃ© (nombre de places)</label>
      <input type="number" class="inp" id="edit-meeting-capacity" min="1" max="200" value="${m.capacity||''}" style="max-width:120px;">
    </div>
    <div class="fg">
      <label class="lb">Type d'Ã©cran</label>
      <div class="check-group">
        <input type="radio" name="edit-screen-type" id="edit-screen-tactile" value="tactile" ${m.screenType==='tactile'?'checked':''}>
        <label for="edit-screen-tactile">Ã‰cran tactile</label>
      </div>
      <div class="check-group">
        <input type="radio" name="edit-screen-type" id="edit-screen-classic" value="classique" ${m.screenType==='classique'?'checked':''}>
        <label for="edit-screen-classic">Ã‰cran classique</label>
      </div>
      <div class="check-group">
        <input type="radio" name="edit-screen-type" id="edit-screen-projector" value="videoprojecteur" ${m.screenType==='videoprojecteur'?'checked':''}>
        <label for="edit-screen-projector">VidÃ©oprojecteur</label>
      </div>
    </div>
    <div class="fg">
      <label class="lb">Taille de l'Ã©cran</label>
      <select class="sel" id="edit-meeting-size">
        <option value="49" ${m.screenSize===49?'selected':''}>49 pouces</option>
        <option value="55" ${m.screenSize===55?'selected':''}>55 pouces</option>
        <option value="65" ${m.screenSize===65?'selected':''}>65 pouces</option>
        <option value="75" ${m.screenSize===75?'selected':''}>75 pouces</option>
        <option value="85" ${m.screenSize===85?'selected':''}>85 pouces</option>
        <option value="98" ${m.screenSize===98?'selected':''}>98 pouces</option>
      </select>
    </div>
    <div class="fg">
      <div class="check-group">
        <input type="checkbox" id="edit-meeting-mtr" ${m.hasMTR?'checked':''}>
        <label for="edit-meeting-mtr">Ã‰quipement MTR (Microsoft Teams Rooms)</label>
      </div>
      <div class="check-group">
        <input type="checkbox" id="edit-meeting-clickshare" ${m.hasClickshare?'checked':''}>
        <label for="edit-meeting-clickshare">ClickShare</label>
      </div>
      <div class="check-group">
        <input type="checkbox" id="edit-meeting-wepresent" ${m.hasWepresent?'checked':''}>
        <label for="edit-meeting-wepresent">WePresent</label>
      </div>
    </div>
    
    <div class="fg"><label class="lb">Couleur</label>
      <input type="color" id="edit-mt-color" value="${m.customColor||'#3ddc97'}" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    <div class="fg"><div class="check-group">
      <input type="checkbox" id="edit-mt-retired" onchange="document.getElementById('edit-mt-retireddate').parentElement.style.display=this.checked?'block':'none'" ${m.retired?'checked':''}>
      <label for="edit-mt-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      <div style="display:${m.retired?'block':'none'};margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="edit-mt-retireddate" value="${m.retiredDate||''}" style="max-width:180px;">
      </div>
    </div></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveMeeting(${m.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteMeeting(${m.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  switchTab('equip');
}

function saveMeeting(mid) {
  const f = activeFloor(); if (!f) return;
  const m = f.meetings.find(x => x.id === mid); if (!m) return;
  m.name = document.getElementById('edit-meeting-name').value.trim();
  m.capacity = parseInt(document.getElementById('edit-meeting-capacity')?.value) || 0;
  m.screenType = document.querySelector('input[name="edit-screen-type"]:checked').value;
  m.screenSize = parseInt(document.getElementById('edit-meeting-size').value);
  m.hasMTR = document.getElementById('edit-meeting-mtr').checked;
  m.hasClickshare = document.getElementById('edit-meeting-clickshare').checked;
  m.hasWepresent = document.getElementById('edit-meeting-wepresent').checked;
  m.retired = document.getElementById('edit-mt-retired')?.checked || false;
  m.customColor = document.getElementById('edit-mt-color')?.value || '';
  renderEquipmentsList();
  renderCanvas();
  updateStats();
  notify('Salle de rÃ©union mise Ã  jour.');
}

function deleteMeeting(mid) {
  const f = activeFloor(); if (!f) return;
  const m = f.meetings.find(x => x.id === mid); if (!m) return;
  showConfirmModal(`Supprimer "${m.name || 'cette salle'}" ?`, '', () => {
    f.meetings = f.meetings.filter(x => x.id !== mid);
    renderCanvas(); renderEquipmentsList(); updateStats();
    notify('Salle de rÃ©union supprimÃ©e.');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOVE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editMove(mv) {
  const ed = document.getElementById('tab-move');
  const content = `
    <div class="ed-title">
      Ã‰diter dÃ©mÃ©nagement
      <button class="ed-close" onclick="renderMovesList()">Ã—</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="edit-move-name" value="${esc(mv.name||'')}" placeholder="ex: DÃ©mÃ©nagement Bureau 201 â†’ 305">
    </div>
    <div class="fg">
      <label class="lb">Date du dÃ©mÃ©nagement</label>
      <input type="date" class="inp" id="edit-move-date" value="${mv.date||''}">
    </div>
    <div class="fg">
      <label class="lb">Personnes concernÃ©es</label>
      <div class="move-people-list" id="edit-move-people"></div>
      <div class="add-person">
        <input type="text" class="inp" id="edit-move-person-input" placeholder="Nom de la personne">
        <button class="btn" onclick="addEditMovePerson(${mv.id})">+</button>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveMove(${mv.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteMove(${mv.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  renderEditMovePeople(mv);
  switchTab('move');
  document.getElementById('edit-move-person-input').onkeydown = e => { if (e.key==='Enter') addEditMovePerson(mv.id); };
}

function renderEditMovePeople(mv) {
  const c = document.getElementById('edit-move-people');
  if (!c) return;
  c.innerHTML = '';
  if (mv.people.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune personne</div>';
    return;
  }
  mv.people.forEach((p,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `
      <div class="move-person-name">${esc(p.name)}</div>
      <div class="move-person-pc">
        <input type="checkbox" ${p.needsPC?'checked':''} onchange="toggleEditPersonPC(${mv.id},${i})">
        <span>PC</span>
      </div>
      <button class="sock-del" onclick="removeEditMovePerson(${mv.id},${i})">Ã—</button>
    `;
    c.appendChild(d);
  });
}

function addEditMovePerson(mvid) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  const inp = document.getElementById('edit-move-person-input');
  const v = inp.value.trim(); if (!v) return;
  mv.people.push({name: v, needsPC: false});
  inp.value = '';
  renderEditMovePeople(mv);
  renderMovesList();
  updateStats();
}

function removeEditMovePerson(mvid, idx) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  mv.people.splice(idx, 1);
  renderEditMovePeople(mv);
  renderMovesList();
  updateStats();
}

function toggleEditPersonPC(mvid, idx) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  mv.people[idx].needsPC = !mv.people[idx].needsPC;
  updateStats();
}

function saveMove(mvid) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  mv.name = document.getElementById('edit-move-name')?.value.trim() || '';
  mv.date = document.getElementById('edit-move-date').value;
  renderMovesList();
  renderCanvas();
  updateStats();
  notify('DÃ©mÃ©nagement mis Ã  jour.');
}

function deleteMove(mvid) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  showConfirmModal('Supprimer ce dÃ©mÃ©nagement ?', '', () => {
    f.moves = f.moves.filter(x => x.id !== mvid);
    renderCanvas(); renderMovesList(); updateStats();
    notify('DÃ©mÃ©nagement supprimÃ©.');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMAGE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupImageUpload() {
  const dz = document.getElementById('drop-zone');
  const card = document.getElementById('dz-card');

  card.onclick = () => {
    const inp = document.createElement('input');
    inp.type = 'file'; inp.accept = 'image/*,.pdf,application/pdf,.json,application/json';
    inp.onchange = e => { if (e.target.files[0]) handleDropZoneFile(e.target.files[0]); };
    inp.click();
  };

  dz.ondragover = e => { e.preventDefault(); card.classList.add('over'); };
  dz.ondragleave = () => card.classList.remove('over');
  dz.ondrop = e => {
    e.preventDefault();
    card.classList.remove('over');
    if (e.dataTransfer.files[0]) handleDropZoneFile(e.dataTransfer.files[0]);
  };
}

function handleDropZoneFile(file) {
  // Si c'est un fichier JSON, importer directement comme projet
  if (file.type === 'application/json' || file.name.toLowerCase().endsWith('.json')) {
    // Simuler l'event pour rÃ©utiliser importJSON
    const fakeEvent = { target: { files: [file], value: '' } };
    importJSON(fakeEvent);
    return;
  }
  // Sinon traiter comme plan image/PDF
  handlePlanFile(file);
}

let _pendingPlanFile = null;

function handlePlanFile(file) {
  _pendingPlanFile = file;
  openModalFloor();
}

function loadImage(file) {
  const f = activeFloor(); if (!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      f.imageB64 = e.target.result;
      f.imageW = img.width;
      f.imageH = img.height;
      renderCanvas();
      notify('Plan chargÃ© !');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

async function loadPDF(file) {
  const f = activeFloor(); if (!f) return;
  notify('Chargement du PDF...');

  try {
    if (typeof pdfjsLib === 'undefined') {
      alert('PDF.js non chargÃ©. VÃ©rifiez votre connexion internet.');
      return;
    }
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const arrayBuffer = await file.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const numPages = pdfDoc.numPages;

    let pageNum = 1;
    if (numPages > 1) {
      const input = prompt(
        `Ce PDF contient ${numPages} page${numPages > 1 ? 's' : ''}.\nQuelle page voulez-vous utiliser ? (1â€“${numPages})`,
        '1'
      );
      pageNum = Math.max(1, Math.min(numPages, parseInt(input) || 1));
    }

    const page = await pdfDoc.getPage(pageNum);
    const scale = 2;
    const viewport = page.getViewport({ scale });

    const canvas = document.createElement('canvas');
    canvas.width  = viewport.width;
    canvas.height = viewport.height;
    const ctx = canvas.getContext('2d');

    await page.render({ canvasContext: ctx, viewport }).promise;

    f.imageB64 = canvas.toDataURL('image/png');
    f.imageW   = canvas.width;
    f.imageH   = canvas.height;
    renderCanvas();
    notify(`PDF page ${pageNum}/${numPages} chargÃ© !`);

  } catch (err) {
    console.error('PDF load error:', err);
    alert('Erreur lors du chargement du PDF : ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getCanvasCoords(clientX, clientY) {
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (clientX - rect.left) / S.zoom;
  const y = (clientY - rect.top) / S.zoom;
  return {x, y};
}

// Returns coords relative to canvas-area (for ghost positioning)
function getScreenCoords(clientX, clientY) {
  const areaRect = document.getElementById('canvas-area').getBoundingClientRect();
  return { sx: clientX - areaRect.left, sy: clientY - areaRect.top };
}

function setupDrawing() {
  const root = document.getElementById('canvas-root');
  const ghost = document.getElementById('draw-ghost');

  root.addEventListener('mousedown', e => {
    if (S.mode === 'edit-shape') {
      const target = e.target;
      
      // Check if clicking on a vertex point
      if (target.hasAttribute('data-anchor') && target.getAttribute('data-point-type') === 'vertex') {
        const anchor = parseInt(target.getAttribute('data-anchor'));
        S.editingShape.selectedPoint = anchor;
        const rect = document.getElementById('canvas-root').getBoundingClientRect();
        S.editingShape.startX = (e.clientX - rect.left) / S.zoom;
        S.editingShape.startY = (e.clientY - rect.top) / S.zoom;
        return;
      }
      
      // Midpoints are handled by their own click event
      
      // Check if clicking on a shape to select it
      if (target.hasAttribute('data-type')) {
        const type = target.getAttribute('data-type');
        const id = parseInt(target.getAttribute('data-id'));
        if (type === 'room' || type === 'meeting' || type === 'move') {
          selectShapeForEditing(type, id);
        }
        return;
      }
      
      return;
    }
    
    if (S.mode === 'draw') startDrawRoom(e);
    else if (S.mode === 'copier') placeCopier(e);
    else if (S.mode === 'printer') placePrinter(e);
    else if (S.mode === 'meeting') placeMeeting(e);
    else if (S.mode === 'move') startDrawMove(e);
    else if (S.mode === 'screen') placeScreen(e);
    else if (S.mode === 'techroom') startDrawTechroom(e);
    else if (S.mode === 'display') placeDisplay(e);
    else if (S.mode === 'socket') placeSocket(e);
    else if (S.mode === 'projector') placeProjector(e);
    else if (S.mode === 'plotter') placePlotter(e);
    else if (S.mode === 'freezone') startDrawFreezone(e);
  });

  root.addEventListener('mousemove', e => {
    if (S.mode === 'edit-shape' && S.editingShape?.selectedPoint !== null && S.editingShape?.selectedPoint !== undefined) {
      const rect = document.getElementById('canvas-root').getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / S.zoom;
      const mouseY = (e.clientY - rect.top) / S.zoom;
      
      const item = getEditableItem(S.editingShape.type, S.editingShape.id);
      if (!item || !item.points) return;
      
      const pointIdx = S.editingShape.selectedPoint;
      if (pointIdx >= 0 && pointIdx < item.points.length) {
        item.points[pointIdx].x = mouseX;
        item.points[pointIdx].y = mouseY;
        renderCanvas();
      }
      return;
    }
    
    if (S.mode === 'draw' && S.drawing) continueDrawRoom(e);
    else if (S.mode === 'meeting' && S.drawing) continueDrawMeeting(e);
    else if (S.mode === 'move' && S.drawing) continueDrawMove(e);
    else if (S.mode === 'techroom' && S.drawing) continueDrawTechroom(e);
    else if (S.mode === 'freezone' && S.drawing) continueDrawFreezone(e);
  });

  root.addEventListener('mouseup', e => {
    if (S.mode === 'edit-shape' && S.editingShape?.selectedPoint !== null && S.editingShape?.selectedPoint !== undefined) {
      S.editingShape.selectedPoint = null;
      notify('Point dÃ©placÃ© !');
      return;
    }
    
    if (S.mode === 'draw' && S.drawing) endDrawRoom(e);
    else if (S.mode === 'meeting' && S.drawing) endDrawMeeting(e);
    else if (S.mode === 'move' && S.drawing) endDrawMove(e);
    else if (S.mode === 'techroom' && S.drawing) endDrawTechroom(e);
    else if (S.mode === 'freezone' && S.drawing) endDrawFreezone(e);
  });
}

function startDrawRoom(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  S.drawing = {x0:x, y0:y, sx0:sx, sy0:sy};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = sx+'px';
  ghost.style.top = sy+'px';
  ghost.style.width = '0px';
  ghost.style.height = '0px';
}

function continueDrawRoom(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.left = Math.min(sx, S.drawing.sx0)+'px';
  ghost.style.top  = Math.min(sy, S.drawing.sy0)+'px';
  ghost.style.width  = (Math.abs(sx - S.drawing.sx0))+'px';
  ghost.style.height = (Math.abs(sy - S.drawing.sy0))+'px';
}

function endDrawRoom(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  
  document.getElementById('draw-ghost').style.display = 'none';
  S.drawing = null;

  if (w < 10 || h < 10) return;

  S.tempRoom = {x:l, y:t, w, h};
  openModalRoom();
}

function placeCopier(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  S.tempCopierPos = {x, y};
  openModalCopier();
}

function placePrinter(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  S.tempPrinterPos = {x, y};
  openModalPrinter();
}

function placeMeeting(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  S.drawing = {x0:x, y0:y, sx0:sx, sy0:sy};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = sx+'px';
  ghost.style.top = sy+'px';
  ghost.style.width = '0px';
  ghost.style.height = '0px';
  ghost.style.borderColor = '#3ddc97';
  ghost.style.background = 'rgba(61,220,151,.08)';
}

function startDrawMove(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  S.drawing = {x0:x, y0:y, sx0:sx, sy0:sy};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = sx+'px';
  ghost.style.top = sy+'px';
  ghost.style.width = '0px';
  ghost.style.height = '0px';
  ghost.style.borderColor = 'var(--accent2)';
  ghost.style.borderStyle = 'dashed';
  ghost.style.background = 'rgba(0,229,204,.08)';
}

function continueDrawMeeting(e) {
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.left = Math.min(sx, S.drawing.sx0)+'px';
  ghost.style.top  = Math.min(sy, S.drawing.sy0)+'px';
  ghost.style.width  = Math.abs(sx - S.drawing.sx0)+'px';
  ghost.style.height = Math.abs(sy - S.drawing.sy0)+'px';
}

function endDrawMeeting(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'none';
  ghost.style.borderColor = 'var(--accent2)';
  ghost.style.borderStyle = 'solid';
  ghost.style.background = 'rgba(0,229,204,.08)';
  S.drawing = null;

  if (w < 10 || h < 10) return;

  S.tempMeetingPos = {x:l, y:t, w, h};
  openModalMeeting();
}

function continueDrawMove(e) {
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.left = Math.min(sx, S.drawing.sx0)+'px';
  ghost.style.top  = Math.min(sy, S.drawing.sy0)+'px';
  ghost.style.width  = Math.abs(sx - S.drawing.sx0)+'px';
  ghost.style.height = Math.abs(sy - S.drawing.sy0)+'px';
}

function endDrawMove(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'none';
  ghost.style.borderColor = 'var(--accent2)';
  ghost.style.borderStyle = 'solid';
  S.drawing = null;

  if (w < 10 || h < 10) return;

  S.tempMovePos = {x:l, y:t, w, h};
  S.tempMove = {people: []};
  openModalMove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ZOOM & PAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyTransform() {
  const root = document.getElementById('canvas-root');
  root.style.transform = `scale(${S.zoom}) translate(${S.pan.x}px, ${S.pan.y}px)`;
  document.getElementById('zpct').textContent = Math.round(S.zoom*100)+'%';
}

function zoomIn() { S.zoom = Math.min(S.zoom*1.2, 5); applyTransform(); }
function zoomOut() { S.zoom = Math.max(S.zoom/1.2, 0.2); applyTransform(); }
function zoomReset() { S.zoom=1; S.pan={x:0,y:0}; applyTransform(); }
function zoomFit() {
  const f = activeFloor();
  if (!f || !f.imageW || !f.imageH) { zoomReset(); return; }
  const area = document.getElementById('canvas-area');
  const aw = area.clientWidth - 32;
  const ah = area.clientHeight - 32;
  const scaleX = aw / f.imageW;
  const scaleY = ah / f.imageH;
  S.zoom = Math.min(scaleX, scaleY, 1);
  S.pan = {x: (aw/S.zoom - f.imageW)/2, y: (ah/S.zoom - f.imageH)/2};
  applyTransform();
}

function setupPan() {
  const area = document.getElementById('canvas-area');
  let dragging = false, ox, oy;

  area.addEventListener('mousedown', e => {
    // Check if clicking on an element to drag â€” only in drag-elements mode
    const target = e.target;
    if (S.mode === 'drag-elements' && target.hasAttribute && (target.hasAttribute('data-type') || target.parentElement?.hasAttribute('data-type'))) {
      const elem = target.hasAttribute('data-type') ? target : target.parentElement;
      const type = elem.getAttribute('data-type');
      const id = parseInt(elem.getAttribute('data-id'));
      
      e.stopPropagation();
      const f = activeFloor();
      if (!f) return;
      
      const rect = document.getElementById('canvas-root').getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / S.zoom;
      const mouseY = (e.clientY - rect.top) / S.zoom;
      
      let item = null;
      if (type === 'room') item = f.rooms.find(r => r.id === id);
      else if (type === 'copier') item = f.copiers.find(c => c.id === id);
      else if (type === 'printer') item = f.printers.find(p => p.id === id);
      else if (type === 'meeting') item = f.meetings.find(m => m.id === id);
      else if (type === 'move') item = f.moves.find(m => m.id === id);
      else if (type === 'screen') item = (f.screens||[]).find(s => s.id === id);
      else if (type === 'techroom') item = (f.techrooms||[]).find(t => t.id === id);
      else if (type === 'display') item = (f.displays||[]).find(d => d.id === id);
      else if (type === 'socket') item = (f.sockets||[]).find(s => s.id === id);
      else if (type === 'projector') item = (f.projectors||[]).find(p => p.id === id);
      else if (type === 'plotter') item = (f.plotters||[]).find(p => p.id === id);
      else if (type === 'freezone') item = (f.freezones||[]).find(z => z.id === id);
      
      if (item) {
        S.dragging = {
          type,
          id,
          startX: mouseX,
          startY: mouseY,
          origX: item.x,
          origY: item.y
        };
        area.style.cursor = 'grabbing';
      }
      return;
    }
    
    // Panning â€” works in nav AND drag-elements modes (on empty space)
    if (S.mode !== 'nav' && S.mode !== 'drag-elements') return;
    dragging = true; 
    ox = e.clientX - S.pan.x; 
    oy = e.clientY - S.pan.y;
    area.style.cursor = 'grabbing';
  });

  area.addEventListener('mousemove', e => {
    if (S.dragging) {
      const f = activeFloor();
      if (!f) return;
      
      const rect = document.getElementById('canvas-root').getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / S.zoom;
      const mouseY = (e.clientY - rect.top) / S.zoom;
      
      const dx = mouseX - S.dragging.startX;
      const dy = mouseY - S.dragging.startY;
      
      let item = null;
      const t = S.dragging.type;
      if (t === 'room') item = f.rooms.find(r => r.id === S.dragging.id);
      else if (t === 'copier') item = f.copiers.find(c => c.id === S.dragging.id);
      else if (t === 'printer') item = f.printers.find(p => p.id === S.dragging.id);
      else if (t === 'meeting') item = f.meetings.find(m => m.id === S.dragging.id);
      else if (t === 'move') item = f.moves.find(m => m.id === S.dragging.id);
      else if (t === 'screen') item = (f.screens||[]).find(s => s.id === S.dragging.id);
      else if (t === 'techroom') item = (f.techrooms||[]).find(t => t.id === S.dragging.id);
      else if (t === 'display') item = (f.displays||[]).find(d => d.id === S.dragging.id);
      else if (t === 'socket') item = (f.sockets||[]).find(s => s.id === S.dragging.id);
      else if (t === 'projector') item = (f.projectors||[]).find(p => p.id === S.dragging.id);
      else if (t === 'plotter') item = (f.plotters||[]).find(p => p.id === S.dragging.id);
      else if (t === 'freezone') item = (f.freezones||[]).find(z => z.id === S.dragging.id);
      
      if (item) {
        // Pour les Ã©lÃ©ments avec points (polygones), dÃ©placer tous les points
        if (item.points && item.points.length > 0 && !S.dragging.origPoints) {
          S.dragging.origPoints = item.points.map(p => ({x: p.x, y: p.y}));
        }
        if (S.dragging.origPoints) {
          item.points.forEach((p, i) => {
            p.x = S.dragging.origPoints[i].x + dx;
            p.y = S.dragging.origPoints[i].y + dy;
          });
        }
        // Pour les Ã©lÃ©ments ponctuels (copier, printer, screen, display, socket)
        if (item.x !== undefined) {
          item.x = S.dragging.origX + dx;
          item.y = S.dragging.origY + dy;
        }
        renderCanvas();
      }
      return;
    }
    
    if (dragging) {
      S.pan.x = e.clientX - ox;
      S.pan.y = e.clientY - oy;
      applyTransform();
    }
    const rect = document.getElementById('canvas-root').getBoundingClientRect();
    const x = Math.round((e.clientX - rect.left) / S.zoom);
    const y = Math.round((e.clientY - rect.top) / S.zoom);
    document.getElementById('coords').textContent = `x:${x} y:${y}`;
  });

  area.addEventListener('mouseup', () => {
    if (S.dragging) {
      S.dragging = null;
      area.style.cursor = '';
      notify('Ã‰lÃ©ment dÃ©placÃ© !');
    }
    if (dragging) { 
      dragging = false; 
      area.style.cursor = ''; 
    }
  });

  area.addEventListener('wheel', e => {
    e.preventDefault();
    if (e.deltaY < 0) zoomIn(); else zoomOut();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModalRoom() {
  document.getElementById('modal-room-name').value = '';
  document.getElementById('modal-room-sockets').value = '';
  document.getElementById('modal-room-notes').value = '';
  const retiredCb = document.getElementById('modal-room-retired');
  if (retiredCb) retiredCb.checked = false;
  S._tempRoomPeople = [];
  renderModalRoomPeople();
  document.getElementById('modal-room').classList.add('on');
  setTimeout(() => { const i = document.getElementById('modal-room-name'); i.focus(); }, 60);
  document.getElementById('modal-room-person-input').onkeydown = e => { if (e.key==='Enter') addRoomPerson(); };
}
function confirmRoom() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-room-name').value.trim();
  const retired = document.getElementById('modal-room-retired')?.checked || false;
  const retiredDate = retired ? (document.getElementById('modal-room-retireddate')?.value || '') : '';
  const customColor = document.getElementById('modal-room-color')?.value || '';
  const socketNums = document.getElementById('modal-room-sockets').value.trim();
  const notes = document.getElementById('modal-room-notes').value.trim();
  const r = {
    id: _id++, 
    name,
    retired,
    retiredDate,
    customColor,
    people: [...(S._tempRoomPeople || [])],
    socketNums: socketNums,
    notes: notes, 
    x: S.tempRoom.x, 
    y: S.tempRoom.y, 
    w: S.tempRoom.w, 
    h: S.tempRoom.h,
    points: [
      {x: S.tempRoom.x, y: S.tempRoom.y},
      {x: S.tempRoom.x + S.tempRoom.w, y: S.tempRoom.y},
      {x: S.tempRoom.x + S.tempRoom.w, y: S.tempRoom.y + S.tempRoom.h},
      {x: S.tempRoom.x, y: S.tempRoom.y + S.tempRoom.h}
    ],
    sockets: []
  };
  f.rooms.push(r);
  document.getElementById('modal-room').classList.remove('on');
  S.tempRoom = null;
  renderCanvas();
  renderRoomsList();
  updateStats();
  notify(`Bureau "${name||'sans nom'}" crÃ©Ã© !`);
}
function cancelRoom() { document.getElementById('modal-room').classList.remove('on'); S.tempRoom = null; S._tempRoomPeople = []; }

// Room people helpers
function renderModalRoomPeople() {
  const c = document.getElementById('modal-room-people');
  if (!c) return;
  c.innerHTML = '';
  if (!S._tempRoomPeople || S._tempRoomPeople.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune personne</div>';
    return;
  }
  S._tempRoomPeople.forEach((p,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `<div class="move-person-name">${esc(p)}</div><button class="sock-del" onclick="removeRoomPerson(${i})">Ã—</button>`;
    c.appendChild(d);
  });
}
function addRoomPerson() {
  const inp = document.getElementById('modal-room-person-input');
  const v = inp.value.trim(); if (!v) return;
  if (!S._tempRoomPeople) S._tempRoomPeople = [];
  S._tempRoomPeople.push(v);
  inp.value = '';
  renderModalRoomPeople();
}
function removeRoomPerson(idx) {
  S._tempRoomPeople.splice(idx, 1);
  renderModalRoomPeople();
}

function openModalCopier() {
  document.getElementById('modal-copier-name').value = '';
  document.getElementById('modal-copier-network').value = '';
  document.getElementById('modal-copier').classList.add('on');
  setTimeout(() => { document.getElementById('modal-copier-name').focus(); }, 60);
}
function confirmCopier() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-copier-name').value.trim();
  const network = document.getElementById('modal-copier-network').value.trim();
  const c = {id: _id++, name, network, customColor: document.getElementById('modal-copier-color').value, retired: document.getElementById('modal-copier-retired').checked, retiredDate: document.getElementById('modal-copier-retired').checked ? (document.getElementById('modal-copier-retireddate')?.value||'') : '', x:S.tempCopierPos.x, y:S.tempCopierPos.y};
  f.copiers.push(c);
  document.getElementById('modal-copier').classList.remove('on');
  S.tempCopierPos = null;
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify(`Copieur "${name||'sans nom'}" crÃ©Ã© !`);
}
function cancelCopier() { document.getElementById('modal-copier').classList.remove('on'); S.tempCopierPos = null; }

function openModalPrinter() {
  document.getElementById('modal-printer-name').value = '';
  document.getElementById('modal-printer-network').value = '';
  document.getElementById('modal-printer').classList.add('on');
  setTimeout(() => { document.getElementById('modal-printer-name').focus(); }, 60);
}
function confirmPrinter() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-printer-name').value.trim();
  const network = document.getElementById('modal-printer-network').value.trim();
  const p = {id: _id++, name, network, customColor: document.getElementById('modal-printer-color').value, retired: document.getElementById('modal-printer-retired').checked, retiredDate: document.getElementById('modal-printer-retired').checked ? (document.getElementById('modal-printer-retireddate')?.value||'') : '', x:S.tempPrinterPos.x, y:S.tempPrinterPos.y};
  f.printers.push(p);
  document.getElementById('modal-printer').classList.remove('on');
  S.tempPrinterPos = null;
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify(`Imprimante "${name||'sans nom'}" crÃ©Ã©e !`);
}
function cancelPrinter() { document.getElementById('modal-printer').classList.remove('on'); S.tempPrinterPos = null; }

function openModalMeeting() {
  document.getElementById('modal-meeting-name').value = '';
  document.getElementById('screen-tactile').checked = true;
  document.getElementById('modal-meeting-size').value = '55';
  document.getElementById('modal-meeting-capacity').value = '';
  document.getElementById('modal-meeting-mtr').checked = false;
  document.getElementById('modal-meeting-clickshare').checked = false;
  document.getElementById('modal-meeting-wepresent').checked = false;
  document.getElementById('modal-meeting').classList.add('on');
  setTimeout(() => { document.getElementById('modal-meeting-name').focus(); }, 60);
}
function confirmMeeting() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-meeting-name').value.trim();
  const capacity = parseInt(document.getElementById('modal-meeting-capacity').value) || 0;
  const screenType = document.querySelector('input[name="screen-type"]:checked').value;
  const screenSize = parseInt(document.getElementById('modal-meeting-size').value);
  const hasMTR = document.getElementById('modal-meeting-mtr').checked;
  const hasClickshare = document.getElementById('modal-meeting-clickshare').checked;
  const hasWepresent = document.getElementById('modal-meeting-wepresent').checked;
  const meetingRetired = document.getElementById('modal-meeting-retired').checked;
  const meetingColor = document.getElementById('modal-meeting-color')?.value || '';
  const meetingRetiredDate = meetingRetired ? (document.getElementById('modal-meeting-retireddate')?.value||'') : '';
  const m = {
    id: _id++, 
    name, 
    retired: meetingRetired,
    retiredDate: meetingRetiredDate,
    customColor: meetingColor,
    capacity,
    screenType, 
    screenSize, 
    hasMTR,
    hasClickshare,
    hasWepresent,
    x: S.tempMeetingPos.x, 
    y: S.tempMeetingPos.y,
    w: S.tempMeetingPos.w,
    h: S.tempMeetingPos.h,
    points: [
      {x: S.tempMeetingPos.x, y: S.tempMeetingPos.y},
      {x: S.tempMeetingPos.x + S.tempMeetingPos.w, y: S.tempMeetingPos.y},
      {x: S.tempMeetingPos.x + S.tempMeetingPos.w, y: S.tempMeetingPos.y + S.tempMeetingPos.h},
      {x: S.tempMeetingPos.x, y: S.tempMeetingPos.y + S.tempMeetingPos.h}
    ]
  };
  f.meetings.push(m);
  document.getElementById('modal-meeting').classList.remove('on');
  S.tempMeetingPos = null;
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify(`Salle de rÃ©union "${name||'sans nom'}" crÃ©Ã©e !`);
}
function cancelMeeting() { document.getElementById('modal-meeting').classList.remove('on'); S.tempMeetingPos = null; }

function openModalMove() {
  document.getElementById('modal-move-name').value = '';
  document.getElementById('modal-move-date').value = '';
  document.getElementById('modal-move-people').innerHTML = '';
  S.tempMove.people = [];
  document.getElementById('modal-move').classList.add('on');
  setTimeout(() => { document.getElementById('modal-move-date').focus(); }, 60);
}
function confirmMove() {
  const f = activeFloor(); if (!f) return;
  const date = document.getElementById('modal-move-date').value;
  const moveName = document.getElementById('modal-move-name').value.trim();
  const mv = {
    id: _id++,
    name: moveName,
    date,
    retired: document.getElementById('modal-move-retired')?.checked || false,
    retiredDate: document.getElementById('modal-move-retired')?.checked ? (document.getElementById('modal-move-retireddate')?.value||'') : '',
    customColor: document.getElementById('modal-move-color')?.value || '',
    people: S.tempMove.people,
    x: S.tempMovePos.x,
    y: S.tempMovePos.y,
    w: S.tempMovePos.w,
    h: S.tempMovePos.h,
    points: [
      {x: S.tempMovePos.x, y: S.tempMovePos.y},
      {x: S.tempMovePos.x + S.tempMovePos.w, y: S.tempMovePos.y},
      {x: S.tempMovePos.x + S.tempMovePos.w, y: S.tempMovePos.y + S.tempMovePos.h},
      {x: S.tempMovePos.x, y: S.tempMovePos.y + S.tempMovePos.h}
    ]
  };
  f.moves.push(mv);
  document.getElementById('modal-move').classList.remove('on');
  S.tempMovePos = null;
  S.tempMove = {people: []};
  renderCanvas();
  renderMovesList();
  updateStats();
  notify('DÃ©mÃ©nagement crÃ©Ã© !');
}
function cancelMove() { 
  document.getElementById('modal-move').classList.remove('on'); 
  S.tempMovePos = null;
  S.tempMove = {people: []};
}

function renderModalMovePeople() {
  const c = document.getElementById('modal-move-people');
  c.innerHTML = '';
  if (S.tempMove.people.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune personne</div>';
    return;
  }
  S.tempMove.people.forEach((p,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `
      <div class="move-person-name">${esc(p.name)}</div>
      <div class="move-person-pc">
        <input type="checkbox" ${p.needsPC?'checked':''} onchange="toggleMovePerson(${i})">
        <span>PC</span>
      </div>
      <button class="sock-del" onclick="removeMovePerson(${i})">Ã—</button>
    `;
    c.appendChild(d);
  });
}

function addMovePerson() {
  const inp = document.getElementById('modal-move-person-input');
  const v = inp.value.trim(); if (!v) return;
  S.tempMove.people.push({name: v, needsPC: false});
  inp.value = '';
  renderModalMovePeople();
}

function removeMovePerson(idx) {
  S.tempMove.people.splice(idx, 1);
  renderModalMovePeople();
}

function toggleMovePerson(idx) {
  S.tempMove.people[idx].needsPC = !S.tempMove.people[idx].needsPC;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCATIONS MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLocationsModal() {
  renderLocationsList();
  document.getElementById('modal-locations').classList.add('on');
  setTimeout(() => { document.getElementById('location-input').focus(); }, 60);
}

function closeLocationsModal() {
  document.getElementById('modal-locations').classList.remove('on');
}

function renderLocationsList() {
  const list = document.getElementById('locations-list');
  list.innerHTML = '';
  
  if (S.locations.length === 0) {
    list.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;padding:10px;">Aucun lieu dÃ©fini</div>';
    return;
  }
  
  S.locations.forEach((loc, i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.style.marginBottom = '5px';
    d.innerHTML = `
      <div class="move-person-name" style="flex:1;">${esc(loc)}</div>
      <button class="sock-del" onclick="removeLocation(${i})">Ã—</button>
    `;
    list.appendChild(d);
  });
}

function addLocation() {
  const inp = document.getElementById('location-input');
  const v = inp.value.trim();
  if (!v) return;
  if (S.locations.includes(v)) {
    notify('Ce lieu existe dÃ©jÃ  !');
    return;
  }
  S.locations.push(v);
  inp.value = '';
  renderLocationsList();
  notify(`Lieu "${v}" ajoutÃ© !`);
}

function removeLocation(idx) {
  const loc = S.locations[idx];
  showConfirmModal(`Supprimer le lieu "${loc}" ?`, '', () => {
    S.locations.splice(idx, 1);
    renderLocationsList();
    notify(`Lieu "${loc}" supprimÃ©.`);
  });
}

function openModalFloor() {
  const selSite = document.getElementById('modal-floor-site');
  const selLevel = document.getElementById('modal-floor-level');
  const selSubSite = document.getElementById('modal-floor-subsite');
  const subSiteGroup = document.getElementById('modal-floor-subsite-group');
  
  // Remplir les sites
  selSite.innerHTML = '<option value="">-- Choisir un site --</option>';
  S.locations.forEach(loc => {
    const opt = document.createElement('option');
    opt.value = loc;
    opt.textContent = loc;
    selSite.appendChild(opt);
  });
  
  // Remplir les sous-sites COM
  selSubSite.innerHTML = '<option value="">-- Choisir un sous-site --</option>';
  S.comSubSites.forEach(sub => {
    const opt = document.createElement('option');
    opt.value = sub;
    opt.textContent = sub;
    selSubSite.appendChild(opt);
  });
  
  // Fonction pour remplir les niveaux selon le site/sous-site
  const fillLevels = () => {
    const site = selSite.value;
    const subSite = selSubSite.value;
    
    selLevel.innerHTML = '<option value="">-- Choisir un Ã©tage --</option>';
    
    // Sites avec niveaux restreints (Sous-sol, RDC, 1er, 2Ã¨me)
    const restrictedSites = ['Pfaffenhoffen','Haguenau','Rittershoffen','Reichshoffen','Soultz-sous-ForÃªts','Molsheim','Huningue','Erstein','Planigy'];
    const restrictedLevels = ['Sous-sol', 'RDC', '1er', '2Ã¨me'];
    
    let levels = S.floorLevels;
    
    if (restrictedSites.includes(site)) {
      levels = restrictedLevels;
    }
    // Si COM avec sous-site sÃ©lectionnÃ©, utiliser les niveaux spÃ©cifiques
    else if (site === 'COM' && subSite && S.comSubSiteLevels[subSite]) {
      levels = S.comSubSiteLevels[subSite];
    }
    
    levels.forEach(lvl => {
      const opt = document.createElement('option');
      opt.value = lvl;
      opt.textContent = lvl;
      selLevel.appendChild(opt);
    });
  };
  
  // Afficher/masquer le sous-site selon le site sÃ©lectionnÃ©
  selSite.onchange = () => {
    if (selSite.value === 'COM') {
      subSiteGroup.style.display = 'block';
      selSubSite.value = '';
      selLevel.innerHTML = '<option value="">-- Choisir un Ã©tage --</option>';
    } else {
      subSiteGroup.style.display = 'none';
      selSubSite.value = '';
      fillLevels();
    }
  };
  
  // Remplir les niveaux quand le sous-site change
  selSubSite.onchange = fillLevels;
  
  fillLevels();
  subSiteGroup.style.display = 'none';
  document.getElementById('modal-floor').classList.add('on');
  setTimeout(() => selSite.focus(), 60);
}

function confirmFloor() {
  const site = document.getElementById('modal-floor-site').value.trim();
  const level = document.getElementById('modal-floor-level').value.trim();
  const subSite = site === 'COM' ? document.getElementById('modal-floor-subsite').value.trim() : '';
  
  if (!site || !level) {
    notify('Veuillez sÃ©lectionner un site et un Ã©tage.');
    return;
  }
  
  if (site === 'COM' && !subSite) {
    notify('Veuillez sÃ©lectionner un sous-site pour le COM.');
    return;
  }
  
  document.getElementById('modal-floor').classList.remove('on');
  addFloor(site, level, subSite);
  const fullName = subSite ? `${site} - ${subSite} - ${level}` : `${site} - ${level}`;
  notify(`Ã‰tage "${fullName}" crÃ©Ã© !`);
  
  // Charger le fichier plan si prÃ©sent
  if (_pendingPlanFile) {
    const file = _pendingPlanFile;
    _pendingPlanFile = null;
    if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
      loadPDF(file);
    } else {
      loadImage(file);
    }
  }
}

function cancelFloor() { 
  document.getElementById('modal-floor').classList.remove('on');
  _pendingPlanFile = null;
}

document.addEventListener('keydown', e => {
  if (e.key==='Escape') { 
    cancelRoom(); cancelFloor(); cancelCopier(); cancelPrinter();
    cancelMeeting(); cancelMove(); closeLocationsModal();
    cancelScreen(); cancelTechroom(); cancelDisplay(); cancelSocket(); cancelProjector(); cancelPlotter(); cancelFreezone(); closeExportModal(); closeConfirmModal();
  }
});

['modal-room','modal-floor','modal-copier','modal-printer','modal-meeting','modal-move','modal-locations','modal-screen','modal-techroom','modal-display','modal-socket','modal-projector','modal-plotter','modal-freezone','modal-export'].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('click', e => {
    if (e.target === e.currentTarget) {
      if (id==='modal-room') cancelRoom();
      else if (id==='modal-floor') cancelFloor();
      else if (id==='modal-copier') cancelCopier();
      else if (id==='modal-printer') cancelPrinter();
      else if (id==='modal-meeting') cancelMeeting();
      else if (id==='modal-move') cancelMove();
      else if (id==='modal-locations') closeLocationsModal();
      else if (id==='modal-screen') cancelScreen();
      else if (id==='modal-techroom') cancelTechroom();
      else if (id==='modal-display') cancelDisplay();
      else if (id==='modal-freezone') cancelFreezone();
    }
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL CONFIRMATION (remplace window.confirm bloquÃ© en iframe)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _confirmCallback = null;
function showConfirmModal(title, body, onConfirm) {
  document.getElementById('confirm-title').textContent = title;
  const bd = document.getElementById('confirm-body');
  bd.textContent = body;
  bd.style.display = body ? 'block' : 'none';
  _confirmCallback = onConfirm;
  document.getElementById('modal-confirm').classList.add('on');
}
function closeConfirmModal() {
  document.getElementById('modal-confirm').classList.remove('on');
  _confirmCallback = null;
}
function doConfirm() {
  const cb = _confirmCallback;
  closeConfirmModal();
  if (cb) cb();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOOLTIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RETIRED COLOR HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RETIRED_COLOR = '#8b1a1a';
const SEARCH_HIGHLIGHT_COLOR = '#ff9800';

function onPlanSearch(val) {
  S._searchQuery = val.trim().toLowerCase();
  renderCanvas();
}

// Check if an item matches the search query
function matchesSearch(item) {
  if (!S._searchQuery) return false;
  const q = S._searchQuery;
  // Flatten people: can be strings or {name} objects
  const ppl = (item.people || []).map(p => typeof p === 'object' ? p.name : p).filter(Boolean);
  const fields = [
    item.name, item.network, item.brand, item.desc,
    item.socketNums, item.notes, item.date,
    item.screenType, item.screenSize, item.capacity,
    item.color, item.icon,
    ...ppl,
    ...(item.outlets || []),
  ].filter(v => v != null);
  return fields.some(f => String(f).toLowerCase().includes(q));
}
function getItemColor(item, baseColor) {
  return item.retired ? RETIRED_COLOR : baseColor;
}
// Colorize all stroke/fill in an SVG group
function colorizeGroup(g, color, origColor) {
  g.querySelectorAll('*').forEach(el => {
    if (el.getAttribute('stroke') === origColor) el.setAttribute('stroke', color);
    if (el.getAttribute('fill') === origColor) el.setAttribute('fill', color);
  });
}
// Apply iconSize scale to a resource SVG group
function applyIconScale(iconG, item, cx, cy) {
  const sz = (item.iconSize || 22) / 22;
  if (sz !== 1) {
    iconG.setAttribute('transform', `translate(${cx},${cy}) scale(${sz}) translate(${-cx},${-cy})`);
  }
}

// Unified resource SVG renderer: circle + icon + label + resize
function renderResourceSVG(svg, item, type, baseColor, editFn, floorName, drawIconFn) {
  const sz = (item.iconSize || 22) / 22;
  const r = Math.round(20 * sz);
  const effectiveBase = item.customColor || baseColor;
  const clr = matchesSearch(item) ? SEARCH_HIGHLIGHT_COLOR : item.retired ? RETIRED_COLOR : effectiveBase;
  
  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.style.cursor = 'pointer';
  g.setAttribute('data-type', type);
  g.setAttribute('data-id', item.id);
  g.addEventListener('click', e => { e.stopPropagation(); editFn(item); });
  g.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, type, item, floorName));
  g.addEventListener('mouseleave', hideTT);
  
  // Circle outline
  const circ = document.createElementNS('http://www.w3.org/2000/svg','circle');
  circ.setAttribute('cx', item.x); circ.setAttribute('cy', item.y);
  circ.setAttribute('r', r);
  circ.setAttribute('fill', clr); circ.setAttribute('fill-opacity', matchesSearch(item) ? '0.45' : '0.15');
  circ.setAttribute('stroke', clr); circ.setAttribute('stroke-width','2');
  g.appendChild(circ);
  
  // Icon content (drawn by callback)
  const icon = document.createElementNS('http://www.w3.org/2000/svg','g');
  icon.setAttribute('transform', `translate(${item.x},${item.y}) scale(${sz}) translate(${-item.x},${-item.y})`);
  icon.style.pointerEvents = 'none';
  drawIconFn(icon, item.x, item.y, clr);
  g.appendChild(icon);
  
  // Label badge
  const label = item.name || '';
  if (label) {
    const lbw = Math.max(70 * sz, 50);
    const badgeBg = document.createElementNS('http://www.w3.org/2000/svg','rect');
    badgeBg.setAttribute('x', item.x - lbw/2);
    badgeBg.setAttribute('y', item.y + r + 6);
    badgeBg.setAttribute('width', lbw); badgeBg.setAttribute('height','18');
    badgeBg.setAttribute('fill', clr); badgeBg.setAttribute('fill-opacity','0.9');
    badgeBg.setAttribute('rx','4');
    g.appendChild(badgeBg);
    
    const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
    lbl.setAttribute('x', item.x);
    lbl.setAttribute('y', item.y + r + 17);
    lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('dominant-baseline','middle');
    lbl.setAttribute('fill','#fff'); lbl.setAttribute('font-size','9'); lbl.setAttribute('font-weight','600');
    lbl.textContent = label.length > 14 ? label.substring(0,12)+'â€¦' : label;
    g.appendChild(lbl);
  }
  
  // RETIRÃ‰ badge
  if (item.retired) {
    const retLbl = document.createElementNS('http://www.w3.org/2000/svg','text');
    retLbl.setAttribute('x', item.x);
    retLbl.setAttribute('y', item.y - r - 4);
    retLbl.setAttribute('text-anchor','middle'); retLbl.setAttribute('dominant-baseline','middle');
    retLbl.setAttribute('fill','#ff4444'); retLbl.setAttribute('font-size','9'); retLbl.setAttribute('font-weight','900');
    retLbl.setAttribute('stroke','#000'); retLbl.setAttribute('stroke-width','2.5'); retLbl.setAttribute('paint-order','stroke');
    retLbl.textContent = 'â›” RetirÃ©(e)' + (item.retiredDate ? ' â€” ' + new Date(item.retiredDate).toLocaleDateString('fr-FR') : '');
    g.appendChild(retLbl);
  }
  
  // Scroll-to-resize on resource icons
  g.addEventListener('wheel', e => {
    e.preventDefault(); e.stopPropagation();
    const step = e.deltaY < 0 ? 2 : -2;
    item.iconSize = Math.max(10, Math.min(60, (item.iconSize || 22) + step));
    renderCanvas();
  });
  
  svg.appendChild(g);
}

// Icon drawing functions for each resource type
function drawCopierIcon(icon, cx, cy, clr) {
  const els = [
    {tag:'rect', a:{x:cx-10,y:cy-10,width:20,height:5,rx:1,fill:'none',stroke:clr,'stroke-width':1.5}},
    {tag:'rect', a:{x:cx-12,y:cy-4,width:24,height:8,rx:1,fill:'none',stroke:clr,'stroke-width':1.5}},
    {tag:'rect', a:{x:cx-10,y:cy+5,width:20,height:5,rx:1,fill:'none',stroke:clr,'stroke-width':1.5}},
    {tag:'line', a:{x1:cx-7,y1:cy-1,x2:cx+7,y2:cy-1,stroke:clr,'stroke-width':1.5}},
    {tag:'line', a:{x1:cx-7,y1:cy+1,x2:cx+7,y2:cy+1,stroke:clr,'stroke-width':1.5}},
  ];
  els.forEach(({tag, a}) => {
    const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    Object.entries(a).forEach(([k,v]) => el.setAttribute(k, v));
    icon.appendChild(el);
  });
}

function drawPrinterIcon(icon, cx, cy, clr) {
  const p1 = document.createElementNS('http://www.w3.org/2000/svg','path');
  p1.setAttribute('d', `M${cx-6} ${cy-8} L${cx-6} ${cy-4} L${cx+6} ${cy-4} L${cx+6} ${cy-8}`);
  p1.setAttribute('fill','none'); p1.setAttribute('stroke',clr); p1.setAttribute('stroke-width','1.5');
  p1.setAttribute('stroke-linecap','round'); p1.setAttribute('stroke-linejoin','round');
  icon.appendChild(p1);
  const body = document.createElementNS('http://www.w3.org/2000/svg','rect');
  body.setAttribute('x',cx-9); body.setAttribute('y',cy-4); body.setAttribute('width','18'); body.setAttribute('height','6');
  body.setAttribute('rx','1'); body.setAttribute('fill','none'); body.setAttribute('stroke',clr); body.setAttribute('stroke-width','1.5');
  icon.appendChild(body);
  const out = document.createElementNS('http://www.w3.org/2000/svg','rect');
  out.setAttribute('x',cx-6); out.setAttribute('y',cy+2); out.setAttribute('width','12'); out.setAttribute('height','6');
  out.setAttribute('rx','1'); out.setAttribute('fill','none'); out.setAttribute('stroke',clr); out.setAttribute('stroke-width','1.5');
  icon.appendChild(out);
  const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
  dot.setAttribute('cx',cx+5); dot.setAttribute('cy',cy-1); dot.setAttribute('r','1'); dot.setAttribute('fill',clr);
  icon.appendChild(dot);
}

function drawScreenIcon(icon, cx, cy, clr) {
  const scrn = document.createElementNS('http://www.w3.org/2000/svg','rect');
  scrn.setAttribute('x',cx-10); scrn.setAttribute('y',cy-9); scrn.setAttribute('width','20'); scrn.setAttribute('height','13');
  scrn.setAttribute('rx','2'); scrn.setAttribute('fill','none'); scrn.setAttribute('stroke',clr); scrn.setAttribute('stroke-width','1.5');
  icon.appendChild(scrn);
  const s1 = document.createElementNS('http://www.w3.org/2000/svg','line');
  s1.setAttribute('x1',cx); s1.setAttribute('y1',cy+4); s1.setAttribute('x2',cx); s1.setAttribute('y2',cy+8);
  s1.setAttribute('stroke',clr); s1.setAttribute('stroke-width','1.5');
  icon.appendChild(s1);
  const s2 = document.createElementNS('http://www.w3.org/2000/svg','line');
  s2.setAttribute('x1',cx-4); s2.setAttribute('y1',cy+8); s2.setAttribute('x2',cx+4); s2.setAttribute('y2',cy+8);
  s2.setAttribute('stroke',clr); s2.setAttribute('stroke-width','1.5');
  icon.appendChild(s2);
}

function drawDisplayIcon(icon, cx, cy, clr) {
  const tv = document.createElementNS('http://www.w3.org/2000/svg','rect');
  tv.setAttribute('x',cx-12); tv.setAttribute('y',cy-11); tv.setAttribute('width','24'); tv.setAttribute('height','16');
  tv.setAttribute('rx','2'); tv.setAttribute('fill','none'); tv.setAttribute('stroke',clr); tv.setAttribute('stroke-width','1.8');
  icon.appendChild(tv);
  [cy-5,cy-2,cy+1].forEach(yy => {
    const ln = document.createElementNS('http://www.w3.org/2000/svg','line');
    ln.setAttribute('x1',cx-7); ln.setAttribute('y1',yy); ln.setAttribute('x2',cx+5); ln.setAttribute('y2',yy);
    ln.setAttribute('stroke',clr); ln.setAttribute('stroke-width','1'); ln.setAttribute('stroke-opacity','0.6');
    icon.appendChild(ln);
  });
  const stand = document.createElementNS('http://www.w3.org/2000/svg','path');
  stand.setAttribute('d', `M${cx-3} ${cy+5} L${cx-3} ${cy+8} M${cx+3} ${cy+5} L${cx+3} ${cy+8} M${cx-6} ${cy+8} L${cx+6} ${cy+8}`);
  stand.setAttribute('fill','none'); stand.setAttribute('stroke',clr); stand.setAttribute('stroke-width','1.5'); stand.setAttribute('stroke-linecap','round');
  icon.appendChild(stand);
}

function drawSocketIcon(icon, cx, cy, clr) {
  const box = document.createElementNS('http://www.w3.org/2000/svg','rect');
  box.setAttribute('x',cx-8); box.setAttribute('y',cy-7); box.setAttribute('width','16'); box.setAttribute('height','14');
  box.setAttribute('rx','2'); box.setAttribute('fill','none'); box.setAttribute('stroke',clr); box.setAttribute('stroke-width','1.5');
  icon.appendChild(box);
  [{x:cx-4},{x:cx+2}].forEach(({x}) => {
    const hole = document.createElementNS('http://www.w3.org/2000/svg','rect');
    hole.setAttribute('x',x); hole.setAttribute('y',cy-2); hole.setAttribute('width','2'); hole.setAttribute('height','4');
    hole.setAttribute('fill',clr);
    icon.appendChild(hole);
  });
}

function drawProjectorIcon(icon, cx, cy, clr) {
  const body = document.createElementNS('http://www.w3.org/2000/svg','rect');
  body.setAttribute('x',cx-12); body.setAttribute('y',cy-7); body.setAttribute('width','24'); body.setAttribute('height','14');
  body.setAttribute('rx','2'); body.setAttribute('fill','none'); body.setAttribute('stroke',clr); body.setAttribute('stroke-width','1.8');
  icon.appendChild(body);
  const lens = document.createElementNS('http://www.w3.org/2000/svg','circle');
  lens.setAttribute('cx',cx+6); lens.setAttribute('cy',cy); lens.setAttribute('r','4');
  lens.setAttribute('fill','none'); lens.setAttribute('stroke',clr); lens.setAttribute('stroke-width','1.5');
  icon.appendChild(lens);
  const beam = document.createElementNS('http://www.w3.org/2000/svg','path');
  beam.setAttribute('d', `M${cx+10},${cy-2} L${cx+16},${cy-5} M${cx+10},${cy+2} L${cx+16},${cy+5}`);
  beam.setAttribute('stroke',clr); beam.setAttribute('stroke-width','1'); beam.setAttribute('stroke-dasharray','2,2');
  icon.appendChild(beam);
}

function drawPlotterIcon(icon, cx, cy, clr) {
  const body = document.createElementNS('http://www.w3.org/2000/svg','rect');
  body.setAttribute('x',cx-14); body.setAttribute('y',cy-8); body.setAttribute('width','28'); body.setAttribute('height','12');
  body.setAttribute('rx','2'); body.setAttribute('fill','none'); body.setAttribute('stroke',clr); body.setAttribute('stroke-width','1.8');
  icon.appendChild(body);
  const paper = document.createElementNS('http://www.w3.org/2000/svg','path');
  paper.setAttribute('d', `M${cx-10},${cy+4} L${cx-10},${cy+10} L${cx+10},${cy+10} L${cx+10},${cy+4}`);
  paper.setAttribute('fill','none'); paper.setAttribute('stroke',clr); paper.setAttribute('stroke-width','1.3');
  icon.appendChild(paper);
  const feed = document.createElementNS('http://www.w3.org/2000/svg','line');
  feed.setAttribute('x1',cx-10); feed.setAttribute('y1',cy-2); feed.setAttribute('x2',cx+10); feed.setAttribute('y2',cy-2);
  feed.setAttribute('stroke',clr); feed.setAttribute('stroke-width','1.2');
  icon.appendChild(feed);
  const btn = document.createElementNS('http://www.w3.org/2000/svg','circle');
  btn.setAttribute('cx',cx+10); btn.setAttribute('cy',cy-5); btn.setAttribute('r','1.2'); btn.setAttribute('fill',clr);
  icon.appendChild(btn);
}
const TYPE_META = {
  room:     { label:'Bureau',              color:'#4f8aff' },
  copier:   { label:'Copieur',             color:'#ff6b35' },
  printer:  { label:'Imprimante',          color:'#4f8aff' },
  meeting:  { label:'Salle de rÃ©union',    color:'#3ddc97' },
  move:     { label:'DÃ©mÃ©nagement',        color:'#00e5cc' },
  screen:   { label:'Ã‰cran',              color:'#9b87f5' },
  techroom: { label:'Local technique',     color:'#2196f3' },
  display:  { label:'Affichage dynamique', color:'#ffaa33' },
  socket:   { label:'Prises rÃ©seau',       color:'#00bfa5' },
  projector:{ label:'VidÃ©oprojecteur',    color:'#e066ff' },
  plotter:  { label:'Traceur',              color:'#00acc1' },
  freezone: { label:'Zone libre',          color:'#a78bfa' },
};

function buildTTRows(rows) {
  return rows.filter(r => r.val && String(r.val).trim()).map(r => {
    // Convertir les retours Ã  la ligne en <br>
    const valHtml = esc(String(r.val)).replace(/\n/g, '<br>');
    return `<div class="tt-row"><span class="tt-row-label">${r.label}</span><span class="tt-row-val">${valHtml}</span></div>`;
  }).join('');
}

function showTTGeneric(cx, cy, type, item, floorName) {
  const tt = document.getElementById('tt');
  const meta = TYPE_META[type] || { label: type, color: '#888' };
  let rows = '';

  if (type === 'room') {
    rows = buildTTRows([
      { label: 'Ã‰tage', val: floorName }
    ]);
  } else if (type === 'copier' || type === 'printer') {
    rows = buildTTRows([
      { label: 'Ã‰tage',   val: floorName },
      { label: 'RÃ©seau',  val: item.network }
    ]);
  } else if (type === 'meeting') {
    const screenLabel = `${(item.screenType==='tactile'?'Tactile':item.screenType==='videoprojecteur'?'VidÃ©oproj.':'Classique')} ${item.screenSize}"${item.hasMTR ? ' + MTR' : ''}${item.hasClickshare ? ' + CS' : ''}${item.hasWepresent ? ' + WP' : ''}`;
    rows = buildTTRows([
      { label: 'Ã‰tage',  val: floorName },
      { label: 'Ã‰cran',  val: screenLabel }
    ]);
  } else if (type === 'move') {
    const dateStr = item.date ? new Date(item.date).toLocaleDateString('fr-FR') : null;
    const pcCount = item.people?.filter(p => p.needsPC).length || 0;
    // Chaque personne sur sa propre ligne, avec ğŸ’» si PC
    const people = item.people?.length
      ? item.people.map(p => p.name + (p.needsPC ? ' ğŸ’»' : '')).join('\n')
      : null;
    rows = buildTTRows([
      { label: 'Ã‰tage',     val: floorName },
      { label: 'Date',      val: dateStr },
      { label: 'Personnes', val: item.people?.length ? `${item.people.length} personne${item.people.length>1?'s':''}${pcCount ? ` (${pcCount} PC)` : ''}` : null },
      { label: 'Noms',      val: people }
    ]);
  } else if (type === 'screen') {
    rows = buildTTRows([
      { label: 'Ã‰tage',   val: floorName },
      { label: 'Taille',  val: item.size ? item.size + ' pouces' : null },
      { label: 'Marque',  val: item.brand },
      { label: 'RÃ©seau',  val: item.network }
    ]);
  } else if (type === 'techroom') {
    rows = buildTTRows([
      { label: 'Ã‰tage',       val: floorName },
      { label: 'Description', val: item.desc }
    ]);
  } else if (type === 'display') {
    rows = buildTTRows([
      { label: 'Ã‰tage',    val: floorName },
      { label: 'Taille',   val: item.size ? item.size + ' pouces' : null },
      { label: 'Contenu',  val: item.content },
      { label: 'RÃ©seau',   val: item.network }
    ]);
  } else if (type === 'projector') {
    rows = buildTTRows([
      { label: 'Ã‰tage',       val: floorName },
      { label: 'Marque',      val: item.brand },
      { label: 'RÃ©solution',  val: item.resolution },
      { label: 'RÃ©seau',      val: item.network }
    ]);
  } else if (type === 'plotter') {
    rows = buildTTRows([
      { label: 'Ã‰tage',    val: floorName },
      { label: 'Marque',   val: item.brand },
      { label: 'Format',   val: item.format },
      { label: 'RÃ©seau',   val: item.network }
    ]);
  } else if (type === 'socket') {
    const outlets = item.outlets?.length 
      ? item.outlets.join('\n')
      : null;
    rows = buildTTRows([
      { label: 'Ã‰tage',  val: floorName },
      { label: 'Nombre', val: item.outlets?.length ? `${item.outlets.length} prise${item.outlets.length>1?'s':''}` : null },
      { label: 'DÃ©tails', val: outlets }
    ]);
  }

  tt.innerHTML = `
    <div class="tt-badge" style="background:${meta.color}22;color:${meta.color};border:1px solid ${meta.color}44;">${meta.label}</div>
    <div class="tt-name">${esc(item.name || '(sans nom)')}</div>
    ${rows ? `<div class="tt-divider"></div>${rows}` : ''}
  `;

  tt.classList.add('on');
  positionTT(tt, cx, cy);
}

function showTT(cx, cy, f, room) {
  showTTGeneric(cx, cy, 'room', room, f.name);
}

function positionTT(tt, cx, cy) {
  let lx = cx + 16, ly = cy + 16;
  tt.style.left = lx + 'px'; tt.style.top = ly + 'px';
  const r = tt.getBoundingClientRect();
  if (r.right > window.innerWidth - 10) lx = cx - r.width - 12;
  if (r.bottom > window.innerHeight - 10) ly = cy - r.height - 12;
  tt.style.left = lx + 'px'; tt.style.top = ly + 'px';
}

function hideTT() { document.getElementById('tt').classList.remove('on'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMode(m) {
  S.mode = m;
  ['nav','drag-elements','draw','edit-shape','copier','printer','meeting','move','screen','techroom','display','socket','projector','plotter'].forEach(mode => {
    const btn = document.getElementById('btn-'+mode);
    if (btn) btn.classList.toggle('active', m===mode);
  });
  document.getElementById('canvas-area').className = 'canvas-area mode-'+m;
  const modeLabels = {
    nav:'NAVIGATION', 'drag-elements':'DÃ‰PLACER Ã‰LÃ‰MENTS', draw:'TRACER BUREAU', 'edit-shape':'Ã‰DITER FORME',
    copier:'PLACER COPIEUR', printer:'PLACER IMPRIMANTE',
    meeting:'PLACER SALLE RÃ‰UNION', move:'ZONE DÃ‰MÃ‰NAGEMENT',
    screen:'PLACER Ã‰CRAN TV', techroom:'TRACER LOCAL TECHNIQUE', display:'PLACER Ã‰CRAN D\'INFORMATION',
    socket:'PLACER PRISES RÃ‰SEAU', projector:'PLACER VIDÃ‰OPROJECTEUR', plotter:'PLACER TRACEUR', freezone:'TRACER ZONE LIBRE'
  };
  document.getElementById('mode-chip').textContent = modeLabels[m] || 'NAVIGATION';
  if (m !== 'edit-shape') { S.editingShape = null; renderCanvas(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t) {
  ['list','edit','equip','move','stats'].forEach(n => {
    document.getElementById('tab-'+n).classList.toggle('on', n===t);
    document.getElementById('tab-'+n+'-btn').classList.toggle('on', n===t);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  document.getElementById('st-floors').textContent = S.floors.length;
  const totalR = S.floors.reduce((a,f) => a+f.rooms.length, 0);
  const totalC = S.floors.reduce((a,f) => a+f.copiers.length, 0);
  const totalP = S.floors.reduce((a,f) => a+f.printers.length, 0);
  const totalM = S.floors.reduce((a,f) => a+f.meetings.length, 0);
  
  document.getElementById('st-rooms').textContent = totalR;
  document.getElementById('st-copiers').textContent = totalC;
  document.getElementById('st-printers').textContent = totalP;
  document.getElementById('st-meetings').textContent = totalM;

  const det = document.getElementById('st-detail');
  det.innerHTML = '';
  S.floors.forEach(f => {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:10px 0 5px';
    h.textContent = f.name;
    det.appendChild(h);
    
    if (f.rooms.length === 0 && f.copiers.length === 0 && f.printers.length === 0 && f.meetings.length === 0) {
      const e = document.createElement('div');
      e.style.cssText = 'font-size:11px;color:var(--muted);font-style:italic;margin-bottom:6px;';
      e.textContent = 'Aucun Ã©lÃ©ment';
      det.appendChild(e);
    }
    
    f.rooms.forEach((r,i) => {
      const col = matchesSearch(r) ? SEARCH_HIGHLIGHT_COLOR : r.retired ? RETIRED_COLOR : (r.customColor || roomColor(f.id, i));
      const d = document.createElement('div');
      d.className = 'rli'; d.style.cursor='default';
      d.innerHTML = `
        <div class="rli-dot" style="background:${col}"></div>
        <div class="rli-name" style="font-size:12px">${esc(r.name||'(sans nom)')}</div>
      `;
      det.appendChild(d);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function placeScreen(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  S.tempScreenPos = {x:(e.clientX-rect.left)/S.zoom, y:(e.clientY-rect.top)/S.zoom};
  openModalScreen();
}
function openModalScreen() {
  document.getElementById('modal-screen-name').value = '';
  document.getElementById('modal-screen-size').value = '55';
  document.getElementById('modal-screen-network').value = '';
  document.getElementById('modal-screen-brand-custom').style.display = 'none';
  document.querySelectorAll('input[name="screen-brand"]')[0].checked = true;
  document.getElementById('modal-screen').classList.add('on');
  // Show/hide custom brand input
  document.querySelectorAll('input[name="screen-brand"]').forEach(r => {
    r.onchange = () => {
      document.getElementById('modal-screen-brand-custom').style.display =
        document.querySelector('input[name="screen-brand"]:checked').value === 'autre' ? 'block' : 'none';
    };
  });
  setTimeout(() => document.getElementById('modal-screen-name').focus(), 60);
}
function cancelScreen() { document.getElementById('modal-screen').classList.remove('on'); }
function confirmScreen() {
  const f = activeFloor(); if (!f) return;
  const brandVal = document.querySelector('input[name="screen-brand"]:checked').value;
  const brand = brandVal === 'autre'
    ? (document.getElementById('modal-screen-brand-custom').value.trim() || 'Autre')
    : brandVal;
  const sc = {
    id: _id++,
    name: document.getElementById('modal-screen-name').value.trim(),
    size: parseInt(document.getElementById('modal-screen-size').value),
    brand,
    network: document.getElementById('modal-screen-network').value.trim(),
    customColor: document.getElementById('modal-screen-color').value,
    retired: document.getElementById('modal-screen-retired').checked,
    retiredDate: document.getElementById('modal-screen-retired').checked ? (document.getElementById('modal-screen-retireddate')?.value||'') : '',
    x: S.tempScreenPos.x, y: S.tempScreenPos.y
  };
  if (!f.screens) f.screens = [];
  f.screens.push(sc);
  document.getElementById('modal-screen').classList.remove('on');
  S.tempScreenPos = null;
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Ã‰cran "${sc.name||sc.size+'"'}" crÃ©Ã© !`);
}
function editScreen(sc) {
  const ed = document.getElementById('tab-equip');
  const brandOptions = ['Samsung','NEC','Grundig','LG'].map(b =>
    `<label class="check-group"><input type="radio" name="edit-screen-brand" value="${b}" ${sc.brand===b?'checked':''}> ${b}</label>`
  ).join('');
  const isOther = !['Samsung','NEC','Grundig','LG'].includes(sc.brand);
  ed.innerHTML = `
    <div class="ed-title">Ã‰diter Ã©cran <button class="ed-close" onclick="renderEquipmentsList()">Ã—</button></div>
    <div class="fg"><label class="lb">Nom</label><input class="inp" id="edit-screen-name" value="${esc(sc.name||'')}"></div>
    <div class="fg"><label class="lb">Taille</label>
      <select class="sel" id="edit-screen-size">
        ${[49,55,65,75,98].map(s=>`<option value="${s}" ${sc.size===s?'selected':''}>${s} pouces</option>`).join('')}
      </select></div>
    <div class="fg"><label class="lb">Marque</label>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;">${brandOptions}
        <label class="check-group"><input type="radio" name="edit-screen-brand" value="autre" id="edit-screen-brand-autre" ${isOther?'checked':''}> Autre</label>
      </div>
      <input class="inp" id="edit-screen-brand-custom" placeholder="PrÃ©ciser..." style="display:${isOther?'block':'none'};margin-top:4px;" value="${isOther?esc(sc.brand):''}">
    </div>
    <div class="fg"><label class="lb">RÃ©seau</label><textarea class="txa" id="edit-screen-network">${esc(sc.network||'')}</textarea></div>
    
    <div class="fg"><label class="lb">Couleur</label>
      <input type="color" id="edit-sc-color" value="${sc.customColor||'#9b87f5'}" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    <div class="fg" style="background:rgba(139,26,26,0.08);border:1px solid rgba(139,26,26,0.2);border-radius:8px;padding:8px 10px;">
      <div class="check-group">
        <input type="checkbox" id="edit-sc-retired" onchange="document.getElementById('edit-sc-retireddate').parentElement.style.display=this.checked?'block':'none';document.getElementById('edit-sc-retired-msg').style.display=this.checked?'block':'none'" ${sc.retired?'checked':''}>
        <label for="edit-sc-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      </div>
      <div id="edit-sc-retired-msg" style="display:${sc.retired?'block':'none'};margin-top:4px;font-size:11px;color:#8b1a1a;font-style:italic;">Cet Ã©lÃ©ment a Ã©tÃ© retirÃ©</div>
      <div style="display:${sc.retired?'block':'none'};margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="edit-sc-retireddate" value="${sc.retiredDate||''}" style="max-width:180px;">
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveScreen(${sc.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteScreen(${sc.id})">Supprimer</button>
    </div>`;
  document.querySelectorAll('input[name="edit-screen-brand"]').forEach(r => {
    r.onchange = () => {
      document.getElementById('edit-screen-brand-custom').style.display =
        document.querySelector('input[name="edit-screen-brand"]:checked').value === 'autre' ? 'block' : 'none';
    };
  });
  switchTab('equip');
}
function saveScreen(sid) {
  const f = activeFloor(); if (!f) return;
  const sc = (f.screens||[]).find(s => s.id===sid); if (!sc) return;
  sc.name = document.getElementById('edit-screen-name').value.trim();
  sc.size = parseInt(document.getElementById('edit-screen-size').value);
  const bv = document.querySelector('input[name="edit-screen-brand"]:checked').value;
  sc.brand = bv==='autre' ? (document.getElementById('edit-screen-brand-custom').value.trim()||'Autre') : bv;
  sc.network = document.getElementById('edit-screen-network').value.trim();
  sc.customColor = document.getElementById('edit-sc-color')?.value || '';
  sc.retired = document.getElementById('edit-sc-retired')?.checked || false;
  sc.retiredDate = sc.retired ? (document.getElementById('edit-sc-retireddate')?.value||'') : '';
  renderEquipmentsList(); renderCanvas(); notify('Ã‰cran mis Ã  jour.');
}
function deleteScreen(sid) {
  const f = activeFloor(); if (!f) return;
  f.screens = (f.screens||[]).filter(s => s.id!==sid);
  renderEquipmentsList(); renderCanvas(); updateStats(); notify('Ã‰cran supprimÃ©.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TECH ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startDrawTechroom(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  S.drawing = {x0:x, y0:y, sx0:sx, sy0:sy};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = sx+'px'; ghost.style.top = sy+'px';
  ghost.style.width = '0px'; ghost.style.height = '0px';
  ghost.style.borderColor = '#2196f3';
  ghost.style.background = 'rgba(224,48,48,.08)';
}
function continueDrawTechroom(e) {
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.left = Math.min(sx, S.drawing.sx0)+'px';
  ghost.style.top  = Math.min(sy, S.drawing.sy0)+'px';
  ghost.style.width  = Math.abs(sx - S.drawing.sx0)+'px';
  ghost.style.height = Math.abs(sy - S.drawing.sy0)+'px';
}
function endDrawTechroom(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const w = Math.abs(x - S.drawing.x0), h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0), t = Math.min(y, S.drawing.y0);
  document.getElementById('draw-ghost').style.display = 'none';
  S.drawing = null;
  if (w < 10 || h < 10) return;
  S.tempTechroomPos = {x:l, y:t, w, h};
  openModalTechroom();
}
function openModalTechroom() {
  document.getElementById('modal-techroom-name').value = '';
  document.getElementById('modal-techroom-desc').value = '';
  document.getElementById('modal-techroom').classList.add('on');
  setTimeout(() => document.getElementById('modal-techroom-name').focus(), 60);
}
function cancelTechroom() { document.getElementById('modal-techroom').classList.remove('on'); S.drawing = null; document.getElementById('draw-ghost').style.display='none'; }
function confirmTechroom() {
  const f = activeFloor(); if (!f) return;
  const tr = {
    id: _id++,
    name: document.getElementById('modal-techroom-name').value.trim(),
    desc: document.getElementById('modal-techroom-desc').value.trim(),
    x: S.tempTechroomPos.x, y: S.tempTechroomPos.y,
    w: S.tempTechroomPos.w, h: S.tempTechroomPos.h,
    points: [
      {x: S.tempTechroomPos.x, y: S.tempTechroomPos.y},
      {x: S.tempTechroomPos.x + S.tempTechroomPos.w, y: S.tempTechroomPos.y},
      {x: S.tempTechroomPos.x + S.tempTechroomPos.w, y: S.tempTechroomPos.y + S.tempTechroomPos.h},
      {x: S.tempTechroomPos.x, y: S.tempTechroomPos.y + S.tempTechroomPos.h}
    ]
  };
  tr.retired = document.getElementById('modal-techroom-retired').checked;
  tr.retiredDate = tr.retired ? (document.getElementById('modal-techroom-retireddate')?.value||'') : '';
  tr.customColor = document.getElementById('modal-techroom-color')?.value || '';
  if (!f.techrooms) f.techrooms = [];
  f.techrooms.push(tr);
  document.getElementById('modal-techroom').classList.remove('on');
  S.tempTechroomPos = null;
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Local technique "${tr.name||'sans nom'}" crÃ©Ã© !`);
}
function editTechroom(tr) {
  const ed = document.getElementById('tab-equip');
  ed.innerHTML = `
    <div class="ed-title">Ã‰diter local technique <button class="ed-close" onclick="renderEquipmentsList()">Ã—</button></div>
    <div class="fg"><label class="lb">Nom</label><input class="inp" id="edit-tr-name" value="${esc(tr.name||'')}"></div>
    <div class="fg"><label class="lb">Description</label><textarea class="txa" id="edit-tr-desc">${esc(tr.desc||'')}</textarea></div>
    
    <div class="fg"><label class="lb">Couleur</label>
      <input type="color" id="edit-tr-color" value="${tr.customColor||'#2196f3'}" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    <div class="fg"><div class="check-group">
      <input type="checkbox" id="edit-tr-retired" onchange="document.getElementById('edit-tr-retireddate').parentElement.style.display=this.checked?'block':'none'" ${tr.retired?'checked':''}>
      <label for="edit-tr-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      <div style="display:${tr.retired?'block':'none'};margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="edit-tr-retireddate" value="${tr.retiredDate||''}" style="max-width:180px;">
      </div>
    </div></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveTechroom(${tr.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteTechroom(${tr.id})">Supprimer</button>
    </div>`;
  switchTab('equip');
}
function saveTechroom(tid) {
  const f = activeFloor(); if (!f) return;
  const tr = (f.techrooms||[]).find(t => t.id===tid); if (!tr) return;
  tr.name = document.getElementById('edit-tr-name').value.trim();
  tr.desc = document.getElementById('edit-tr-desc').value.trim();
  tr.retired = document.getElementById('edit-tr-retired')?.checked || false;
  tr.customColor = document.getElementById('edit-tr-color')?.value || '';
  renderEquipmentsList(); renderCanvas(); notify('Local technique mis Ã  jour.');
}
function deleteTechroom(tid) {
  const f = activeFloor(); if (!f) return;
  f.techrooms = (f.techrooms||[]).filter(t => t.id!==tid);
  renderEquipmentsList(); renderCanvas(); updateStats(); notify('Local technique supprimÃ©.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FREE ZONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FREEZONE_ICONS = [
  {icon:'â˜•',label:'Pause cafÃ©'},
  {icon:'ğŸ½ï¸',label:'RÃ©fectoire'},
  {icon:'ğŸ“¦',label:'Stockage'},
  {icon:'ğŸšª',label:'EntrÃ©e'},
  {icon:'ğŸ›‹ï¸',label:'Lounge'},
  {icon:'ğŸ–¨ï¸',label:'Reprographie'},
  {icon:'ğŸ”’',label:'SÃ©curitÃ©'},
  {icon:'ğŸ’¡',label:'IdÃ©es'},
  {icon:'ğŸ“š',label:'BibliothÃ¨que'},
  {icon:'ğŸ‹ï¸',label:'Sport'},
  {icon:'ğŸ§¹',label:'MÃ©nage'},
  {icon:'âš¡',label:'Ã‰nergie'},
  {icon:'ğŸŒ¿',label:'Nature'},
  {icon:'ğŸ®',label:'Jeux'},
  {icon:'ğŸ’Š',label:'Infirmerie'},
  {icon:'ğŸš¿',label:'Sanitaire'},
  {icon:'ğŸ…¿ï¸',label:'Parking'},
  {icon:'ğŸš´',label:'VÃ©los'},
  {icon:'ğŸ“¡',label:'RÃ©seau'},
  {icon:'ğŸ”§',label:'Maintenance'},
  {icon:'ğŸ¨',label:'CrÃ©atif'},
  {icon:'ğŸ“',label:'TÃ©lÃ©phonie'},
  {icon:'ğŸ–¥ï¸',label:'Informatique'},
  {icon:'ğŸ ',label:'Zone neutre'},
];

let _fzSelectedColor = '#a78bfa';
let _fzSelectedIcon = 'ğŸ“¦';

function initFreezonePicker() {
  // Color picker
  document.querySelectorAll('.fz-color').forEach(el => {
    el.style.border = '3px solid transparent';
    el.addEventListener('click', () => {
      document.querySelectorAll('.fz-color').forEach(e => e.style.border='3px solid transparent');
      el.style.border = '3px solid #fff';
      _fzSelectedColor = el.dataset.color;
    });
  });
  // Set first color selected
  const first = document.querySelector('.fz-color');
  if (first) { first.style.border='3px solid #fff'; _fzSelectedColor = first.dataset.color; }

  // Icon picker
  const picker = document.getElementById('freezone-icon-picker');
  if (!picker) return;
  picker.innerHTML = '';
  FREEZONE_ICONS.forEach(({icon, label}) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.title = label;
    btn.textContent = icon;
    btn.style.cssText = 'font-size:20px;padding:6px;border-radius:8px;border:2px solid var(--border);background:var(--card);cursor:pointer;transition:all .12s;';
    btn.addEventListener('click', () => {
      picker.querySelectorAll('button').forEach(b => b.style.borderColor = 'var(--border)');
      btn.style.borderColor = _fzSelectedColor;
      _fzSelectedIcon = icon;
    });
    if (icon === _fzSelectedIcon) btn.style.borderColor = _fzSelectedColor;
    picker.appendChild(btn);
  });
}

function startDrawFreezone(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  S.drawing = {x0:x, y0:y, sx0:sx, sy0:sy};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = sx+'px'; ghost.style.top = sy+'px';
  ghost.style.width = '0px'; ghost.style.height = '0px';
  ghost.style.borderColor = '#a78bfa';
  ghost.style.borderStyle = 'dashed';
  ghost.style.background = 'rgba(167,139,250,.08)';
}
function continueDrawFreezone(e) {
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.left = Math.min(sx, S.drawing.sx0)+'px';
  ghost.style.top  = Math.min(sy, S.drawing.sy0)+'px';
  ghost.style.width  = Math.abs(sx - S.drawing.sx0)+'px';
  ghost.style.height = Math.abs(sy - S.drawing.sy0)+'px';
}
function endDrawFreezone(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const w = Math.abs(x - S.drawing.x0), h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0), t = Math.min(y, S.drawing.y0);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'none';
  ghost.style.borderStyle = 'solid';
  S.drawing = null;
  if (w < 20 || h < 20) return;
  S.tempFreezonePo = {x:l, y:t, w, h};
  openModalFreezone();
}
function openModalFreezone(fz) {
  _fzSelectedColor = fz ? fz.color : '#a78bfa';
  _fzSelectedIcon  = fz ? fz.icon  : 'ğŸ“¦';
  document.getElementById('modal-freezone-name').value = fz ? fz.name : '';
  document.getElementById('modal-freezone').classList.add('on');
  initFreezonePicker();
  // Restore color selection
  document.querySelectorAll('.fz-color').forEach(el => {
    el.style.border = el.dataset.color === _fzSelectedColor ? '3px solid #fff' : '3px solid transparent';
  });
  // Restore icon selection
  const picker = document.getElementById('freezone-icon-picker');
  if (picker) picker.querySelectorAll('button').forEach(b => {
    b.style.borderColor = b.textContent === _fzSelectedIcon ? _fzSelectedColor : 'var(--border)';
  });
  setTimeout(() => document.getElementById('modal-freezone-name').focus(), 60);
}
function cancelFreezone() {
  document.getElementById('modal-freezone').classList.remove('on');
  S.drawing = null; S.tempFreezonePo = null; S.editingFreezeoneId = null;
  document.getElementById('draw-ghost').style.display='none';
}
function confirmFreezone() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-freezone-name').value.trim();
  if (!f.freezones) f.freezones = [];

  if (S.editingFreezeoneId != null) {
    const fz = f.freezones.find(z => z.id === S.editingFreezeoneId);
    if (fz) {
      fz.name = name;
      fz.color = _fzSelectedColor;
      fz.icon = _fzSelectedIcon;
    }
    S.editingFreezeoneId = null;
  } else {
    const pos = S.tempFreezonePo;
    const fz = {
      id: _id++, name,
      color: _fzSelectedColor,
      customColor: document.getElementById('modal-freezone-color')?.value || '',
      retiredDate: document.getElementById('modal-freezone-retired')?.checked ? (document.getElementById('modal-freezone-retireddate')?.value||'') : '',
      icon: _fzSelectedIcon,
      x: pos.x, y: pos.y, w: pos.w, h: pos.h,
      points: [
        {x: pos.x, y: pos.y},
        {x: pos.x + pos.w, y: pos.y},
        {x: pos.x + pos.w, y: pos.y + pos.h},
        {x: pos.x, y: pos.y + pos.h}
      ]
    };
    f.freezones.push(fz);
    S.tempFreezonePo = null;
  }
  document.getElementById('modal-freezone').classList.remove('on');
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Zone libre "${name||'sans nom'}" ${S.editingFreezeoneId != null ? 'mise Ã  jour' : 'crÃ©Ã©e'} !`);
}
function editFreezone(fz) {
  S.editingFreezeoneId = fz.id;
  openModalFreezone(fz);
}
function deleteFreezone(fzid) {
  const f = activeFloor(); if (!f) return;
  f.freezones = (f.freezones||[]).filter(z => z.id !== fzid);
  renderEquipmentsList(); renderCanvas(); updateStats(); notify('Zone libre supprimÃ©e.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DYNAMIC DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function placeDisplay(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  S.tempDisplayPos = {x:(e.clientX-rect.left)/S.zoom, y:(e.clientY-rect.top)/S.zoom};
  openModalDisplay();
}
function openModalDisplay() {
  document.getElementById('modal-display-name').value = '';
  document.getElementById('modal-display-size').value = '55';
  document.getElementById('modal-display-content').value = '';
  document.getElementById('modal-display-network').value = '';
  document.getElementById('modal-display').classList.add('on');
  setTimeout(() => document.getElementById('modal-display-name').focus(), 60);
}
function cancelDisplay() { document.getElementById('modal-display').classList.remove('on'); }
function confirmDisplay() {
  const f = activeFloor(); if (!f) return;
  const dp = {
    id: _id++,
    name: document.getElementById('modal-display-name').value.trim(),
    size: parseInt(document.getElementById('modal-display-size').value),
    content: document.getElementById('modal-display-content').value.trim(),
    network: document.getElementById('modal-display-network').value.trim(),
    customColor: document.getElementById('modal-display-color').value,
    retired: document.getElementById('modal-display-retired').checked,
    retiredDate: document.getElementById('modal-display-retired').checked ? (document.getElementById('modal-display-retireddate')?.value||'') : '',
    x: S.tempDisplayPos.x, y: S.tempDisplayPos.y
  };
  if (!f.displays) f.displays = [];
  f.displays.push(dp);
  document.getElementById('modal-display').classList.remove('on');
  S.tempDisplayPos = null;
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Affichage dynamique "${dp.name||'sans nom'}" crÃ©Ã© !`);
}
function editDisplay(dp) {
  const ed = document.getElementById('tab-equip');
  ed.innerHTML = `
    <div class="ed-title">Ã‰diter affichage dynamique <button class="ed-close" onclick="renderEquipmentsList()">Ã—</button></div>
    <div class="fg"><label class="lb">Nom / Emplacement</label><input class="inp" id="edit-dp-name" value="${esc(dp.name||'')}"></div>
    <div class="fg"><label class="lb">Taille</label>
      <select class="sel" id="edit-dp-size">
        ${[32,43,49,55,65,75,98].map(s=>`<option value="${s}" ${dp.size===s?'selected':''}>${s} pouces</option>`).join('')}
      </select></div>
    <div class="fg"><label class="lb">Contenu diffusÃ©</label><input class="inp" id="edit-dp-content" value="${esc(dp.content||'')}"></div>
    <div class="fg"><label class="lb">RÃ©seau</label><textarea class="txa" id="edit-dp-network">${esc(dp.network||'')}</textarea></div>
    
    <div class="fg"><label class="lb">Couleur</label>
      <input type="color" id="edit-dp-color" value="${dp.customColor||'#ffaa33'}" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    <div class="fg"><div class="check-group">
      <input type="checkbox" id="edit-dp-retired" onchange="document.getElementById('edit-dp-retireddate').parentElement.style.display=this.checked?'block':'none'" ${dp.retired?'checked':''}>
      <label for="edit-dp-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      <div style="display:${dp.retired?'block':'none'};margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="edit-dp-retireddate" value="${dp.retiredDate||''}" style="max-width:180px;">
      </div>
    </div></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveDisplay(${dp.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteDisplay(${dp.id})">Supprimer</button>
    </div>`;
  switchTab('equip');
}
function saveDisplay(did) {
  const f = activeFloor(); if (!f) return;
  const dp = (f.displays||[]).find(d => d.id===did); if (!dp) return;
  dp.name = document.getElementById('edit-dp-name').value.trim();
  dp.size = parseInt(document.getElementById('edit-dp-size').value);
  dp.content = document.getElementById('edit-dp-content').value.trim();
  dp.network = document.getElementById('edit-dp-network').value.trim();
  dp.retired = document.getElementById('edit-dp-retired').checked;
  dp.customColor = document.getElementById('edit-dp-color')?.value || '';
  renderEquipmentsList(); renderCanvas(); notify('Affichage dynamique mis Ã  jour.');
}
function deleteDisplay(did) {
  const f = activeFloor(); if (!f) return;
  f.displays = (f.displays||[]).filter(d => d.id!==did);
  renderEquipmentsList(); renderCanvas(); updateStats(); notify('Affichage dynamique supprimÃ©.');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROJECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function placeProjector(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  S.tempProjectorPos = {x:(e.clientX-rect.left)/S.zoom, y:(e.clientY-rect.top)/S.zoom};
  openModalProjector();
}
function openModalProjector() {
  document.getElementById('modal-projector-name').value = '';
  document.getElementById('modal-projector-brand').value = '';
  document.getElementById('modal-projector-resolution').value = 'Full HD';
  document.getElementById('modal-projector-network').value = '';
  document.getElementById('modal-projector').classList.add('on');
  setTimeout(() => document.getElementById('modal-projector-name').focus(), 60);
}
function cancelProjector() { document.getElementById('modal-projector').classList.remove('on'); }
function confirmProjector() {
  const f = activeFloor(); if (!f) return;
  const pj = {
    id: _id++,
    name: document.getElementById('modal-projector-name').value.trim(),
    brand: document.getElementById('modal-projector-brand').value.trim(),
    resolution: document.getElementById('modal-projector-resolution').value,
    network: document.getElementById('modal-projector-network').value.trim(),
    customColor: document.getElementById('modal-projector-color').value,
    retired: document.getElementById('modal-projector-retired').checked,
    retiredDate: document.getElementById('modal-projector-retired').checked ? (document.getElementById('modal-projector-retireddate')?.value||'') : '',
    x: S.tempProjectorPos.x, y: S.tempProjectorPos.y
  };
  if (!f.projectors) f.projectors = [];
  f.projectors.push(pj);
  document.getElementById('modal-projector').classList.remove('on');
  S.tempProjectorPos = null;
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`VidÃ©oprojecteur "${pj.name||'sans nom'}" crÃ©Ã© !`);
}
function editProjector(pj) {
  const f = activeFloor(); if (!f) return;
  const item = (f.projectors||[]).find(p => p.id === pj.id); if (!item) return;
  const ed = document.getElementById('tab-equip');
  ed.innerHTML = `
    <div class="ed-title">Ã‰diter vidÃ©oprojecteur <button class="ed-close" onclick="renderEquipmentsList()">Ã—</button></div>
    <div class="fg"><label class="lb">Nom / Emplacement</label><input class="inp" id="edit-pj-name" value="${esc(item.name||'')}"></div>
    <div class="fg"><label class="lb">Marque / ModÃ¨le</label><input class="inp" id="edit-pj-brand" value="${esc(item.brand||'')}"></div>
    <div class="fg"><label class="lb">RÃ©solution</label>
      <select class="sel" id="edit-pj-resolution">
        ${['HD','Full HD','4K'].map(r=>`<option value="${r}" ${pj.resolution===r?'selected':''}>${r}</option>`).join('')}
      </select></div>
    <div class="fg"><label class="lb">RÃ©seau</label><textarea class="txa" id="edit-pj-network">${esc(item.network||'')}</textarea></div>
    
    <div class="fg"><label class="lb">Couleur</label>
      <input type="color" id="edit-pj-color" value="${pj.customColor||'#e066ff'}" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    <div class="fg"><div class="check-group">
      <input type="checkbox" id="edit-pj-retired" onchange="document.getElementById('edit-pj-retireddate').parentElement.style.display=this.checked?'block':'none'" ${pj.retired?'checked':''}>
      <label for="edit-pj-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      <div style="display:${pj.retired?'block':'none'};margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="edit-pj-retireddate" value="${pj.retiredDate||''}" style="max-width:180px;">
      </div>
    </div></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveProjector(${pj.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteProjector(${pj.id})">Supprimer</button>
    </div>`;
  switchTab('equip');
}
function saveProjector(pid) {
  const f = activeFloor(); if (!f) return;
  const pj = (f.projectors||[]).find(p => p.id===pid); if (!pj) return;
  pj.name = document.getElementById('edit-pj-name').value.trim();
  pj.brand = document.getElementById('edit-pj-brand').value.trim();
  pj.resolution = document.getElementById('edit-pj-resolution').value;
  pj.network = document.getElementById('edit-pj-network').value.trim();
  pj.retired = document.getElementById('edit-pj-retired').checked;
  pj.customColor = document.getElementById('edit-pj-color')?.value || '';
  renderEquipmentsList(); renderCanvas(); notify('VidÃ©oprojecteur mis Ã  jour.');
}
function deleteProjector(pid) {
  const f = activeFloor(); if (!f) return;
  f.projectors = (f.projectors||[]).filter(p => p.id!==pid);
  renderEquipmentsList(); renderCanvas(); updateStats(); notify('VidÃ©oprojecteur supprimÃ©.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLOTTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function placePlotter(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  S.tempPlotterPos = {x:(e.clientX-rect.left)/S.zoom, y:(e.clientY-rect.top)/S.zoom};
  openModalPlotter();
}
function openModalPlotter() {
  document.getElementById('modal-plotter-name').value = '';
  document.getElementById('modal-plotter-brand').value = '';
  document.getElementById('modal-plotter-format').value = 'A0';
  document.getElementById('modal-plotter-network').value = '';
  document.getElementById('modal-plotter').classList.add('on');
  setTimeout(() => document.getElementById('modal-plotter-name').focus(), 60);
}
function cancelPlotter() { document.getElementById('modal-plotter').classList.remove('on'); }
function confirmPlotter() {
  const f = activeFloor(); if (!f) return;
  const pl = {
    id: _id++,
    name: document.getElementById('modal-plotter-name').value.trim(),
    brand: document.getElementById('modal-plotter-brand').value.trim(),
    format: document.getElementById('modal-plotter-format').value,
    network: document.getElementById('modal-plotter-network').value.trim(),
    customColor: document.getElementById('modal-plotter-color').value,
    retired: document.getElementById('modal-plotter-retired').checked,
    retiredDate: document.getElementById('modal-plotter-retired').checked ? (document.getElementById('modal-plotter-retireddate')?.value||'') : '',
    x: S.tempPlotterPos.x, y: S.tempPlotterPos.y
  };
  if (!f.plotters) f.plotters = [];
  f.plotters.push(pl);
  document.getElementById('modal-plotter').classList.remove('on');
  S.tempPlotterPos = null;
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Traceur "${pl.name||'sans nom'}" crÃ©Ã© !`);
}
function editPlotter(pl) {
  const f = activeFloor(); if (!f) return;
  const item = (f.plotters||[]).find(p => p.id === pl.id); if (!item) return;
  const ed = document.getElementById('tab-equip');
  ed.innerHTML = `
    <div class="ed-title">Ã‰diter traceur <button class="ed-close" onclick="renderEquipmentsList()">Ã—</button></div>
    <div class="fg"><label class="lb">Nom / Emplacement</label><input class="inp" id="edit-pl-name" value="${esc(item.name||'')}"></div>
    <div class="fg"><label class="lb">Marque / ModÃ¨le</label><input class="inp" id="edit-pl-brand" value="${esc(item.brand||'')}"></div>
    <div class="fg"><label class="lb">Format max</label>
      <select class="sel" id="edit-pl-format">
        ${['A1','A0','A0+'].map(f=>`<option value="${f}" ${pl.format===f?'selected':''}>${f}</option>`).join('')}
      </select></div>
    <div class="fg"><label class="lb">RÃ©seau</label><textarea class="txa" id="edit-pl-network">${esc(item.network||'')}</textarea></div>
    
    <div class="fg"><label class="lb">Couleur</label>
      <input type="color" id="edit-pl-color" value="${pl.customColor||'#00acc1'}" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    <div class="fg"><div class="check-group">
      <input type="checkbox" id="edit-pl-retired" onchange="document.getElementById('edit-pl-retireddate').parentElement.style.display=this.checked?'block':'none'" ${pl.retired?'checked':''}>
      <label for="edit-pl-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      <div style="display:${pl.retired?'block':'none'};margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="edit-pl-retireddate" value="${pl.retiredDate||''}" style="max-width:180px;">
      </div>
    </div></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="savePlotter(${pl.id})">Enregistrer</button>
      <button class="btn danger" onclick="deletePlotter(${pl.id})">Supprimer</button>
    </div>`;
  switchTab('equip');
}
function savePlotter(pid) {
  const f = activeFloor(); if (!f) return;
  const pl = (f.plotters||[]).find(p => p.id===pid); if (!pl) return;
  pl.name = document.getElementById('edit-pl-name').value.trim();
  pl.brand = document.getElementById('edit-pl-brand').value.trim();
  pl.format = document.getElementById('edit-pl-format').value;
  pl.network = document.getElementById('edit-pl-network').value.trim();
  pl.retired = document.getElementById('edit-pl-retired').checked;
  pl.customColor = document.getElementById('edit-pl-color')?.value || '';
  renderEquipmentsList(); renderCanvas(); notify('Traceur mis Ã  jour.');
}
function deletePlotter(pid) {
  const f = activeFloor(); if (!f) return;
  f.plotters = (f.plotters||[]).filter(p => p.id!==pid);
  renderEquipmentsList(); renderCanvas(); updateStats(); notify('Traceur supprimÃ©.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOCKET (NETWORK OUTLETS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function placeSocket(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  S.tempSocketPos = {x, y};
  S.tempSocket = {outlets: []};
  openModalSocket();
}
function openModalSocket() {
  document.getElementById('modal-socket-name').value = '';
  document.getElementById('modal-socket-outlet-input').value = '';
  const retiredCb = document.getElementById('modal-socket-retired');
  if (retiredCb) retiredCb.checked = false;
  renderModalSocketOutlets();
  document.getElementById('modal-socket').classList.add('on');
  setTimeout(() => document.getElementById('modal-socket-name').focus(), 60);
  document.getElementById('modal-socket-outlet-input').onkeydown = e => { if (e.key==='Enter') addSocketOutlet(); };
}
function renderModalSocketOutlets() {
  const c = document.getElementById('modal-socket-outlets');
  if (!c) return;
  c.innerHTML = '';
  if (S.tempSocket.outlets.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune prise</div>';
    return;
  }
  S.tempSocket.outlets.forEach((o,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `
      <div class="move-person-name">${esc(o)}</div>
      <button class="sock-del" onclick="removeSocketOutlet(${i})">Ã—</button>
    `;
    c.appendChild(d);
  });
}
function addSocketOutlet() {
  const inp = document.getElementById('modal-socket-outlet-input');
  const v = inp.value.trim(); if (!v) return;
  S.tempSocket.outlets.push(v);
  inp.value = '';
  renderModalSocketOutlets();
}
function removeSocketOutlet(idx) {
  S.tempSocket.outlets.splice(idx, 1);
  renderModalSocketOutlets();
}
function cancelSocket() {
  document.getElementById('modal-socket').classList.remove('on');
  S.tempSocket = {outlets: []};
}
function confirmSocket() {
  const f = activeFloor(); if (!f) return;
  const nameEl = document.getElementById('modal-socket-name');
  if (!nameEl) { console.error('modal-socket-name not found'); return; }
  const sock = {
    id: _id++,
    name: nameEl.value.trim(),
    outlets: [...S.tempSocket.outlets],
    customColor: document.getElementById('modal-socket-color')?.value || '',
    retired: document.getElementById('modal-socket-retired')?.checked || false,
    retiredDate: document.getElementById('modal-socket-retired')?.checked ? (document.getElementById('modal-socket-retireddate')?.value||'') : '',
    x: S.tempSocketPos.x, y: S.tempSocketPos.y
  };
  if (!f.sockets) f.sockets = [];
  f.sockets.push(sock);
  document.getElementById('modal-socket').classList.remove('on');
  S.tempSocketPos = null;
  S.tempSocket = {outlets: []};
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Prises rÃ©seau "${sock.name||'sans nom'}" crÃ©Ã©es !`);
}
function editSocket(sock) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">Ã‰diter prises rÃ©seau <button class="ed-close" onclick="renderEquipmentsList()">Ã—</button></div>
    <div class="fg"><label class="lb">Nom de l'emplacement</label><input class="inp" id="edit-socket-name" value="${esc(sock.name||'')}"></div>
    <div class="fg">
      <label class="lb">Prises rÃ©seau</label>
      <div class="move-people-list" id="edit-socket-outlets"></div>
      <div class="add-person">
        <input type="text" class="inp" id="edit-socket-outlet-input" placeholder="ex: Prise 1 - IP 192.168.1.10">
        <button class="btn" onclick="addEditSocketOutlet(${sock.id})">+</button>
      </div>
    </div>
    
    <div class="fg"><label class="lb">Couleur</label>
      <input type="color" id="edit-sock-color" value="${sock.customColor||'#00bfa5'}" style="width:50px;height:30px;padding:2px;cursor:pointer;">
    </div>
    <div class="fg"><div class="check-group">
      <input type="checkbox" id="edit-sock-retired" onchange="document.getElementById('edit-sock-retireddate').parentElement.style.display=this.checked?'block':'none'" ${sock.retired?'checked':''}>
      <label for="edit-sock-retired" style="color:#8b1a1a;font-weight:600;">RetirÃ©(e)</label>
      <div style="display:${sock.retired?'block':'none'};margin-top:6px;">
        <label class="lb" style="font-size:11px;">Date de retrait</label>
        <input type="date" class="inp" id="edit-sock-retireddate" value="${sock.retiredDate||''}" style="max-width:180px;">
      </div>
    </div></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveSocket(${sock.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteSocket(${sock.id})">Supprimer</button>
    </div>`;
  ed.innerHTML = content;
  renderEditSocketOutlets(sock);
  switchTab('equip');
  document.getElementById('edit-socket-outlet-input').onkeydown = e => { if (e.key==='Enter') addEditSocketOutlet(sock.id); };
}
function renderEditSocketOutlets(sock) {
  const c = document.getElementById('edit-socket-outlets');
  if (!c) return;
  c.innerHTML = '';
  if (!sock.outlets || sock.outlets.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune prise</div>';
    return;
  }
  sock.outlets.forEach((o,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `
      <div class="move-person-name">${esc(o)}</div>
      <button class="sock-del" onclick="removeEditSocketOutlet(${sock.id},${i})">Ã—</button>
    `;
    c.appendChild(d);
  });
}
function addEditSocketOutlet(sid) {
  const f = activeFloor(); if (!f) return;
  const sock = (f.sockets||[]).find(s => s.id === sid); if (!sock) return;
  const inp = document.getElementById('edit-socket-outlet-input');
  const v = inp.value.trim(); if (!v) return;
  sock.outlets.push(v);
  inp.value = '';
  renderEditSocketOutlets(sock);
  renderEquipmentsList(); updateStats();
}
function removeEditSocketOutlet(sid, idx) {
  const f = activeFloor(); if (!f) return;
  const sock = (f.sockets||[]).find(s => s.id === sid); if (!sock) return;
  sock.outlets.splice(idx, 1);
  renderEditSocketOutlets(sock);
  renderEquipmentsList(); updateStats();
}
function saveSocket(sid) {
  const f = activeFloor(); if (!f) return;
  const sock = (f.sockets||[]).find(s => s.id === sid); if (!sock) return;
  sock.name = document.getElementById('edit-socket-name').value.trim();
  sock.customColor = document.getElementById('edit-sock-color')?.value || '';
  sock.retired = document.getElementById('edit-sock-retired')?.checked || false;
  sock.retiredDate = sock.retired ? (document.getElementById('edit-sock-retireddate')?.value||'') : '';
  renderEquipmentsList(); renderCanvas(); updateStats();
  notify('Prises rÃ©seau mises Ã  jour.');
}
function deleteSocket(sid) {
  const f = activeFloor(); if (!f) return;
  const sock = (f.sockets||[]).find(s => s.id === sid); if (!sock) return;
  showConfirmModal(`Supprimer "${sock.name || 'ces prises rÃ©seau'}" ?`, '', () => {
    f.sockets = (f.sockets||[]).filter(s => s.id!==sid);
    renderCanvas(); renderEquipmentsList(); updateStats();
    notify('Prises rÃ©seau supprimÃ©es.');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLOOR ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function clearFloor() {
  const f = activeFloor(); if (!f) return;
  // confirm() bloquÃ© en iframe â€” on utilise un modal inline
  showConfirmModal(
    `Vider l'Ã©tage "${f.name}" ?`,
    'Tous les bureaux, Ã©quipements et le plan image seront supprimÃ©s.',
    () => {
      f.rooms=[]; f.copiers=[]; f.printers=[]; f.meetings=[]; f.moves=[];
      f.screens=[]; f.techrooms=[]; f.displays=[]; f.sockets=[]; f.projectors=[]; f.plotters=[];
      f.imageB64=null; f.imageW=0; f.imageH=0;
      S.selectedRoom=null;
      renderCanvas(); renderRoomsList(); renderEquipmentsList();
      renderMovesList(); editorOpen(null); updateStats();
      notify('Ã‰tage vidÃ©.');
    }
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportExcel() {
  const wb = XLSX.utils.book_new();
  
  // Feuille rÃ©capitulatif gÃ©nÃ©ral
  const summaryData = [
    ['Export du plan - RÃ©capitulatif'],
    ['Date d\'export', new Date().toLocaleDateString('fr-FR')],
    [''],
    ['Statistiques globales'],
    ['Nombre d\'Ã©tages', S.floors.length],
    ['Nombre de lieux', S.locations.length],
    ['Bureaux', S.floors.reduce((a,f) => a+f.rooms.length, 0)],
    ['Copieurs', S.floors.reduce((a,f) => a+f.copiers.length, 0)],
    ['Imprimantes', S.floors.reduce((a,f) => a+f.printers.length, 0)],
    ['Salles de rÃ©union', S.floors.reduce((a,f) => a+f.meetings.length, 0)],
    ['Zones de dÃ©mÃ©nagement', S.floors.reduce((a,f) => a+f.moves.length, 0)]
  ];
  const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, ws1, 'RÃ©capitulatif');
  
  // Feuille BUREAUX
  const roomsData = [
    ['BUREAUX'],
    [''],
    ['Ã‰tage', 'Nom du bureau', 'Personnes', 'Prises rÃ©seau', 'Notes', 'RetirÃ©']
  ];
  
  S.floors.forEach(f => {
    f.rooms.forEach(r => {
      roomsData.push([
        f.name,
        r.name || '(sans nom)',
        (r.people||[]).join(', '),
        r.socketNums || '',
        r.notes || '',
        r.retired ? 'Oui' : 'Non'
      ]);
    });
  });
  
  if (roomsData.length > 3) {
    const wsRooms = XLSX.utils.aoa_to_sheet(roomsData);
    XLSX.utils.book_append_sheet(wb, wsRooms, 'Bureaux');
  }
  
  // Feuille COPIEURS
  const copiersData = [
    ['COPIEURS'],
    [''],
    ['Ã‰tage', 'Nom', 'Informations rÃ©seau']
  ];
  
  S.floors.forEach(f => {
    f.copiers.forEach(c => {
      copiersData.push([
        f.name,
        c.name || '(sans nom)',
        c.network || ''
      ]);
    });
  });
  
  if (copiersData.length > 3) {
    const wsCopiers = XLSX.utils.aoa_to_sheet(copiersData);
    XLSX.utils.book_append_sheet(wb, wsCopiers, 'Copieurs');
  }
  
  // Feuille IMPRIMANTES
  const printersData = [
    ['IMPRIMANTES'],
    [''],
    ['Ã‰tage', 'Nom', 'Informations rÃ©seau']
  ];
  
  S.floors.forEach(f => {
    f.printers.forEach(p => {
      printersData.push([
        f.name,
        p.name || '(sans nom)',
        p.network || ''
      ]);
    });
  });
  
  if (printersData.length > 3) {
    const wsPrinters = XLSX.utils.aoa_to_sheet(printersData);
    XLSX.utils.book_append_sheet(wb, wsPrinters, 'Imprimantes');
  }
  
  // Feuille SALLES DE RÃ‰UNION
  const meetingsData = [
    ['SALLES DE RÃ‰UNION'],
    [''],
    ['Ã‰tage', 'Nom', 'CapacitÃ©', 'Type d\'Ã©cran', 'Taille Ã©cran', 'Ã‰quipement MTR', 'ClickShare', 'WePresent']
  ];
  
  S.floors.forEach(f => {
    f.meetings.forEach(m => {
      meetingsData.push([
        f.name,
        m.name || '(sans nom)',
        m.capacity || '',
        m.screenType === 'tactile' ? 'Tactile' : m.screenType === 'videoprojecteur' ? 'VidÃ©oprojecteur' : 'Classique',
        m.screenSize + ' pouces',
        m.hasMTR ? 'Oui' : 'Non',
        m.hasClickshare ? 'Oui' : 'Non',
        m.hasWepresent ? 'Oui' : 'Non'
      ]);
    });
  });
  
  if (meetingsData.length > 3) {
    const wsMeetings = XLSX.utils.aoa_to_sheet(meetingsData);
    XLSX.utils.book_append_sheet(wb, wsMeetings, 'Salles de rÃ©union');
  }
  
  // Feuille DÃ‰MÃ‰NAGEMENTS
  const movesData = [
    ['DÃ‰MÃ‰NAGEMENTS'],
    [''],
    ['Ã‰tage', 'Date', 'Personne', 'PC requis']
  ];
  
  S.floors.forEach(f => {
    f.moves.forEach(mv => {
      const dateStr = mv.date ? new Date(mv.date).toLocaleDateString('fr-FR') : 'Non dÃ©finie';
      if (mv.people && mv.people.length > 0) {
        mv.people.forEach(p => {
          movesData.push([
            f.name,
            dateStr,
            p.name,
            p.needsPC ? 'Oui' : 'Non'
          ]);
        });
      } else {
        movesData.push([f.name, dateStr, '(aucune personne)', '']);
      }
    });
  });
  
  if (movesData.length > 3) {
    const wsMoves = XLSX.utils.aoa_to_sheet(movesData);
    XLSX.utils.book_append_sheet(wb, wsMoves, 'DÃ©mÃ©nagements');
  }
  
  // Feuille Ã‰CRANS
  const screensData = [
    ['Ã‰CRANS'],
    [''],
    ['Ã‰tage', 'Nom', 'Taille', 'Marque', 'Informations rÃ©seau']
  ];
  S.floors.forEach(f => {
    (f.screens||[]).forEach(sc => {
      screensData.push([f.name, sc.name||'(sans nom)', sc.size+' pouces', sc.brand||'', sc.network||'']);
    });
  });
  if (screensData.length > 3) {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(screensData), 'Ã‰crans');
  }

  // Feuille LOCAUX TECHNIQUES
  const techData = [
    ['LOCAUX TECHNIQUES'],
    [''],
    ['Ã‰tage', 'Nom', 'Description']
  ];
  S.floors.forEach(f => {
    (f.techrooms||[]).forEach(tr => {
      techData.push([f.name, tr.name||'(sans nom)', tr.desc||'']);
    });
  });
  if (techData.length > 3) {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(techData), 'Locaux techniques');
  }

  // Feuille AFFICHAGES DYNAMIQUES
  const displaysData = [
    ['AFFICHAGES DYNAMIQUES'],
    [''],
    ['Ã‰tage', 'Nom / Emplacement', 'Taille', 'Contenu diffusÃ©', 'Informations rÃ©seau']
  ];
  S.floors.forEach(f => {
    (f.displays||[]).forEach(dp => {
      displaysData.push([f.name, dp.name||'(sans nom)', dp.size+' pouces', dp.content||'', dp.network||'']);
    });
  });
  if (displaysData.length > 3) {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(displaysData), 'Affichages dynamiques');
  }

  // Feuille VIDÃ‰OPROJECTEURS
  const projectorsData = [
    ['VIDÃ‰OPROJECTEURS'],
    [''],
    ['Ã‰tage', 'Nom / Emplacement', 'Marque / ModÃ¨le', 'RÃ©solution', 'Informations rÃ©seau']
  ];
  S.floors.forEach(f => {
    (f.projectors||[]).forEach(pj => {
      projectorsData.push([f.name, pj.name||'(sans nom)', pj.brand||'', pj.resolution||'', pj.network||'']);
    });
  });
  if (projectorsData.length > 3) {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(projectorsData), 'VidÃ©oprojecteurs');
  }

  // Feuille TRACEURS
  const plottersData = [
    ['TRACEURS'],
    [''],
    ['Ã‰tage', 'Nom / Emplacement', 'Marque / ModÃ¨le', 'Format max', 'Informations rÃ©seau']
  ];
  S.floors.forEach(f => {
    (f.plotters||[]).forEach(pl => {
      plottersData.push([f.name, pl.name||'(sans nom)', pl.brand||'', pl.format||'', pl.network||'']);
    });
  });
  if (plottersData.length > 3) {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(plottersData), 'Traceurs');
  }

  // Nom du fichier avec date
  const today = new Date();
  const dateStr = today.toLocaleDateString('fr-FR').replace(/\//g, '-');
  const floorName = (activeFloor()?.name || 'plan').replace(/[^a-z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Ã¦Å“ ]/gi, '_').replace(/ +/g, '_');
  const fileName = `${floorName}_${dateStr}.xlsx`;
  
  XLSX.writeFile(wb, fileName);
  notify('Export Excel rÃ©ussi !');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENERATE INFO PANEL FOR EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateInfoPanel(floor) {
  const panel = document.createElement('div');
  panel.style.cssText = `
    position: absolute;
    right: 0;
    top: 0;
    width: 300px;
    height: 100%;
    background: white;
    padding: 20px;
    box-sizing: border-box;
    font-family: 'Segoe UI', Arial, sans-serif;
    overflow-y: auto;
    border-left: 2px solid #333;
  `;

  let html = `
    <div style="margin-bottom:20px;border-bottom:3px solid #333;padding-bottom:10px;">
      <h2 style="margin:0;font-size:18px;font-weight:700;color:#333;">${esc(floor.name)}</h2>
      <p style="margin:5px 0 0;font-size:11px;color:#666;">Export du ${new Date().toLocaleDateString('fr-FR')}</p>
    </div>
  `;

  // Bureaux
  if (floor.rooms.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Bureaux (${floor.rooms.length})</h3>`;
    floor.rooms.forEach(r => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:3px;">â€¢ ${esc(r.name||'(sans nom)')}</div>`;
    });
    html += `</div>`;
  }

  // Copieurs
  if (floor.copiers.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Copieurs (${floor.copiers.length})</h3>`;
    floor.copiers.forEach(c => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(c.name||'(sans nom)')}</strong>`;
      if (c.network) html += `<br><span style="font-size:10px;color:#888;">${esc(c.network).replace(/\n/g, '<br>')}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Imprimantes
  if (floor.printers.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Imprimantes (${floor.printers.length})</h3>`;
    floor.printers.forEach(p => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(p.name||'(sans nom)')}</strong>`;
      if (p.network) html += `<br><span style="font-size:10px;color:#888;">${esc(p.network).replace(/\n/g, '<br>')}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Salles de rÃ©union
  if (floor.meetings.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Salles de rÃ©union (${floor.meetings.length})</h3>`;
    floor.meetings.forEach(m => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(m.name||'(sans nom)')}</strong><br>
        <span style="font-size:10px;color:#888;">${(m.screenType==='tactile'?'Tactile':m.screenType==='videoprojecteur'?'VidÃ©oproj.':'Classique')} ${m.screenSize}"${m.hasMTR?' + MTR':''}${m.hasClickshare?' + CS':''}${m.hasWepresent?' + WP':''}</span>
      </div>`;
    });
    html += `</div>`;
  }

  // Ã‰crans
  if ((floor.screens||[]).length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Ã‰crans (${floor.screens.length})</h3>`;
    floor.screens.forEach(sc => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(sc.name||'(sans nom)')}</strong><br>
        <span style="font-size:10px;color:#888;">${sc.size}" ${sc.brand||''}</span>`;
      if (sc.network) html += `<br><span style="font-size:10px;color:#888;">${esc(sc.network).replace(/\n/g, '<br>')}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Affichages dynamiques
  if ((floor.displays||[]).length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Affichages dynamiques (${floor.displays.length})</h3>`;
    floor.displays.forEach(dp => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(dp.name||'(sans nom)')}</strong><br>
        <span style="font-size:10px;color:#888;">${dp.size}"${dp.content?' - '+esc(dp.content):''}</span>`;
      if (dp.network) html += `<br><span style="font-size:10px;color:#888;">${esc(dp.network).replace(/\n/g, '<br>')}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Locaux techniques
  if ((floor.techrooms||[]).length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Locaux techniques (${floor.techrooms.length})</h3>`;
    floor.techrooms.forEach(tr => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(tr.name||'(sans nom)')}</strong>`;
      if (tr.desc) html += `<br><span style="font-size:10px;color:#888;">${esc(tr.desc).replace(/\n/g, '<br>')}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // DÃ©mÃ©nagements
  if (floor.moves.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">DÃ©mÃ©nagements (${floor.moves.length})</h3>`;
    floor.moves.forEach(mv => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:8px;">
        <strong>${mv.date ? new Date(mv.date).toLocaleDateString('fr-FR') : 'Date non dÃ©finie'}</strong><br>`;
      if (mv.people && mv.people.length > 0) {
        html += `<span style="font-size:10px;color:#888;">${mv.people.length} personne${mv.people.length>1?'s':''}</span><br>`;
        mv.people.forEach(p => {
          html += `<span style="font-size:10px;color:#666;">â€¢ ${esc(p.name)}${p.needsPC?' ğŸ’»':''}</span><br>`;
        });
      } else {
        html += `<span style="font-size:10px;color:#888;font-style:italic;">Aucune personne</span>`;
      }
      html += `</div>`;
    });
    html += `</div>`;
  }

  panel.innerHTML = html;
  return panel;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT OPTIONS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _exportType = null;
let _exportOptions = {
  rooms: true, copiers: true, printers: true, meetings: true,
  screens: true, displays: true, techrooms: true, sockets: true, moves: true
};

function openExportOptionsModal(type) {
  _exportType = type;
  const title = {
    'png': 'Export PNG - SÃ©lection',
    'pdf': 'Export PDF - SÃ©lection',
    'json': 'Export JSON - SÃ©lection'
  }[type] || 'Options d\'export';
  
  document.getElementById('export-options-title').textContent = title;
  
  // Reset all checkboxes to checked
  document.querySelectorAll('.export-checkbox').forEach(cb => cb.checked = true);
  document.getElementById('export-all').checked = true;
  
  document.getElementById('modal-export-options').classList.add('on');
}

function toggleAllExportOptions() {
  const allChecked = document.getElementById('export-all').checked;
  document.querySelectorAll('.export-checkbox').forEach(cb => cb.checked = allChecked);
}

function cancelExportOptions() {
  document.getElementById('modal-export-options').classList.remove('on');
  _exportType = null;
}

function getExportOptions() {
  const options = {};
  document.querySelectorAll('.export-checkbox').forEach(cb => {
    options[cb.dataset.type] = cb.checked;
  });
  return options;
}

function confirmExportOptions() {
  const options = getExportOptions();
  document.getElementById('modal-export-options').classList.remove('on');
  
  if (_exportType === 'png') {
    doExportPNG(options);
  } else if (_exportType === 'pdf') {
    doExportPDF(options);
  } else if (_exportType === 'json') {
    doExportJSON(options);
  }
  
  _exportType = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT PNG - HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSVGToCanvas(ctx, f, options = {}) {

  // Helper: garantit que l'item a un tableau points
  const withPoints = (item) => {
    ensurePolygon(item);
    return item.points && item.points.length >= 3 ? item : null;
  };

  // Helper: dessine un polygone rempli
  const drawPoly = (points, fillColor, strokeColor, alpha, lineWidth, dash=[]) => {
    if (!points || points.length < 3) return;
    ctx.save();
    ctx.setLineDash(dash.length ? dash : []);
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    points.forEach(p => ctx.lineTo(p.x, p.y));
    ctx.closePath();
    ctx.globalAlpha = alpha;
    ctx.fillStyle = fillColor;
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.strokeStyle = strokeColor;
    ctx.lineWidth = lineWidth;
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.restore();
  };

  // Helper: texte centrÃ© avec halo noir pour lisibilitÃ©
  const drawLabel = (text, cx, cy, color, fontSize=12, fontWeight='bold') => {
    if (!text) return;
    const t = text.length > 20 ? text.substring(0,18)+'â€¦' : text;
    ctx.save();
    ctx.font = `${fontWeight} ${fontSize}px Arial, sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.lineWidth = 3;
    ctx.strokeStyle = '#000';
    ctx.globalAlpha = 0.7;
    ctx.strokeText(t, cx, cy);
    ctx.globalAlpha = 1;
    ctx.fillStyle = '#fff';
    ctx.fillText(t, cx, cy);
    ctx.restore();
  };

  // Helper: emoji depuis le cache prÃ©-chargÃ©
  const drawEmoji = (emoji, cx, cy, size=40) => {
    if (!emoji) return;
    const key = `${emoji}_${size}`;
    const img = _emojiCache[key];
    if (img) {
      ctx.drawImage(img, cx - size/2, cy - size/2, size, size);
    } else {
      // Fallback texte si pas en cache
      ctx.save();
      ctx.font = `${size * 0.8}px "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",sans-serif`;
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(emoji, cx, cy);
      ctx.restore();
    }
  };

  // Helper: cercle pour Ã©lÃ©ments ponctuels
  const drawCircle = (x, y, color, label, size=20) => {
    ctx.save();
    ctx.globalAlpha = 0.2;
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x, y, size, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
    ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x, y, size, 0, Math.PI*2); ctx.stroke();
    ctx.restore();
    if (label) drawLabel(label.length>14?label.substring(0,12)+'â€¦':label, x, y + size + 10, '#333', 10);
  };

  const getBounds = (points) => {
    const xs = points.map(p=>p.x), ys = points.map(p=>p.y);
    const x=Math.min(...xs), y=Math.min(...ys);
    return {x, y, w:Math.max(...xs)-x, h:Math.max(...ys)-y};
  };

  // Helper: draw background disc + monitor/desk icon on canvas
  const drawDeskIcon = (cx, cy, color, scale=1) => {
    ctx.save();
    // Background disc
    ctx.fillStyle = color; ctx.globalAlpha = 0.18;
    ctx.beginPath(); ctx.arc(cx, cy, 16*scale, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
    ctx.strokeStyle = color; ctx.lineWidth = 2.2 * scale; ctx.lineCap = 'round';
    // Monitor
    ctx.beginPath();
    ctx.rect(cx - 12*scale, cy - 8*scale, 24*scale, 15*scale);
    ctx.stroke();
    // Stand
    ctx.beginPath();
    ctx.moveTo(cx, cy + 7*scale); ctx.lineTo(cx, cy + 11*scale);
    ctx.moveTo(cx - 6*scale, cy + 11*scale); ctx.lineTo(cx + 6*scale, cy + 11*scale);
    ctx.stroke();
    ctx.restore();
  };

  // Helper: draw background disc + people icon on canvas
  const drawPeopleIcon = (cx, cy, color, scale=1) => {
    ctx.save();
    // Background disc
    ctx.fillStyle = color; ctx.globalAlpha = 0.18;
    ctx.beginPath(); ctx.arc(cx, cy, 16*scale, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
    ctx.strokeStyle = color; ctx.lineWidth = 2 * scale; ctx.lineCap = 'round';
    // Person 1
    ctx.beginPath(); ctx.arc(cx - 5*scale, cy - 5*scale, 3*scale, 0, Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx - 11*scale, cy + 5*scale);
    ctx.quadraticCurveTo(cx - 5*scale, cy - 1*scale, cx + 1*scale, cy + 5*scale); ctx.stroke();
    // Person 2
    ctx.beginPath(); ctx.arc(cx + 5*scale, cy - 5*scale, 3*scale, 0, Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx - 1*scale, cy + 5*scale);
    ctx.quadraticCurveTo(cx + 5*scale, cy - 1*scale, cx + 11*scale, cy + 5*scale); ctx.stroke();
    ctx.restore();
  };

  // Helper: draw background disc + moving box icon on canvas
  const drawMoveBoxIcon = (cx, cy, color, scale=1) => {
    ctx.save();
    // Background disc
    ctx.fillStyle = color; ctx.globalAlpha = 0.18;
    ctx.beginPath(); ctx.arc(cx, cy + 2*scale, 18*scale, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
    ctx.strokeStyle = color; ctx.lineWidth = 2.2 * scale; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    // Box body
    ctx.beginPath();
    ctx.rect(cx - 14*scale, cy - 2*scale, 28*scale, 16*scale);
    ctx.stroke();
    // Box flaps
    ctx.lineWidth = 2 * scale;
    ctx.beginPath();
    ctx.moveTo(cx - 14*scale, cy - 2*scale);
    ctx.lineTo(cx - 9*scale, cy - 8*scale);
    ctx.lineTo(cx, cy - 4*scale);
    ctx.lineTo(cx + 9*scale, cy - 8*scale);
    ctx.lineTo(cx + 14*scale, cy - 2*scale);
    ctx.stroke();
    // Arrow
    ctx.beginPath();
    ctx.moveTo(cx - 6*scale, cy + 6*scale); ctx.lineTo(cx + 6*scale, cy + 6*scale);
    ctx.moveTo(cx + 2*scale, cy + 2.5*scale); ctx.lineTo(cx + 6*scale, cy + 6*scale); ctx.lineTo(cx + 2*scale, cy + 9.5*scale);
    ctx.stroke();
    ctx.restore();
  };

  // â”€â”€ BUREAUX â”€â”€
  if (options.rooms !== false) {
    f.rooms.forEach((r, i) => {
      const item = withPoints(r); if (!item) return;
      const color = r.retired ? RETIRED_COLOR : (r.customColor || roomColor(f.id, i));
      drawPoly(item.points, color, color, 0.15, 2);
      const b = getBounds(item.points);
      const cx = b.x+b.w/2, cy = b.y+b.h/2;
      let yOff = 0;
      if (b.h > 55) {
        drawDeskIcon(cx, cy - 12, color);
        yOff = 10;
      }
      drawLabel(r.name, cx, cy + yOff, color, 13);
      yOff += 14;
      if (r.people && r.people.length > 0) {
        const maxP = Math.min(r.people.length, Math.floor((b.y + b.h - (cy + yOff) - 4) / 11));
        r.people.slice(0, maxP).forEach(p => {
          drawLabel(p, cx, cy + yOff, '#fff', 9, 'normal');
          yOff += 11;
        });
      }
      if (r.socketNums) {
        drawLabel('ğŸ”Œ ' + r.socketNums, cx, cy + yOff, '#80ffea', 8, 'bold');
        yOff += 11;
      }
      if (r.retired) drawLabel('â›” RetirÃ©(e)' + (r.retiredDate ? ' â€” ' + new Date(r.retiredDate).toLocaleDateString('fr-FR') : ''), cx, b.y + 12, '#ff4444', 11, 'bold');
    });
  }

  // â”€â”€ SALLES DE RÃ‰UNION â”€â”€
  if (options.meetings !== false) {
    (f.meetings||[]).forEach(m => {
      const item = withPoints(m); if (!item) return;
      const color = m.retired ? RETIRED_COLOR : (m.customColor || '#3ddc97');
      drawPoly(item.points, color, color, 0.15, 2);
      const b = getBounds(item.points);
      const cx = b.x+b.w/2, cy = b.y+b.h/2;
      const capStr = m.capacity ? `ğŸ‘¥ ${m.capacity} places` : '';
      const info = `${(m.screenType==='tactile'?'Tactile':m.screenType==='videoprojecteur'?'VidÃ©oproj.':'Classique')} ${m.screenSize}"${m.hasMTR?' + MTR':''}${m.hasClickshare?' + CS':''}${m.hasWepresent?' + WP':''}`;
      if (b.w > 80 && b.h > 55) {
        drawPeopleIcon(cx, cy - 12, color);
        drawLabel(m.name, cx, cy + 6, color, 12);
        if (capStr) drawLabel(capStr, cx, cy + 18, '#fff', 9, 'bold');
        drawLabel(info, cx, cy + (capStr ? 30 : 20), color, 9, 'normal');
      } else {
        drawLabel(m.name, cx, cy - 8, color, 12);
        drawLabel(info, cx, cy + 8, color, 9, 'normal');
      }
      if (m.retired) drawLabel('â›” RetirÃ©(e)' + (m.retiredDate ? ' â€” ' + new Date(m.retiredDate).toLocaleDateString('fr-FR') : ''), cx, b.y + 12, '#ff4444', 11, 'bold');
    });
  }

  // â”€â”€ DÃ‰MÃ‰NAGEMENTS â”€â”€
  if (options.moves !== false) {
    (f.moves||[]).forEach(mv => {
      const item = withPoints(mv); if (!item) return;
      const color = mv.retired ? RETIRED_COLOR : (mv.customColor || '#00e5cc');
      drawPoly(item.points, color, color, 0.15, 3, [8,4]);
      const b = getBounds(item.points);
      const cx = b.x+b.w/2, cy = b.y+b.h/2;
      let yOff = 0;
      if (b.h > 70) {
        drawMoveBoxIcon(cx, cy - 12, color);
        yOff = 10;
      }
      if (mv.name) { drawLabel(mv.name, cx, cy + yOff, '#fff', 12); yOff += 14; }
      if (mv.date) { drawLabel(new Date(mv.date).toLocaleDateString('fr-FR'), cx, cy + yOff, color, 10); yOff += 12; }
      const pcount = mv.people?.length||0;
      drawLabel(`${pcount} personne${pcount>1?'s':''}`, cx, cy + yOff, color, 10);
      if (mv.retired) drawLabel('â›” RetirÃ©(e)' + (mv.retiredDate ? ' â€” ' + new Date(mv.retiredDate).toLocaleDateString('fr-FR') : ''), cx, b.y + 12, '#ff4444', 11, 'bold');
    });
  }

  // â”€â”€ LOCAUX TECHNIQUES â”€â”€
  if (options.techrooms !== false) {
    (f.techrooms||[]).forEach(tr => {
      const item = withPoints(tr); if (!item) return;
      const color = tr.retired ? RETIRED_COLOR : (tr.customColor || '#2196f3');
      drawPoly(item.points, color, color, 0.15, 2.5);
      const b = getBounds(item.points);
      const cx = b.x+b.w/2, cy = b.y+b.h/2;
      ctx.save();
      ctx.strokeStyle = color; ctx.lineWidth = 1.5;
      [-6, 0, 6].forEach(dy => {
        ctx.beginPath(); ctx.rect(cx-9, cy-12+dy, 18, 4); ctx.stroke();
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.arc(cx-6, cy-10+dy, 0.8, 0, Math.PI*2); ctx.fill();
      });
      ctx.restore();
      drawLabel(tr.name, cx, cy + 14, color, 11);
      if (tr.retired) drawLabel('â›” RetirÃ©(e)', cx, b.y + 12, '#ff4444', 11, 'bold');
    });
  }

  // â”€â”€ ZONES LIBRES â”€â”€
  if (options.freezones !== false) {
    (f.freezones||[]).forEach(fz => {
      const item = withPoints(fz); if (!item) return;
      const color = fz.retired ? RETIRED_COLOR : (fz.customColor || fz.color || '#a78bfa');
      drawPoly(item.points, color, color, 0.15, 2, [6,3]);
      const b = getBounds(item.points);
      const cx = b.x+b.w/2, cy = b.y+b.h/2;
      if (fz.icon) {
        drawEmoji(fz.icon, cx, cy - 16, 40);
        drawLabel(fz.name, cx, cy + 16, color, 12);
      } else {
        drawLabel(fz.name, cx, cy, color, 12);
      }
      if (fz.retired) drawLabel('â›” RetirÃ©(e)', cx, b.y + 12, '#ff4444', 11, 'bold');
    });
  }

  // â”€â”€ Helper: label badge (fond colorÃ© + texte blanc) â”€â”€
  const drawBadgeLabel = (text, cx, cy, color, fontSize=10) => {
    if (!text) return;
    const t = text.length > 14 ? text.substring(0,12)+'â€¦' : text;
    ctx.save();
    ctx.font = `bold ${fontSize}px Arial, sans-serif`;
    const tw = ctx.measureText(t).width;
    const pw = Math.max(tw + 12, 70);
    ctx.fillStyle = color; ctx.globalAlpha = 0.9;
    const rx=4, bx=cx-pw/2, by=cy-9, bw=pw, bh=18;
    ctx.beginPath();
    ctx.moveTo(bx+rx, by); ctx.lineTo(bx+bw-rx, by);
    ctx.quadraticCurveTo(bx+bw, by, bx+bw, by+rx);
    ctx.lineTo(bx+bw, by+bh-rx);
    ctx.quadraticCurveTo(bx+bw, by+bh, bx+bw-rx, by+bh);
    ctx.lineTo(bx+rx, by+bh);
    ctx.quadraticCurveTo(bx, by+bh, bx, by+bh-rx);
    ctx.lineTo(bx, by+rx);
    ctx.quadraticCurveTo(bx, by, bx+rx, by);
    ctx.closePath(); ctx.fill();
    ctx.globalAlpha = 1; ctx.fillStyle = '#fff';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(t, cx, cy);
    ctx.restore();
  };

  // â”€â”€ COPIEURS (icÃ´ne multifonction) â”€â”€
  if (options.copiers !== false) (f.copiers||[]).forEach(c => {
    const color = c.retired ? RETIRED_COLOR : (c.customColor || '#ff6b35'), x = c.x, y = c.y;
    const sz = (c.iconSize || 22) / 22;
    drawCircle(x, y, color, null, 20*sz);
    ctx.save(); ctx.strokeStyle = color; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.rect(x-10, y-10, 20, 5); ctx.stroke();
    ctx.beginPath(); ctx.rect(x-12, y-4, 24, 8); ctx.stroke();
    ctx.beginPath(); ctx.rect(x-10, y+5, 20, 5); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x-7, y-1); ctx.lineTo(x+7, y-1);
    ctx.moveTo(x-7, y+1); ctx.lineTo(x+7, y+1); ctx.stroke();
    ctx.restore();
    drawBadgeLabel(c.name, x, y+36, color);
  });

  // â”€â”€ IMPRIMANTES (icÃ´ne imprimante) â”€â”€
  if (options.printers !== false) (f.printers||[]).forEach(p => {
    const color = p.retired ? RETIRED_COLOR : (p.customColor || '#4f8aff'), x = p.x, y = p.y;
    const sz = (p.iconSize || 22) / 22;
    drawCircle(x, y, color, null, 20*sz);
    ctx.save(); ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    ctx.beginPath();
    ctx.moveTo(x-6, y-8); ctx.lineTo(x-6, y-4); ctx.lineTo(x+6, y-4); ctx.lineTo(x+6, y-8); ctx.stroke();
    ctx.beginPath(); ctx.rect(x-9, y-4, 18, 6); ctx.stroke();
    ctx.beginPath(); ctx.rect(x-6, y+2, 12, 6); ctx.stroke();
    ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x+5, y-1, 1, 0, Math.PI*2); ctx.fill();
    ctx.restore();
    drawBadgeLabel(p.name, x, y+34, color);
  });

  // â”€â”€ Ã‰CRANS TV (cercle + icÃ´ne moniteur) â”€â”€
  if (options.screens !== false) (f.screens||[]).forEach(sc => {
    const color = sc.retired ? RETIRED_COLOR : (sc.customColor || '#9b87f5'), x = sc.x, y = sc.y;
    ctx.save();
    ctx.globalAlpha = 0.2; ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x, y, 20, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1; ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x, y, 20, 0, Math.PI*2); ctx.stroke();
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.rect(x-10, y-9, 20, 13); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x, y+4); ctx.lineTo(x, y+8);
    ctx.moveTo(x-4, y+8); ctx.lineTo(x+4, y+8); ctx.stroke();
    ctx.restore();
    const scrLabel = `${sc.size||''}" ${sc.brand||''}`.trim().substring(0,14);
    drawBadgeLabel(scrLabel || sc.name, x, y+36, color, 9);
  });

  // â”€â”€ AFFICHAGES DYNAMIQUES (cercle + icÃ´ne TV) â”€â”€
  if (options.displays !== false) (f.displays||[]).forEach(dp => {
    const color = dp.retired ? RETIRED_COLOR : (dp.customColor || '#ffaa33'), x = dp.x, y = dp.y;
    ctx.save();
    ctx.globalAlpha = 0.18; ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x, y, 22, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1; ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x, y, 22, 0, Math.PI*2); ctx.stroke();
    ctx.lineWidth = 1.8;
    ctx.beginPath(); ctx.rect(x-12, y-11, 24, 16); ctx.stroke();
    ctx.globalAlpha = 0.25; ctx.fillStyle = color;
    ctx.beginPath(); ctx.rect(x-10, y-9, 20, 12); ctx.fill();
    ctx.globalAlpha = 1; ctx.strokeStyle = color; ctx.lineWidth = 1.2;
    ctx.beginPath(); ctx.moveTo(x-7, y-5); ctx.lineTo(x+7, y-5);
    ctx.moveTo(x-7, y-2); ctx.lineTo(x+3, y-2);
    ctx.moveTo(x-7, y+1); ctx.lineTo(x, y+1); ctx.stroke();
    ctx.lineWidth = 1.5; ctx.lineCap = 'round';
    ctx.beginPath(); ctx.moveTo(x-3, y+5); ctx.lineTo(x-3, y+8);
    ctx.moveTo(x+3, y+5); ctx.lineTo(x+3, y+8);
    ctx.moveTo(x-6, y+8); ctx.lineTo(x+6, y+8); ctx.stroke();
    ctx.restore();
    drawBadgeLabel(dp.name, x, y+38, color, 9);
  });

  // â”€â”€ PRISES RÃ‰SEAU (cercle + icÃ´ne prise + badge compteur) â”€â”€
  if (options.sockets !== false) (f.sockets||[]).forEach(sock => {
    const color = sock.retired ? RETIRED_COLOR : (sock.customColor || '#00bfa5'), x = sock.x, y = sock.y;
    ctx.save();
    ctx.globalAlpha = 0.2; ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x, y, 20, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1; ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x, y, 20, 0, Math.PI*2); ctx.stroke();
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.rect(x-8, y-7, 16, 14); ctx.stroke();
    ctx.fillStyle = color;
    ctx.fillRect(x-4, y-2, 2, 4);
    ctx.fillRect(x+2, y-2, 2, 4);
    ctx.restore();
    if (sock.outlets && sock.outlets.length > 0) {
      ctx.save(); ctx.fillStyle = color;
      ctx.beginPath(); ctx.arc(x+14, y-14, 8, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(x+14, y-14, 8, 0, Math.PI*2); ctx.stroke();
      ctx.fillStyle = '#fff'; ctx.font = 'bold 10px Arial';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(sock.outlets.length+'', x+14, y-14);
      ctx.restore();
    }
    drawBadgeLabel(sock.name, x, y+34, color, 9);
  });

  // â”€â”€ VIDÃ‰OPROJECTEURS (cercle + icÃ´ne projecteur) â”€â”€
  if (options.projectors !== false) (f.projectors||[]).forEach(pj => {
    const color = pj.retired ? RETIRED_COLOR : (pj.customColor || '#e066ff'), x = pj.x, y = pj.y;
    ctx.save();
    ctx.globalAlpha = 0.18; ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x, y, 22, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1; ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x, y, 22, 0, Math.PI*2); ctx.stroke();
    // Body
    ctx.lineWidth = 1.8;
    ctx.beginPath(); ctx.rect(x-12, y-7, 24, 14); ctx.stroke();
    // Lens
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(x+6, y, 4, 0, Math.PI*2); ctx.stroke();
    // Beam
    ctx.lineWidth = 1; ctx.setLineDash([2,2]);
    ctx.beginPath(); ctx.moveTo(x+10, y-2); ctx.lineTo(x+18, y-6);
    ctx.moveTo(x+10, y+2); ctx.lineTo(x+18, y+6); ctx.stroke();
    ctx.setLineDash([]);
    ctx.restore();
    drawBadgeLabel(pj.name, x, y+38, color, 9);
  });

  // â”€â”€ TRACEURS (cercle + icÃ´ne traceur) â”€â”€
  if (options.plotters !== false) (f.plotters||[]).forEach(pl => {
    const color = pl.retired ? RETIRED_COLOR : (pl.customColor || '#00acc1'), x = pl.x, y = pl.y;
    ctx.save();
    ctx.globalAlpha = 0.18; ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x, y, 22, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1; ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x, y, 22, 0, Math.PI*2); ctx.stroke();
    // Body
    ctx.lineWidth = 1.8;
    ctx.beginPath(); ctx.rect(x-14, y-8, 28, 12); ctx.stroke();
    // Paper output
    ctx.lineWidth = 1.3;
    ctx.beginPath(); ctx.moveTo(x-10, y+4); ctx.lineTo(x-10, y+10);
    ctx.lineTo(x+10, y+10); ctx.lineTo(x+10, y+4); ctx.stroke();
    // Feed line
    ctx.lineWidth = 1.2;
    ctx.beginPath(); ctx.moveTo(x-10, y-2); ctx.lineTo(x+10, y-2); ctx.stroke();
    // Button
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x+10, y-5, 1.2, 0, Math.PI*2); ctx.fill();
    ctx.restore();
    drawBadgeLabel(pl.name, x, y+38, color, 9);
  });
}

function drawInfoPanel(ctx, f, x, width, height, options = {}) {
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(x, 0, width, height);
  
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x, 0);
  ctx.lineTo(x, height);
  ctx.stroke();
  
  let y = 30;
  const padding = 20;
  const innerW = width - padding * 2;
  
  // â”€â”€ Title â”€â”€
  ctx.fillStyle = '#333';
  ctx.font = 'bold 16px Arial';
  ctx.fillText(f.name, x + padding, y);
  y += 14;
  
  ctx.font = '10px Arial';
  ctx.fillStyle = '#888';
  ctx.fillText(new Date().toLocaleDateString('fr-FR') + '  â€¢  Modificateur de plan', x + padding, y);
  y += 20;
  
  // SÃ©parateur
  const drawSep = () => {
    ctx.strokeStyle = '#ddd'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x + padding, y); ctx.lineTo(x + width - padding, y); ctx.stroke();
    y += 14;
  };
  drawSep();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  LÃ‰GENDE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ctx.font = 'bold 13px Arial';
  ctx.fillStyle = '#333';
  ctx.fillText('LÃ‰GENDE', x + padding, y);
  y += 18;

  // Helper: rounded rect path
  const rrect = (rx, ry, rw, rh, r) => {
    ctx.beginPath();
    ctx.moveTo(rx+r, ry); ctx.lineTo(rx+rw-r, ry);
    ctx.quadraticCurveTo(rx+rw, ry, rx+rw, ry+r);
    ctx.lineTo(rx+rw, ry+rh-r);
    ctx.quadraticCurveTo(rx+rw, ry+rh, rx+rw-r, ry+rh);
    ctx.lineTo(rx+r, ry+rh);
    ctx.quadraticCurveTo(rx, ry+rh, rx, ry+rh-r);
    ctx.lineTo(rx, ry+r);
    ctx.quadraticCurveTo(rx, ry, rx+r, ry);
    ctx.closePath();
  };

  // Helper: draw legend row with icon and label
  const legendRow = (drawIcon, label, color) => {
    const iconX = x + padding + 12;
    const iconY = y;
    ctx.save();
    drawIcon(ctx, iconX, iconY, color);
    ctx.restore();
    ctx.fillStyle = '#333';
    ctx.font = '11px Arial';
    ctx.textAlign = 'left'; ctx.textBaseline = 'middle';
    ctx.fillText(label, x + padding + 30, iconY);
    // Color hex (right-aligned)
    ctx.fillStyle = '#aaa';
    ctx.font = '9px "Courier New", monospace';
    ctx.textAlign = 'right';
    ctx.fillText(color, x + width - padding, iconY);
    ctx.textAlign = 'left';
    y += 22;
  };

  // â”€â”€ Bureau â”€â”€
  if (options.rooms !== false) {
    legendRow((c, cx, cy, col) => {
      c.fillStyle = col; c.globalAlpha = 0.25;
      rrect(cx-10, cy-7, 20, 14, 2); c.fill();
      c.globalAlpha = 1; c.strokeStyle = col; c.lineWidth = 1.5;
      rrect(cx-10, cy-7, 20, 14, 2); c.stroke();
    }, 'Bureau', '#4f8aff');
  }

  // â”€â”€ Salle de rÃ©union â”€â”€
  if (options.meetings !== false) {
    legendRow((c, cx, cy, col) => {
      c.fillStyle = col; c.globalAlpha = 0.25;
      rrect(cx-10, cy-7, 20, 14, 2); c.fill();
      c.globalAlpha = 1; c.strokeStyle = col; c.lineWidth = 1.5;
      rrect(cx-10, cy-7, 20, 14, 2); c.stroke();
    }, 'Salle de rÃ©union', '#3ddc97');
  }

  // â”€â”€ DÃ©mÃ©nagement â”€â”€
  if (options.moves !== false) {
    legendRow((c, cx, cy, col) => {
      c.fillStyle = col; c.globalAlpha = 0.25;
      rrect(cx-10, cy-7, 20, 14, 2); c.fill();
      c.globalAlpha = 1; c.strokeStyle = col; c.lineWidth = 1.5;
      c.setLineDash([4, 2]);
      rrect(cx-10, cy-7, 20, 14, 2); c.stroke();
      c.setLineDash([]);
    }, 'DÃ©mÃ©nagement', '#00e5cc');
  }

  // â”€â”€ Local technique â”€â”€
  if (options.techrooms !== false) {
    legendRow((c, cx, cy, col) => {
      c.strokeStyle = col; c.lineWidth = 1.2;
      [-4, 0, 4].forEach(dy => {
        rrect(cx-8, cy+dy-2, 16, 3.5, 0.5); c.stroke();
        c.fillStyle = col;
        c.beginPath(); c.arc(cx-5, cy+dy-0.5, 0.8, 0, Math.PI*2); c.fill();
      });
    }, 'Local technique', '#2196f3');
  }

  // â”€â”€ Zone libre â”€â”€
  if (options.freezones !== false) {
    legendRow((c, cx, cy, col) => {
      c.fillStyle = col; c.globalAlpha = 0.25;
      rrect(cx-10, cy-7, 20, 14, 2); c.fill();
      c.globalAlpha = 1; c.strokeStyle = col; c.lineWidth = 1.5;
      c.setLineDash([3, 2]);
      rrect(cx-10, cy-7, 20, 14, 2); c.stroke();
      c.setLineDash([]);
    }, 'Zone libre', '#a78bfa');
  }

  // â”€â”€ Copieur â”€â”€
  if (options.copiers !== false) {
    legendRow((c, cx, cy, col) => {
      c.strokeStyle = col; c.lineWidth = 1.2;
      // Scanner
      rrect(cx-7, cy-6, 14, 3.5, 0.5); c.stroke();
      // Body
      rrect(cx-8, cy-1.5, 16, 5, 0.5); c.stroke();
      // Tray
      rrect(cx-7, cy+4.5, 14, 3, 0.5); c.stroke();
    }, 'Copieur', '#ff6b35');
  }

  // â”€â”€ Imprimante â”€â”€
  if (options.printers !== false) {
    legendRow((c, cx, cy, col) => {
      c.strokeStyle = col; c.lineWidth = 1.2; c.lineCap = 'round';
      // Paper top
      c.beginPath(); c.moveTo(cx-4, cy-6); c.lineTo(cx-4, cy-3); c.lineTo(cx+4, cy-3); c.lineTo(cx+4, cy-6); c.stroke();
      // Body
      rrect(cx-6, cy-3, 12, 4, 0.5); c.stroke();
      // Output
      rrect(cx-4, cy+1.5, 8, 4, 0.5); c.stroke();
      // Button
      c.fillStyle = col;
      c.beginPath(); c.arc(cx+3, cy-1, 0.8, 0, Math.PI*2); c.fill();
    }, 'Imprimante', '#4f8aff');
  }

  // â”€â”€ Ã‰cran TV â”€â”€
  if (options.screens !== false) {
    legendRow((c, cx, cy, col) => {
      // Circle
      c.fillStyle = col; c.globalAlpha = 0.2;
      c.beginPath(); c.arc(cx, cy, 9, 0, Math.PI*2); c.fill();
      c.globalAlpha = 1; c.strokeStyle = col; c.lineWidth = 1;
      c.beginPath(); c.arc(cx, cy, 9, 0, Math.PI*2); c.stroke();
      // Monitor
      c.strokeStyle = col; c.lineWidth = 1;
      rrect(cx-6, cy-5, 12, 8, 1); c.stroke();
      c.beginPath(); c.moveTo(cx, cy+3); c.lineTo(cx, cy+5.5); c.stroke();
      c.beginPath(); c.moveTo(cx-3, cy+5.5); c.lineTo(cx+3, cy+5.5); c.stroke();
    }, 'Ã‰cran TV', '#9b87f5');
  }

  // â”€â”€ Affichage dynamique â”€â”€
  if (options.displays !== false) {
    legendRow((c, cx, cy, col) => {
      // Circle
      c.fillStyle = col; c.globalAlpha = 0.18;
      c.beginPath(); c.arc(cx, cy, 9, 0, Math.PI*2); c.fill();
      c.globalAlpha = 1; c.strokeStyle = col; c.lineWidth = 1;
      c.beginPath(); c.arc(cx, cy, 9, 0, Math.PI*2); c.stroke();
      // TV
      c.strokeStyle = col; c.lineWidth = 1.2;
      rrect(cx-7, cy-5, 14, 9, 1); c.stroke();
      // Lines
      c.lineWidth = 0.8;
      c.beginPath(); c.moveTo(cx-4, cy-2); c.lineTo(cx+4, cy-2); c.stroke();
      c.beginPath(); c.moveTo(cx-4, cy); c.lineTo(cx+2, cy); c.stroke();
      // Stand
      c.lineWidth = 1; c.lineCap = 'round';
      c.beginPath(); c.moveTo(cx-2, cy+4); c.lineTo(cx-2, cy+6); c.moveTo(cx+2, cy+4); c.lineTo(cx+2, cy+6);
      c.moveTo(cx-4, cy+6); c.lineTo(cx+4, cy+6); c.stroke();
    }, 'Affichage dynamique', '#ffaa33');
  }

  // â”€â”€ VidÃ©oprojecteur â”€â”€
  if (options.projectors !== false) {
    legendRow((c, cx, cy, col) => {
      c.fillStyle = col; c.globalAlpha = 0.2;
      c.beginPath(); c.arc(cx, cy, 9, 0, Math.PI*2); c.fill();
      c.globalAlpha = 1; c.strokeStyle = col; c.lineWidth = 1;
      c.beginPath(); c.arc(cx, cy, 9, 0, Math.PI*2); c.stroke();
      c.lineWidth = 1.2;
      c.beginPath(); c.rect(cx-7, cy-4, 14, 8); c.stroke();
      c.beginPath(); c.arc(cx+3, cy, 2.5, 0, Math.PI*2); c.stroke();
    }, 'VidÃ©oprojecteur', '#e066ff');
  }

  // â”€â”€ Traceur â”€â”€
  if (options.plotters !== false) {
    legendRow((c, cx, cy, col) => {
      c.fillStyle = col; c.globalAlpha = 0.2;
      c.beginPath(); c.arc(cx, cy, 9, 0, Math.PI*2); c.fill();
      c.globalAlpha = 1; c.strokeStyle = col; c.lineWidth = 1;
      c.beginPath(); c.arc(cx, cy, 9, 0, Math.PI*2); c.stroke();
      c.lineWidth = 1.2;
      c.beginPath(); c.rect(cx-8, cy-5, 16, 8); c.stroke();
      c.beginPath(); c.moveTo(cx-6, cy+3); c.lineTo(cx-6, cy+6);
      c.lineTo(cx+6, cy+6); c.lineTo(cx+6, cy+3); c.stroke();
    }, 'Traceur', '#00acc1');
  }

  // â”€â”€ Prise rÃ©seau â”€â”€
  if (options.sockets !== false) {
    legendRow((c, cx, cy, col) => {
      // Circle
      c.fillStyle = col; c.globalAlpha = 0.2;
      c.beginPath(); c.arc(cx, cy, 9, 0, Math.PI*2); c.fill();
      c.globalAlpha = 1; c.strokeStyle = col; c.lineWidth = 1;
      c.beginPath(); c.arc(cx, cy, 9, 0, Math.PI*2); c.stroke();
      // Socket box
      c.strokeStyle = col; c.lineWidth = 1;
      rrect(cx-5, cy-4, 10, 8, 1); c.stroke();
      // Holes
      c.fillStyle = col;
      c.fillRect(cx-3, cy-1.5, 1.5, 3);
      c.fillRect(cx+1.5, cy-1.5, 1.5, 3);
    }, 'Prise rÃ©seau', '#00bfa5');
  }

  y += 6;
  drawSep();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  INVENTAIRE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ctx.font = 'bold 13px Arial';
  ctx.fillStyle = '#333';
  ctx.fillText('INVENTAIRE', x + padding, y);
  y += 18;
  
  // Sections with color bullets
  const addSection = (title, items, color) => {
    if (items.length === 0) return;
    // Color bullet + title
    ctx.save();
    ctx.fillStyle = color; ctx.globalAlpha = 0.9;
    rrect(x + padding, y - 8, 8, 8, 2); ctx.fill();
    ctx.globalAlpha = 1;
    ctx.restore();
    ctx.font = 'bold 11px Arial';
    ctx.fillStyle = '#333';
    ctx.fillText(`${title} (${items.length})`, x + padding + 12, y - 3);
    y += 14;
    
    ctx.font = '10px Arial';
    ctx.fillStyle = '#555';
    items.forEach(item => {
      if (y > height - 20) return; // overflow protection
      const name = item.name || item || '(sans nom)';
      ctx.fillText('  ' + (name.length > 28 ? name.substring(0, 26) + 'â€¦' : name), x + padding + 5, y);
      y += 13;
    });
    y += 8;
  };
  
  if (options.rooms !== false) addSection('BUREAUX', f.rooms, '#4f8aff');
  if (options.copiers !== false) addSection('COPIEURS', f.copiers, '#ff6b35');
  if (options.printers !== false) addSection('IMPRIMANTES', f.printers, '#4f8aff');
  if (options.meetings !== false) addSection('SALLES DE RÃ‰UNION', f.meetings, '#3ddc97');
  if (options.screens !== false) addSection('Ã‰CRANS', f.screens||[], '#9b87f5');
  if (options.displays !== false) addSection('AFFICHAGES', f.displays||[], '#ffaa33');
  if (options.techrooms !== false) addSection('LOCAUX TECH', f.techrooms||[], '#2196f3');
  if (options.sockets !== false) addSection('PRISES RÃ‰SEAU', f.sockets||[], '#00bfa5');
  if (options.projectors !== false) addSection('VIDÃ‰OPROJECTEURS', f.projectors||[], '#e066ff');
  if (options.plotters !== false) addSection('TRACEURS', f.plotters||[], '#00acc1');
  if (options.moves !== false) addSection('DÃ‰MÃ‰NAGEMENTS', f.moves, '#00e5cc');
  if (options.freezones !== false) addSection('ZONES LIBRES', (f.freezones||[]).map(fz => ({name: (fz.icon?fz.icon+' ':'')+fz.name})), '#a78bfa');

  // â”€â”€ Stats rÃ©sumÃ© en bas â”€â”€
  if (y < height - 60) {
    y = Math.max(y + 10, height - 55);
    drawSep();
    ctx.font = 'bold 10px Arial';
    ctx.fillStyle = '#888';
    const stats = [];
    if (options.rooms !== false && f.rooms.length) stats.push(`${f.rooms.length} bureau${f.rooms.length>1?'x':''}`);
    if (options.copiers !== false && f.copiers.length) stats.push(`${f.copiers.length} copieur${f.copiers.length>1?'s':''}`);
    if (options.printers !== false && f.printers.length) stats.push(`${f.printers.length} imp.`);
    if (options.meetings !== false && f.meetings.length) stats.push(`${f.meetings.length} rÃ©union${f.meetings.length>1?'s':''}`);
    if (options.screens !== false && (f.screens||[]).length) stats.push(`${f.screens.length} Ã©cran${f.screens.length>1?'s':''}`);
    if (options.displays !== false && (f.displays||[]).length) stats.push(`${f.displays.length} affich.`);
    if (options.techrooms !== false && (f.techrooms||[]).length) stats.push(`${f.techrooms.length} local tech.`);
    if (options.sockets !== false && (f.sockets||[]).length) stats.push(`${f.sockets.length} prise${f.sockets.length>1?'s':''}`);
    if (options.projectors !== false && (f.projectors||[]).length) stats.push(`${f.projectors.length} vidÃ©oproj.`);
    if (options.plotters !== false && (f.plotters||[]).length) stats.push(`${f.plotters.length} traceur${f.plotters.length>1?'s':''}`);
    if (options.moves !== false && f.moves.length) stats.push(`${f.moves.length} dÃ©m.`);
    if (stats.length > 0) {
      ctx.fillText('RÃ©sumÃ© : ' + stats.join(' Â· '), x + padding, y);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT PNG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ PrÃ©-rendu des emojis en images PNG via canvas attachÃ© au DOM â”€â”€
async function renderEmojiToDataURL(emoji, size) {
  return new Promise(resolve => {
    const c = document.createElement('canvas');
    c.width = size * 2; c.height = size * 2;
    // Attache briÃ¨vement au DOM pour forcer le rendu emoji
    c.style.cssText = 'position:fixed;left:-9999px;top:-9999px;opacity:0;pointer-events:none;';
    document.body.appendChild(c);
    const tc = c.getContext('2d');
    tc.clearRect(0, 0, c.width, c.height);
    // DÃ©lai pour que le navigateur initialise le contexte emoji
    requestAnimationFrame(() => {
      tc.font = `${size * 1.6}px "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",sans-serif`;
      tc.textAlign = 'center';
      tc.textBaseline = 'middle';
      tc.fillText(emoji, size, size + 1);
      const dataURL = c.toDataURL('image/png');
      document.body.removeChild(c);
      resolve(dataURL);
    });
  });
}

// â”€â”€ Cache des emojis dÃ©jÃ  rendus â”€â”€
const _emojiCache = {};
async function getEmojiImage(emoji, size=40) {
  const key = `${emoji}_${size}`;
  if (_emojiCache[key]) return _emojiCache[key];
  const dataURL = await renderEmojiToDataURL(emoji, size);
  const img = new Image();
  await new Promise(r => { img.onload = r; img.src = dataURL; });
  _emojiCache[key] = img;
  return img;
}

function exportPNG() {
  openExportOptionsModal('png');
}

async function doExportPNG(options) {
  const f = activeFloor();
  if (!f || !f.imageB64) { alert('Veuillez charger un plan avant d\'exporter en PNG.'); return; }

  notify('GÃ©nÃ©ration du PNG en cours...');

  try {
    // PrÃ©-charger tous les emojis des freezones
    const emojiPromises = (f.freezones||[])
      .filter(fz => fz.icon)
      .map(fz => getEmojiImage(fz.icon, 40));
    await Promise.all(emojiPromises);

    const PANEL_WIDTH = 300;
    const canvas = document.createElement('canvas');
    canvas.width = f.imageW + PANEL_WIDTH;
    canvas.height = f.imageH;
    const ctx = canvas.getContext('2d');

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const planImg = new Image();
    await new Promise((res, rej) => { planImg.onload=res; planImg.onerror=rej; planImg.src=f.imageB64; });
    ctx.drawImage(planImg, 0, 0);

    renderSVGToCanvas(ctx, f, options);
    drawInfoPanel(ctx, f, f.imageW, PANEL_WIDTH, f.imageH, options);

    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.download = `${f.name.replace(/[^a-z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Ã¦Å“ ]/gi, '_').replace(/ +/g, '_')}.png`;
      link.href = url;
      link.click();
      setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(link); }, 100);
      notify('Export PNG rÃ©ussi !');
    }, 'image/png');

  } catch(err) {
    console.error('Export PNG error:', err);
    alert('Erreur lors de l\'export PNG: ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPDF() {
  openExportOptionsModal('pdf');
}

async function doExportPDF(options) {
  const f = activeFloor();
  if (!f || !f.imageB64) { alert('Veuillez charger un plan avant d\'exporter en PDF.'); return; }

  notify('GÃ©nÃ©ration du PDF en cours...');

  try {
    // PrÃ©-charger tous les emojis
    const emojiPromises = (f.freezones||[])
      .filter(fz => fz.icon)
      .map(fz => getEmojiImage(fz.icon, 40));
    await Promise.all(emojiPromises);

    const PANEL_WIDTH = 300;
    const canvas = document.createElement('canvas');
    canvas.width = f.imageW + PANEL_WIDTH;
    canvas.height = f.imageH;
    const ctx = canvas.getContext('2d');

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const planImg = new Image();
    await new Promise((res, rej) => { planImg.onload=res; planImg.onerror=rej; planImg.src=f.imageB64; });
    ctx.drawImage(planImg, 0, 0);

    renderSVGToCanvas(ctx, f, options);
    drawInfoPanel(ctx, f, f.imageW, PANEL_WIDTH, f.imageH, options);

    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const ratio = canvas.width / canvas.height;

    let pdfWidth, pdfHeight;
    if (ratio > 1.414) {
      pdfWidth = 297; pdfHeight = pdfWidth / ratio;
      if (pdfHeight > 210) { pdfHeight = 210; pdfWidth = pdfHeight * ratio; }
    } else {
      pdfHeight = 297; pdfWidth = pdfHeight * ratio;
      if (pdfWidth > 210) { pdfWidth = 210; pdfHeight = pdfWidth / ratio; }
    }

    const pdf = new jsPDF({ orientation: ratio > 1 ? 'landscape' : 'portrait', unit: 'mm', format: 'a4' });
    const xOffset = (pdf.internal.pageSize.getWidth() - pdfWidth) / 2;
    const yOffset = (pdf.internal.pageSize.getHeight() - pdfHeight) / 2;
    pdf.addImage(imgData, 'PNG', xOffset, yOffset, pdfWidth, pdfHeight);

    const pdfBlob = pdf.output('blob');
    const url = URL.createObjectURL(pdfBlob);
    const link = document.createElement('a');
    link.style.display = 'none';
    document.body.appendChild(link);
    link.href = url;
    link.download = `${f.name.replace(/[^a-z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Ã¦Å“ ]/gi, '_').replace(/ +/g, '_')}.pdf`;
    link.click();
    setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(link); }, 100);
    notify('Export PDF rÃ©ussi !');

  } catch(err) {
    console.error('Export PDF error:', err);
    alert('Erreur lors de l\'export PDF: ' + err.message);
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / IMPORT JSON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportJSON() {
  openExportOptionsModal('json');
}

async function doExportJSON(options = {}) {
  const prog = document.getElementById('progress');
  prog.style.transform = 'scaleX(0.3)';
  await new Promise(r => setTimeout(r, 80));
  prog.style.transform = 'scaleX(0.7)';
  await new Promise(r => setTimeout(r, 80));

  const data = {
    version: 7,
    exported: new Date().toISOString(),
    locations: S.locations,
    floorLevels: S.floorLevels,
    comSubSites: S.comSubSites,
    comSubSiteLevels: S.comSubSiteLevels,
    floors: S.floors.map(f => ({
      id: f.id, name: f.name, site: f.site, level: f.level, subSite: f.subSite || null,
      imageB64: f.imageB64,
      imageW: f.imageW, imageH: f.imageH,
      rooms: options.rooms !== false ? f.rooms : [],
      copiers: options.copiers !== false ? (f.copiers || []) : [],
      printers: options.printers !== false ? (f.printers || []) : [],
      meetings: options.meetings !== false ? (f.meetings || []) : [],
      moves: options.moves !== false ? (f.moves || []) : [],
      screens: options.screens !== false ? (f.screens || []) : [],
      techrooms: options.techrooms !== false ? (f.techrooms || []) : [],
      displays: options.displays !== false ? (f.displays || []) : [],
      sockets: options.sockets !== false ? (f.sockets || []) : [],
      projectors: options.projectors !== false ? (f.projectors || []) : [],
      plotters: options.plotters !== false ? (f.plotters || []) : [],
      freezones: options.freezones !== false ? (f.freezones || []) : []
    }))
  };

  prog.style.transform = 'scaleX(1)';
  await new Promise(r => setTimeout(r, 120));
  prog.style.transform = 'scaleX(0)';

  try {
    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], {type:'application/json'});
    
    // MÃ©thode compatible pour le tÃ©lÃ©chargement
    const a = document.createElement('a');
    a.style.display = 'none';
    document.body.appendChild(a);
    
    const url = URL.createObjectURL(blob);
    a.href = url;
    const jsonFloorName = (activeFloor()?.name || 'plan').replace(/[^a-z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Ã¦Å“ ]/gi, '_').replace(/ +/g, '_');
    a.download = `${jsonFloorName}.json`;
    a.click();
    
    // Cleanup aprÃ¨s un dÃ©lai
    setTimeout(() => {
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 100);
    
    notify('Export JSON rÃ©ussi â€” tout inclus !');
  } catch (err) {
    console.error('Export JSON error:', err);
    alert('Erreur lors de l\'export JSON: ' + err.message);
  }
}

function importJSON(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.floors) throw new Error('Format invalide : propriÃ©tÃ© "floors" manquante');

      S.locations = data.locations || ['Pfaffenhoffen', 'Haguenau', 'Rittershoffen', 'Reichshoffen', 'Soultz-sous-ForÃªts', 'COM', 'AVA', 'ARM', 'RBG', 'Molsheim', 'Erstein', 'Huningue', 'Planigy'];
      S.floorLevels = data.floorLevels || ['Sous-sol', 'RDC', '1er', '2Ã¨me', '3Ã¨me', '4Ã¨me', '5Ã¨me', '6Ã¨me'];
      S.comSubSites = data.comSubSites || ['Loge ASA', 'BS', 'BTI', 'BI', 'BE'];
      S.comSubSiteLevels = data.comSubSiteLevels || {
        'Loge ASA': ['RDC'], 'BS': ['RDC'],
        'BI': ['Sous-sol', 'RDC', '1er'],
        'BTI': ['Sous-sol', 'RDC', '1er', '2Ã¨me', '3Ã¨me', '4Ã¨me', '5Ã¨me', '6Ã¨me'],
        'BE':  ['Sous-sol', 'RDC', '1er', '2Ã¨me', '3Ã¨me', '4Ã¨me', '5Ã¨me', '6Ã¨me']
      };

      S.floors = data.floors.map(f => ({
        id: f.id,
        name: f.name,
        site: f.site || '',
        level: f.level || '',
        subSite: f.subSite || null,
        imageB64: f.imageB64 || null,
        imageW: f.imageW || 0,
        imageH: f.imageH || 0,
        rooms:     f.rooms     || [],
        copiers:   f.copiers   || [],
        printers:  f.printers  || [],
        meetings:  f.meetings  || [],
        moves:     f.moves     || [],
        screens:   f.screens   || [],
        techrooms: f.techrooms || [],
        displays:  f.displays  || [],
        sockets:   f.sockets   || [],
        projectors:f.projectors || [],
        plotters:  f.plotters   || [],
        freezones: f.freezones || []
      }));

      // Recalcul sÃ©curisÃ© du compteur d'ID
      const allIds = S.floors.flatMap(f => [
        f.id,
        ...f.rooms.map(r=>r.id),
        ...(f.copiers||[]).map(c=>c.id),
        ...(f.printers||[]).map(p=>p.id),
        ...(f.meetings||[]).map(m=>m.id),
        ...(f.moves||[]).map(m=>m.id),
        ...(f.screens||[]).map(s=>s.id),
        ...(f.techrooms||[]).map(t=>t.id),
        ...(f.displays||[]).map(d=>d.id),
        ...(f.sockets||[]).map(s=>s.id),
        ...(f.projectors||[]).map(p=>p.id),
        ...(f.plotters||[]).map(p=>p.id),
        ...(f.freezones||[]).map(z=>z.id)
      ]).filter(id => typeof id === 'number' && !isNaN(id));
      _id = (allIds.length > 0 ? Math.max(...allIds) : 0) + 1;

      S.activeFloor = S.floors[0]?.id ?? null;
      S.selectedRoom = null;
      renderFloorsBar();
      renderCanvas();
      renderRoomsList();
      renderEquipmentsList();
      renderMovesList();
      editorOpen(null);
      updateStats();
      notify('Plan importÃ© avec succÃ¨s !');
    } catch(err) {
      alert('Fichier JSON invalide : ' + err.message);
      console.error('Import JSON error:', err);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

let _notifTimer;
function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg; n.classList.add('on');
  clearTimeout(_notifTimer);
  _notifTimer = setTimeout(() => n.classList.remove('on'), 2600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEAVE WARNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _allowLeave = false;
let _pendingUnload = false;

function hasUnsavedData() {
  // VÃ©rifier s'il y a des donnÃ©es non vides
  return S.floors && S.floors.length > 0;
}

function showLeaveWarning(e) {
  if (_allowLeave || !hasUnsavedData()) return;
  
  // EmpÃªcher la fermeture immÃ©diate
  e.preventDefault();
  e.returnValue = ''; // NÃ©cessaire pour certains navigateurs
  
  // Afficher notre modal personnalisÃ©
  if (!_pendingUnload) {
    _pendingUnload = true;
    document.getElementById('modal-leave-warning').classList.add('on');
  }
  
  return '';
}

function cancelLeave() {
  _pendingUnload = false;
  document.getElementById('modal-leave-warning').classList.remove('on');
}

function confirmLeave() {
  _allowLeave = true;
  _pendingUnload = false;
  document.getElementById('modal-leave-warning').classList.remove('on');
  // L'utilisateur devra cliquer Ã  nouveau pour fermer/quitter
  notify('Vous pouvez maintenant fermer cette page.');
}

async function exportJSONAndStay() {
  const allOptions = {rooms:true, copiers:true, printers:true, meetings:true, screens:true, displays:true, techrooms:true, sockets:true, moves:true};
  await doExportJSON(allOptions);
  cancelLeave();
  notify('JSON exportÃ© ! Vous pouvez continuer Ã  travailler.');
}

async function exportPNGAndStay() {
  const allOptions = {rooms:true, copiers:true, printers:true, meetings:true, screens:true, displays:true, techrooms:true, sockets:true, moves:true};
  await doExportPNG(allOptions);
  cancelLeave();
  notify('PNG exportÃ© ! Vous pouvez continuer Ã  travailler.');
}

async function exportPDFAndStay() {
  const allOptions = {rooms:true, copiers:true, printers:true, meetings:true, screens:true, displays:true, techrooms:true, sockets:true, moves:true};
  await doExportPDF(allOptions);
  cancelLeave();
  notify('PDF exportÃ© ! Vous pouvez continuer Ã  travailler.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setMode('nav');
setupImageUpload();
setupDrawing();
setupPan();

// Warning avant de quitter la page
window.addEventListener('beforeunload', showLeaveWarning);

// Gestion des menus dÃ©roulants
function toggleDropdown(id) {
  const dropdown = document.getElementById(id);
  const wasOpen = dropdown.classList.contains('open');
  
  // Fermer tous les dropdowns
  closeAllDropdowns();
  
  // Ouvrir celui-ci si il Ã©tait fermÃ©
  if (!wasOpen) {
    dropdown.classList.add('open');
  }
}

function closeAllDropdowns() {
  document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
}

// Fermer les dropdowns en cliquant ailleurs
document.addEventListener('click', (e) => {
  if (!e.target.closest('.dropdown')) {
    closeAllDropdowns();
  }
});

// Hover-based dropdown avec dÃ©lai anti-flickering
let _dropdownCloseTimers = {};

document.querySelectorAll('.dropdown').forEach(dd => {
  const id = dd.id;
  
  dd.addEventListener('mouseenter', () => {
    // Annuler tout timer de fermeture en cours
    if (_dropdownCloseTimers[id]) {
      clearTimeout(_dropdownCloseTimers[id]);
      _dropdownCloseTimers[id] = null;
    }
  });
  
  dd.addEventListener('mouseleave', () => {
    // Fermer avec un dÃ©lai pour Ã©viter le flickering
    _dropdownCloseTimers[id] = setTimeout(() => {
      dd.classList.remove('open');
      _dropdownCloseTimers[id] = null;
    }, 250);
  });
});

// Setup enter key for move person input in modal
document.getElementById('modal-move-person-input').onkeydown = e => { 
  if (e.key==='Enter') addMovePerson(); 
};

// Setup enter key for location input in modal
document.getElementById('location-input').onkeydown = e => { 
  if (e.key==='Enter') addLocation(); 
};
</script>
</body>
</html>
