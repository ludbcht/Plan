<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modificateur de plan</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Supprimer temporairement console.warn pour éviter le warning de jsPDF
const originalWarn = console.warn;
console.warn = function(...args) {
  if (args[0] && args[0].includes && args[0].includes('Setting up fake worker')) return;
  originalWarn.apply(console, args);
};
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// Restaurer console.warn après chargement de jsPDF
setTimeout(() => { console.warn = originalWarn; }, 100);
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
:root {
  --bg:#0b0d12; --surface:#121520; --card:#181d2a; --card2:#1e2436;
  --border:#252c3f; --border2:#2e3650;
  --accent:#4f8aff; --accent2:#00e5cc; --warn:#ff5f57; --warn2:#ff6b35;
  --text:#e8ecf5; --muted:#6b7494; --success:#3ddc97;
  --font-display:'Syne',sans-serif; --font-mono:'JetBrains Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--font-display);display:flex;flex-direction:column;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* ── HEADER ─────────────────────────────────────── */
header{
  height:56px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;flex-shrink:0;z-index:200;
}
.logo{display:flex;align-items:center;gap:10px;}
.logo-mark{
  width:32px;height:32px;border-radius:8px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
}
.logo-mark svg{width:16px;height:16px;}
.logo-name{font-size:17px;font-weight:800;letter-spacing:-0.5px;}
.logo-name em{color:var(--accent2);font-style:normal;}
.header-right{display:flex;align-items:center;gap:8px;}

.chip{
  font-family:var(--font-mono);font-size:10px;
  padding:3px 10px;border-radius:20px;
  background:rgba(79,138,255,.12);color:var(--accent);
  border:1px solid rgba(79,138,255,.25);
}

/* ── TOOLBAR ─────────────────────────────────────── */
.toolbar{
  height:48px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:6px;padding:0 16px;flex-shrink:0;overflow:visible;
  position:relative;z-index:100;
}
.tg{display:flex;gap:4px;align-items:center;padding-right:12px;border-right:1px solid var(--border);}
.tg:last-child{border-right:none;padding-right:0;}

.btn{
  display:flex;align-items:center;gap:6px;
  font-family:var(--font-display);font-size:12px;font-weight:700;
  padding:6px 12px;border-radius:7px;border:1px solid var(--border2);
  background:var(--card);color:var(--text);cursor:pointer;
  transition:all .15s;white-space:nowrap;
}
.btn:hover{background:var(--card2);border-color:var(--accent);color:var(--accent);}
.btn.active{background:rgba(79,138,255,.15);border-color:var(--accent);color:var(--accent);}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
.btn.primary:hover{background:#6b9fff;}
.btn.success{background:rgba(61,220,151,.12);border-color:rgba(61,220,151,.35);color:var(--success);}
.btn.success:hover{background:rgba(61,220,151,.22);}
.btn.danger{background:rgba(255,95,87,.1);border-color:rgba(255,95,87,.3);color:var(--warn);}
.btn.danger:hover{background:rgba(255,95,87,.2);}
.btn svg{width:14px;height:14px;flex-shrink:0;}

/* ── DROPDOWN MENUS ────────────────────────────────── */
.dropdown{position:relative;}
.dropdown-toggle{cursor:pointer;}
.dropdown-menu{
  display:none;position:absolute;top:100%;left:0;margin-top:4px;
  background:var(--surface);border:1px solid var(--border);border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);min-width:200px;z-index:9999;
  padding:4px 0;
}
.dropdown.open .dropdown-menu{display:block;}
.dropdown:hover .dropdown-menu{display:block;}
.dropdown-menu button{
  width:100%;display:flex;align-items:center;gap:8px;
  padding:8px 16px;border:none;background:none;
  font-size:13px;font-weight:600;color:var(--text);
  text-align:left;cursor:pointer;transition:background .12s;
}
.dropdown-menu button:hover{background:var(--card2);}
.dropdown-menu button svg{width:16px;height:16px;color:var(--accent);}

/* ── FLOORS BAR ──────────────────────────────────── */
.floors-bar{
  height:42px;background:var(--card);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:0;padding:0 16px;flex-shrink:0;overflow-x:auto;
}
.floor-tab{
  display:flex;align-items:center;gap:8px;
  font-size:12px;font-weight:700;padding:6px 16px;
  cursor:pointer;border-radius:6px 6px 0 0;
  border:1px solid transparent;border-bottom:none;
  color:var(--muted);transition:all .15s;white-space:nowrap;
  position:relative;bottom:-1px;
}
.floor-tab:hover{color:var(--text);background:rgba(255,255,255,.04);}
.floor-tab.active{
  color:var(--accent2);background:var(--surface);
  border-color:var(--border);border-bottom-color:var(--surface);
}
.floor-tab .ft-del{
  width:16px;height:16px;border-radius:50%;
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:14px;line-height:1;transition:all .15s;
}
.floor-tab .ft-del:hover{background:rgba(255,95,87,.2);color:var(--warn);}
.add-floor-btn{
  font-size:13px;font-weight:700;color:var(--muted);
  cursor:pointer;padding:4px 10px;border-radius:6px;
  transition:all .15s;white-space:nowrap;
  display:flex;align-items:center;gap:5px;
}
.add-floor-btn:hover{color:var(--accent2);background:rgba(0,229,204,.08);}

/* ── MAIN ────────────────────────────────────────── */
.main{display:flex;flex:1;overflow:hidden;}

/* ── CANVAS AREA ─────────────────────────────────── */
.canvas-area{
  flex:1;position:relative;overflow:hidden;
  background:var(--bg);
  background-image:
    linear-gradient(rgba(79,138,255,.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(79,138,255,.03) 1px,transparent 1px);
  background-size:32px 32px;
}
.canvas-area.mode-draw{cursor:crosshair;}
.canvas-area.mode-nav{cursor:default;}
.canvas-area.mode-copier{cursor:copy;}
.canvas-area.mode-printer{cursor:crosshair;}
.canvas-area.mode-meeting{cursor:cell;}
.canvas-area.mode-move{cursor:move;}
.canvas-area.mode-edit-shape{cursor:pointer;}
.canvas-area.mode-screen{cursor:copy;}
.canvas-area.mode-techroom{cursor:crosshair;}
.canvas-area.mode-display{cursor:copy;}
.canvas-area.mode-socket{cursor:copy;}
.canvas-area.mode-freezone{cursor:crosshair;}

#canvas-root{position:absolute;top:0;left:0;transform-origin:0 0;}
#plan-img{position:absolute;top:0;left:0;user-select:none;pointer-events:none;opacity:.88;}
#svg-layer{position:absolute;top:0;left:0;overflow:visible;}

/* Drop zone */
#drop-zone{
  position:absolute;inset:0;display:flex;
  align-items:center;justify-content:center;z-index:10;
}
.dz-card{
  background:var(--surface);border:2px dashed var(--border2);
  border-radius:20px;padding:48px 64px;
  display:flex;flex-direction:column;align-items:center;gap:14px;
  cursor:pointer;transition:all .2s;text-align:center;
}
.dz-card:hover,.dz-card.over{border-color:var(--accent);background:rgba(79,138,255,.05);}
.dz-icon{opacity:.35;}
.dz-title{font-size:18px;font-weight:800;}
.dz-sub{font-size:13px;color:var(--muted);line-height:1.6;}

/* Drawing rect */
#draw-ghost{
  position:absolute;pointer-events:none;display:none;
  border:2px solid var(--accent2);background:rgba(0,229,204,.08);border-radius:3px;
}

/* Zoom HUD */
.zoom-hud{
  position:absolute;bottom:16px;right:16px;
  display:flex;flex-direction:column;align-items:center;gap:3px;
}
.zbtn{
  width:34px;height:34px;border-radius:8px;
  background:var(--card);border:1px solid var(--border2);
  color:var(--text);font-size:18px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.zbtn:hover{border-color:var(--accent);color:var(--accent);}
.zpct{font-family:var(--font-mono);font-size:10px;color:var(--muted);padding:2px;}

/* Coords HUD */
.coords-hud{
  position:absolute;bottom:16px;left:16px;
  font-family:var(--font-mono);font-size:10px;color:var(--muted);
  background:rgba(18,21,32,.7);padding:5px 10px;border-radius:6px;
  pointer-events:none;
}

/* ── SIDE PANEL ──────────────────────────────────── */
.side{
  width:340px;background:var(--surface);
  border-left:1px solid var(--border);
  display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;
}
.tabs{display:flex;border-bottom:1px solid var(--border);}
.tab{
  flex:1;padding:11px 6px;text-align:center;
  font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:var(--muted);cursor:pointer;
  border-bottom:2px solid transparent;transition:all .15s;
}
.tab.on{color:var(--accent2);border-bottom-color:var(--accent2);}
.tab-body{display:none;flex:1;overflow-y:auto;padding:14px;}
.tab-body.on{display:block;}

/* Empty state */
.es{display:flex;flex-direction:column;align-items:center;gap:10px;padding:32px 16px;text-align:center;color:var(--muted);}
.es-title{font-size:14px;font-weight:700;color:var(--text);opacity:.45;}
.es-sub{font-size:12px;line-height:1.6;}

/* Room list item */
.rli{
  display:flex;align-items:center;gap:8px;
  background:var(--card);border:1px solid var(--border);
  border-radius:9px;padding:9px 10px;margin-bottom:5px;
  cursor:pointer;transition:all .15s;
}
.rli:hover{border-color:var(--accent);}
.rli.on{border-color:var(--accent2);background:rgba(0,229,204,.06);}
.rli-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.rli-icon{width:20px;height:20px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.rli-icon svg{width:16px;height:16px;}
.rli-name{flex:1;font-size:13px;font-weight:600;}
.rli-cnt{font-family:var(--font-mono);font-size:10px;color:var(--muted);}
.rli-acts{display:flex;gap:2px;}
.ib{
  width:26px;height:26px;border-radius:6px;
  background:var(--card2);border:1px solid var(--border2);
  color:var(--muted);font-size:14px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.ib:hover{border-color:var(--accent);color:var(--accent);}
.ib.danger:hover{border-color:var(--warn);color:var(--warn);}

/* Editor */
.ed-title{font-size:14px;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.ed-close{
  width:24px;height:24px;margin-left:auto;border-radius:6px;
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:18px;transition:all .15s;
}
.ed-close:hover{background:rgba(255,95,87,.12);color:var(--warn);}
.fg{margin-bottom:14px;}
.lb{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;color:var(--muted);}
.inp,.txa{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:7px;padding:9px 11px;
  font-family:var(--font-display);font-size:13px;color:var(--text);
  transition:all .15s;
}
.inp:focus,.txa:focus{outline:none;border-color:var(--accent);background:var(--card2);}
.txa{min-height:70px;resize:vertical;font-family:var(--font-mono);font-size:11px;}
.sock-list{display:flex;flex-direction:column;gap:5px;margin-top:6px;}
.sock-it{
  display:flex;align-items:center;gap:6px;
  background:var(--card2);border:1px solid var(--border);
  border-radius:6px;padding:6px 8px;
}
.sock-name{flex:1;font-family:var(--font-mono);font-size:11px;}
.sock-del{
  width:22px;height:22px;border-radius:5px;
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:14px;transition:all .15s;
}
.sock-del:hover{background:rgba(255,95,87,.15);color:var(--warn);}
.add-sock{
  display:flex;gap:4px;margin-top:6px;
}
.add-sock .inp{flex:1;}
.add-sock .btn{padding:8px 14px;}
.del-room-btn{width:100%;margin-top:8px;}

/* Check group */
.check-group{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.check-group input[type="checkbox"]{
  width:16px;height:16px;cursor:pointer;
  accent-color:var(--accent);
}
.check-group label{font-size:12px;cursor:pointer;}

/* Select */
.sel{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:7px;padding:9px 11px;
  font-family:var(--font-display);font-size:13px;color:var(--text);
  cursor:pointer;transition:all .15s;
}
.sel:focus{outline:none;border-color:var(--accent);background:var(--card2);}

/* Move people list */
.move-people-list{display:flex;flex-direction:column;gap:5px;margin-top:6px;}
.move-person{
  display:flex;align-items:center;gap:6px;
  background:var(--card2);border:1px solid var(--border);
  border-radius:6px;padding:6px 8px;
}
.move-person-name{flex:1;font-size:12px;}
.move-person-pc{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted);}
.move-person-pc input{width:14px;height:14px;cursor:pointer;accent-color:var(--success);}
.add-person{display:flex;gap:4px;margin-top:6px;}
.add-person .inp{flex:1;}
.add-person .btn{padding:8px 14px;}

/* Stats cards */
.sc{
  display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;
}
.scard{
  background:var(--card);border:1px solid var(--border);
  border-radius:9px;padding:12px;text-align:center;
}
.scard-val{font-size:24px;font-weight:800;color:var(--accent2);}
.scard-lab{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-top:4px;}

/* Modal */
.modal{
  position:fixed;inset:0;z-index:300;
  background:rgba(11,13,18,.85);backdrop-filter:blur(8px);
  display:none;align-items:center;justify-content:center;
  animation:fadeIn .15s;
}
.modal.on{display:flex;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.md{
  background:var(--surface);border:1px solid var(--border2);
  border-radius:14px;padding:22px 24px;width:90%;max-width:420px;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.md-title{font-size:16px;font-weight:800;margin-bottom:14px;}
.md-acts{display:flex;gap:6px;margin-top:16px;}
.md-acts .btn{flex:1;justify-content:center;}

/* Tooltip */
#tt{
  position:absolute;z-index:250;pointer-events:none;
  background:var(--card);border:1px solid var(--border2);
  border-radius:10px;padding:12px 14px;opacity:0;
  transition:opacity .12s;box-shadow:0 8px 28px rgba(0,0,0,.5);
  max-width:260px;min-width:160px;
}
#tt.on{opacity:1;}
.tt-badge{
  display:inline-block;font-size:9px;font-weight:800;text-transform:uppercase;
  letter-spacing:1px;padding:2px 8px;border-radius:20px;margin-bottom:6px;
}
.tt-name{font-size:14px;font-weight:800;margin-bottom:6px;line-height:1.3;}
.tt-row{
  display:flex;align-items:flex-start;gap:6px;
  font-size:11px;color:var(--muted);margin-top:3px;
}
.tt-row-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;flex-shrink:0;color:var(--border2);}
.tt-row-val{font-size:11px;color:var(--text);word-break:break-word;white-space:pre-line;}
.tt-divider{height:1px;background:var(--border);margin:6px 0;}

/* Notif */
#notif{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--card);border:1px solid var(--accent);
  border-radius:10px;padding:12px 20px;
  font-size:13px;font-weight:700;color:var(--accent2);
  box-shadow:0 8px 24px rgba(0,0,0,.4);
  transition:transform .25s cubic-bezier(.34,1.56,.64,1);
  z-index:400;
}
#notif.on{transform:translateX(-50%) translateY(0);}

/* Progress */
#progress{
  position:fixed;top:0;left:0;width:100%;height:3px;
  background:var(--accent2);transform:scaleX(0);
  transform-origin:0 0;transition:transform .2s;z-index:500;
}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
    </div>
    <div class="logo-name">Modificateur de <em>plan</em></div>
  </div>
  <div class="header-right">
    <div class="chip" id="mode-chip">NAVIGATION</div>
  </div>
</header>

<!-- Toolbar -->
<div class="toolbar">
  <div class="tg">
    <button class="btn" id="btn-nav" onclick="setMode('nav')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
      Navigation
    </button>
    <button class="btn" id="btn-edit-shape" onclick="setMode('edit-shape')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m6.36 6.36l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m6.36-6.36l4.24-4.24"/></svg>
      Éditer forme
    </button>
    
    <!-- Catégorie: Tracer une zone -->
    <div class="dropdown" id="dropdown-zone">
      <button class="btn dropdown-toggle" onclick="toggleDropdown('dropdown-zone')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2z"/><polyline points="7 10 12 15 17 10"/></svg>
        Tracer une zone ▼
      </button>
      <div class="dropdown-menu">
        <button onclick="setMode('meeting'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3h2v4M8 3H6v4"/></svg>
          Salle de réunion
        </button>
        <button onclick="setMode('techroom'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><line x1="6" y1="6" x2="6" y2="6"/><line x1="6" y1="18" x2="6" y2="18"/></svg>
          Local technique
        </button>
        <button onclick="setMode('draw'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
          Bureau
        </button>
        <button onclick="setMode('move'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M9 22V12h6v10"/></svg>
          Déménagement
        </button>
        <button onclick="setMode('freezone'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" stroke-dasharray="4,3"/><path d="M12 8v8M8 12h8"/></svg>
          Zone libre
        </button>
      </div>
    </div>
    
    <!-- Catégorie: Ressource -->
    <div class="dropdown" id="dropdown-resource">
      <button class="btn dropdown-toggle" onclick="toggleDropdown('dropdown-resource')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m6.36 6.36l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m6.36-6.36l4.24-4.24"/></svg>
        Ressource ▼
      </button>
      <div class="dropdown-menu">
        <button onclick="setMode('copier'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="2" width="12" height="6" rx="1"/><path d="M18 8v10a2 2 0 01-2 2H8a2 2 0 01-2-2V8"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="18" y2="16"/></svg>
          Copieur
        </button>
        <button onclick="setMode('printer'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Imprimante
        </button>
        <button onclick="setMode('screen'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          Écran TV
        </button>
        <button onclick="setMode('display'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="14" rx="2"/><path d="M7 21h10M12 17v4"/><circle cx="8" cy="11" r="1" fill="currentColor"/><path d="M12 8v6M15 9l-3 5-3-5"/></svg>
          Écran d'information
        </button>
        <button onclick="setMode('socket'); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="7" width="14" height="12" rx="2"/><circle cx="10" cy="12" r="1.5" fill="currentColor"/><circle cx="14" cy="12" r="1.5" fill="currentColor"/><path d="M10 7V5m4 2V5"/></svg>
          Prises réseau
        </button>
      </div>
    </div>
  </div>
  
  <div class="tg">
    <button class="btn" onclick="zoomIn()" title="Zoom +">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    </button>
    <button class="btn" onclick="zoomOut()" title="Zoom -">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    </button>
    <button class="btn" onclick="zoomReset()" title="Réinitialiser (100%)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      100%
    </button>
    <button class="btn" onclick="zoomFit()" title="Ajuster au plan">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg>
      Ajuster
    </button>
  </div>
  
  <div class="tg">
    <div class="dropdown" id="dropdown-export">
      <button class="btn success dropdown-toggle" onclick="toggleDropdown('dropdown-export')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Exporter ▼
      </button>
      <div class="dropdown-menu">
        <button onclick="exportJSON(); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          JSON
        </button>
        <button onclick="exportExcel(); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Excel
        </button>
        <button onclick="exportPNG(); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          PNG
        </button>
        <button onclick="exportPDF(); closeAllDropdowns();">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 13h6M9 17h4"/></svg>
          PDF
        </button>
      </div>
    </div>
    <label class="btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Importer
      <input type="file" accept="application/json" style="display:none;" onchange="importJSON(event)">
    </label>
    <button class="btn" onclick="openLocationsModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
      Lieux
    </button>
    <button class="btn danger" onclick="clearFloor()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
      Vider
    </button>
  </div>
</div>

<!-- Floors bar -->
<div class="floors-bar" id="floors-bar"></div>

<!-- Main -->
<div class="main">
  <!-- Canvas -->
  <div class="canvas-area" id="canvas-area">
    <div id="drop-zone">
      <div class="dz-card" id="dz-card">
        <div class="dz-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
        </div>
        <div class="dz-title">Déposer un plan d'étage</div>
        <div class="dz-sub">ou cliquez pour choisir un fichier<br>(PNG, JPG, SVG, PDF)</div>
      </div>
    </div>
    <div id="canvas-root">
      <img id="plan-img">
      <svg id="svg-layer"></svg>
    </div>
    <div id="draw-ghost"></div>
    <div class="zoom-hud">
      <button class="zbtn" onclick="zoomIn()">+</button>
      <div class="zpct" id="zpct">100%</div>
      <button class="zbtn" onclick="zoomOut()">−</button>
      <button class="zbtn" onclick="zoomReset()" title="Réinitialiser (100%)">⊙</button>
      <button class="zbtn" onclick="zoomFit()" title="Ajuster à l'écran" style="font-size:12px;">⤢</button>
    </div>
    <div class="coords-hud" id="coords">x:0 y:0</div>
  </div>

  <!-- Side panel -->
  <div class="side">
    <div class="tabs">
      <div class="tab on" id="tab-list-btn" onclick="switchTab('list')">Liste</div>
      <div class="tab" id="tab-edit-btn" onclick="switchTab('edit')">Édition</div>
      <div class="tab" id="tab-equip-btn" onclick="switchTab('equip')">Équipements</div>
      <div class="tab" id="tab-move-btn" onclick="switchTab('move')">Déménagements</div>
      <div class="tab" id="tab-stats-btn" onclick="switchTab('stats')">Stats</div>
    </div>

    <!-- Liste -->
    <div class="tab-body on" id="tab-list"></div>

    <!-- Édition -->
    <div class="tab-body" id="tab-edit"></div>

    <!-- Équipements -->
    <div class="tab-body" id="tab-equip"></div>

    <!-- Déménagements -->
    <div class="tab-body" id="tab-move"></div>

    <!-- Stats -->
    <div class="tab-body" id="tab-stats">
      <div class="sc">
        <div class="scard"><div class="scard-val" id="st-floors">0</div><div class="scard-lab">Étages</div></div>
        <div class="scard"><div class="scard-val" id="st-rooms">0</div><div class="scard-lab">Bureaux</div></div>
        <div class="scard"><div class="scard-val" id="st-copiers">0</div><div class="scard-lab">Copieurs</div></div>
      </div>
      <div class="sc">
        <div class="scard"><div class="scard-val" id="st-printers">0</div><div class="scard-lab">Imprimantes</div></div>
        <div class="scard"><div class="scard-val" id="st-meetings">0</div><div class="scard-lab">Salles</div></div>
      </div>
      <div id="st-detail"></div>
    </div>
  </div>
</div>

<!-- Modal Floor -->
<div class="modal" id="modal-floor">
  <div class="md">
    <div class="md-title">Nouvel étage</div>
    <div class="fg">
      <label class="lb">Site</label>
      <select class="sel" id="modal-floor-site">
        <option value="">-- Choisir un site --</option>
      </select>
    </div>
    <div class="fg" id="modal-floor-subsite-group" style="display:none;">
      <label class="lb">Sous-site COM</label>
      <select class="sel" id="modal-floor-subsite">
        <option value="">-- Choisir un sous-site --</option>
      </select>
    </div>
    <div class="fg">
      <label class="lb">Étage</label>
      <select class="sel" id="modal-floor-level">
        <option value="">-- Choisir un étage --</option>
      </select>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelFloor()">Annuler</button>
      <button class="btn primary" onclick="confirmFloor()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Room -->
<div class="modal" id="modal-room">
  <div class="md">
    <div class="md-title">Nouveau bureau</div>
    <div class="fg">
      <label class="lb">Nom du bureau</label>
      <input type="text" class="inp" id="modal-room-name" placeholder="ex: Bureau 101">
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelRoom()">Annuler</button>
      <button class="btn primary" onclick="confirmRoom()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Copier -->
<div class="modal" id="modal-copier">
  <div class="md">
    <div class="md-title">Nouveau copieur</div>
    <div class="fg">
      <label class="lb">Nom du copieur</label>
      <input type="text" class="inp" id="modal-copier-name" placeholder="ex: Copieur RDC">
    </div>
    <div class="fg">
      <label class="lb">Informations réseau</label>
      <textarea class="txa" id="modal-copier-network" placeholder="IP, VLAN, etc."></textarea>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelCopier()">Annuler</button>
      <button class="btn primary" onclick="confirmCopier()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Printer -->
<div class="modal" id="modal-printer">
  <div class="md">
    <div class="md-title">Nouvelle imprimante</div>
    <div class="fg">
      <label class="lb">Nom de l'imprimante</label>
      <input type="text" class="inp" id="modal-printer-name" placeholder="ex: Imprimante Bureau 1">
    </div>
    <div class="fg">
      <label class="lb">Informations réseau</label>
      <textarea class="txa" id="modal-printer-network" placeholder="IP, VLAN, etc."></textarea>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelPrinter()">Annuler</button>
      <button class="btn primary" onclick="confirmPrinter()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Meeting Room -->
<div class="modal" id="modal-meeting">
  <div class="md">
    <div class="md-title">Nouvelle salle de réunion</div>
    <div class="fg">
      <label class="lb">Nom de la salle</label>
      <input type="text" class="inp" id="modal-meeting-name" placeholder="ex: Salle Réunion A">
    </div>
    <div class="fg">
      <label class="lb">Type d'écran</label>
      <div class="check-group">
        <input type="radio" name="screen-type" id="screen-tactile" value="tactile" checked>
        <label for="screen-tactile">Écran tactile</label>
      </div>
      <div class="check-group">
        <input type="radio" name="screen-type" id="screen-classic" value="classique">
        <label for="screen-classic">Écran classique</label>
      </div>
    </div>
    <div class="fg">
      <label class="lb">Taille de l'écran</label>
      <select class="sel" id="modal-meeting-size">
        <option value="49">49 pouces</option>
        <option value="55" selected>55 pouces</option>
        <option value="65">65 pouces</option>
        <option value="75">75 pouces</option>
        <option value="98">98 pouces</option>
      </select>
    </div>
    <div class="fg">
      <div class="check-group">
        <input type="checkbox" id="modal-meeting-mtr">
        <label for="modal-meeting-mtr">Équipement MTR (Microsoft Teams Rooms)</label>
      </div>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelMeeting()">Annuler</button>
      <button class="btn primary" onclick="confirmMeeting()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Move -->
<div class="modal" id="modal-move">
  <div class="md">
    <div class="md-title">Nouveau déménagement</div>
    <div class="fg">
      <label class="lb">Date du déménagement</label>
      <input type="date" class="inp" id="modal-move-date">
    </div>
    <div class="fg">
      <label class="lb">Personnes concernées</label>
      <div class="move-people-list" id="modal-move-people"></div>
      <div class="add-person">
        <input type="text" class="inp" id="modal-move-person-input" placeholder="Nom de la personne">
        <button class="btn" onclick="addMovePerson()">+</button>
      </div>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelMove()">Annuler</button>
      <button class="btn primary" onclick="confirmMove()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Confirmation -->
<div class="modal" id="modal-confirm" onclick="if(event.target===this)closeConfirmModal()">
  <div class="md" style="max-width:380px;text-align:center;">
    <div class="md-title" id="confirm-title" style="font-size:16px;"></div>
    <div id="confirm-body" style="font-size:13px;color:var(--muted);margin:-4px 0 16px;min-height:0;"></div>
    <div class="md-acts" style="justify-content:center;">
      <button class="btn" onclick="closeConfirmModal()">Annuler</button>
      <button class="btn danger" onclick="doConfirm()">Confirmer</button>
    </div>
  </div>
</div>

<!-- Modal Warning Before Leaving -->
<div class="modal" id="modal-leave-warning" style="z-index:10000;">
  <div class="md" style="max-width:520px;">
    <div class="md-title">⚠️ Attention - Données non sauvegardées</div>
    <p style="margin:16px 0;line-height:1.6;color:#555;font-size:14px;">
      Vous êtes sur le point de quitter cette page. Vos modifications seront perdues si vous ne les exportez pas.
    </p>
    <p style="margin:16px 0;font-weight:600;color:#333;font-size:14px;">
      Voulez-vous exporter votre travail avant de partir ?
    </p>
    <div style="display:flex;gap:8px;margin-top:20px;flex-wrap:wrap;">
      <button class="btn success" onclick="exportJSONAndStay()" style="flex:1;min-width:140px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:16px;height:16px;margin-right:4px;vertical-align:middle;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        JSON
      </button>
      <button class="btn success" onclick="exportPNGAndStay()" style="flex:1;min-width:140px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:16px;height:16px;margin-right:4px;vertical-align:middle;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        PNG
      </button>
      <button class="btn success" onclick="exportPDFAndStay()" style="flex:1;min-width:140px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:16px;height:16px;margin-right:4px;vertical-align:middle;"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        PDF
      </button>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn" onclick="cancelLeave()" style="flex:1;">Rester sur la page</button>
      <button class="btn danger" onclick="confirmLeave()" style="flex:1;">Quitter sans exporter</button>
    </div>
  </div>
</div>

<!-- Modal Export Options -->
<div class="modal" id="modal-export-options">
  <div class="md" style="max-width:480px;">
    <div class="md-title" id="export-options-title">Options d'export</div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Sélectionnez les éléments à inclure dans l'export :</p>
    
    <div style="margin-bottom:16px;">
      <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:4px;transition:background 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" id="export-all" onchange="toggleAllExportOptions()" style="margin-right:10px;width:18px;height:18px;cursor:pointer;">
        <strong style="font-size:14px;">Tout sélectionner</strong>
      </label>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;">
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="rooms" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Bureaux</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="copiers" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Copieurs</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="printers" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Imprimantes</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="meetings" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Salles de réunion</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="screens" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Écrans</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="displays" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Affichages dyn.</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="techrooms" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Locaux tech.</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="sockets" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Prises réseau</span>
      </label>
      <label style="display:flex;align-items:center;padding:6px;cursor:pointer;" class="export-option">
        <input type="checkbox" class="export-checkbox" data-type="moves" checked style="margin-right:8px;width:16px;height:16px;cursor:pointer;">
        <span style="font-size:13px;">Déménagements</span>
      </label>
    </div>
    
    <div class="md-acts">
      <button class="btn" onclick="cancelExportOptions()">Annuler</button>
      <button class="btn primary" onclick="confirmExportOptions()">Exporter</button>
    </div>
  </div>
</div>

<!-- Modal Locations -->
<div class="modal" id="modal-locations">
  <div class="md" style="max-width:520px;">
    <div class="md-title">Gérer les lieux</div>
    <div class="fg">
      <label class="lb">Lieux disponibles</label>
      <div id="locations-list" style="max-height:300px;overflow-y:auto;"></div>
      <div class="add-person" style="margin-top:10px;">
        <input type="text" class="inp" id="location-input" placeholder="Nouveau lieu (ex: Bureau Paris, Étage 2...)">
        <button class="btn" onclick="addLocation()">+</button>
      </div>
    </div>
    <div class="md-acts">
      <button class="btn primary" onclick="closeLocationsModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- Modal Screen -->
<div class="modal" id="modal-screen">
  <div class="md">
    <div class="md-title">Nouvel écran</div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="modal-screen-name" placeholder="ex: Écran Accueil">
    </div>
    <div class="fg">
      <label class="lb">Taille</label>
      <select class="sel" id="modal-screen-size">
        <option value="49">49 pouces</option>
        <option value="55" selected>55 pouces</option>
        <option value="65">65 pouces</option>
        <option value="75">75 pouces</option>
        <option value="98">98 pouces</option>
      </select>
    </div>
    <div class="fg">
      <label class="lb">Marque</label>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:6px;">
        <label class="check-group"><input type="radio" name="screen-brand" value="Samsung" checked> Samsung</label>
        <label class="check-group"><input type="radio" name="screen-brand" value="NEC"> NEC</label>
        <label class="check-group"><input type="radio" name="screen-brand" value="Grundig"> Grundig</label>
        <label class="check-group"><input type="radio" name="screen-brand" value="LG"> LG</label>
        <label class="check-group"><input type="radio" name="screen-brand" value="autre" id="modal-screen-brand-autre"> Autre</label>
      </div>
      <input type="text" class="inp" id="modal-screen-brand-custom" placeholder="Préciser la marque..." style="display:none;margin-top:4px;">
    </div>
    <div class="fg">
      <label class="lb">Informations réseau</label>
      <textarea class="txa" id="modal-screen-network" placeholder="IP, VLAN, etc."></textarea>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelScreen()">Annuler</button>
      <button class="btn primary" onclick="confirmScreen()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Zone Libre -->
<div class="modal" id="modal-freezone">
  <div class="md" style="max-width:520px;">
    <div class="md-title">Nouvelle zone libre</div>
    <div class="fg">
      <label class="lb">Nom de la zone</label>
      <input type="text" class="inp" id="modal-freezone-name" placeholder="ex: Salle de pause, Stockage, Accueil...">
    </div>
    <div class="fg">
      <label class="lb">Couleur</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;" id="freezone-color-picker">
        <div class="fz-color on" data-color="#a78bfa" style="background:#a78bfa;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border .15s;"></div>
        <div class="fz-color" data-color="#fb7185" style="background:#fb7185;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#f59e0b" style="background:#f59e0b;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#34d399" style="background:#34d399;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#38bdf8" style="background:#38bdf8;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#f97316" style="background:#f97316;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#e879f9" style="background:#e879f9;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
        <div class="fz-color" data-color="#94a3b8" style="background:#94a3b8;width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;"></div>
      </div>
    </div>
    <div class="fg">
      <label class="lb">Icône</label>
      <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;" id="freezone-icon-picker"></div>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelFreezone()">Annuler</button>
      <button class="btn primary" onclick="confirmFreezone()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Tech Room -->
<div class="modal" id="modal-techroom">
  <div class="md">
    <div class="md-title">Nouveau local technique</div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="modal-techroom-name" placeholder="ex: Local Tech RDC">
    </div>
    <div class="fg">
      <label class="lb">Description</label>
      <textarea class="txa" id="modal-techroom-desc" placeholder="Contenu, équipements, notes..."></textarea>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelTechroom()">Annuler</button>
      <button class="btn primary" onclick="confirmTechroom()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Display (Affichage dynamique) -->
<div class="modal" id="modal-display">
  <div class="md">
    <div class="md-title">Nouvel affichage dynamique</div>
    <div class="fg">
      <label class="lb">Nom / Emplacement</label>
      <input type="text" class="inp" id="modal-display-name" placeholder="ex: Hall d'entrée, Salle de pause...">
    </div>
    <div class="fg">
      <label class="lb">Taille de l'écran</label>
      <select class="sel" id="modal-display-size">
        <option value="32">32 pouces</option>
        <option value="43">43 pouces</option>
        <option value="49">49 pouces</option>
        <option value="55" selected>55 pouces</option>
        <option value="65">65 pouces</option>
        <option value="75">75 pouces</option>
        <option value="98">98 pouces</option>
      </select>
    </div>
    <div class="fg">
      <label class="lb">Contenu diffusé</label>
      <input type="text" class="inp" id="modal-display-content" placeholder="ex: Actualités, Planning, Signalétique...">
    </div>
    <div class="fg">
      <label class="lb">Informations réseau</label>
      <textarea class="txa" id="modal-display-network" placeholder="IP, VLAN, etc."></textarea>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelDisplay()">Annuler</button>
      <button class="btn primary" onclick="confirmDisplay()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Socket (Network Outlets) -->
<div class="modal" id="modal-socket">
  <div class="md">
    <div class="md-title">Prises réseau</div>
    <div class="fg">
      <label class="lb">Nom de l'emplacement</label>
      <input type="text" class="inp" id="modal-socket-name" placeholder="ex: Bureau 201, Salle de conf...">
    </div>
    <div class="fg">
      <label class="lb">Prises réseau</label>
      <div class="move-people-list" id="modal-socket-outlets"></div>
      <div class="add-person">
        <input type="text" class="inp" id="modal-socket-outlet-input" placeholder="ex: Prise 1 - IP 192.168.1.10">
        <button class="btn" onclick="addSocketOutlet()">+</button>
      </div>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelSocket()">Annuler</button>
      <button class="btn primary" onclick="confirmSocket()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Export Options -->
<div class="modal" id="modal-export">
  <div class="md" style="max-width:400px;">
    <div class="md-title">Options d'export</div>
    <div style="margin-bottom:16px;font-size:13px;color:var(--muted);">Sélectionnez les éléments à inclure dans l'export</div>
    
    <div style="margin-bottom:12px;">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;border-radius:6px;background:var(--card2);">
        <input type="checkbox" id="export-all" onchange="toggleAllExport()" checked style="width:18px;height:18px;cursor:pointer;">
        <span style="font-weight:700;">Tout sélectionner</span>
      </label>
    </div>
    
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:16px;">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="rooms" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Bureaux</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="copiers" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Copieurs</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="printers" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Imprimantes</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="meetings" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Salles de réunion</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="screens" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Écrans</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="displays" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Affichages dynamiques</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="techrooms" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Locaux techniques</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="sockets" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Prises réseau</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:4px;transition:background .15s;" onmouseover="this.style.background='var(--card2)'" onmouseout="this.style.background='transparent'">
        <input type="checkbox" class="export-option" value="moves" checked onchange="updateExportAllCheckbox()" style="width:16px;height:16px;cursor:pointer;">
        <span>Déménagements</span>
      </label>
    </div>
    
    <div class="md-acts">
      <button class="btn" onclick="closeExportModal()">Annuler</button>
      <button class="btn success" onclick="confirmExport()">Exporter</button>
    </div>
  </div>
</div>

<div id="tt"></div>

<div id="notif"></div>
<div id="progress"></div>

<script>
// ═══════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════
let _id = 1;
const S = {
  floors: [],
  locations: ['Pfaffenhoffen', 'Haguenau', 'Rittershoffen', 'Reichshoffen', 'Soultz-sous-Forêts', 'COM', 'AVA', 'ARM', 'RBG', 'Molsheim', 'Erstein', 'Huningue', 'Planigy'],
  comSubSites: ['Loge ASA', 'BS', 'BTI', 'BI', 'BE'],
  comSubSiteLevels: {
    'Loge ASA': ['RDC'],
    'BS': ['RDC'],
    'BI': ['Sous-sol', 'RDC', '1er'],
    'BTI': ['Sous-sol', 'RDC', '1er', '2ème', '3ème', '4ème', '5ème', '6ème'],
    'BE': ['Sous-sol', 'RDC', '1er', '2ème', '3ème', '4ème', '5ème', '6ème']
  },
  floorLevels: ['Sous-sol', 'RDC', '1er', '2ème', '3ème', '4ème', '5ème', '6ème'],
  activeFloor: null,
  selectedRoom: null,
  mode: 'nav',
  zoom: 1,
  pan: {x:0, y:0},
  drawing: null,
  dragging: null,
  editingShape: null,
  tempMove: {people: []},
  tempCopierPos: null,
  tempPrinterPos: null,
  tempMeetingPos: null,
  tempMovePos: null,
  tempScreenPos: null,
  tempTechroomPos: null,
  tempDisplayPos: null,
  tempSocketPos: null,
  tempSocket: {outlets: []}
};

// ═══════════════════════════════════════════════════
//  FLOOR MANAGEMENT
// ═══════════════════════════════════════════════════
function activeFloor() { return S.floors.find(f => f.id === S.activeFloor) || null; }

function addFloor(site, level, subSite) {
  const name = subSite ? `${site} - ${subSite} - ${level}` : `${site} - ${level}`;
  const f = {
    id: _id++, name, site, level, subSite: subSite || null,
    imageB64: null, imageW: 0, imageH: 0,
    rooms: [], copiers: [], printers: [], meetings: [], moves: [],
    screens: [], techrooms: [], displays: [], sockets: [], freezones: []
  };
  S.floors.push(f);
  S.activeFloor = f.id;
  renderFloorsBar(); renderCanvas(); renderRoomsList();
  renderEquipmentsList(); renderMovesList(); editorOpen(null); updateStats();
}

// Convert old rectangle format to polygon format
function ensurePolygon(item) {
  if (!item.points && item.x !== undefined && item.w !== undefined) {
    // Convert rectangle to polygon
    item.points = [
      {x: item.x, y: item.y},
      {x: item.x + item.w, y: item.y},
      {x: item.x + item.w, y: item.y + item.h},
      {x: item.x, y: item.y + item.h}
    ];
    // Keep x, y, w, h for backward compatibility and bounds calculation
  }
  return item;
}

// Calculate bounds from points
function calculateBounds(points) {
  if (!points || points.length === 0) return {x: 0, y: 0, w: 0, h: 0};
  const xs = points.map(p => p.x);
  const ys = points.map(p => p.y);
  const minX = Math.min(...xs);
  const minY = Math.min(...ys);
  const maxX = Math.max(...xs);
  const maxY = Math.max(...ys);
  return {
    x: minX,
    y: minY,
    w: maxX - minX,
    h: maxY - minY
  };
}

function selectFloor(fid) {
  S.activeFloor = fid;
  S.selectedRoom = null;
  renderFloorsBar();
  renderCanvas();
  renderRoomsList();
  renderEquipmentsList();
  renderMovesList();
  editorOpen(null);
}

function removeFloor(fid) {
  const f = S.floors.find(x => x.id === fid);
  if (!f) return;
  showConfirmModal(`Supprimer l'étage "${f.name}" ?`, 'Cette action est irréversible.', () => {
    S.floors = S.floors.filter(x => x.id !== fid);
    if (S.activeFloor === fid) S.activeFloor = S.floors[0]?.id ?? null;
    S.selectedRoom = null;
    renderFloorsBar(); renderCanvas(); renderRoomsList();
    renderEquipmentsList(); renderMovesList(); editorOpen(null); updateStats();
    notify(`Étage "${f.name}" supprimé.`);
  });
}

function editFloorName(fid, spanElement) {
  const f = S.floors.find(x => x.id === fid);
  if (!f) return;
  
  const input = document.createElement('input');
  input.type = 'text';
  input.value = f.name;
  input.style.cssText = 'background:var(--card2);border:1px solid var(--accent);color:var(--text);padding:4px 8px;border-radius:4px;font-size:12px;font-weight:700;font-family:var(--font-display);width:120px;';
  
  spanElement.replaceWith(input);
  input.focus();
  input.select();
  
  const save = () => {
    const newName = input.value.trim() || f.name;
    f.name = newName;
    renderFloorsBar();
    updateStats();
    notify(`Étage renommé en "${newName}"`);
  };
  
  input.onblur = save;
  input.onkeydown = (e) => {
    if (e.key === 'Enter') save();
    if (e.key === 'Escape') { f.name = f.name; renderFloorsBar(); }
  };
}

function renderFloorsBar() {
  const bar = document.getElementById('floors-bar');
  bar.innerHTML = '';
  S.floors.forEach(f => {
    const tab = document.createElement('div');
    tab.className = 'floor-tab';
    if (f.id === S.activeFloor) tab.classList.add('active');
    const span = document.createElement('span');
    span.textContent = f.name;
    span.onclick = () => selectFloor(f.id);
    span.ondblclick = (e) => { 
      e.stopPropagation(); 
      editFloorName(f.id, span); 
    };
    span.title = 'Double-cliquez pour renommer';
    tab.appendChild(span);
    if (S.floors.length > 1) {
      const del = document.createElement('button');
      del.className = 'ft-del'; del.textContent = '×';
      del.onclick = e => { e.stopPropagation(); removeFloor(f.id); };
      tab.appendChild(del);
    }
    bar.appendChild(tab);
  });
  const add = document.createElement('div');
  add.className = 'add-floor-btn';
  add.innerHTML = '<span>+</span><span>Ajouter</span>';
  add.onclick = openModalFloor;
  bar.appendChild(add);
}

// ═══════════════════════════════════════════════════
//  RENDER CANVAS
// ═══════════════════════════════════════════════════
function renderCanvas() {
  const f = activeFloor();
  const img = document.getElementById('plan-img');
  const svg = document.getElementById('svg-layer');
  const dz = document.getElementById('drop-zone');

  if (!f || !f.imageB64) {
    img.src = ''; img.style.display = 'none';
    svg.innerHTML = ''; dz.style.display = 'flex';
    return;
  }

  dz.style.display = 'none';
  img.src = f.imageB64;
  img.style.display = 'block';
  img.style.width = f.imageW + 'px';
  img.style.height = f.imageH + 'px';

  svg.setAttribute('width', f.imageW);
  svg.setAttribute('height', f.imageH);
  svg.innerHTML = '';

  // Draw rooms
  f.rooms.forEach((r,i) => {
    ensurePolygon(r);
    const col = roomColor(f.id, i);
    
    // Create polygon from points
    const pointsStr = r.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', col);
    poly.setAttribute('fill-opacity', S.selectedRoom === r.id ? '0.35' : '0.15');
    poly.setAttribute('stroke', col);
    poly.setAttribute('stroke-width', S.selectedRoom === r.id ? '3' : '2');
    poly.style.cursor = 'move';
    poly.setAttribute('data-type', 'room');
    poly.setAttribute('data-id', r.id);
    poly.addEventListener('click', (e) => { 
      e.stopPropagation();
      S.selectedRoom = r.id; 
      renderCanvas(); 
      renderRoomsList(); 
      editorOpen(r); 
    });
    poly.addEventListener('mouseenter', e => showTT(e.clientX, e.clientY, f, r));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);
    
    // Update bounds
    const bounds = calculateBounds(r.points);
    r.x = bounds.x;
    r.y = bounds.y;
    r.w = bounds.w;
    r.h = bounds.h;
    
    // Add text info in room if big enough
    if (r.w > 80 && r.h > 40) {
      const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
      textG.style.pointerEvents = 'none';
      
      // Room name
      if (r.name) {
        const nameText = document.createElementNS('http://www.w3.org/2000/svg','text');
        nameText.setAttribute('x', r.x + r.w/2);
        nameText.setAttribute('y', r.y + r.h/2);
        nameText.setAttribute('text-anchor', 'middle');
        nameText.setAttribute('dominant-baseline', 'middle');
        nameText.setAttribute('fill', '#fff');
        nameText.setAttribute('font-size', '12');
        nameText.setAttribute('font-weight', '700');
        nameText.setAttribute('stroke', '#000');
        nameText.setAttribute('stroke-width', '3');
        nameText.setAttribute('paint-order', 'stroke');
        nameText.textContent = r.name.length > 15 ? r.name.substring(0,13)+'...' : r.name;
        textG.appendChild(nameText);
      }
      
      svg.appendChild(textG);
    }
  });

  // Draw copiers
  f.copiers.forEach(c => {
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.style.cursor = 'move';
    g.setAttribute('data-type', 'copier');
    g.setAttribute('data-id', c.id);
    g.addEventListener('click', (e) => { 
      e.stopPropagation();
      editCopier(c); 
    });
    g.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'copier', c, f.name));
    g.addEventListener('mouseleave', hideTT);

    // SVG icon for copier/multifunction printer
    const icon = document.createElementNS('http://www.w3.org/2000/svg','g');
    icon.setAttribute('transform', `translate(${c.x-12}, ${c.y-12})`);
    
    // Top scanner part
    const topRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    topRect.setAttribute('x', '2');
    topRect.setAttribute('y', '2');
    topRect.setAttribute('width', '20');
    topRect.setAttribute('height', '5');
    topRect.setAttribute('fill', 'none');
    topRect.setAttribute('stroke', '#ff6b35');
    topRect.setAttribute('stroke-width', '1.5');
    topRect.setAttribute('rx', '1');
    icon.appendChild(topRect);
    
    // Middle printer part
    const midRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    midRect.setAttribute('x', '0');
    midRect.setAttribute('y', '8');
    midRect.setAttribute('width', '24');
    midRect.setAttribute('height', '8');
    midRect.setAttribute('fill', 'none');
    midRect.setAttribute('stroke', '#ff6b35');
    midRect.setAttribute('stroke-width', '1.5');
    midRect.setAttribute('rx', '1');
    icon.appendChild(midRect);
    
    // Bottom tray
    const bottomRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    bottomRect.setAttribute('x', '2');
    bottomRect.setAttribute('y', '17');
    bottomRect.setAttribute('width', '20');
    bottomRect.setAttribute('height', '5');
    bottomRect.setAttribute('fill', 'none');
    bottomRect.setAttribute('stroke', '#ff6b35');
    bottomRect.setAttribute('stroke-width', '1.5');
    bottomRect.setAttribute('rx', '1');
    icon.appendChild(bottomRect);
    
    // Paper lines
    const line1 = document.createElementNS('http://www.w3.org/2000/svg','line');
    line1.setAttribute('x1', '5');
    line1.setAttribute('y1', '11');
    line1.setAttribute('x2', '19');
    line1.setAttribute('y2', '11');
    line1.setAttribute('stroke', '#ff6b35');
    line1.setAttribute('stroke-width', '1.5');
    icon.appendChild(line1);
    
    const line2 = document.createElementNS('http://www.w3.org/2000/svg','line');
    line2.setAttribute('x1', '5');
    line2.setAttribute('y1', '13');
    line2.setAttribute('x2', '19');
    line2.setAttribute('y2', '13');
    line2.setAttribute('stroke', '#ff6b35');
    line2.setAttribute('stroke-width', '1.5');
    icon.appendChild(line2);
    
    g.appendChild(icon);

    // Label background
    if (c.name) {
      const labelBg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      labelBg.setAttribute('x', c.x - 35);
      labelBg.setAttribute('y', c.y + 25);
      labelBg.setAttribute('width', '70');
      labelBg.setAttribute('height', '18');
      labelBg.setAttribute('fill', '#ff6b35');
      labelBg.setAttribute('fill-opacity', '0.9');
      labelBg.setAttribute('rx', '4');
      g.appendChild(labelBg);

      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', c.x);
      label.setAttribute('y', c.y + 36);
      label.setAttribute('text-anchor', 'middle');
      label.setAttribute('dominant-baseline', 'middle');
      label.setAttribute('fill', '#fff');
      label.setAttribute('font-size', '10');
      label.setAttribute('font-weight', '600');
      label.textContent = c.name.length > 12 ? c.name.substring(0,10)+'...' : c.name;
      g.appendChild(label);
    }

    svg.appendChild(g);
  });

  // Draw printers
  f.printers.forEach(p => {
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.style.cursor = 'move';
    g.setAttribute('data-type', 'printer');
    g.setAttribute('data-id', p.id);
    g.addEventListener('click', (e) => { 
      e.stopPropagation();
      editPrinter(p); 
    });
    g.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'printer', p, f.name));
    g.addEventListener('mouseleave', hideTT);

    // SVG icon for printer
    const icon = document.createElementNS('http://www.w3.org/2000/svg','g');
    icon.setAttribute('transform', `translate(${p.x-10}, ${p.y-10})`);
    
    // Top paper part
    const topPath = document.createElementNS('http://www.w3.org/2000/svg','path');
    topPath.setAttribute('d', 'M4 2 L4 6 L16 6 L16 2');
    topPath.setAttribute('fill', 'none');
    topPath.setAttribute('stroke', '#4f8aff');
    topPath.setAttribute('stroke-width', '1.5');
    topPath.setAttribute('stroke-linecap', 'round');
    topPath.setAttribute('stroke-linejoin', 'round');
    icon.appendChild(topPath);
    
    // Main printer body
    const bodyRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    bodyRect.setAttribute('x', '1');
    bodyRect.setAttribute('y', '6');
    bodyRect.setAttribute('width', '18');
    bodyRect.setAttribute('height', '6');
    bodyRect.setAttribute('fill', 'none');
    bodyRect.setAttribute('stroke', '#4f8aff');
    bodyRect.setAttribute('stroke-width', '1.5');
    bodyRect.setAttribute('rx', '1');
    icon.appendChild(bodyRect);
    
    // Output tray
    const outputRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    outputRect.setAttribute('x', '4');
    outputRect.setAttribute('y', '12');
    outputRect.setAttribute('width', '12');
    outputRect.setAttribute('height', '6');
    outputRect.setAttribute('fill', 'none');
    outputRect.setAttribute('stroke', '#4f8aff');
    outputRect.setAttribute('stroke-width', '1.5');
    outputRect.setAttribute('rx', '1');
    icon.appendChild(outputRect);
    
    // Button indicator
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx', '15');
    circle.setAttribute('cy', '9');
    circle.setAttribute('r', '1');
    circle.setAttribute('fill', '#4f8aff');
    icon.appendChild(circle);
    
    g.appendChild(icon);

    // Label background
    if (p.name) {
      const labelBg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      labelBg.setAttribute('x', p.x - 35);
      labelBg.setAttribute('y', p.y + 23);
      labelBg.setAttribute('width', '70');
      labelBg.setAttribute('height', '18');
      labelBg.setAttribute('fill', '#4f8aff');
      labelBg.setAttribute('fill-opacity', '0.9');
      labelBg.setAttribute('rx', '4');
      g.appendChild(labelBg);

      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', p.x);
      label.setAttribute('y', p.y + 34);
      label.setAttribute('text-anchor', 'middle');
      label.setAttribute('dominant-baseline', 'middle');
      label.setAttribute('fill', '#fff');
      label.setAttribute('font-size', '10');
      label.setAttribute('font-weight', '600');
      label.textContent = p.name.length > 12 ? p.name.substring(0,10)+'...' : p.name;
      g.appendChild(label);
    }

    svg.appendChild(g);
  });

  // Draw meeting rooms
  f.meetings.forEach(m => {
    ensurePolygon(m);
    
    const pointsStr = m.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', '#3ddc97');
    poly.setAttribute('fill-opacity', '0.15');
    poly.setAttribute('stroke', '#3ddc97');
    poly.setAttribute('stroke-width', '2');
    poly.style.cursor = 'move';
    poly.setAttribute('data-type', 'meeting');
    poly.setAttribute('data-id', m.id);
    poly.addEventListener('click', (e) => { 
      e.stopPropagation();
      editMeeting(m); 
    });
    poly.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'meeting', m, f.name));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);
    
    // Update bounds
    const bounds = calculateBounds(m.points);
    m.x = bounds.x;
    m.y = bounds.y;
    m.w = bounds.w;
    m.h = bounds.h;

    // Add text info in meeting room
    const centerX = m.x + m.w / 2;
    const centerY = m.y + m.h / 2;
    
    const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
    textG.style.pointerEvents = 'none';
    
    // Room name
    if (m.name) {
      const nameText = document.createElementNS('http://www.w3.org/2000/svg','text');
      nameText.setAttribute('x', centerX);
      nameText.setAttribute('y', centerY - 8);
      nameText.setAttribute('text-anchor', 'middle');
      nameText.setAttribute('fill', '#3ddc97');
      nameText.setAttribute('font-size', '12');
      nameText.setAttribute('font-weight', '700');
      nameText.setAttribute('stroke', '#000');
      nameText.setAttribute('stroke-width', '3');
      nameText.setAttribute('paint-order', 'stroke');
      nameText.textContent = m.name.length > 18 ? m.name.substring(0,16)+'...' : m.name;
      textG.appendChild(nameText);
    }
    
    // Screen info
    const screenInfo = `${m.screenType==='tactile'?'Tactile':'Classique'} ${m.screenSize}"${m.hasMTR?' + MTR':''}`;
    const infoText = document.createElementNS('http://www.w3.org/2000/svg','text');
    infoText.setAttribute('x', centerX);
    infoText.setAttribute('y', centerY + 6);
    infoText.setAttribute('text-anchor', 'middle');
    infoText.setAttribute('fill', '#3ddc97');
    infoText.setAttribute('font-size', '9');
    infoText.setAttribute('opacity', '0.9');
    infoText.setAttribute('stroke', '#000');
    infoText.setAttribute('stroke-width', '2.5');
    infoText.setAttribute('paint-order', 'stroke');
    infoText.textContent = screenInfo;
    textG.appendChild(infoText);
    
    svg.appendChild(textG);
  });

  // Draw moves
  f.moves.forEach(mv => {
    ensurePolygon(mv);
    
    const pointsStr = mv.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', '#00e5cc');
    poly.setAttribute('fill-opacity', '0.15');
    poly.setAttribute('stroke', '#00e5cc');
    poly.setAttribute('stroke-width', '3');
    poly.setAttribute('stroke-dasharray', '8,4');
    poly.style.cursor = 'move';
    poly.setAttribute('data-type', 'move');
    poly.setAttribute('data-id', mv.id);
    poly.addEventListener('click', (e) => { 
      e.stopPropagation();
      editMove(mv); 
    });
    poly.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'move', mv, f.name));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);
    
    // Update bounds
    const bounds = calculateBounds(mv.points);
    mv.x = bounds.x;
    mv.y = bounds.y;
    mv.w = bounds.w;
    mv.h = bounds.h;
    
    // Add text info in move zone
    if (mv.w > 100 && mv.h > 60) {
      const centerX = mv.x + mv.w / 2;
      const centerY = mv.y + mv.h / 2;
      
      const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
      textG.style.pointerEvents = 'none';
      
      // Date
      if (mv.date) {
        const dateText = document.createElementNS('http://www.w3.org/2000/svg','text');
        dateText.setAttribute('x', centerX);
        dateText.setAttribute('y', centerY - 12);
        dateText.setAttribute('text-anchor', 'middle');
        dateText.setAttribute('fill', '#00e5cc');
        dateText.setAttribute('font-size', '11');
        dateText.setAttribute('font-weight', '700');
        dateText.setAttribute('stroke', '#000');
        dateText.setAttribute('stroke-width', '3');
        dateText.setAttribute('paint-order', 'stroke');
        dateText.textContent = new Date(mv.date).toLocaleDateString('fr-FR');
        textG.appendChild(dateText);
      }
      
      // People count
      if (mv.people.length > 0) {
        const peopleText = document.createElementNS('http://www.w3.org/2000/svg','text');
        peopleText.setAttribute('x', centerX);
        peopleText.setAttribute('y', centerY + 2);
        peopleText.setAttribute('text-anchor', 'middle');
        peopleText.setAttribute('fill', '#00e5cc');
        peopleText.setAttribute('font-size', '10');
        peopleText.setAttribute('opacity', '0.9');
        peopleText.setAttribute('stroke', '#000');
        peopleText.setAttribute('stroke-width', '2.5');
        peopleText.setAttribute('paint-order', 'stroke');
        const pcCount = mv.people.filter(p => p.needsPC).length;
        peopleText.textContent = `${mv.people.length} personne${mv.people.length>1?'s':''}`;
        textG.appendChild(peopleText);
        
        // PC count
        if (pcCount > 0) {
          const pcText = document.createElementNS('http://www.w3.org/2000/svg','text');
          pcText.setAttribute('x', centerX);
          pcText.setAttribute('y', centerY + 14);
          pcText.setAttribute('text-anchor', 'middle');
          pcText.setAttribute('fill', '#00e5cc');
          pcText.setAttribute('font-size', '9');
          pcText.setAttribute('opacity', '0.8');
          pcText.setAttribute('stroke', '#000');
          pcText.setAttribute('stroke-width', '2.5');
          pcText.setAttribute('paint-order', 'stroke');
          pcText.textContent = `${pcCount} PC`;
          textG.appendChild(pcText);
        }
      }
      
      svg.appendChild(textG);
    }
  });

  // Draw screens
  (f.screens||[]).forEach(sc => {
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.style.cursor = 'move';
    g.setAttribute('data-type','screen'); g.setAttribute('data-id', sc.id);
    g.addEventListener('click', e => { e.stopPropagation(); editScreen(sc); });
    g.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'screen', sc, f.name));
    g.addEventListener('mouseleave', hideTT);

    const circ = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circ.setAttribute('cx', sc.x); circ.setAttribute('cy', sc.y);
    circ.setAttribute('r','20');
    circ.setAttribute('fill','#9b87f5'); circ.setAttribute('fill-opacity','0.2');
    circ.setAttribute('stroke','#9b87f5'); circ.setAttribute('stroke-width','2');
    g.appendChild(circ);

    // Screen SVG icon
    const icon = document.createElementNS('http://www.w3.org/2000/svg','g');
    icon.setAttribute('transform', `translate(${sc.x-10},${sc.y-9})`);
    const scrRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    scrRect.setAttribute('x','0'); scrRect.setAttribute('y','0');
    scrRect.setAttribute('width','20'); scrRect.setAttribute('height','13');
    scrRect.setAttribute('rx','2'); scrRect.setAttribute('fill','none');
    scrRect.setAttribute('stroke','#9b87f5'); scrRect.setAttribute('stroke-width','1.5');
    icon.appendChild(scrRect);
    const stand1 = document.createElementNS('http://www.w3.org/2000/svg','line');
    stand1.setAttribute('x1','10'); stand1.setAttribute('y1','13');
    stand1.setAttribute('x2','10'); stand1.setAttribute('y2','17');
    stand1.setAttribute('stroke','#9b87f5'); stand1.setAttribute('stroke-width','1.5');
    icon.appendChild(stand1);
    const stand2 = document.createElementNS('http://www.w3.org/2000/svg','line');
    stand2.setAttribute('x1','6'); stand2.setAttribute('y1','17');
    stand2.setAttribute('x2','14'); stand2.setAttribute('y2','17');
    stand2.setAttribute('stroke','#9b87f5'); stand2.setAttribute('stroke-width','1.5');
    icon.appendChild(stand2);
    g.appendChild(icon);

    if (sc.name) {
      const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      bg.setAttribute('x', sc.x-35); bg.setAttribute('y', sc.y+25);
      bg.setAttribute('width','70'); bg.setAttribute('height','18');
      bg.setAttribute('fill','#9b87f5'); bg.setAttribute('fill-opacity','0.9'); bg.setAttribute('rx','4');
      g.appendChild(bg);
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', sc.x); lbl.setAttribute('y', sc.y+36);
      lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('dominant-baseline','middle');
      lbl.setAttribute('fill','#fff'); lbl.setAttribute('font-size','9'); lbl.setAttribute('font-weight','600');
      lbl.setAttribute('stroke','#000'); lbl.setAttribute('stroke-width','2'); lbl.setAttribute('paint-order','stroke');
      lbl.textContent = `${sc.size}" ${sc.brand||''}`.trim().substring(0,14);
      g.appendChild(lbl);
    }
    svg.appendChild(g);
  });

  // Draw tech rooms (polygon zones, red)
  (f.techrooms||[]).forEach(tr => {
    ensurePolygon(tr);

    const COLOR = '#e03030';
    const pointsStr = tr.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', COLOR);
    poly.setAttribute('fill-opacity', '0.15');
    poly.setAttribute('stroke', COLOR);
    poly.setAttribute('stroke-width', '2.5');
    poly.style.cursor = 'move';
    poly.setAttribute('data-type','techroom'); poly.setAttribute('data-id', tr.id);
    poly.addEventListener('click', e => { e.stopPropagation(); editTechroom(tr); });
    poly.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'techroom', tr, f.name));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);

    // Update bounds
    const bounds = calculateBounds(tr.points);
    tr.x = bounds.x; tr.y = bounds.y; tr.w = bounds.w; tr.h = bounds.h;

    // Label: rack icon + name centered
    const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
    textG.style.pointerEvents = 'none';

    // Rack icon centered
    const cx = tr.x + tr.w/2, cy = tr.y + tr.h/2;
    const ico = document.createElementNS('http://www.w3.org/2000/svg','g');
    ico.setAttribute('transform', `translate(${cx-9},${cy-12})`);
    [0,6,12].forEach(yy => {
      const rack = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rack.setAttribute('x','0'); rack.setAttribute('y', yy+'');
      rack.setAttribute('width','18'); rack.setAttribute('height','4');
      rack.setAttribute('rx','1'); rack.setAttribute('fill','none');
      rack.setAttribute('stroke', COLOR); rack.setAttribute('stroke-width','1.5');
      ico.appendChild(rack);
      const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
      dot.setAttribute('cx','2.5'); dot.setAttribute('cy', (yy+2)+'');
      dot.setAttribute('r','1'); dot.setAttribute('fill', COLOR);
      ico.appendChild(dot);
    });
    textG.appendChild(ico);

    if (tr.name && tr.w > 60 && tr.h > 40) {
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', cx); lbl.setAttribute('y', cy + 16);
      lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('dominant-baseline','middle');
      lbl.setAttribute('fill', COLOR); lbl.setAttribute('font-size','11'); lbl.setAttribute('font-weight','700');
      lbl.setAttribute('stroke','#000'); lbl.setAttribute('stroke-width','2.5'); lbl.setAttribute('paint-order','stroke');
      lbl.textContent = tr.name.length>16 ? tr.name.substring(0,14)+'…' : tr.name;
      textG.appendChild(lbl);
    }
    svg.appendChild(textG);
  });

  // Draw dynamic displays
  (f.displays||[]).forEach(dp => {
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.style.cursor = 'move';
    g.setAttribute('data-type','display'); g.setAttribute('data-id', dp.id);
    g.addEventListener('click', e => { e.stopPropagation(); editDisplay(dp); });
    g.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'display', dp, f.name));
    g.addEventListener('mouseleave', hideTT);

    // Outer circle
    const circ = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circ.setAttribute('cx', dp.x); circ.setAttribute('cy', dp.y);
    circ.setAttribute('r','22');
    circ.setAttribute('fill','#ffaa33'); circ.setAttribute('fill-opacity','0.18');
    circ.setAttribute('stroke','#ffaa33'); circ.setAttribute('stroke-width','2');
    g.appendChild(circ);

    // TV icon
    const ico = document.createElementNS('http://www.w3.org/2000/svg','g');
    ico.setAttribute('transform',`translate(${dp.x-12},${dp.y-11})`);

    // TV body
    const tvBody = document.createElementNS('http://www.w3.org/2000/svg','rect');
    tvBody.setAttribute('x','0'); tvBody.setAttribute('y','0');
    tvBody.setAttribute('width','24'); tvBody.setAttribute('height','16');
    tvBody.setAttribute('rx','2'); tvBody.setAttribute('fill','none');
    tvBody.setAttribute('stroke','#ffaa33'); tvBody.setAttribute('stroke-width','1.8');
    ico.appendChild(tvBody);

    // TV screen inner (slightly inset)
    const tvScreen = document.createElementNS('http://www.w3.org/2000/svg','rect');
    tvScreen.setAttribute('x','2'); tvScreen.setAttribute('y','2');
    tvScreen.setAttribute('width','20'); tvScreen.setAttribute('height','12');
    tvScreen.setAttribute('rx','1'); tvScreen.setAttribute('fill','#ffaa33');
    tvScreen.setAttribute('fill-opacity','0.25');
    ico.appendChild(tvScreen);

    // Play/signal lines inside screen
    const line1 = document.createElementNS('http://www.w3.org/2000/svg','line');
    line1.setAttribute('x1','5'); line1.setAttribute('y1','6');
    line1.setAttribute('x2','19'); line1.setAttribute('y2','6');
    line1.setAttribute('stroke','#ffaa33'); line1.setAttribute('stroke-width','1.2');
    ico.appendChild(line1);
    const line2 = document.createElementNS('http://www.w3.org/2000/svg','line');
    line2.setAttribute('x1','5'); line2.setAttribute('y1','9');
    line2.setAttribute('x2','15'); line2.setAttribute('y2','9');
    line2.setAttribute('stroke','#ffaa33'); line2.setAttribute('stroke-width','1.2');
    ico.appendChild(line2);
    const line3 = document.createElementNS('http://www.w3.org/2000/svg','line');
    line3.setAttribute('x1','5'); line3.setAttribute('y1','12');
    line3.setAttribute('x2','12'); line3.setAttribute('y2','12');
    line3.setAttribute('stroke','#ffaa33'); line3.setAttribute('stroke-width','1.2');
    ico.appendChild(line3);

    // Stand
    const stand = document.createElementNS('http://www.w3.org/2000/svg','path');
    stand.setAttribute('d','M9 16 L9 19 M15 16 L15 19 M6 19 L18 19');
    stand.setAttribute('stroke','#ffaa33'); stand.setAttribute('stroke-width','1.5');
    stand.setAttribute('fill','none'); stand.setAttribute('stroke-linecap','round');
    ico.appendChild(stand);

    g.appendChild(ico);

    // Label
    if (dp.name) {
      const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      bg.setAttribute('x', dp.x-35); bg.setAttribute('y', dp.y+27);
      bg.setAttribute('width','70'); bg.setAttribute('height','18');
      bg.setAttribute('fill','#ffaa33'); bg.setAttribute('fill-opacity','0.9'); bg.setAttribute('rx','4');
      g.appendChild(bg);
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', dp.x); lbl.setAttribute('y', dp.y+38);
      lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('dominant-baseline','middle');
      lbl.setAttribute('fill','#fff'); lbl.setAttribute('font-size','9'); lbl.setAttribute('font-weight','700');
      lbl.setAttribute('stroke','#000'); lbl.setAttribute('stroke-width','2'); lbl.setAttribute('paint-order','stroke');
      lbl.textContent = (dp.name.length>12 ? dp.name.substring(0,10)+'…' : dp.name);
      g.appendChild(lbl);
    }
    svg.appendChild(g);
  });

  // Draw network sockets
  (f.sockets||[]).forEach(sock => {
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.style.cursor = 'move';
    g.setAttribute('data-type','socket'); g.setAttribute('data-id', sock.id);
    g.addEventListener('click', e => { e.stopPropagation(); editSocket(sock); });
    g.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'socket', sock, f.name));
    g.addEventListener('mouseleave', hideTT);

    const circ = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circ.setAttribute('cx', sock.x); circ.setAttribute('cy', sock.y);
    circ.setAttribute('r','20');
    circ.setAttribute('fill','#00bfa5'); circ.setAttribute('fill-opacity','0.2');
    circ.setAttribute('stroke','#00bfa5'); circ.setAttribute('stroke-width','2');
    g.appendChild(circ);

    // Outlet icon (electrical socket symbol)
    const ico = document.createElementNS('http://www.w3.org/2000/svg','g');
    ico.setAttribute('transform',`translate(${sock.x-10},${sock.y-10})`);
    
    // Rect outer
    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x','2'); rect.setAttribute('y','3');
    rect.setAttribute('width','16'); rect.setAttribute('height','14');
    rect.setAttribute('rx','2'); rect.setAttribute('fill','none');
    rect.setAttribute('stroke','#00bfa5'); rect.setAttribute('stroke-width','1.5');
    ico.appendChild(rect);
    
    // Left plug hole
    const hole1 = document.createElementNS('http://www.w3.org/2000/svg','rect');
    hole1.setAttribute('x','6'); hole1.setAttribute('y','8');
    hole1.setAttribute('width','2'); hole1.setAttribute('height','4');
    hole1.setAttribute('rx','0.5'); hole1.setAttribute('fill','#00bfa5');
    ico.appendChild(hole1);
    
    // Right plug hole
    const hole2 = document.createElementNS('http://www.w3.org/2000/svg','rect');
    hole2.setAttribute('x','12'); hole2.setAttribute('y','8');
    hole2.setAttribute('width','2'); hole2.setAttribute('height','4');
    hole2.setAttribute('rx','0.5'); hole2.setAttribute('fill','#00bfa5');
    ico.appendChild(hole2);
    
    g.appendChild(ico);

    // Badge with count
    if (sock.outlets && sock.outlets.length > 0) {
      const badge = document.createElementNS('http://www.w3.org/2000/svg','circle');
      badge.setAttribute('cx', sock.x+14); badge.setAttribute('cy', sock.y-14);
      badge.setAttribute('r','8');
      badge.setAttribute('fill','#00bfa5'); badge.setAttribute('stroke','#fff'); badge.setAttribute('stroke-width','2');
      g.appendChild(badge);
      const count = document.createElementNS('http://www.w3.org/2000/svg','text');
      count.setAttribute('x', sock.x+14); count.setAttribute('y', sock.y-14);
      count.setAttribute('text-anchor','middle'); count.setAttribute('dominant-baseline','middle');
      count.setAttribute('fill','#fff'); count.setAttribute('font-size','10'); count.setAttribute('font-weight','800');
      count.textContent = sock.outlets.length;
      g.appendChild(count);
    }

    // Label
    if (sock.name) {
      const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      bg.setAttribute('x', sock.x-35); bg.setAttribute('y', sock.y+25);
      bg.setAttribute('width','70'); bg.setAttribute('height','16');
      bg.setAttribute('fill','#00bfa5'); bg.setAttribute('fill-opacity','0.9'); bg.setAttribute('rx','3');
      g.appendChild(bg);
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', sock.x); lbl.setAttribute('y', sock.y+34);
      lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('dominant-baseline','middle');
      lbl.setAttribute('fill','#fff'); lbl.setAttribute('font-size','9'); lbl.setAttribute('font-weight','700');
      lbl.setAttribute('stroke','#000'); lbl.setAttribute('stroke-width','2'); lbl.setAttribute('paint-order','stroke');
      lbl.textContent = (sock.name.length>12 ? sock.name.substring(0,10)+'…' : sock.name);
      g.appendChild(lbl);
    }
    svg.appendChild(g);
  });

  applyTransform();
  
  // Draw free zones
  (f.freezones||[]).forEach(fz => {
    ensurePolygon(fz);
    const COLOR = fz.color || '#a78bfa';
    const pointsStr = fz.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', COLOR);
    poly.setAttribute('fill-opacity', '0.15');
    poly.setAttribute('stroke', COLOR);
    poly.setAttribute('stroke-width', '2');
    poly.setAttribute('stroke-dasharray', '6,3');
    poly.style.cursor = 'pointer';
    poly.setAttribute('data-type','freezone');
    poly.setAttribute('data-id', fz.id);
    poly.addEventListener('click', e => { e.stopPropagation(); editFreezone(fz); });
    poly.addEventListener('mouseenter', e => showTTGeneric(e.clientX, e.clientY, 'freezone', fz, f.name));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);

    const bounds = calculateBounds(fz.points);
    fz.x = bounds.x; fz.y = bounds.y; fz.w = bounds.w; fz.h = bounds.h;
    const cx = fz.x + fz.w/2, cy = fz.y + fz.h/2;

    const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
    textG.style.pointerEvents = 'none';

    if (fz.icon) {
      const fo = document.createElementNS('http://www.w3.org/2000/svg','foreignObject');
      fo.setAttribute('x', cx-12); fo.setAttribute('y', cy-18);
      fo.setAttribute('width','24'); fo.setAttribute('height','24');
      const div = document.createElement('div');
      div.style.cssText = 'font-size:20px;text-align:center;line-height:24px;';
      div.textContent = fz.icon;
      fo.appendChild(div);
      textG.appendChild(fo);
    }

    if (fz.name && fz.w > 40 && fz.h > 30) {
      const lbl = document.createElementNS('http://www.w3.org/2000/svg','text');
      lbl.setAttribute('x', cx);
      lbl.setAttribute('y', fz.icon ? cy + 14 : cy + 4);
      lbl.setAttribute('text-anchor','middle');
      lbl.setAttribute('fill', COLOR);
      lbl.setAttribute('font-size','12'); lbl.setAttribute('font-weight','700');
      lbl.setAttribute('stroke','#000'); lbl.setAttribute('stroke-width','2.5');
      lbl.setAttribute('paint-order','stroke');
      lbl.textContent = fz.name.length>18 ? fz.name.substring(0,16)+'…' : fz.name;
      textG.appendChild(lbl);
    }
    svg.appendChild(textG);
  });

  // Show anchor points in edit-shape mode
  if (S.mode === 'edit-shape' && S.editingShape) {
    const item = getEditableItem(S.editingShape.type, S.editingShape.id);
    if (item) {
      drawAnchorPoints(item, S.editingShape.type);
    }
  }
}

function roomColor(fid, idx) {
  const colors = ['#4f8aff','#00e5cc','#3ddc97','#ff6b35','#ff5f57','#9b87f5','#ffaa33','#ff4d9a'];
  return colors[(fid + idx) % colors.length];
}

// ═══════════════════════════════════════════════════
//  SHAPE EDITING
// ═══════════════════════════════════════════════════
function getEditableItem(type, id) {
  const f = activeFloor();
  if (!f) return null;
  
  if (type === 'room') return f.rooms.find(r => r.id === id);
  else if (type === 'meeting') return f.meetings.find(m => m.id === id);
  else if (type === 'move') return f.moves.find(m => m.id === id);
  else if (type === 'techroom') return (f.techrooms||[]).find(t => t.id === id);
  return null;
}

function drawAnchorPoints(item, type) {
  const svg = document.getElementById('svg-layer');
  
  ensurePolygon(item);
  
  // Draw all polygon points
  item.points.forEach((pt, idx) => {
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx', pt.x);
    circle.setAttribute('cy', pt.y);
    circle.setAttribute('r', '7');
    circle.setAttribute('fill', '#fff');
    circle.setAttribute('stroke', '#4f8aff');
    circle.setAttribute('stroke-width', '2.5');
    circle.style.cursor = 'move';
    circle.setAttribute('data-anchor', idx);
    circle.setAttribute('data-point-type', 'vertex');
    
    const title = document.createElementNS('http://www.w3.org/2000/svg','title');
    title.textContent = `Point ${idx + 1} (clic droit pour supprimer)`;
    circle.appendChild(title);
    
    // Right-click to delete point
    circle.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      if (item.points.length > 3) {
        item.points.splice(idx, 1);
        renderCanvas();
        notify('Point supprimé');
      } else {
        notify('Minimum 3 points requis');
      }
    });
    
    svg.appendChild(circle);
  });
  
  // Draw midpoints for adding new points
  for (let i = 0; i < item.points.length; i++) {
    const p1 = item.points[i];
    const p2 = item.points[(i + 1) % item.points.length];
    const midX = (p1.x + p2.x) / 2;
    const midY = (p1.y + p2.y) / 2;
    
    const midCircle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    midCircle.setAttribute('cx', midX);
    midCircle.setAttribute('cy', midY);
    midCircle.setAttribute('r', '5');
    midCircle.setAttribute('fill', '#00e5cc');
    midCircle.setAttribute('stroke', '#4f8aff');
    midCircle.setAttribute('stroke-width', '2');
    midCircle.style.cursor = 'pointer';
    midCircle.setAttribute('data-midpoint', i);
    midCircle.setAttribute('data-point-type', 'midpoint');
    
    const midTitle = document.createElementNS('http://www.w3.org/2000/svg','title');
    midTitle.textContent = `Cliquer pour ajouter un point`;
    midCircle.appendChild(midTitle);
    
    // Click to add point
    midCircle.addEventListener('click', (e) => {
      e.stopPropagation();
      item.points.splice(i + 1, 0, {x: midX, y: midY});
      renderCanvas();
      notify('Point ajouté');
    });
    
    svg.appendChild(midCircle);
  }
}

function selectShapeForEditing(type, id) {
  S.editingShape = {type, id, selectedPoint: null};
  renderCanvas();
  notify(`Cliquez sur les points d'ancrage pour redimensionner`);
}

// ═══════════════════════════════════════════════════
//  ROOMS LIST
// ═══════════════════════════════════════════════════
function renderRoomsList() {
  const list = document.getElementById('tab-list');
  const f = activeFloor();
  if (!f || f.rooms.length === 0) {
    list.innerHTML = '<div class="es"><div class="es-title">Aucun bureau</div><div class="es-sub">Tracez des bureaux sur le plan</div></div>';
    return;
  }
  list.innerHTML = '';
  f.rooms.forEach((r,i) => {
    const col = roomColor(f.id, i);
    const d = document.createElement('div');
    d.className = 'rli';
    if (S.selectedRoom === r.id) d.classList.add('on');
    d.innerHTML = `
      <div class="rli-dot" style="background:${col}"></div>
      <div class="rli-name">${esc(r.name||'Bureau '+(i+1))}</div>
      <div class="rli-acts">
        <button class="ib" onclick="event.stopPropagation();editRoom(${r.id})" title="Modifier">✎</button>
        <button class="ib danger" onclick="event.stopPropagation();deleteRoom(${r.id})" title="Supprimer">×</button>
      </div>
    `;
    d.onclick = () => { S.selectedRoom = r.id; renderCanvas(); renderRoomsList(); editorOpen(r); };
    list.appendChild(d);
  });
}

// ═══════════════════════════════════════════════════
//  EQUIPMENTS LIST
// ═══════════════════════════════════════════════════
function renderEquipmentsList() {
  const list = document.getElementById('tab-equip');
  const f = activeFloor();
  if (!f || (f.copiers.length === 0 && f.printers.length === 0 && f.meetings.length === 0
    && (f.screens||[]).length === 0 && (f.techrooms||[]).length === 0 && (f.displays||[]).length === 0)) {
    list.innerHTML = '<div class="es"><div class="es-title">Aucun équipement</div><div class="es-sub">Ajoutez des copieurs, imprimantes, salles de réunion, écrans, affichages dynamiques ou locaux techniques</div></div>';
    return;
  }
  list.innerHTML = '';

  // Copiers
  if (f.copiers.length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:10px 0 8px;';
    h.textContent = 'COPIEURS';
    list.appendChild(h);

    f.copiers.forEach((c,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#ff6b35;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="2" width="12" height="6" rx="1"/><path d="M18 8v10a2 2 0 01-2 2H8a2 2 0 01-2-2V8"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="18" y2="16"/></svg>
        </div>
        <div class="rli-name">${esc(c.name||'Copieur '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editCopier(${JSON.stringify(c).replace(/"/g,'&quot;')})" title="Modifier">✎</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteCopier(${c.id})" title="Supprimer">×</button>
        </div>
      `;
      d.onclick = () => editCopier(c);
      list.appendChild(d);
    });
  }

  // Printers
  if (f.printers.length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'IMPRIMANTES';
    list.appendChild(h);

    f.printers.forEach((p,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#4f8aff;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        </div>
        <div class="rli-name">${esc(p.name||'Imprimante '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editPrinter(${JSON.stringify(p).replace(/"/g,'&quot;')})" title="Modifier">✎</button>
          <button class="ib danger" onclick="event.stopPropagation();deletePrinter(${p.id})" title="Supprimer">×</button>
        </div>
      `;
      d.onclick = () => editPrinter(p);
      list.appendChild(d);
    });
  }

  // Meeting rooms
  if (f.meetings.length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'SALLES DE RÉUNION';
    list.appendChild(h);

    f.meetings.forEach((m,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#3ddc97;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3h2v4M8 3H6v4"/></svg>
        </div>
        <div class="rli-name">${esc(m.name||'Salle '+(i+1))}</div>
        <div class="rli-cnt" style="font-size:9px;">${m.screenSize}"</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editMeeting(${JSON.stringify(m).replace(/"/g,'&quot;')})" title="Modifier">✎</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteMeeting(${m.id})" title="Supprimer">×</button>
        </div>
      `;
      d.onclick = () => editMeeting(m);
      list.appendChild(d);
    });
  }

  // Screens
  if ((f.screens||[]).length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'ÉCRANS';
    list.appendChild(h);
    f.screens.forEach((sc,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#9b87f5;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
        </div>
        <div class="rli-name">${esc(sc.name||'Écran '+(i+1))}</div>
        <div class="rli-cnt" style="font-size:9px;">${sc.size}" ${sc.brand||''}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editScreen({id:${sc.id}})" title="Modifier">✎</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteScreen(${sc.id})" title="Supprimer">×</button>
        </div>`;
      d.onclick = () => editScreen(sc);
      list.appendChild(d);
    });
  }

  // Tech rooms
  if ((f.techrooms||[]).length > 0) {    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'LOCAUX TECHNIQUES';
    list.appendChild(h);
    f.techrooms.forEach((tr,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#ff6b35;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
        </div>
        <div class="rli-name">${esc(tr.name||'Local Tech '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editTechroom({id:${tr.id}})" title="Modifier">✎</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteTechroom(${tr.id})" title="Supprimer">×</button>
        </div>`;
      d.onclick = () => editTechroom(tr);
      list.appendChild(d);
    });
  }

  // Dynamic Displays
  if ((f.displays||[]).length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'AFFICHAGES DYNAMIQUES';
    list.appendChild(h);
    f.displays.forEach((dp,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#ffaa33;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="4" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/><line x1="6" y1="9" x2="18" y2="9"/><line x1="6" y1="13" x2="14" y2="13"/></svg>
        </div>
        <div class="rli-name">${esc(dp.name||'Affichage '+(i+1))}</div>
        <div class="rli-cnt" style="font-size:9px;">${dp.size}"</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editDisplay({id:${dp.id}})" title="Modifier">✎</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteDisplay(${dp.id})" title="Supprimer">×</button>
        </div>`;
      d.onclick = () => editDisplay(dp);
      list.appendChild(d);
    });
  }

  // Free zones
  if ((f.freezones||[]).length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'ZONES LIBRES';
    list.appendChild(h);
    f.freezones.forEach((fz,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:${fz.color||'#a78bfa'};font-size:16px;">${fz.icon||'📦'}</div>
        <div class="rli-name">${esc(fz.name||'Zone '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editFreezone(${JSON.stringify(fz).replace(/"/g,'&quot;')})" title="Modifier">✎</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteFreezone(${fz.id})" title="Supprimer">×</button>
        </div>`;
      d.onclick = () => editFreezone(fz);
      list.appendChild(d);
    });
  }
}

// ═══════════════════════════════════════════════════
//  MOVES LIST
// ═══════════════════════════════════════════════════
function renderMovesList() {
  const list = document.getElementById('tab-move');
  const f = activeFloor();
  if (!f || f.moves.length === 0) {
    list.innerHTML = '<div class="es"><div class="es-title">Aucun déménagement</div><div class="es-sub">Créez des zones de déménagement</div></div>';
    return;
  }
  list.innerHTML = '';

  f.moves.forEach((mv,i) => {
    const d = document.createElement('div');
    d.className = 'rli';
    d.innerHTML = `
      <div class="rli-icon" style="color:#00e5cc;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M9 22V12h6v10"/></svg>
      </div>
      <div class="rli-name">${mv.date ? new Date(mv.date).toLocaleDateString('fr-FR') : 'Date non définie'}</div>
      <div class="rli-cnt">${mv.people.length}</div>
      <div class="rli-acts">
        <button class="ib" onclick="event.stopPropagation();editMove(${JSON.stringify(mv).replace(/"/g,'&quot;')})" title="Modifier">✎</button>
        <button class="ib danger" onclick="event.stopPropagation();deleteMove(${mv.id})" title="Supprimer">×</button>
      </div>
    `;
    d.onclick = () => editMove(mv);
    list.appendChild(d);
  });
}

// ═══════════════════════════════════════════════════
//  EDITOR PANEL
// ═══════════════════════════════════════════════════
function editorOpen(room) {
  const ed = document.getElementById('tab-edit');
  if (!room) {
    ed.innerHTML = '<div class="es"><div class="es-title">Aucune sélection</div><div class="es-sub">Sélectionnez un bureau pour le modifier</div></div>';
    return;
  }

  ed.innerHTML = `
    <div class="ed-title">
      Éditer bureau
      <button class="ed-close" onclick="editorClose()">×</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="ed-name" value="${esc(room.name||'')}" placeholder="Bureau 101">
    </div>
    <button class="btn danger del-room-btn" onclick="deleteRoom(${room.id})">Supprimer le bureau</button>
  `;

  document.getElementById('ed-name').oninput = e => { room.name = e.target.value; renderRoomsList(); renderCanvas(); };
}

function editorClose() {
  S.selectedRoom = null;
  renderCanvas();
  renderRoomsList();
  editorOpen(null);
}

function editRoom(rid) {
  const f = activeFloor(); if (!f) return;
  const r = f.rooms.find(x => x.id === rid); if (!r) return;
  S.selectedRoom = rid;
  renderCanvas();
  renderRoomsList();
  editorOpen(r);
  switchTab('edit');
}

function deleteRoom(rid) {
  const f = activeFloor(); if (!f) return;
  const r = f.rooms.find(x => x.id === rid); if (!r) return;
  showConfirmModal(`Supprimer "${r.name || 'ce bureau'}" ?`, '', () => {
    f.rooms = f.rooms.filter(x => x.id !== rid);
    if (S.selectedRoom === rid) S.selectedRoom = null;
    renderCanvas(); renderRoomsList(); editorOpen(null); updateStats();
    notify('Bureau supprimé.');
  });
}

// ═══════════════════════════════════════════════════
//  COPIER MANAGEMENT
// ═══════════════════════════════════════════════════
function editCopier(c) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">
      Éditer copieur
      <button class="ed-close" onclick="renderEquipmentsList()">×</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="edit-copier-name" value="${esc(c.name||'')}" placeholder="Copieur RDC">
    </div>
    <div class="fg">
      <label class="lb">Informations réseau</label>
      <textarea class="txa" id="edit-copier-network" placeholder="IP, VLAN, etc.">${esc(c.network||'')}</textarea>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveCopier(${c.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteCopier(${c.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  switchTab('equip');
}

function saveCopier(cid) {
  const f = activeFloor(); if (!f) return;
  const c = f.copiers.find(x => x.id === cid); if (!c) return;
  c.name = document.getElementById('edit-copier-name').value.trim();
  c.network = document.getElementById('edit-copier-network').value.trim();
  renderEquipmentsList();
  renderCanvas();
  updateStats();
  notify('Copieur mis à jour.');
}

function deleteCopier(cid) {
  const f = activeFloor(); if (!f) return;
  const c = f.copiers.find(x => x.id === cid); if (!c) return;
  showConfirmModal(`Supprimer "${c.name || 'ce copieur'}" ?`, '', () => {
    f.copiers = f.copiers.filter(x => x.id !== cid);
    renderCanvas(); renderEquipmentsList(); updateStats();
    notify('Copieur supprimé.');
  });
}

// ═══════════════════════════════════════════════════
//  PRINTER MANAGEMENT
// ═══════════════════════════════════════════════════
function editPrinter(p) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">
      Éditer imprimante
      <button class="ed-close" onclick="renderEquipmentsList()">×</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="edit-printer-name" value="${esc(p.name||'')}" placeholder="Imprimante Bureau 1">
    </div>
    <div class="fg">
      <label class="lb">Informations réseau</label>
      <textarea class="txa" id="edit-printer-network" placeholder="IP, VLAN, etc.">${esc(p.network||'')}</textarea>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="savePrinter(${p.id})">Enregistrer</button>
      <button class="btn danger" onclick="deletePrinter(${p.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  switchTab('equip');
}

function savePrinter(pid) {
  const f = activeFloor(); if (!f) return;
  const p = f.printers.find(x => x.id === pid); if (!p) return;
  p.name = document.getElementById('edit-printer-name').value.trim();
  p.network = document.getElementById('edit-printer-network').value.trim();
  renderEquipmentsList();
  renderCanvas();
  updateStats();
  notify('Imprimante mise à jour.');
}

function deletePrinter(pid) {
  const f = activeFloor(); if (!f) return;
  const p = f.printers.find(x => x.id === pid); if (!p) return;
  showConfirmModal(`Supprimer "${p.name || 'cette imprimante'}" ?`, '', () => {
    f.printers = f.printers.filter(x => x.id !== pid);
    renderCanvas(); renderEquipmentsList(); updateStats();
    notify('Imprimante supprimée.');
  });
}

// ═══════════════════════════════════════════════════
//  MEETING ROOM MANAGEMENT
// ═══════════════════════════════════════════════════
function editMeeting(m) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">
      Éditer salle de réunion
      <button class="ed-close" onclick="renderEquipmentsList()">×</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="edit-meeting-name" value="${esc(m.name||'')}" placeholder="Salle Réunion A">
    </div>
    <div class="fg">
      <label class="lb">Type d'écran</label>
      <div class="check-group">
        <input type="radio" name="edit-screen-type" id="edit-screen-tactile" value="tactile" ${m.screenType==='tactile'?'checked':''}>
        <label for="edit-screen-tactile">Écran tactile</label>
      </div>
      <div class="check-group">
        <input type="radio" name="edit-screen-type" id="edit-screen-classic" value="classique" ${m.screenType==='classique'?'checked':''}>
        <label for="edit-screen-classic">Écran classique</label>
      </div>
    </div>
    <div class="fg">
      <label class="lb">Taille de l'écran</label>
      <select class="sel" id="edit-meeting-size">
        <option value="49" ${m.screenSize===49?'selected':''}>49 pouces</option>
        <option value="55" ${m.screenSize===55?'selected':''}>55 pouces</option>
        <option value="65" ${m.screenSize===65?'selected':''}>65 pouces</option>
        <option value="75" ${m.screenSize===75?'selected':''}>75 pouces</option>
        <option value="98" ${m.screenSize===98?'selected':''}>98 pouces</option>
      </select>
    </div>
    <div class="fg">
      <div class="check-group">
        <input type="checkbox" id="edit-meeting-mtr" ${m.hasMTR?'checked':''}>
        <label for="edit-meeting-mtr">Équipement MTR (Microsoft Teams Rooms)</label>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveMeeting(${m.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteMeeting(${m.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  switchTab('equip');
}

function saveMeeting(mid) {
  const f = activeFloor(); if (!f) return;
  const m = f.meetings.find(x => x.id === mid); if (!m) return;
  m.name = document.getElementById('edit-meeting-name').value.trim();
  m.screenType = document.querySelector('input[name="edit-screen-type"]:checked').value;
  m.screenSize = parseInt(document.getElementById('edit-meeting-size').value);
  m.hasMTR = document.getElementById('edit-meeting-mtr').checked;
  renderEquipmentsList();
  renderCanvas();
  updateStats();
  notify('Salle de réunion mise à jour.');
}

function deleteMeeting(mid) {
  const f = activeFloor(); if (!f) return;
  const m = f.meetings.find(x => x.id === mid); if (!m) return;
  showConfirmModal(`Supprimer "${m.name || 'cette salle'}" ?`, '', () => {
    f.meetings = f.meetings.filter(x => x.id !== mid);
    renderCanvas(); renderEquipmentsList(); updateStats();
    notify('Salle de réunion supprimée.');
  });
}

// ═══════════════════════════════════════════════════
//  MOVE MANAGEMENT
// ═══════════════════════════════════════════════════
function editMove(mv) {
  const ed = document.getElementById('tab-move');
  const content = `
    <div class="ed-title">
      Éditer déménagement
      <button class="ed-close" onclick="renderMovesList()">×</button>
    </div>
    <div class="fg">
      <label class="lb">Date du déménagement</label>
      <input type="date" class="inp" id="edit-move-date" value="${mv.date||''}">
    </div>
    <div class="fg">
      <label class="lb">Personnes concernées</label>
      <div class="move-people-list" id="edit-move-people"></div>
      <div class="add-person">
        <input type="text" class="inp" id="edit-move-person-input" placeholder="Nom de la personne">
        <button class="btn" onclick="addEditMovePerson(${mv.id})">+</button>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveMove(${mv.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteMove(${mv.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  renderEditMovePeople(mv);
  switchTab('move');
  document.getElementById('edit-move-person-input').onkeydown = e => { if (e.key==='Enter') addEditMovePerson(mv.id); };
}

function renderEditMovePeople(mv) {
  const c = document.getElementById('edit-move-people');
  if (!c) return;
  c.innerHTML = '';
  if (mv.people.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune personne</div>';
    return;
  }
  mv.people.forEach((p,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `
      <div class="move-person-name">${esc(p.name)}</div>
      <div class="move-person-pc">
        <input type="checkbox" ${p.needsPC?'checked':''} onchange="toggleEditPersonPC(${mv.id},${i})">
        <span>PC</span>
      </div>
      <button class="sock-del" onclick="removeEditMovePerson(${mv.id},${i})">×</button>
    `;
    c.appendChild(d);
  });
}

function addEditMovePerson(mvid) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  const inp = document.getElementById('edit-move-person-input');
  const v = inp.value.trim(); if (!v) return;
  mv.people.push({name: v, needsPC: false});
  inp.value = '';
  renderEditMovePeople(mv);
  renderMovesList();
  updateStats();
}

function removeEditMovePerson(mvid, idx) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  mv.people.splice(idx, 1);
  renderEditMovePeople(mv);
  renderMovesList();
  updateStats();
}

function toggleEditPersonPC(mvid, idx) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  mv.people[idx].needsPC = !mv.people[idx].needsPC;
  updateStats();
}

function saveMove(mvid) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  mv.date = document.getElementById('edit-move-date').value;
  renderMovesList();
  renderCanvas();
  updateStats();
  notify('Déménagement mis à jour.');
}

function deleteMove(mvid) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  showConfirmModal('Supprimer ce déménagement ?', '', () => {
    f.moves = f.moves.filter(x => x.id !== mvid);
    renderCanvas(); renderMovesList(); updateStats();
    notify('Déménagement supprimé.');
  });
}

// ═══════════════════════════════════════════════════
//  IMAGE UPLOAD
// ═══════════════════════════════════════════════════
function setupImageUpload() {
  const dz = document.getElementById('drop-zone');
  const card = document.getElementById('dz-card');

  card.onclick = () => {
    const inp = document.createElement('input');
    inp.type = 'file'; inp.accept = 'image/*,.pdf,application/pdf';
    inp.onchange = e => { if (e.target.files[0]) handlePlanFile(e.target.files[0]); };
    inp.click();
  };

  dz.ondragover = e => { e.preventDefault(); card.classList.add('over'); };
  dz.ondragleave = () => card.classList.remove('over');
  dz.ondrop = e => {
    e.preventDefault();
    card.classList.remove('over');
    if (e.dataTransfer.files[0]) handlePlanFile(e.dataTransfer.files[0]);
  };
}

let _pendingPlanFile = null;

function handlePlanFile(file) {
  _pendingPlanFile = file;
  openModalFloor();
}

function loadImage(file) {
  const f = activeFloor(); if (!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      f.imageB64 = e.target.result;
      f.imageW = img.width;
      f.imageH = img.height;
      renderCanvas();
      notify('Plan chargé !');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

async function loadPDF(file) {
  const f = activeFloor(); if (!f) return;
  notify('Chargement du PDF...');

  try {
    if (typeof pdfjsLib === 'undefined') {
      alert('PDF.js non chargé. Vérifiez votre connexion internet.');
      return;
    }
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const arrayBuffer = await file.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const numPages = pdfDoc.numPages;

    let pageNum = 1;
    if (numPages > 1) {
      const input = prompt(
        `Ce PDF contient ${numPages} page${numPages > 1 ? 's' : ''}.\nQuelle page voulez-vous utiliser ? (1–${numPages})`,
        '1'
      );
      pageNum = Math.max(1, Math.min(numPages, parseInt(input) || 1));
    }

    const page = await pdfDoc.getPage(pageNum);
    const scale = 2;
    const viewport = page.getViewport({ scale });

    const canvas = document.createElement('canvas');
    canvas.width  = viewport.width;
    canvas.height = viewport.height;
    const ctx = canvas.getContext('2d');

    await page.render({ canvasContext: ctx, viewport }).promise;

    f.imageB64 = canvas.toDataURL('image/png');
    f.imageW   = canvas.width;
    f.imageH   = canvas.height;
    renderCanvas();
    notify(`PDF page ${pageNum}/${numPages} chargé !`);

  } catch (err) {
    console.error('PDF load error:', err);
    alert('Erreur lors du chargement du PDF : ' + err.message);
  }
}

// ═══════════════════════════════════════════════════
//  DRAWING
// ═══════════════════════════════════════════════════
function getCanvasCoords(clientX, clientY) {
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (clientX - rect.left) / S.zoom;
  const y = (clientY - rect.top) / S.zoom;
  return {x, y};
}

// Returns coords relative to canvas-area (for ghost positioning)
function getScreenCoords(clientX, clientY) {
  const areaRect = document.getElementById('canvas-area').getBoundingClientRect();
  return { sx: clientX - areaRect.left, sy: clientY - areaRect.top };
}

function setupDrawing() {
  const root = document.getElementById('canvas-root');
  const ghost = document.getElementById('draw-ghost');

  root.addEventListener('mousedown', e => {
    if (S.mode === 'edit-shape') {
      const target = e.target;
      
      // Check if clicking on a vertex point
      if (target.hasAttribute('data-anchor') && target.getAttribute('data-point-type') === 'vertex') {
        const anchor = parseInt(target.getAttribute('data-anchor'));
        S.editingShape.selectedPoint = anchor;
        const rect = document.getElementById('canvas-root').getBoundingClientRect();
        S.editingShape.startX = (e.clientX - rect.left) / S.zoom;
        S.editingShape.startY = (e.clientY - rect.top) / S.zoom;
        return;
      }
      
      // Midpoints are handled by their own click event
      
      // Check if clicking on a shape to select it
      if (target.hasAttribute('data-type')) {
        const type = target.getAttribute('data-type');
        const id = parseInt(target.getAttribute('data-id'));
        if (type === 'room' || type === 'meeting' || type === 'move') {
          selectShapeForEditing(type, id);
        }
        return;
      }
      
      return;
    }
    
    if (S.mode === 'draw') startDrawRoom(e);
    else if (S.mode === 'copier') placeCopier(e);
    else if (S.mode === 'printer') placePrinter(e);
    else if (S.mode === 'meeting') placeMeeting(e);
    else if (S.mode === 'move') startDrawMove(e);
    else if (S.mode === 'screen') placeScreen(e);
    else if (S.mode === 'techroom') startDrawTechroom(e);
    else if (S.mode === 'display') placeDisplay(e);
    else if (S.mode === 'socket') placeSocket(e);
    else if (S.mode === 'freezone') startDrawFreezone(e);
  });

  root.addEventListener('mousemove', e => {
    if (S.mode === 'edit-shape' && S.editingShape?.selectedPoint !== null && S.editingShape?.selectedPoint !== undefined) {
      const rect = document.getElementById('canvas-root').getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / S.zoom;
      const mouseY = (e.clientY - rect.top) / S.zoom;
      
      const item = getEditableItem(S.editingShape.type, S.editingShape.id);
      if (!item || !item.points) return;
      
      const pointIdx = S.editingShape.selectedPoint;
      if (pointIdx >= 0 && pointIdx < item.points.length) {
        item.points[pointIdx].x = mouseX;
        item.points[pointIdx].y = mouseY;
        renderCanvas();
      }
      return;
    }
    
    if (S.mode === 'draw' && S.drawing) continueDrawRoom(e);
    else if (S.mode === 'meeting' && S.drawing) continueDrawMeeting(e);
    else if (S.mode === 'move' && S.drawing) continueDrawMove(e);
    else if (S.mode === 'techroom' && S.drawing) continueDrawTechroom(e);
    else if (S.mode === 'freezone' && S.drawing) continueDrawFreezone(e);
  });

  root.addEventListener('mouseup', e => {
    if (S.mode === 'edit-shape' && S.editingShape?.selectedPoint !== null && S.editingShape?.selectedPoint !== undefined) {
      S.editingShape.selectedPoint = null;
      notify('Point déplacé !');
      return;
    }
    
    if (S.mode === 'draw' && S.drawing) endDrawRoom(e);
    else if (S.mode === 'meeting' && S.drawing) endDrawMeeting(e);
    else if (S.mode === 'move' && S.drawing) endDrawMove(e);
    else if (S.mode === 'techroom' && S.drawing) endDrawTechroom(e);
    else if (S.mode === 'freezone' && S.drawing) endDrawFreezone(e);
  });
}

function startDrawRoom(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  S.drawing = {x0:x, y0:y, sx0:sx, sy0:sy};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = sx+'px';
  ghost.style.top = sy+'px';
  ghost.style.width = '0px';
  ghost.style.height = '0px';
}

function continueDrawRoom(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.left = Math.min(sx, S.drawing.sx0)+'px';
  ghost.style.top  = Math.min(sy, S.drawing.sy0)+'px';
  ghost.style.width  = (Math.abs(sx - S.drawing.sx0))+'px';
  ghost.style.height = (Math.abs(sy - S.drawing.sy0))+'px';
}

function endDrawRoom(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  
  document.getElementById('draw-ghost').style.display = 'none';
  S.drawing = null;

  if (w < 10 || h < 10) return;

  S.tempRoom = {x:l, y:t, w, h};
  openModalRoom();
}

function placeCopier(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  S.tempCopierPos = {x, y};
  openModalCopier();
}

function placePrinter(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  S.tempPrinterPos = {x, y};
  openModalPrinter();
}

function placeMeeting(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  S.drawing = {x0:x, y0:y, sx0:sx, sy0:sy};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = sx+'px';
  ghost.style.top = sy+'px';
  ghost.style.width = '0px';
  ghost.style.height = '0px';
  ghost.style.borderColor = '#3ddc97';
  ghost.style.background = 'rgba(61,220,151,.08)';
}

function startDrawMove(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  S.drawing = {x0:x, y0:y, sx0:sx, sy0:sy};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = sx+'px';
  ghost.style.top = sy+'px';
  ghost.style.width = '0px';
  ghost.style.height = '0px';
  ghost.style.borderColor = 'var(--accent2)';
  ghost.style.borderStyle = 'dashed';
  ghost.style.background = 'rgba(0,229,204,.08)';
}

function continueDrawMeeting(e) {
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.left = Math.min(sx, S.drawing.sx0)+'px';
  ghost.style.top  = Math.min(sy, S.drawing.sy0)+'px';
  ghost.style.width  = Math.abs(sx - S.drawing.sx0)+'px';
  ghost.style.height = Math.abs(sy - S.drawing.sy0)+'px';
}

function endDrawMeeting(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'none';
  ghost.style.borderColor = 'var(--accent2)';
  ghost.style.borderStyle = 'solid';
  ghost.style.background = 'rgba(0,229,204,.08)';
  S.drawing = null;

  if (w < 10 || h < 10) return;

  S.tempMeetingPos = {x:l, y:t, w, h};
  openModalMeeting();
}

function continueDrawMove(e) {
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.left = Math.min(sx, S.drawing.sx0)+'px';
  ghost.style.top  = Math.min(sy, S.drawing.sy0)+'px';
  ghost.style.width  = Math.abs(sx - S.drawing.sx0)+'px';
  ghost.style.height = Math.abs(sy - S.drawing.sy0)+'px';
}

function endDrawMove(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'none';
  ghost.style.borderColor = 'var(--accent2)';
  ghost.style.borderStyle = 'solid';
  S.drawing = null;

  if (w < 10 || h < 10) return;

  S.tempMovePos = {x:l, y:t, w, h};
  S.tempMove = {people: []};
  openModalMove();
}

// ═══════════════════════════════════════════════════
//  ZOOM & PAN
// ═══════════════════════════════════════════════════
function applyTransform() {
  const root = document.getElementById('canvas-root');
  root.style.transform = `scale(${S.zoom}) translate(${S.pan.x}px, ${S.pan.y}px)`;
  document.getElementById('zpct').textContent = Math.round(S.zoom*100)+'%';
}

function zoomIn() { S.zoom = Math.min(S.zoom*1.2, 5); applyTransform(); }
function zoomOut() { S.zoom = Math.max(S.zoom/1.2, 0.2); applyTransform(); }
function zoomReset() { S.zoom=1; S.pan={x:0,y:0}; applyTransform(); }
function zoomFit() {
  const f = activeFloor();
  if (!f || !f.imageW || !f.imageH) { zoomReset(); return; }
  const area = document.getElementById('canvas-area');
  const aw = area.clientWidth - 32;
  const ah = area.clientHeight - 32;
  const scaleX = aw / f.imageW;
  const scaleY = ah / f.imageH;
  S.zoom = Math.min(scaleX, scaleY, 1);
  S.pan = {x: (aw/S.zoom - f.imageW)/2, y: (ah/S.zoom - f.imageH)/2};
  applyTransform();
}

function setupPan() {
  const area = document.getElementById('canvas-area');
  let dragging = false, ox, oy;

  area.addEventListener('mousedown', e => {
    // Check if clicking on an element to drag
    const target = e.target;
    if (target.hasAttribute && (target.hasAttribute('data-type') || target.parentElement?.hasAttribute('data-type'))) {
      const elem = target.hasAttribute('data-type') ? target : target.parentElement;
      const type = elem.getAttribute('data-type');
      const id = parseInt(elem.getAttribute('data-id'));
      
      if (S.mode === 'nav') {
        e.stopPropagation();
        const f = activeFloor();
        if (!f) return;
        
        const rect = document.getElementById('canvas-root').getBoundingClientRect();
        const mouseX = (e.clientX - rect.left) / S.zoom;
        const mouseY = (e.clientY - rect.top) / S.zoom;
        
        let item = null;
        if (type === 'room') item = f.rooms.find(r => r.id === id);
        else if (type === 'copier') item = f.copiers.find(c => c.id === id);
        else if (type === 'printer') item = f.printers.find(p => p.id === id);
        else if (type === 'meeting') item = f.meetings.find(m => m.id === id);
        else if (type === 'move') item = f.moves.find(m => m.id === id);
        else if (type === 'screen') item = (f.screens||[]).find(s => s.id === id);
        else if (type === 'techroom') item = (f.techrooms||[]).find(t => t.id === id);
        else if (type === 'display') item = (f.displays||[]).find(d => d.id === id);
        
        if (item) {
          S.dragging = {
            type,
            id,
            startX: mouseX,
            startY: mouseY,
            origX: item.x,
            origY: item.y
          };
        }
      }
    }
    
    if (S.mode !== 'nav') return;
    dragging = true; 
    ox = e.clientX - S.pan.x; 
    oy = e.clientY - S.pan.y;
    area.style.cursor = 'grabbing';
  });

  area.addEventListener('mousemove', e => {
    if (S.dragging) {
      const f = activeFloor();
      if (!f) return;
      
      const rect = document.getElementById('canvas-root').getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / S.zoom;
      const mouseY = (e.clientY - rect.top) / S.zoom;
      
      const dx = mouseX - S.dragging.startX;
      const dy = mouseY - S.dragging.startY;
      
      let item = null;
      if (S.dragging.type === 'room') item = f.rooms.find(r => r.id === S.dragging.id);
      else if (S.dragging.type === 'copier') item = f.copiers.find(c => c.id === S.dragging.id);
      else if (S.dragging.type === 'printer') item = f.printers.find(p => p.id === S.dragging.id);
      else if (S.dragging.type === 'meeting') item = f.meetings.find(m => m.id === S.dragging.id);
      else if (S.dragging.type === 'move') item = f.moves.find(m => m.id === S.dragging.id);
      else if (S.dragging.type === 'screen') item = (f.screens||[]).find(s => s.id === S.dragging.id);
      else if (S.dragging.type === 'techroom') item = (f.techrooms||[]).find(t => t.id === S.dragging.id);
      else if (S.dragging.type === 'display') item = (f.displays||[]).find(d => d.id === S.dragging.id);
      
      if (item) {
        item.x = S.dragging.origX + dx;
        item.y = S.dragging.origY + dy;
        renderCanvas();
      }
      return;
    }
    
    if (dragging) {
      S.pan.x = e.clientX - ox;
      S.pan.y = e.clientY - oy;
      applyTransform();
    }
    const rect = document.getElementById('canvas-root').getBoundingClientRect();
    const x = Math.round((e.clientX - rect.left) / S.zoom);
    const y = Math.round((e.clientY - rect.top) / S.zoom);
    document.getElementById('coords').textContent = `x:${x} y:${y}`;
  });

  area.addEventListener('mouseup', () => {
    if (S.dragging) {
      S.dragging = null;
      notify('Élément déplacé !');
    }
    if (dragging) { 
      dragging = false; 
      area.style.cursor = ''; 
    }
  });

  area.addEventListener('wheel', e => {
    e.preventDefault();
    if (e.deltaY < 0) zoomIn(); else zoomOut();
  });
}

// ═══════════════════════════════════════════════════
//  MODALS
// ═══════════════════════════════════════════════════
function openModalRoom() {
  document.getElementById('modal-room-name').value = '';
  document.getElementById('modal-room').classList.add('on');
  setTimeout(() => { const i = document.getElementById('modal-room-name'); i.focus(); }, 60);
}
function confirmRoom() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-room-name').value.trim();
  const r = {
    id: _id++, 
    name, 
    x: S.tempRoom.x, 
    y: S.tempRoom.y, 
    w: S.tempRoom.w, 
    h: S.tempRoom.h,
    points: [
      {x: S.tempRoom.x, y: S.tempRoom.y},
      {x: S.tempRoom.x + S.tempRoom.w, y: S.tempRoom.y},
      {x: S.tempRoom.x + S.tempRoom.w, y: S.tempRoom.y + S.tempRoom.h},
      {x: S.tempRoom.x, y: S.tempRoom.y + S.tempRoom.h}
    ],
    sockets: []
  };
  f.rooms.push(r);
  document.getElementById('modal-room').classList.remove('on');
  S.tempRoom = null;
  renderCanvas();
  renderRoomsList();
  updateStats();
  notify(`Bureau "${name||'sans nom'}" créé !`);
}
function cancelRoom() { document.getElementById('modal-room').classList.remove('on'); S.tempRoom = null; }

function openModalCopier() {
  document.getElementById('modal-copier-name').value = '';
  document.getElementById('modal-copier-network').value = '';
  document.getElementById('modal-copier').classList.add('on');
  setTimeout(() => { document.getElementById('modal-copier-name').focus(); }, 60);
}
function confirmCopier() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-copier-name').value.trim();
  const network = document.getElementById('modal-copier-network').value.trim();
  const c = {id: _id++, name, network, x:S.tempCopierPos.x, y:S.tempCopierPos.y};
  f.copiers.push(c);
  document.getElementById('modal-copier').classList.remove('on');
  S.tempCopierPos = null;
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify(`Copieur "${name||'sans nom'}" créé !`);
}
function cancelCopier() { document.getElementById('modal-copier').classList.remove('on'); S.tempCopierPos = null; }

function openModalPrinter() {
  document.getElementById('modal-printer-name').value = '';
  document.getElementById('modal-printer-network').value = '';
  document.getElementById('modal-printer').classList.add('on');
  setTimeout(() => { document.getElementById('modal-printer-name').focus(); }, 60);
}
function confirmPrinter() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-printer-name').value.trim();
  const network = document.getElementById('modal-printer-network').value.trim();
  const p = {id: _id++, name, network, x:S.tempPrinterPos.x, y:S.tempPrinterPos.y};
  f.printers.push(p);
  document.getElementById('modal-printer').classList.remove('on');
  S.tempPrinterPos = null;
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify(`Imprimante "${name||'sans nom'}" créée !`);
}
function cancelPrinter() { document.getElementById('modal-printer').classList.remove('on'); S.tempPrinterPos = null; }

function openModalMeeting() {
  document.getElementById('modal-meeting-name').value = '';
  document.getElementById('screen-tactile').checked = true;
  document.getElementById('modal-meeting-size').value = '55';
  document.getElementById('modal-meeting-mtr').checked = false;
  document.getElementById('modal-meeting').classList.add('on');
  setTimeout(() => { document.getElementById('modal-meeting-name').focus(); }, 60);
}
function confirmMeeting() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-meeting-name').value.trim();
  const screenType = document.querySelector('input[name="screen-type"]:checked').value;
  const screenSize = parseInt(document.getElementById('modal-meeting-size').value);
  const hasMTR = document.getElementById('modal-meeting-mtr').checked;
  const m = {
    id: _id++, 
    name, 
    screenType, 
    screenSize, 
    hasMTR,
    x: S.tempMeetingPos.x, 
    y: S.tempMeetingPos.y,
    w: S.tempMeetingPos.w,
    h: S.tempMeetingPos.h,
    points: [
      {x: S.tempMeetingPos.x, y: S.tempMeetingPos.y},
      {x: S.tempMeetingPos.x + S.tempMeetingPos.w, y: S.tempMeetingPos.y},
      {x: S.tempMeetingPos.x + S.tempMeetingPos.w, y: S.tempMeetingPos.y + S.tempMeetingPos.h},
      {x: S.tempMeetingPos.x, y: S.tempMeetingPos.y + S.tempMeetingPos.h}
    ]
  };
  f.meetings.push(m);
  document.getElementById('modal-meeting').classList.remove('on');
  S.tempMeetingPos = null;
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify(`Salle de réunion "${name||'sans nom'}" créée !`);
}
function cancelMeeting() { document.getElementById('modal-meeting').classList.remove('on'); S.tempMeetingPos = null; }

function openModalMove() {
  document.getElementById('modal-move-date').value = '';
  document.getElementById('modal-move-people').innerHTML = '';
  S.tempMove.people = [];
  document.getElementById('modal-move').classList.add('on');
  setTimeout(() => { document.getElementById('modal-move-date').focus(); }, 60);
}
function confirmMove() {
  const f = activeFloor(); if (!f) return;
  const date = document.getElementById('modal-move-date').value;
  const mv = {
    id: _id++,
    date,
    people: S.tempMove.people,
    x: S.tempMovePos.x,
    y: S.tempMovePos.y,
    w: S.tempMovePos.w,
    h: S.tempMovePos.h,
    points: [
      {x: S.tempMovePos.x, y: S.tempMovePos.y},
      {x: S.tempMovePos.x + S.tempMovePos.w, y: S.tempMovePos.y},
      {x: S.tempMovePos.x + S.tempMovePos.w, y: S.tempMovePos.y + S.tempMovePos.h},
      {x: S.tempMovePos.x, y: S.tempMovePos.y + S.tempMovePos.h}
    ]
  };
  f.moves.push(mv);
  document.getElementById('modal-move').classList.remove('on');
  S.tempMovePos = null;
  S.tempMove = {people: []};
  renderCanvas();
  renderMovesList();
  updateStats();
  notify('Déménagement créé !');
}
function cancelMove() { 
  document.getElementById('modal-move').classList.remove('on'); 
  S.tempMovePos = null;
  S.tempMove = {people: []};
}

function renderModalMovePeople() {
  const c = document.getElementById('modal-move-people');
  c.innerHTML = '';
  if (S.tempMove.people.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune personne</div>';
    return;
  }
  S.tempMove.people.forEach((p,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `
      <div class="move-person-name">${esc(p.name)}</div>
      <div class="move-person-pc">
        <input type="checkbox" ${p.needsPC?'checked':''} onchange="toggleMovePerson(${i})">
        <span>PC</span>
      </div>
      <button class="sock-del" onclick="removeMovePerson(${i})">×</button>
    `;
    c.appendChild(d);
  });
}

function addMovePerson() {
  const inp = document.getElementById('modal-move-person-input');
  const v = inp.value.trim(); if (!v) return;
  S.tempMove.people.push({name: v, needsPC: false});
  inp.value = '';
  renderModalMovePeople();
}

function removeMovePerson(idx) {
  S.tempMove.people.splice(idx, 1);
  renderModalMovePeople();
}

function toggleMovePerson(idx) {
  S.tempMove.people[idx].needsPC = !S.tempMove.people[idx].needsPC;
}

// ═══════════════════════════════════════════════════
//  LOCATIONS MANAGEMENT
// ═══════════════════════════════════════════════════
function openLocationsModal() {
  renderLocationsList();
  document.getElementById('modal-locations').classList.add('on');
  setTimeout(() => { document.getElementById('location-input').focus(); }, 60);
}

function closeLocationsModal() {
  document.getElementById('modal-locations').classList.remove('on');
}

function renderLocationsList() {
  const list = document.getElementById('locations-list');
  list.innerHTML = '';
  
  if (S.locations.length === 0) {
    list.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;padding:10px;">Aucun lieu défini</div>';
    return;
  }
  
  S.locations.forEach((loc, i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.style.marginBottom = '5px';
    d.innerHTML = `
      <div class="move-person-name" style="flex:1;">${esc(loc)}</div>
      <button class="sock-del" onclick="removeLocation(${i})">×</button>
    `;
    list.appendChild(d);
  });
}

function addLocation() {
  const inp = document.getElementById('location-input');
  const v = inp.value.trim();
  if (!v) return;
  if (S.locations.includes(v)) {
    notify('Ce lieu existe déjà !');
    return;
  }
  S.locations.push(v);
  inp.value = '';
  renderLocationsList();
  notify(`Lieu "${v}" ajouté !`);
}

function removeLocation(idx) {
  const loc = S.locations[idx];
  showConfirmModal(`Supprimer le lieu "${loc}" ?`, '', () => {
    S.locations.splice(idx, 1);
    renderLocationsList();
    notify(`Lieu "${loc}" supprimé.`);
  });
}

function openModalFloor() {
  const selSite = document.getElementById('modal-floor-site');
  const selLevel = document.getElementById('modal-floor-level');
  const selSubSite = document.getElementById('modal-floor-subsite');
  const subSiteGroup = document.getElementById('modal-floor-subsite-group');
  
  // Remplir les sites
  selSite.innerHTML = '<option value="">-- Choisir un site --</option>';
  S.locations.forEach(loc => {
    const opt = document.createElement('option');
    opt.value = loc;
    opt.textContent = loc;
    selSite.appendChild(opt);
  });
  
  // Remplir les sous-sites COM
  selSubSite.innerHTML = '<option value="">-- Choisir un sous-site --</option>';
  S.comSubSites.forEach(sub => {
    const opt = document.createElement('option');
    opt.value = sub;
    opt.textContent = sub;
    selSubSite.appendChild(opt);
  });
  
  // Fonction pour remplir les niveaux selon le site/sous-site
  const fillLevels = () => {
    const site = selSite.value;
    const subSite = selSubSite.value;
    
    selLevel.innerHTML = '<option value="">-- Choisir un étage --</option>';
    
    let levels = S.floorLevels;
    
    // Si COM avec sous-site sélectionné, utiliser les niveaux spécifiques
    if (site === 'COM' && subSite && S.comSubSiteLevels[subSite]) {
      levels = S.comSubSiteLevels[subSite];
    }
    
    levels.forEach(lvl => {
      const opt = document.createElement('option');
      opt.value = lvl;
      opt.textContent = lvl;
      selLevel.appendChild(opt);
    });
  };
  
  // Afficher/masquer le sous-site selon le site sélectionné
  selSite.onchange = () => {
    if (selSite.value === 'COM') {
      subSiteGroup.style.display = 'block';
      selSubSite.value = '';
      selLevel.innerHTML = '<option value="">-- Choisir un étage --</option>';
    } else {
      subSiteGroup.style.display = 'none';
      selSubSite.value = '';
      fillLevels();
    }
  };
  
  // Remplir les niveaux quand le sous-site change
  selSubSite.onchange = fillLevels;
  
  fillLevels();
  subSiteGroup.style.display = 'none';
  document.getElementById('modal-floor').classList.add('on');
  setTimeout(() => selSite.focus(), 60);
}

function confirmFloor() {
  const site = document.getElementById('modal-floor-site').value.trim();
  const level = document.getElementById('modal-floor-level').value.trim();
  const subSite = site === 'COM' ? document.getElementById('modal-floor-subsite').value.trim() : '';
  
  if (!site || !level) {
    notify('Veuillez sélectionner un site et un étage.');
    return;
  }
  
  if (site === 'COM' && !subSite) {
    notify('Veuillez sélectionner un sous-site pour le COM.');
    return;
  }
  
  document.getElementById('modal-floor').classList.remove('on');
  addFloor(site, level, subSite);
  const fullName = subSite ? `${site} - ${subSite} - ${level}` : `${site} - ${level}`;
  notify(`Étage "${fullName}" créé !`);
  
  // Charger le fichier plan si présent
  if (_pendingPlanFile) {
    const file = _pendingPlanFile;
    _pendingPlanFile = null;
    if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
      loadPDF(file);
    } else {
      loadImage(file);
    }
  }
}

function cancelFloor() { 
  document.getElementById('modal-floor').classList.remove('on');
  _pendingPlanFile = null;
}

document.addEventListener('keydown', e => {
  if (e.key==='Escape') { 
    cancelRoom(); cancelFloor(); cancelCopier(); cancelPrinter();
    cancelMeeting(); cancelMove(); closeLocationsModal();
    cancelScreen(); cancelTechroom(); cancelDisplay(); cancelSocket(); cancelFreezone(); closeExportModal(); closeConfirmModal();
  }
});

['modal-room','modal-floor','modal-copier','modal-printer','modal-meeting','modal-move','modal-locations','modal-screen','modal-techroom','modal-display','modal-socket','modal-freezone','modal-export'].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('click', e => {
    if (e.target === e.currentTarget) {
      if (id==='modal-room') cancelRoom();
      else if (id==='modal-floor') cancelFloor();
      else if (id==='modal-copier') cancelCopier();
      else if (id==='modal-printer') cancelPrinter();
      else if (id==='modal-meeting') cancelMeeting();
      else if (id==='modal-move') cancelMove();
      else if (id==='modal-locations') closeLocationsModal();
      else if (id==='modal-screen') cancelScreen();
      else if (id==='modal-techroom') cancelTechroom();
      else if (id==='modal-display') cancelDisplay();
      else if (id==='modal-freezone') cancelFreezone();
    }
  });
});

// ═══════════════════════════════════════════════════
//  MODAL CONFIRMATION (remplace window.confirm bloqué en iframe)
// ═══════════════════════════════════════════════════
let _confirmCallback = null;
function showConfirmModal(title, body, onConfirm) {
  document.getElementById('confirm-title').textContent = title;
  const bd = document.getElementById('confirm-body');
  bd.textContent = body;
  bd.style.display = body ? 'block' : 'none';
  _confirmCallback = onConfirm;
  document.getElementById('modal-confirm').classList.add('on');
}
function closeConfirmModal() {
  document.getElementById('modal-confirm').classList.remove('on');
  _confirmCallback = null;
}
function doConfirm() {
  const cb = _confirmCallback;
  closeConfirmModal();
  if (cb) cb();
}

// ═══════════════════════════════════════════════════
//  TOOLTIP
// ═══════════════════════════════════════════════════
const TYPE_META = {
  room:     { label:'Bureau',              color:'#4f8aff' },
  copier:   { label:'Copieur',             color:'#ff6b35' },
  printer:  { label:'Imprimante',          color:'#4f8aff' },
  meeting:  { label:'Salle de réunion',    color:'#3ddc97' },
  move:     { label:'Déménagement',        color:'#00e5cc' },
  screen:   { label:'Écran',              color:'#9b87f5' },
  techroom: { label:'Local technique',     color:'#e03030' },
  display:  { label:'Affichage dynamique', color:'#ffaa33' },
  socket:   { label:'Prises réseau',       color:'#00bfa5' },
  freezone: { label:'Zone libre',          color:'#a78bfa' },
};

function buildTTRows(rows) {
  return rows.filter(r => r.val && String(r.val).trim()).map(r => {
    // Convertir les retours à la ligne en <br>
    const valHtml = esc(String(r.val)).replace(/\n/g, '<br>');
    return `<div class="tt-row"><span class="tt-row-label">${r.label}</span><span class="tt-row-val">${valHtml}</span></div>`;
  }).join('');
}

function showTTGeneric(cx, cy, type, item, floorName) {
  const tt = document.getElementById('tt');
  const meta = TYPE_META[type] || { label: type, color: '#888' };
  let rows = '';

  if (type === 'room') {
    rows = buildTTRows([
      { label: 'Étage', val: floorName }
    ]);
  } else if (type === 'copier' || type === 'printer') {
    rows = buildTTRows([
      { label: 'Étage',   val: floorName },
      { label: 'Réseau',  val: item.network }
    ]);
  } else if (type === 'meeting') {
    const screenLabel = `${item.screenType === 'tactile' ? 'Tactile' : 'Classique'} ${item.screenSize}"${item.hasMTR ? ' + MTR' : ''}`;
    rows = buildTTRows([
      { label: 'Étage',  val: floorName },
      { label: 'Écran',  val: screenLabel }
    ]);
  } else if (type === 'move') {
    const dateStr = item.date ? new Date(item.date).toLocaleDateString('fr-FR') : null;
    const pcCount = item.people?.filter(p => p.needsPC).length || 0;
    // Chaque personne sur sa propre ligne, avec 💻 si PC
    const people = item.people?.length
      ? item.people.map(p => p.name + (p.needsPC ? ' 💻' : '')).join('\n')
      : null;
    rows = buildTTRows([
      { label: 'Étage',     val: floorName },
      { label: 'Date',      val: dateStr },
      { label: 'Personnes', val: item.people?.length ? `${item.people.length} personne${item.people.length>1?'s':''}${pcCount ? ` (${pcCount} PC)` : ''}` : null },
      { label: 'Noms',      val: people }
    ]);
  } else if (type === 'screen') {
    rows = buildTTRows([
      { label: 'Étage',   val: floorName },
      { label: 'Taille',  val: item.size ? item.size + ' pouces' : null },
      { label: 'Marque',  val: item.brand },
      { label: 'Réseau',  val: item.network }
    ]);
  } else if (type === 'techroom') {
    rows = buildTTRows([
      { label: 'Étage',       val: floorName },
      { label: 'Description', val: item.desc }
    ]);
  } else if (type === 'display') {
    rows = buildTTRows([
      { label: 'Étage',    val: floorName },
      { label: 'Taille',   val: item.size ? item.size + ' pouces' : null },
      { label: 'Contenu',  val: item.content },
      { label: 'Réseau',   val: item.network }
    ]);
  } else if (type === 'socket') {
    const outlets = item.outlets?.length 
      ? item.outlets.join('\n')
      : null;
    rows = buildTTRows([
      { label: 'Étage',  val: floorName },
      { label: 'Nombre', val: item.outlets?.length ? `${item.outlets.length} prise${item.outlets.length>1?'s':''}` : null },
      { label: 'Détails', val: outlets }
    ]);
  }

  tt.innerHTML = `
    <div class="tt-badge" style="background:${meta.color}22;color:${meta.color};border:1px solid ${meta.color}44;">${meta.label}</div>
    <div class="tt-name">${esc(item.name || '(sans nom)')}</div>
    ${rows ? `<div class="tt-divider"></div>${rows}` : ''}
  `;

  tt.classList.add('on');
  positionTT(tt, cx, cy);
}

function showTT(cx, cy, f, room) {
  showTTGeneric(cx, cy, 'room', room, f.name);
}

function positionTT(tt, cx, cy) {
  let lx = cx + 16, ly = cy + 16;
  tt.style.left = lx + 'px'; tt.style.top = ly + 'px';
  const r = tt.getBoundingClientRect();
  if (r.right > window.innerWidth - 10) lx = cx - r.width - 12;
  if (r.bottom > window.innerHeight - 10) ly = cy - r.height - 12;
  tt.style.left = lx + 'px'; tt.style.top = ly + 'px';
}

function hideTT() { document.getElementById('tt').classList.remove('on'); }

// ═══════════════════════════════════════════════════
//  MODE
// ═══════════════════════════════════════════════════
function setMode(m) {
  S.mode = m;
  ['nav','draw','edit-shape','copier','printer','meeting','move','screen','techroom','display','socket'].forEach(mode => {
    const btn = document.getElementById('btn-'+mode);
    if (btn) btn.classList.toggle('active', m===mode);
  });
  document.getElementById('canvas-area').className = 'canvas-area mode-'+m;
  const modeLabels = {
    nav:'NAVIGATION', draw:'TRACER BUREAU', 'edit-shape':'ÉDITER FORME',
    copier:'PLACER COPIEUR', printer:'PLACER IMPRIMANTE',
    meeting:'PLACER SALLE RÉUNION', move:'ZONE DÉMÉNAGEMENT',
    screen:'PLACER ÉCRAN TV', techroom:'TRACER LOCAL TECHNIQUE', display:'PLACER ÉCRAN D\'INFORMATION',
    socket:'PLACER PRISES RÉSEAU', freezone:'TRACER ZONE LIBRE'
  };
  document.getElementById('mode-chip').textContent = modeLabels[m] || 'NAVIGATION';
  if (m !== 'edit-shape') { S.editingShape = null; renderCanvas(); }
}

// ═══════════════════════════════════════════════════
//  TABS
// ═══════════════════════════════════════════════════
function switchTab(t) {
  ['list','edit','equip','move','stats'].forEach(n => {
    document.getElementById('tab-'+n).classList.toggle('on', n===t);
    document.getElementById('tab-'+n+'-btn').classList.toggle('on', n===t);
  });
}

// ═══════════════════════════════════════════════════
//  STATS
// ═══════════════════════════════════════════════════
function updateStats() {
  document.getElementById('st-floors').textContent = S.floors.length;
  const totalR = S.floors.reduce((a,f) => a+f.rooms.length, 0);
  const totalC = S.floors.reduce((a,f) => a+f.copiers.length, 0);
  const totalP = S.floors.reduce((a,f) => a+f.printers.length, 0);
  const totalM = S.floors.reduce((a,f) => a+f.meetings.length, 0);
  
  document.getElementById('st-rooms').textContent = totalR;
  document.getElementById('st-copiers').textContent = totalC;
  document.getElementById('st-printers').textContent = totalP;
  document.getElementById('st-meetings').textContent = totalM;

  const det = document.getElementById('st-detail');
  det.innerHTML = '';
  S.floors.forEach(f => {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:10px 0 5px';
    h.textContent = f.name;
    det.appendChild(h);
    
    if (f.rooms.length === 0 && f.copiers.length === 0 && f.printers.length === 0 && f.meetings.length === 0) {
      const e = document.createElement('div');
      e.style.cssText = 'font-size:11px;color:var(--muted);font-style:italic;margin-bottom:6px;';
      e.textContent = 'Aucun élément';
      det.appendChild(e);
    }
    
    f.rooms.forEach((r,i) => {
      const col = roomColor(f.id, i);
      const d = document.createElement('div');
      d.className = 'rli'; d.style.cursor='default';
      d.innerHTML = `
        <div class="rli-dot" style="background:${col}"></div>
        <div class="rli-name" style="font-size:12px">${esc(r.name||'(sans nom)')}</div>
      `;
      det.appendChild(d);
    });
  });
}

// ═══════════════════════════════════════════════════
//  SCREEN
// ═══════════════════════════════════════════════════
function placeScreen(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  S.tempScreenPos = {x:(e.clientX-rect.left)/S.zoom, y:(e.clientY-rect.top)/S.zoom};
  openModalScreen();
}
function openModalScreen() {
  document.getElementById('modal-screen-name').value = '';
  document.getElementById('modal-screen-size').value = '55';
  document.getElementById('modal-screen-network').value = '';
  document.getElementById('modal-screen-brand-custom').style.display = 'none';
  document.querySelectorAll('input[name="screen-brand"]')[0].checked = true;
  document.getElementById('modal-screen').classList.add('on');
  // Show/hide custom brand input
  document.querySelectorAll('input[name="screen-brand"]').forEach(r => {
    r.onchange = () => {
      document.getElementById('modal-screen-brand-custom').style.display =
        document.querySelector('input[name="screen-brand"]:checked').value === 'autre' ? 'block' : 'none';
    };
  });
  setTimeout(() => document.getElementById('modal-screen-name').focus(), 60);
}
function cancelScreen() { document.getElementById('modal-screen').classList.remove('on'); }
function confirmScreen() {
  const f = activeFloor(); if (!f) return;
  const brandVal = document.querySelector('input[name="screen-brand"]:checked').value;
  const brand = brandVal === 'autre'
    ? (document.getElementById('modal-screen-brand-custom').value.trim() || 'Autre')
    : brandVal;
  const sc = {
    id: _id++,
    name: document.getElementById('modal-screen-name').value.trim(),
    size: parseInt(document.getElementById('modal-screen-size').value),
    brand,
    network: document.getElementById('modal-screen-network').value.trim(),
    x: S.tempScreenPos.x, y: S.tempScreenPos.y
  };
  if (!f.screens) f.screens = [];
  f.screens.push(sc);
  document.getElementById('modal-screen').classList.remove('on');
  S.tempScreenPos = null;
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Écran "${sc.name||sc.size+'"'}" créé !`);
}
function editScreen(sc) {
  const ed = document.getElementById('tab-equip');
  const brandOptions = ['Samsung','NEC','Grundig','LG'].map(b =>
    `<label class="check-group"><input type="radio" name="edit-screen-brand" value="${b}" ${sc.brand===b?'checked':''}> ${b}</label>`
  ).join('');
  const isOther = !['Samsung','NEC','Grundig','LG'].includes(sc.brand);
  ed.innerHTML = `
    <div class="ed-title">Éditer écran <button class="ed-close" onclick="renderEquipmentsList()">×</button></div>
    <div class="fg"><label class="lb">Nom</label><input class="inp" id="edit-screen-name" value="${esc(sc.name||'')}"></div>
    <div class="fg"><label class="lb">Taille</label>
      <select class="sel" id="edit-screen-size">
        ${[49,55,65,75,98].map(s=>`<option value="${s}" ${sc.size===s?'selected':''}>${s} pouces</option>`).join('')}
      </select></div>
    <div class="fg"><label class="lb">Marque</label>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;">${brandOptions}
        <label class="check-group"><input type="radio" name="edit-screen-brand" value="autre" id="edit-screen-brand-autre" ${isOther?'checked':''}> Autre</label>
      </div>
      <input class="inp" id="edit-screen-brand-custom" placeholder="Préciser..." style="display:${isOther?'block':'none'};margin-top:4px;" value="${isOther?esc(sc.brand):''}">
    </div>
    <div class="fg"><label class="lb">Réseau</label><textarea class="txa" id="edit-screen-network">${esc(sc.network||'')}</textarea></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveScreen(${sc.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteScreen(${sc.id})">Supprimer</button>
    </div>`;
  document.querySelectorAll('input[name="edit-screen-brand"]').forEach(r => {
    r.onchange = () => {
      document.getElementById('edit-screen-brand-custom').style.display =
        document.querySelector('input[name="edit-screen-brand"]:checked').value === 'autre' ? 'block' : 'none';
    };
  });
  switchTab('equip');
}
function saveScreen(sid) {
  const f = activeFloor(); if (!f) return;
  const sc = (f.screens||[]).find(s => s.id===sid); if (!sc) return;
  sc.name = document.getElementById('edit-screen-name').value.trim();
  sc.size = parseInt(document.getElementById('edit-screen-size').value);
  const bv = document.querySelector('input[name="edit-screen-brand"]:checked').value;
  sc.brand = bv==='autre' ? (document.getElementById('edit-screen-brand-custom').value.trim()||'Autre') : bv;
  sc.network = document.getElementById('edit-screen-network').value.trim();
  renderEquipmentsList(); renderCanvas(); notify('Écran mis à jour.');
}
function deleteScreen(sid) {
  const f = activeFloor(); if (!f) return;
  f.screens = (f.screens||[]).filter(s => s.id!==sid);
  renderEquipmentsList(); renderCanvas(); updateStats(); notify('Écran supprimé.');
}

// ═══════════════════════════════════════════════════
//  TECH ROOM
// ═══════════════════════════════════════════════════
function startDrawTechroom(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  S.drawing = {x0:x, y0:y, sx0:sx, sy0:sy};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = sx+'px'; ghost.style.top = sy+'px';
  ghost.style.width = '0px'; ghost.style.height = '0px';
  ghost.style.borderColor = '#e03030';
  ghost.style.background = 'rgba(224,48,48,.08)';
}
function continueDrawTechroom(e) {
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.left = Math.min(sx, S.drawing.sx0)+'px';
  ghost.style.top  = Math.min(sy, S.drawing.sy0)+'px';
  ghost.style.width  = Math.abs(sx - S.drawing.sx0)+'px';
  ghost.style.height = Math.abs(sy - S.drawing.sy0)+'px';
}
function endDrawTechroom(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const w = Math.abs(x - S.drawing.x0), h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0), t = Math.min(y, S.drawing.y0);
  document.getElementById('draw-ghost').style.display = 'none';
  S.drawing = null;
  if (w < 10 || h < 10) return;
  S.tempTechroomPos = {x:l, y:t, w, h};
  openModalTechroom();
}
function openModalTechroom() {
  document.getElementById('modal-techroom-name').value = '';
  document.getElementById('modal-techroom-desc').value = '';
  document.getElementById('modal-techroom').classList.add('on');
  setTimeout(() => document.getElementById('modal-techroom-name').focus(), 60);
}
function cancelTechroom() { document.getElementById('modal-techroom').classList.remove('on'); S.drawing = null; document.getElementById('draw-ghost').style.display='none'; }
function confirmTechroom() {
  const f = activeFloor(); if (!f) return;
  const tr = {
    id: _id++,
    name: document.getElementById('modal-techroom-name').value.trim(),
    desc: document.getElementById('modal-techroom-desc').value.trim(),
    x: S.tempTechroomPos.x, y: S.tempTechroomPos.y,
    w: S.tempTechroomPos.w, h: S.tempTechroomPos.h,
    points: [
      {x: S.tempTechroomPos.x, y: S.tempTechroomPos.y},
      {x: S.tempTechroomPos.x + S.tempTechroomPos.w, y: S.tempTechroomPos.y},
      {x: S.tempTechroomPos.x + S.tempTechroomPos.w, y: S.tempTechroomPos.y + S.tempTechroomPos.h},
      {x: S.tempTechroomPos.x, y: S.tempTechroomPos.y + S.tempTechroomPos.h}
    ]
  };
  if (!f.techrooms) f.techrooms = [];
  f.techrooms.push(tr);
  document.getElementById('modal-techroom').classList.remove('on');
  S.tempTechroomPos = null;
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Local technique "${tr.name||'sans nom'}" créé !`);
}
function editTechroom(tr) {
  const ed = document.getElementById('tab-equip');
  ed.innerHTML = `
    <div class="ed-title">Éditer local technique <button class="ed-close" onclick="renderEquipmentsList()">×</button></div>
    <div class="fg"><label class="lb">Nom</label><input class="inp" id="edit-tr-name" value="${esc(tr.name||'')}"></div>
    <div class="fg"><label class="lb">Description</label><textarea class="txa" id="edit-tr-desc">${esc(tr.desc||'')}</textarea></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveTechroom(${tr.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteTechroom(${tr.id})">Supprimer</button>
    </div>`;
  switchTab('equip');
}
function saveTechroom(tid) {
  const f = activeFloor(); if (!f) return;
  const tr = (f.techrooms||[]).find(t => t.id===tid); if (!tr) return;
  tr.name = document.getElementById('edit-tr-name').value.trim();
  tr.desc = document.getElementById('edit-tr-desc').value.trim();
  renderEquipmentsList(); renderCanvas(); notify('Local technique mis à jour.');
}
function deleteTechroom(tid) {
  const f = activeFloor(); if (!f) return;
  f.techrooms = (f.techrooms||[]).filter(t => t.id!==tid);
  renderEquipmentsList(); renderCanvas(); updateStats(); notify('Local technique supprimé.');
}

// ═══════════════════════════════════════════════════
//  FREE ZONE
// ═══════════════════════════════════════════════════
const FREEZONE_ICONS = [
  {icon:'☕',label:'Pause café'},
  {icon:'🍽️',label:'Réfectoire'},
  {icon:'📦',label:'Stockage'},
  {icon:'🚪',label:'Entrée'},
  {icon:'🛋️',label:'Lounge'},
  {icon:'🖨️',label:'Reprographie'},
  {icon:'🔒',label:'Sécurité'},
  {icon:'💡',label:'Idées'},
  {icon:'📚',label:'Bibliothèque'},
  {icon:'🏋️',label:'Sport'},
  {icon:'🧹',label:'Ménage'},
  {icon:'⚡',label:'Énergie'},
  {icon:'🌿',label:'Nature'},
  {icon:'🎮',label:'Jeux'},
  {icon:'💊',label:'Infirmerie'},
  {icon:'🚿',label:'Sanitaire'},
  {icon:'🅿️',label:'Parking'},
  {icon:'🚴',label:'Vélos'},
  {icon:'📡',label:'Réseau'},
  {icon:'🔧',label:'Maintenance'},
  {icon:'🎨',label:'Créatif'},
  {icon:'📞',label:'Téléphonie'},
  {icon:'🖥️',label:'Informatique'},
  {icon:'🏠',label:'Zone neutre'},
];

let _fzSelectedColor = '#a78bfa';
let _fzSelectedIcon = '📦';

function initFreezonePicker() {
  // Color picker
  document.querySelectorAll('.fz-color').forEach(el => {
    el.style.border = '3px solid transparent';
    el.addEventListener('click', () => {
      document.querySelectorAll('.fz-color').forEach(e => e.style.border='3px solid transparent');
      el.style.border = '3px solid #fff';
      _fzSelectedColor = el.dataset.color;
    });
  });
  // Set first color selected
  const first = document.querySelector('.fz-color');
  if (first) { first.style.border='3px solid #fff'; _fzSelectedColor = first.dataset.color; }

  // Icon picker
  const picker = document.getElementById('freezone-icon-picker');
  if (!picker) return;
  picker.innerHTML = '';
  FREEZONE_ICONS.forEach(({icon, label}) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.title = label;
    btn.textContent = icon;
    btn.style.cssText = 'font-size:20px;padding:6px;border-radius:8px;border:2px solid var(--border);background:var(--card);cursor:pointer;transition:all .12s;';
    btn.addEventListener('click', () => {
      picker.querySelectorAll('button').forEach(b => b.style.borderColor = 'var(--border)');
      btn.style.borderColor = _fzSelectedColor;
      _fzSelectedIcon = icon;
    });
    if (icon === _fzSelectedIcon) btn.style.borderColor = _fzSelectedColor;
    picker.appendChild(btn);
  });
}

function startDrawFreezone(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  S.drawing = {x0:x, y0:y, sx0:sx, sy0:sy};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = sx+'px'; ghost.style.top = sy+'px';
  ghost.style.width = '0px'; ghost.style.height = '0px';
  ghost.style.borderColor = '#a78bfa';
  ghost.style.borderStyle = 'dashed';
  ghost.style.background = 'rgba(167,139,250,.08)';
}
function continueDrawFreezone(e) {
  const {sx, sy} = getScreenCoords(e.clientX, e.clientY);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.left = Math.min(sx, S.drawing.sx0)+'px';
  ghost.style.top  = Math.min(sy, S.drawing.sy0)+'px';
  ghost.style.width  = Math.abs(sx - S.drawing.sx0)+'px';
  ghost.style.height = Math.abs(sy - S.drawing.sy0)+'px';
}
function endDrawFreezone(e) {
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  const w = Math.abs(x - S.drawing.x0), h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0), t = Math.min(y, S.drawing.y0);
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'none';
  ghost.style.borderStyle = 'solid';
  S.drawing = null;
  if (w < 20 || h < 20) return;
  S.tempFreezonePo = {x:l, y:t, w, h};
  openModalFreezone();
}
function openModalFreezone(fz) {
  _fzSelectedColor = fz ? fz.color : '#a78bfa';
  _fzSelectedIcon  = fz ? fz.icon  : '📦';
  document.getElementById('modal-freezone-name').value = fz ? fz.name : '';
  document.getElementById('modal-freezone').classList.add('on');
  initFreezonePicker();
  // Restore color selection
  document.querySelectorAll('.fz-color').forEach(el => {
    el.style.border = el.dataset.color === _fzSelectedColor ? '3px solid #fff' : '3px solid transparent';
  });
  // Restore icon selection
  const picker = document.getElementById('freezone-icon-picker');
  if (picker) picker.querySelectorAll('button').forEach(b => {
    b.style.borderColor = b.textContent === _fzSelectedIcon ? _fzSelectedColor : 'var(--border)';
  });
  setTimeout(() => document.getElementById('modal-freezone-name').focus(), 60);
}
function cancelFreezone() {
  document.getElementById('modal-freezone').classList.remove('on');
  S.drawing = null; S.tempFreezonePo = null; S.editingFreezeoneId = null;
  document.getElementById('draw-ghost').style.display='none';
}
function confirmFreezone() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-freezone-name').value.trim();
  if (!f.freezones) f.freezones = [];

  if (S.editingFreezeoneId != null) {
    const fz = f.freezones.find(z => z.id === S.editingFreezeoneId);
    if (fz) {
      fz.name = name;
      fz.color = _fzSelectedColor;
      fz.icon = _fzSelectedIcon;
    }
    S.editingFreezeoneId = null;
  } else {
    const pos = S.tempFreezonePo;
    const fz = {
      id: _id++, name,
      color: _fzSelectedColor,
      icon: _fzSelectedIcon,
      x: pos.x, y: pos.y, w: pos.w, h: pos.h,
      points: [
        {x: pos.x, y: pos.y},
        {x: pos.x + pos.w, y: pos.y},
        {x: pos.x + pos.w, y: pos.y + pos.h},
        {x: pos.x, y: pos.y + pos.h}
      ]
    };
    f.freezones.push(fz);
    S.tempFreezonePo = null;
  }
  document.getElementById('modal-freezone').classList.remove('on');
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Zone libre "${name||'sans nom'}" ${S.editingFreezeoneId != null ? 'mise à jour' : 'créée'} !`);
}
function editFreezone(fz) {
  S.editingFreezeoneId = fz.id;
  openModalFreezone(fz);
}
function deleteFreezone(fzid) {
  const f = activeFloor(); if (!f) return;
  f.freezones = (f.freezones||[]).filter(z => z.id !== fzid);
  renderEquipmentsList(); renderCanvas(); updateStats(); notify('Zone libre supprimée.');
}

// ═══════════════════════════════════════════════════
//  DYNAMIC DISPLAY
// ═══════════════════════════════════════════════════
function placeDisplay(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  S.tempDisplayPos = {x:(e.clientX-rect.left)/S.zoom, y:(e.clientY-rect.top)/S.zoom};
  openModalDisplay();
}
function openModalDisplay() {
  document.getElementById('modal-display-name').value = '';
  document.getElementById('modal-display-size').value = '55';
  document.getElementById('modal-display-content').value = '';
  document.getElementById('modal-display-network').value = '';
  document.getElementById('modal-display').classList.add('on');
  setTimeout(() => document.getElementById('modal-display-name').focus(), 60);
}
function cancelDisplay() { document.getElementById('modal-display').classList.remove('on'); }
function confirmDisplay() {
  const f = activeFloor(); if (!f) return;
  const dp = {
    id: _id++,
    name: document.getElementById('modal-display-name').value.trim(),
    size: parseInt(document.getElementById('modal-display-size').value),
    content: document.getElementById('modal-display-content').value.trim(),
    network: document.getElementById('modal-display-network').value.trim(),
    x: S.tempDisplayPos.x, y: S.tempDisplayPos.y
  };
  if (!f.displays) f.displays = [];
  f.displays.push(dp);
  document.getElementById('modal-display').classList.remove('on');
  S.tempDisplayPos = null;
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Affichage dynamique "${dp.name||'sans nom'}" créé !`);
}
function editDisplay(dp) {
  const ed = document.getElementById('tab-equip');
  ed.innerHTML = `
    <div class="ed-title">Éditer affichage dynamique <button class="ed-close" onclick="renderEquipmentsList()">×</button></div>
    <div class="fg"><label class="lb">Nom / Emplacement</label><input class="inp" id="edit-dp-name" value="${esc(dp.name||'')}"></div>
    <div class="fg"><label class="lb">Taille</label>
      <select class="sel" id="edit-dp-size">
        ${[32,43,49,55,65,75,98].map(s=>`<option value="${s}" ${dp.size===s?'selected':''}>${s} pouces</option>`).join('')}
      </select></div>
    <div class="fg"><label class="lb">Contenu diffusé</label><input class="inp" id="edit-dp-content" value="${esc(dp.content||'')}"></div>
    <div class="fg"><label class="lb">Réseau</label><textarea class="txa" id="edit-dp-network">${esc(dp.network||'')}</textarea></div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveDisplay(${dp.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteDisplay(${dp.id})">Supprimer</button>
    </div>`;
  switchTab('equip');
}
function saveDisplay(did) {
  const f = activeFloor(); if (!f) return;
  const dp = (f.displays||[]).find(d => d.id===did); if (!dp) return;
  dp.name = document.getElementById('edit-dp-name').value.trim();
  dp.size = parseInt(document.getElementById('edit-dp-size').value);
  dp.content = document.getElementById('edit-dp-content').value.trim();
  dp.network = document.getElementById('edit-dp-network').value.trim();
  renderEquipmentsList(); renderCanvas(); notify('Affichage dynamique mis à jour.');
}
function deleteDisplay(did) {
  const f = activeFloor(); if (!f) return;
  f.displays = (f.displays||[]).filter(d => d.id!==did);
  renderEquipmentsList(); renderCanvas(); updateStats(); notify('Affichage dynamique supprimé.');
}

// ═══════════════════════════════════════════════════
//  SOCKET (NETWORK OUTLETS)
// ═══════════════════════════════════════════════════
function placeSocket(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const {x, y} = getCanvasCoords(e.clientX, e.clientY);
  S.tempSocketPos = {x, y};
  S.tempSocket = {outlets: []};
  openModalSocket();
}
function openModalSocket() {
  document.getElementById('modal-socket-name').value = '';
  document.getElementById('modal-socket-outlet-input').value = '';
  renderModalSocketOutlets();
  document.getElementById('modal-socket').classList.add('on');
  setTimeout(() => document.getElementById('modal-socket-name').focus(), 60);
  document.getElementById('modal-socket-outlet-input').onkeydown = e => { if (e.key==='Enter') addSocketOutlet(); };
}
function renderModalSocketOutlets() {
  const c = document.getElementById('modal-socket-outlets');
  if (!c) return;
  c.innerHTML = '';
  if (S.tempSocket.outlets.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune prise</div>';
    return;
  }
  S.tempSocket.outlets.forEach((o,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `
      <div class="move-person-name">${esc(o)}</div>
      <button class="sock-del" onclick="removeSocketOutlet(${i})">×</button>
    `;
    c.appendChild(d);
  });
}
function addSocketOutlet() {
  const inp = document.getElementById('modal-socket-outlet-input');
  const v = inp.value.trim(); if (!v) return;
  S.tempSocket.outlets.push(v);
  inp.value = '';
  renderModalSocketOutlets();
}
function removeSocketOutlet(idx) {
  S.tempSocket.outlets.splice(idx, 1);
  renderModalSocketOutlets();
}
function cancelSocket() {
  document.getElementById('modal-socket').classList.remove('on');
  S.tempSocket = {outlets: []};
}
function confirmSocket() {
  const f = activeFloor(); if (!f) return;
  const sock = {
    id: _id++,
    name: document.getElementById('modal-socket-name').value.trim(),
    outlets: [...S.tempSocket.outlets],
    x: S.tempSocketPos.x, y: S.tempSocketPos.y
  };
  if (!f.sockets) f.sockets = [];
  f.sockets.push(sock);
  document.getElementById('modal-socket').classList.remove('on');
  S.tempSocketPos = null;
  S.tempSocket = {outlets: []};
  renderCanvas(); renderEquipmentsList(); updateStats();
  notify(`Prises réseau "${sock.name||'sans nom'}" créées !`);
}
function editSocket(sock) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">Éditer prises réseau <button class="ed-close" onclick="renderEquipmentsList()">×</button></div>
    <div class="fg"><label class="lb">Nom de l'emplacement</label><input class="inp" id="edit-socket-name" value="${esc(sock.name||'')}"></div>
    <div class="fg">
      <label class="lb">Prises réseau</label>
      <div class="move-people-list" id="edit-socket-outlets"></div>
      <div class="add-person">
        <input type="text" class="inp" id="edit-socket-outlet-input" placeholder="ex: Prise 1 - IP 192.168.1.10">
        <button class="btn" onclick="addEditSocketOutlet(${sock.id})">+</button>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveSocket(${sock.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteSocket(${sock.id})">Supprimer</button>
    </div>`;
  ed.innerHTML = content;
  renderEditSocketOutlets(sock);
  switchTab('equip');
  document.getElementById('edit-socket-outlet-input').onkeydown = e => { if (e.key==='Enter') addEditSocketOutlet(sock.id); };
}
function renderEditSocketOutlets(sock) {
  const c = document.getElementById('edit-socket-outlets');
  if (!c) return;
  c.innerHTML = '';
  if (!sock.outlets || sock.outlets.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune prise</div>';
    return;
  }
  sock.outlets.forEach((o,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `
      <div class="move-person-name">${esc(o)}</div>
      <button class="sock-del" onclick="removeEditSocketOutlet(${sock.id},${i})">×</button>
    `;
    c.appendChild(d);
  });
}
function addEditSocketOutlet(sid) {
  const f = activeFloor(); if (!f) return;
  const sock = (f.sockets||[]).find(s => s.id === sid); if (!sock) return;
  const inp = document.getElementById('edit-socket-outlet-input');
  const v = inp.value.trim(); if (!v) return;
  sock.outlets.push(v);
  inp.value = '';
  renderEditSocketOutlets(sock);
  renderEquipmentsList(); updateStats();
}
function removeEditSocketOutlet(sid, idx) {
  const f = activeFloor(); if (!f) return;
  const sock = (f.sockets||[]).find(s => s.id === sid); if (!sock) return;
  sock.outlets.splice(idx, 1);
  renderEditSocketOutlets(sock);
  renderEquipmentsList(); updateStats();
}
function saveSocket(sid) {
  const f = activeFloor(); if (!f) return;
  const sock = (f.sockets||[]).find(s => s.id === sid); if (!sock) return;
  sock.name = document.getElementById('edit-socket-name').value.trim();
  renderEquipmentsList(); renderCanvas(); updateStats();
  notify('Prises réseau mises à jour.');
}
function deleteSocket(sid) {
  const f = activeFloor(); if (!f) return;
  const sock = (f.sockets||[]).find(s => s.id === sid); if (!sock) return;
  showConfirmModal(`Supprimer "${sock.name || 'ces prises réseau'}" ?`, '', () => {
    f.sockets = (f.sockets||[]).filter(s => s.id!==sid);
    renderCanvas(); renderEquipmentsList(); updateStats();
    notify('Prises réseau supprimées.');
  });
}

// ═══════════════════════════════════════════════════
//  FLOOR ACTIONS
// ═══════════════════════════════════════════════════
function clearFloor() {
  const f = activeFloor(); if (!f) return;
  // confirm() bloqué en iframe — on utilise un modal inline
  showConfirmModal(
    `Vider l'étage "${f.name}" ?`,
    'Tous les bureaux, équipements et le plan image seront supprimés.',
    () => {
      f.rooms=[]; f.copiers=[]; f.printers=[]; f.meetings=[]; f.moves=[];
      f.screens=[]; f.techrooms=[]; f.displays=[]; f.sockets=[];
      f.imageB64=null; f.imageW=0; f.imageH=0;
      S.selectedRoom=null;
      renderCanvas(); renderRoomsList(); renderEquipmentsList();
      renderMovesList(); editorOpen(null); updateStats();
      notify('Étage vidé.');
    }
  );
}

// ═══════════════════════════════════════════════════
//  EXPORT EXCEL
// ═══════════════════════════════════════════════════
function exportExcel() {
  const wb = XLSX.utils.book_new();
  
  // Feuille récapitulatif général
  const summaryData = [
    ['Export du plan - Récapitulatif'],
    ['Date d\'export', new Date().toLocaleDateString('fr-FR')],
    [''],
    ['Statistiques globales'],
    ['Nombre d\'étages', S.floors.length],
    ['Nombre de lieux', S.locations.length],
    ['Bureaux', S.floors.reduce((a,f) => a+f.rooms.length, 0)],
    ['Copieurs', S.floors.reduce((a,f) => a+f.copiers.length, 0)],
    ['Imprimantes', S.floors.reduce((a,f) => a+f.printers.length, 0)],
    ['Salles de réunion', S.floors.reduce((a,f) => a+f.meetings.length, 0)],
    ['Zones de déménagement', S.floors.reduce((a,f) => a+f.moves.length, 0)]
  ];
  const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, ws1, 'Récapitulatif');
  
  // Feuille BUREAUX
  const roomsData = [
    ['BUREAUX'],
    [''],
    ['Étage', 'Nom du bureau']
  ];
  
  S.floors.forEach(f => {
    f.rooms.forEach(r => {
      roomsData.push([
        f.name,
        r.name || '(sans nom)'
      ]);
    });
  });
  
  if (roomsData.length > 3) {
    const wsRooms = XLSX.utils.aoa_to_sheet(roomsData);
    XLSX.utils.book_append_sheet(wb, wsRooms, 'Bureaux');
  }
  
  // Feuille COPIEURS
  const copiersData = [
    ['COPIEURS'],
    [''],
    ['Étage', 'Nom', 'Informations réseau']
  ];
  
  S.floors.forEach(f => {
    f.copiers.forEach(c => {
      copiersData.push([
        f.name,
        c.name || '(sans nom)',
        c.network || ''
      ]);
    });
  });
  
  if (copiersData.length > 3) {
    const wsCopiers = XLSX.utils.aoa_to_sheet(copiersData);
    XLSX.utils.book_append_sheet(wb, wsCopiers, 'Copieurs');
  }
  
  // Feuille IMPRIMANTES
  const printersData = [
    ['IMPRIMANTES'],
    [''],
    ['Étage', 'Nom', 'Informations réseau']
  ];
  
  S.floors.forEach(f => {
    f.printers.forEach(p => {
      printersData.push([
        f.name,
        p.name || '(sans nom)',
        p.network || ''
      ]);
    });
  });
  
  if (printersData.length > 3) {
    const wsPrinters = XLSX.utils.aoa_to_sheet(printersData);
    XLSX.utils.book_append_sheet(wb, wsPrinters, 'Imprimantes');
  }
  
  // Feuille SALLES DE RÉUNION
  const meetingsData = [
    ['SALLES DE RÉUNION'],
    [''],
    ['Étage', 'Nom', 'Type d\'écran', 'Taille écran', 'Équipement MTR']
  ];
  
  S.floors.forEach(f => {
    f.meetings.forEach(m => {
      meetingsData.push([
        f.name,
        m.name || '(sans nom)',
        m.screenType === 'tactile' ? 'Tactile' : 'Classique',
        m.screenSize + ' pouces',
        m.hasMTR ? 'Oui' : 'Non'
      ]);
    });
  });
  
  if (meetingsData.length > 3) {
    const wsMeetings = XLSX.utils.aoa_to_sheet(meetingsData);
    XLSX.utils.book_append_sheet(wb, wsMeetings, 'Salles de réunion');
  }
  
  // Feuille DÉMÉNAGEMENTS
  const movesData = [
    ['DÉMÉNAGEMENTS'],
    [''],
    ['Étage', 'Date', 'Personne', 'PC requis']
  ];
  
  S.floors.forEach(f => {
    f.moves.forEach(mv => {
      const dateStr = mv.date ? new Date(mv.date).toLocaleDateString('fr-FR') : 'Non définie';
      if (mv.people && mv.people.length > 0) {
        mv.people.forEach(p => {
          movesData.push([
            f.name,
            dateStr,
            p.name,
            p.needsPC ? 'Oui' : 'Non'
          ]);
        });
      } else {
        movesData.push([f.name, dateStr, '(aucune personne)', '']);
      }
    });
  });
  
  if (movesData.length > 3) {
    const wsMoves = XLSX.utils.aoa_to_sheet(movesData);
    XLSX.utils.book_append_sheet(wb, wsMoves, 'Déménagements');
  }
  
  // Feuille ÉCRANS
  const screensData = [
    ['ÉCRANS'],
    [''],
    ['Étage', 'Nom', 'Taille', 'Marque', 'Informations réseau']
  ];
  S.floors.forEach(f => {
    (f.screens||[]).forEach(sc => {
      screensData.push([f.name, sc.name||'(sans nom)', sc.size+' pouces', sc.brand||'', sc.network||'']);
    });
  });
  if (screensData.length > 3) {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(screensData), 'Écrans');
  }

  // Feuille LOCAUX TECHNIQUES
  const techData = [
    ['LOCAUX TECHNIQUES'],
    [''],
    ['Étage', 'Nom', 'Description']
  ];
  S.floors.forEach(f => {
    (f.techrooms||[]).forEach(tr => {
      techData.push([f.name, tr.name||'(sans nom)', tr.desc||'']);
    });
  });
  if (techData.length > 3) {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(techData), 'Locaux techniques');
  }

  // Feuille AFFICHAGES DYNAMIQUES
  const displaysData = [
    ['AFFICHAGES DYNAMIQUES'],
    [''],
    ['Étage', 'Nom / Emplacement', 'Taille', 'Contenu diffusé', 'Informations réseau']
  ];
  S.floors.forEach(f => {
    (f.displays||[]).forEach(dp => {
      displaysData.push([f.name, dp.name||'(sans nom)', dp.size+' pouces', dp.content||'', dp.network||'']);
    });
  });
  if (displaysData.length > 3) {
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(displaysData), 'Affichages dynamiques');
  }

  // Nom du fichier avec date
  const today = new Date();
  const dateStr = today.toLocaleDateString('fr-FR').replace(/\//g, '-');
  const fileName = `Export_du_plan_${dateStr}.xlsx`;
  
  XLSX.writeFile(wb, fileName);
  notify('Export Excel réussi !');
}

// ═══════════════════════════════════════════════════
//  GENERATE INFO PANEL FOR EXPORT
// ═══════════════════════════════════════════════════
function generateInfoPanel(floor) {
  const panel = document.createElement('div');
  panel.style.cssText = `
    position: absolute;
    right: 0;
    top: 0;
    width: 300px;
    height: 100%;
    background: white;
    padding: 20px;
    box-sizing: border-box;
    font-family: 'Segoe UI', Arial, sans-serif;
    overflow-y: auto;
    border-left: 2px solid #333;
  `;

  let html = `
    <div style="margin-bottom:20px;border-bottom:3px solid #333;padding-bottom:10px;">
      <h2 style="margin:0;font-size:18px;font-weight:700;color:#333;">${esc(floor.name)}</h2>
      <p style="margin:5px 0 0;font-size:11px;color:#666;">Export du ${new Date().toLocaleDateString('fr-FR')}</p>
    </div>
  `;

  // Bureaux
  if (floor.rooms.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Bureaux (${floor.rooms.length})</h3>`;
    floor.rooms.forEach(r => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:3px;">• ${esc(r.name||'(sans nom)')}</div>`;
    });
    html += `</div>`;
  }

  // Copieurs
  if (floor.copiers.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Copieurs (${floor.copiers.length})</h3>`;
    floor.copiers.forEach(c => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(c.name||'(sans nom)')}</strong>`;
      if (c.network) html += `<br><span style="font-size:10px;color:#888;">${esc(c.network).replace(/\n/g, '<br>')}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Imprimantes
  if (floor.printers.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Imprimantes (${floor.printers.length})</h3>`;
    floor.printers.forEach(p => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(p.name||'(sans nom)')}</strong>`;
      if (p.network) html += `<br><span style="font-size:10px;color:#888;">${esc(p.network).replace(/\n/g, '<br>')}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Salles de réunion
  if (floor.meetings.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Salles de réunion (${floor.meetings.length})</h3>`;
    floor.meetings.forEach(m => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(m.name||'(sans nom)')}</strong><br>
        <span style="font-size:10px;color:#888;">${m.screenType==='tactile'?'Tactile':'Classique'} ${m.screenSize}"${m.hasMTR?' + MTR':''}</span>
      </div>`;
    });
    html += `</div>`;
  }

  // Écrans
  if ((floor.screens||[]).length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Écrans (${floor.screens.length})</h3>`;
    floor.screens.forEach(sc => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(sc.name||'(sans nom)')}</strong><br>
        <span style="font-size:10px;color:#888;">${sc.size}" ${sc.brand||''}</span>`;
      if (sc.network) html += `<br><span style="font-size:10px;color:#888;">${esc(sc.network).replace(/\n/g, '<br>')}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Affichages dynamiques
  if ((floor.displays||[]).length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Affichages dynamiques (${floor.displays.length})</h3>`;
    floor.displays.forEach(dp => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(dp.name||'(sans nom)')}</strong><br>
        <span style="font-size:10px;color:#888;">${dp.size}"${dp.content?' - '+esc(dp.content):''}</span>`;
      if (dp.network) html += `<br><span style="font-size:10px;color:#888;">${esc(dp.network).replace(/\n/g, '<br>')}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Locaux techniques
  if ((floor.techrooms||[]).length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Locaux techniques (${floor.techrooms.length})</h3>`;
    floor.techrooms.forEach(tr => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:5px;">
        <strong>${esc(tr.name||'(sans nom)')}</strong>`;
      if (tr.desc) html += `<br><span style="font-size:10px;color:#888;">${esc(tr.desc).replace(/\n/g, '<br>')}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  }

  // Déménagements
  if (floor.moves.length > 0) {
    html += `<div style="margin-bottom:16px;">
      <h3 style="margin:0 0 8px;font-size:13px;font-weight:700;color:#333;text-transform:uppercase;">Déménagements (${floor.moves.length})</h3>`;
    floor.moves.forEach(mv => {
      html += `<div style="font-size:11px;color:#555;margin-bottom:8px;">
        <strong>${mv.date ? new Date(mv.date).toLocaleDateString('fr-FR') : 'Date non définie'}</strong><br>`;
      if (mv.people && mv.people.length > 0) {
        html += `<span style="font-size:10px;color:#888;">${mv.people.length} personne${mv.people.length>1?'s':''}</span><br>`;
        mv.people.forEach(p => {
          html += `<span style="font-size:10px;color:#666;">• ${esc(p.name)}${p.needsPC?' 💻':''}</span><br>`;
        });
      } else {
        html += `<span style="font-size:10px;color:#888;font-style:italic;">Aucune personne</span>`;
      }
      html += `</div>`;
    });
    html += `</div>`;
  }

  panel.innerHTML = html;
  return panel;
}

// ═══════════════════════════════════════════════════
//  EXPORT OPTIONS MODAL
// ═══════════════════════════════════════════════════
let _exportType = null;
let _exportOptions = {
  rooms: true, copiers: true, printers: true, meetings: true,
  screens: true, displays: true, techrooms: true, sockets: true, moves: true
};

function openExportOptionsModal(type) {
  _exportType = type;
  const title = {
    'png': 'Export PNG - Sélection',
    'pdf': 'Export PDF - Sélection',
    'json': 'Export JSON - Sélection'
  }[type] || 'Options d\'export';
  
  document.getElementById('export-options-title').textContent = title;
  
  // Reset all checkboxes to checked
  document.querySelectorAll('.export-checkbox').forEach(cb => cb.checked = true);
  document.getElementById('export-all').checked = true;
  
  document.getElementById('modal-export-options').classList.add('on');
}

function toggleAllExportOptions() {
  const allChecked = document.getElementById('export-all').checked;
  document.querySelectorAll('.export-checkbox').forEach(cb => cb.checked = allChecked);
}

function cancelExportOptions() {
  document.getElementById('modal-export-options').classList.remove('on');
  _exportType = null;
}

function getExportOptions() {
  const options = {};
  document.querySelectorAll('.export-checkbox').forEach(cb => {
    options[cb.dataset.type] = cb.checked;
  });
  return options;
}

function confirmExportOptions() {
  const options = getExportOptions();
  document.getElementById('modal-export-options').classList.remove('on');
  
  if (_exportType === 'png') {
    doExportPNG(options);
  } else if (_exportType === 'pdf') {
    doExportPDF(options);
  } else if (_exportType === 'json') {
    doExportJSON(options);
  }
  
  _exportType = null;
}

// ═══════════════════════════════════════════════════
//  EXPORT PNG - HELPERS
// ═══════════════════════════════════════════════════
function renderSVGToCanvas(ctx, f, options = {}) {

  // Helper: draw a filled polygon
  const drawPoly = (points, fillColor, strokeColor, alpha, lineWidth, dash=[]) => {
    if (!points || points.length < 3) return;
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.fillStyle = fillColor;
    ctx.strokeStyle = strokeColor;
    ctx.lineWidth = lineWidth;
    if (dash.length) ctx.setLineDash(dash); else ctx.setLineDash([]);
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    points.forEach(p => ctx.lineTo(p.x, p.y));
    ctx.closePath();
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.stroke();
    ctx.restore();
  };

  // Helper: draw centered label with outline
  const drawLabel = (text, cx, cy, color, fontSize=12, fontWeight='bold') => {
    if (!text) return;
    ctx.save();
    ctx.font = `${fontWeight} ${fontSize}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 3;
    ctx.strokeText(text.length > 18 ? text.substring(0,16)+'…' : text, cx, cy);
    ctx.fillStyle = color;
    ctx.fillText(text.length > 18 ? text.substring(0,16)+'…' : text, cx, cy);
    ctx.restore();
  };

  // Helper: draw emoji centered
  const drawEmoji = (emoji, cx, cy, size=20) => {
    if (!emoji) return;
    ctx.save();
    ctx.font = `${size}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(emoji, cx, cy);
    ctx.restore();
  };

  // Helper: draw a circle element with label
  const drawCircle = (x, y, color, label, size=20) => {
    ctx.save();
    ctx.globalAlpha = 0.2;
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(x, y, size, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
    ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x, y, size, 0, Math.PI*2); ctx.stroke();
    ctx.restore();
    if (label) drawLabel(label.length>14?label.substring(0,12)+'…':label, x, y + size + 10, '#333', 10);
  };

  const getBounds = (points) => {
    const xs = points.map(p=>p.x), ys = points.map(p=>p.y);
    const x=Math.min(...xs), y=Math.min(...ys);
    return {x, y, w:Math.max(...xs)-x, h:Math.max(...ys)-y};
  };

  // ── BUREAUX ──
  if (options.rooms !== false) {
    f.rooms.forEach((r, i) => {
      if (!r.points || r.points.length < 3) return;
      const color = roomColor(f.id, i);
      drawPoly(r.points, color, color, 0.15, 2);
      const b = getBounds(r.points);
      drawLabel(r.name, b.x+b.w/2, b.y+b.h/2, color, 12);
    });
  }

  // ── SALLES DE RÉUNION ──
  if (options.meetings !== false) {
    (f.meetings||[]).forEach(m => {
      if (!m.points || m.points.length < 3) return;
      const color = '#3ddc97';
      drawPoly(m.points, color, color, 0.15, 2);
      const b = getBounds(m.points);
      const cx = b.x+b.w/2, cy = b.y+b.h/2;
      drawLabel(m.name, cx, cy - 8, color, 12);
      const info = `${m.screenType==='tactile'?'Tactile':'Classique'} ${m.screenSize}"${m.hasMTR?' + MTR':''}`;
      drawLabel(info, cx, cy + 8, color, 9, 'normal');
    });
  }

  // ── DÉMÉNAGEMENTS ──
  if (options.moves !== false) {
    (f.moves||[]).forEach(mv => {
      if (!mv.points || mv.points.length < 3) return;
      const color = '#00e5cc';
      drawPoly(mv.points, color, color, 0.15, 3, [8,4]);
      const b = getBounds(mv.points);
      const cx = b.x+b.w/2, cy = b.y+b.h/2;
      drawLabel(mv.date||'', cx, cy - 8, color, 10);
      const pcount = mv.people?.length||0;
      drawLabel(`${pcount} personne${pcount>1?'s':''}`, cx, cy + 8, color, 10);
    });
  }

  // ── LOCAUX TECHNIQUES ──
  if (options.techrooms !== false) {
    (f.techrooms||[]).forEach(tr => {
      if (!tr.points || tr.points.length < 3) return;
      const color = '#e03030';
      drawPoly(tr.points, color, color, 0.15, 2.5);
      const b = getBounds(tr.points);
      const cx = b.x+b.w/2, cy = b.y+b.h/2;
      drawLabel(tr.name, cx, cy, color, 11);
    });
  }

  // ── ZONES LIBRES ──
  if (options.freezones !== false) {
    (f.freezones||[]).forEach(fz => {
      if (!fz.points || fz.points.length < 3) return;
      const color = fz.color || '#a78bfa';
      drawPoly(fz.points, color, color, 0.15, 2, [6,3]);
      const b = getBounds(fz.points);
      const cx = b.x+b.w/2, cy = b.y+b.h/2;
      if (fz.icon) {
        drawEmoji(fz.icon, cx, cy - 10, 18);
        drawLabel(fz.name, cx, cy + 12, color, 12);
      } else {
        drawLabel(fz.name, cx, cy, color, 12);
      }
    });
  }

  // ── COPIEURS ──
  if (options.copiers !== false) f.copiers.forEach(c => drawCircle(c.x, c.y, '#ff6b35', c.name));

  // ── IMPRIMANTES ──
  if (options.printers !== false) f.printers.forEach(p => drawCircle(p.x, p.y, '#4f8aff', p.name, 18));

  // ── ÉCRANS TV ──
  if (options.screens !== false) (f.screens||[]).forEach(s => drawCircle(s.x, s.y, '#9b87f5', s.name));

  // ── AFFICHAGES DYNAMIQUES ──
  if (options.displays !== false) (f.displays||[]).forEach(d => drawCircle(d.x, d.y, '#ffaa33', d.name, 22));

  // ── PRISES RÉSEAU ──
  if (options.sockets !== false) (f.sockets||[]).forEach(s => drawCircle(s.x, s.y, '#00bfa5', s.name));
}

function drawInfoPanel(ctx, f, x, width, height, options = {}) {
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(x, 0, width, height);
  
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x, 0);
  ctx.lineTo(x, height);
  ctx.stroke();
  
  let y = 30;
  const padding = 20;
  
  // Title
  ctx.fillStyle = '#333';
  ctx.font = 'bold 16px Arial';
  ctx.fillText(f.name, x + padding, y);
  y += 10;
  
  ctx.font = '10px Arial';
  ctx.fillStyle = '#666';
  ctx.fillText(new Date().toLocaleDateString('fr-FR'), x + padding, y);
  y += 30;
  
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x + padding, y);
  ctx.lineTo(x + width - padding, y);
  ctx.stroke();
  y += 20;
  
  // Sections
  const addSection = (title, items) => {
    if (items.length === 0) return;
    ctx.font = 'bold 12px Arial';
    ctx.fillStyle = '#333';
    ctx.fillText(`${title} (${items.length})`, x + padding, y);
    y += 18;
    
    ctx.font = '10px Arial';
    items.forEach(item => {
      const name = item.name || item || '(sans nom)';
      ctx.fillText('• ' + (name.length > 25 ? name.substring(0, 23) + '...' : name), x + padding + 5, y);
      y += 14;
    });
    y += 8;
  };
  
  if (options.rooms !== false) addSection('BUREAUX', f.rooms);
  if (options.copiers !== false) addSection('COPIEURS', f.copiers);
  if (options.printers !== false) addSection('IMPRIMANTES', f.printers);
  if (options.meetings !== false) addSection('SALLES DE RÉUNION', f.meetings);
  if (options.screens !== false) addSection('ÉCRANS', f.screens||[]);
  if (options.displays !== false) addSection('AFFICHAGES', f.displays||[]);
  if (options.techrooms !== false) addSection('LOCAUX TECH', f.techrooms||[]);
  if (options.sockets !== false) addSection('PRISES RÉSEAU', f.sockets||[]);
  if (options.moves !== false) addSection('DÉMÉNAGEMENTS', f.moves);
  if (options.freezones !== false) addSection('ZONES LIBRES', (f.freezones||[]).map(fz => ({name: (fz.icon?fz.icon+' ':'')+fz.name})));
}

// ═══════════════════════════════════════════════════
//  EXPORT PNG
// ═══════════════════════════════════════════════════
function exportPNG() {
  openExportOptionsModal('png');
}

async function doExportPNG(options) {
  const f = activeFloor();
  if (!f || !f.imageB64) {
    alert('Veuillez charger un plan avant d\'exporter en PNG.');
    return;
  }
  
  notify('Génération du PNG en cours...');
  
  try {
    const PANEL_WIDTH = 300;
    const canvas = document.createElement('canvas');
    canvas.width = f.imageW + PANEL_WIDTH;
    canvas.height = f.imageH;
    const ctx = canvas.getContext('2d');
    
    // White background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw background image
    const img = new Image();
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = f.imageB64;
    });
    ctx.drawImage(img, 0, 0);
    
    // Draw SVG overlay by rendering each element manually
    ctx.save();
    renderSVGToCanvas(ctx, f, options);
    ctx.restore();
    
    // Draw info panel manually
    drawInfoPanel(ctx, f, f.imageW, PANEL_WIDTH, f.imageH, options);
    
    // Export
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.download = `plan-${f.name.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.png`;
      link.href = url;
      link.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        document.body.removeChild(link);
      }, 100);
      notify('Export PNG réussi !');
    }, 'image/png');
    
  } catch (err) {
    console.error('Export PNG error:', err);
    alert('Erreur lors de l\'export PNG: ' + err.message);
  }
}

// ═══════════════════════════════════════════════════
//  EXPORT PDF
// ═══════════════════════════════════════════════════
function exportPDF() {
  openExportOptionsModal('pdf');
}

async function doExportPDF(options) {
  const f = activeFloor();
  if (!f || !f.imageB64) {
    alert('Veuillez charger un plan avant d\'exporter en PDF.');
    return;
  }
  
  notify('Génération du PDF en cours...');
  
  try {
    const PANEL_WIDTH = 300;
    const canvas = document.createElement('canvas');
    canvas.width = f.imageW + PANEL_WIDTH;
    canvas.height = f.imageH;
    const ctx = canvas.getContext('2d');
    
    // White background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw background image
    const img = new Image();
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = f.imageB64;
    });
    ctx.drawImage(img, 0, 0);
    
    // Draw SVG overlay
    ctx.save();
    renderSVGToCanvas(ctx, f, options);
    ctx.restore();
    
    // Draw info panel
    drawInfoPanel(ctx, f, f.imageW, PANEL_WIDTH, f.imageH, options);
    
    // Create PDF
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    
    const imgWidth = canvas.width;
    const imgHeight = canvas.height;
    const ratio = imgWidth / imgHeight;
    
    let pdfWidth, pdfHeight;
    if (ratio > 1.414) {
      pdfWidth = 297;
      pdfHeight = pdfWidth / ratio;
      if (pdfHeight > 210) {
        pdfHeight = 210;
        pdfWidth = pdfHeight * ratio;
      }
    } else {
      pdfHeight = 297;
      pdfWidth = pdfHeight * ratio;
      if (pdfWidth > 210) {
        pdfWidth = 210;
        pdfHeight = pdfWidth / ratio;
      }
    }
    
    const pdf = new jsPDF({
      orientation: ratio > 1 ? 'landscape' : 'portrait',
      unit: 'mm',
      format: 'a4'
    });
    
    const xOffset = (pdf.internal.pageSize.getWidth() - pdfWidth) / 2;
    const yOffset = (pdf.internal.pageSize.getHeight() - pdfHeight) / 2;
    
    pdf.addImage(imgData, 'PNG', xOffset, yOffset, pdfWidth, pdfHeight);
    
    // Méthode compatible pour le téléchargement
    const pdfBlob = pdf.output('blob');
    const url = URL.createObjectURL(pdfBlob);
    const link = document.createElement('a');
    link.style.display = 'none';
    document.body.appendChild(link);
    link.href = url;
    link.download = `plan-${f.name.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.pdf`;
    link.click();
    
    // Cleanup après un délai
    setTimeout(() => {
      URL.revokeObjectURL(url);
      document.body.removeChild(link);
    }, 100);
    
    notify('Export PDF réussi !');
    
  } catch (err) {
    console.error('Export PDF error:', err);
    alert('Erreur lors de l\'export PDF: ' + err.message);
  }
}


// ═══════════════════════════════════════════════════
//  EXPORT / IMPORT JSON
// ═══════════════════════════════════════════════════
function exportJSON() {
  openExportOptionsModal('json');
}

async function doExportJSON(options = {}) {
  const prog = document.getElementById('progress');
  prog.style.transform = 'scaleX(0.3)';
  await new Promise(r => setTimeout(r, 80));
  prog.style.transform = 'scaleX(0.7)';
  await new Promise(r => setTimeout(r, 80));

  const data = {
    version: 7,
    exported: new Date().toISOString(),
    locations: S.locations,
    floorLevels: S.floorLevels,
    comSubSites: S.comSubSites,
    comSubSiteLevels: S.comSubSiteLevels,
    floors: S.floors.map(f => ({
      id: f.id, name: f.name, site: f.site, level: f.level, subSite: f.subSite || null,
      imageB64: f.imageB64,
      imageW: f.imageW, imageH: f.imageH,
      rooms: options.rooms !== false ? f.rooms : [],
      copiers: options.copiers !== false ? (f.copiers || []) : [],
      printers: options.printers !== false ? (f.printers || []) : [],
      meetings: options.meetings !== false ? (f.meetings || []) : [],
      moves: options.moves !== false ? (f.moves || []) : [],
      screens: options.screens !== false ? (f.screens || []) : [],
      techrooms: options.techrooms !== false ? (f.techrooms || []) : [],
      displays: options.displays !== false ? (f.displays || []) : [],
      sockets: options.sockets !== false ? (f.sockets || []) : [],
      freezones: options.freezones !== false ? (f.freezones || []) : []
    }))
  };

  prog.style.transform = 'scaleX(1)';
  await new Promise(r => setTimeout(r, 120));
  prog.style.transform = 'scaleX(0)';

  try {
    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], {type:'application/json'});
    
    // Méthode compatible pour le téléchargement
    const a = document.createElement('a');
    a.style.display = 'none';
    document.body.appendChild(a);
    
    const url = URL.createObjectURL(blob);
    a.href = url;
    a.download = 'plan-reseau.json';
    a.click();
    
    // Cleanup après un délai
    setTimeout(() => {
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 100);
    
    notify('Export JSON réussi — tout inclus !');
  } catch (err) {
    console.error('Export JSON error:', err);
    alert('Erreur lors de l\'export JSON: ' + err.message);
  }
}

function importJSON(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.floors) throw new Error('Format invalide : propriété "floors" manquante');

      S.locations = data.locations || ['Pfaffenhoffen', 'Haguenau', 'Rittershoffen', 'Reichshoffen', 'Soultz-sous-Forêts', 'COM', 'AVA', 'ARM', 'RBG', 'Molsheim', 'Erstein', 'Huningue', 'Planigy'];
      S.floorLevels = data.floorLevels || ['Sous-sol', 'RDC', '1er', '2ème', '3ème', '4ème', '5ème', '6ème'];
      S.comSubSites = data.comSubSites || ['Loge ASA', 'BS', 'BTI', 'BI', 'BE'];
      S.comSubSiteLevels = data.comSubSiteLevels || {
        'Loge ASA': ['RDC'], 'BS': ['RDC'],
        'BI': ['Sous-sol', 'RDC', '1er'],
        'BTI': ['Sous-sol', 'RDC', '1er', '2ème', '3ème', '4ème', '5ème', '6ème'],
        'BE':  ['Sous-sol', 'RDC', '1er', '2ème', '3ème', '4ème', '5ème', '6ème']
      };

      S.floors = data.floors.map(f => ({
        id: f.id,
        name: f.name,
        site: f.site || '',
        level: f.level || '',
        subSite: f.subSite || null,
        imageB64: f.imageB64 || null,
        imageW: f.imageW || 0,
        imageH: f.imageH || 0,
        rooms:     f.rooms     || [],
        copiers:   f.copiers   || [],
        printers:  f.printers  || [],
        meetings:  f.meetings  || [],
        moves:     f.moves     || [],
        screens:   f.screens   || [],
        techrooms: f.techrooms || [],
        displays:  f.displays  || [],
        sockets:   f.sockets   || [],
        freezones: f.freezones || []
      }));

      // Recalcul sécurisé du compteur d'ID
      const allIds = S.floors.flatMap(f => [
        f.id,
        ...f.rooms.map(r=>r.id),
        ...(f.copiers||[]).map(c=>c.id),
        ...(f.printers||[]).map(p=>p.id),
        ...(f.meetings||[]).map(m=>m.id),
        ...(f.moves||[]).map(m=>m.id),
        ...(f.screens||[]).map(s=>s.id),
        ...(f.techrooms||[]).map(t=>t.id),
        ...(f.displays||[]).map(d=>d.id),
        ...(f.sockets||[]).map(s=>s.id),
        ...(f.freezones||[]).map(z=>z.id)
      ]).filter(id => typeof id === 'number' && !isNaN(id));
      _id = (allIds.length > 0 ? Math.max(...allIds) : 0) + 1;

      S.activeFloor = S.floors[0]?.id ?? null;
      S.selectedRoom = null;
      renderFloorsBar();
      renderCanvas();
      renderRoomsList();
      renderEquipmentsList();
      renderMovesList();
      editorOpen(null);
      updateStats();
      notify('Plan importé avec succès !');
    } catch(err) {
      alert('Fichier JSON invalide : ' + err.message);
      console.error('Import JSON error:', err);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ═══════════════════════════════════════════════════
//  UTILS
// ═══════════════════════════════════════════════════
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

let _notifTimer;
function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg; n.classList.add('on');
  clearTimeout(_notifTimer);
  _notifTimer = setTimeout(() => n.classList.remove('on'), 2600);
}

// ═══════════════════════════════════════════════════
//  LEAVE WARNING
// ═══════════════════════════════════════════════════
let _allowLeave = false;
let _pendingUnload = false;

function hasUnsavedData() {
  // Vérifier s'il y a des données non vides
  return S.floors && S.floors.length > 0;
}

function showLeaveWarning(e) {
  if (_allowLeave || !hasUnsavedData()) return;
  
  // Empêcher la fermeture immédiate
  e.preventDefault();
  e.returnValue = ''; // Nécessaire pour certains navigateurs
  
  // Afficher notre modal personnalisé
  if (!_pendingUnload) {
    _pendingUnload = true;
    document.getElementById('modal-leave-warning').classList.add('on');
  }
  
  return '';
}

function cancelLeave() {
  _pendingUnload = false;
  document.getElementById('modal-leave-warning').classList.remove('on');
}

function confirmLeave() {
  _allowLeave = true;
  _pendingUnload = false;
  document.getElementById('modal-leave-warning').classList.remove('on');
  // L'utilisateur devra cliquer à nouveau pour fermer/quitter
  notify('Vous pouvez maintenant fermer cette page.');
}

async function exportJSONAndStay() {
  const allOptions = {rooms:true, copiers:true, printers:true, meetings:true, screens:true, displays:true, techrooms:true, sockets:true, moves:true};
  await doExportJSON(allOptions);
  cancelLeave();
  notify('JSON exporté ! Vous pouvez continuer à travailler.');
}

async function exportPNGAndStay() {
  const allOptions = {rooms:true, copiers:true, printers:true, meetings:true, screens:true, displays:true, techrooms:true, sockets:true, moves:true};
  await doExportPNG(allOptions);
  cancelLeave();
  notify('PNG exporté ! Vous pouvez continuer à travailler.');
}

async function exportPDFAndStay() {
  const allOptions = {rooms:true, copiers:true, printers:true, meetings:true, screens:true, displays:true, techrooms:true, sockets:true, moves:true};
  await doExportPDF(allOptions);
  cancelLeave();
  notify('PDF exporté ! Vous pouvez continuer à travailler.');
}

// ═══════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════
setMode('nav');
setupImageUpload();
setupDrawing();
setupPan();

// Warning avant de quitter la page
window.addEventListener('beforeunload', showLeaveWarning);

// Gestion des menus déroulants
function toggleDropdown(id) {
  const dropdown = document.getElementById(id);
  const wasOpen = dropdown.classList.contains('open');
  
  // Fermer tous les dropdowns
  closeAllDropdowns();
  
  // Ouvrir celui-ci si il était fermé
  if (!wasOpen) {
    dropdown.classList.add('open');
  }
}

function closeAllDropdowns() {
  document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
}

// Fermer les dropdowns en cliquant ailleurs
document.addEventListener('click', (e) => {
  if (!e.target.closest('.dropdown')) {
    closeAllDropdowns();
  }
});

// Setup enter key for move person input in modal
document.getElementById('modal-move-person-input').onkeydown = e => { 
  if (e.key==='Enter') addMovePerson(); 
};

// Setup enter key for location input in modal
document.getElementById('location-input').onkeydown = e => { 
  if (e.key==='Enter') addLocation(); 
};
</script>
</body>
</html>
