<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modificateur de plan</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --bg:#0b0d12; --surface:#121520; --card:#181d2a; --card2:#1e2436;
  --border:#252c3f; --border2:#2e3650;
  --accent:#4f8aff; --accent2:#00e5cc; --warn:#ff5f57; --warn2:#ff6b35;
  --text:#e8ecf5; --muted:#6b7494; --success:#3ddc97;
  --font-display:'Syne',sans-serif; --font-mono:'JetBrains Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--font-display);display:flex;flex-direction:column;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* ── HEADER ─────────────────────────────────────── */
header{
  height:56px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 20px;flex-shrink:0;z-index:200;
}
.logo{display:flex;align-items:center;gap:10px;}
.logo-mark{
  width:32px;height:32px;border-radius:8px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;
}
.logo-mark svg{width:16px;height:16px;}
.logo-name{font-size:17px;font-weight:800;letter-spacing:-0.5px;}
.logo-name em{color:var(--accent2);font-style:normal;}
.header-right{display:flex;align-items:center;gap:8px;}

.chip{
  font-family:var(--font-mono);font-size:10px;
  padding:3px 10px;border-radius:20px;
  background:rgba(79,138,255,.12);color:var(--accent);
  border:1px solid rgba(79,138,255,.25);
}

/* ── TOOLBAR ─────────────────────────────────────── */
.toolbar{
  height:48px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:6px;padding:0 16px;flex-shrink:0;overflow-x:auto;
}
.tg{display:flex;gap:4px;align-items:center;padding-right:12px;border-right:1px solid var(--border);}
.tg:last-child{border-right:none;padding-right:0;}

.btn{
  display:flex;align-items:center;gap:6px;
  font-family:var(--font-display);font-size:12px;font-weight:700;
  padding:6px 12px;border-radius:7px;border:1px solid var(--border2);
  background:var(--card);color:var(--text);cursor:pointer;
  transition:all .15s;white-space:nowrap;
}
.btn:hover{background:var(--card2);border-color:var(--accent);color:var(--accent);}
.btn.active{background:rgba(79,138,255,.15);border-color:var(--accent);color:var(--accent);}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
.btn.primary:hover{background:#6b9fff;}
.btn.success{background:rgba(61,220,151,.12);border-color:rgba(61,220,151,.35);color:var(--success);}
.btn.success:hover{background:rgba(61,220,151,.22);}
.btn.danger{background:rgba(255,95,87,.1);border-color:rgba(255,95,87,.3);color:var(--warn);}
.btn.danger:hover{background:rgba(255,95,87,.2);}
.btn svg{width:14px;height:14px;flex-shrink:0;}

/* ── FLOORS BAR ──────────────────────────────────── */
.floors-bar{
  height:42px;background:var(--card);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:0;padding:0 16px;flex-shrink:0;overflow-x:auto;
}
.floor-tab{
  display:flex;align-items:center;gap:8px;
  font-size:12px;font-weight:700;padding:6px 16px;
  cursor:pointer;border-radius:6px 6px 0 0;
  border:1px solid transparent;border-bottom:none;
  color:var(--muted);transition:all .15s;white-space:nowrap;
  position:relative;bottom:-1px;
}
.floor-tab:hover{color:var(--text);background:rgba(255,255,255,.04);}
.floor-tab.active{
  color:var(--accent2);background:var(--surface);
  border-color:var(--border);border-bottom-color:var(--surface);
}
.floor-tab .ft-del{
  width:16px;height:16px;border-radius:50%;
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:14px;line-height:1;transition:all .15s;
}
.floor-tab .ft-del:hover{background:rgba(255,95,87,.2);color:var(--warn);}
.add-floor-btn{
  font-size:13px;font-weight:700;color:var(--muted);
  cursor:pointer;padding:4px 10px;border-radius:6px;
  transition:all .15s;white-space:nowrap;
  display:flex;align-items:center;gap:5px;
}
.add-floor-btn:hover{color:var(--accent2);background:rgba(0,229,204,.08);}

/* ── MAIN ────────────────────────────────────────── */
.main{display:flex;flex:1;overflow:hidden;}

/* ── CANVAS AREA ─────────────────────────────────── */
.canvas-area{
  flex:1;position:relative;overflow:hidden;
  background:var(--bg);
  background-image:
    linear-gradient(rgba(79,138,255,.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(79,138,255,.03) 1px,transparent 1px);
  background-size:32px 32px;
}
.canvas-area.mode-draw{cursor:crosshair;}
.canvas-area.mode-nav{cursor:default;}
.canvas-area.mode-copier{cursor:copy;}
.canvas-area.mode-printer{cursor:crosshair;}
.canvas-area.mode-meeting{cursor:cell;}
.canvas-area.mode-move{cursor:move;}
.canvas-area.mode-edit-shape{cursor:pointer;}

#canvas-root{position:absolute;top:0;left:0;transform-origin:0 0;}
#plan-img{position:absolute;top:0;left:0;user-select:none;pointer-events:none;opacity:.88;}
#svg-layer{position:absolute;top:0;left:0;overflow:visible;}

/* Drop zone */
#drop-zone{
  position:absolute;inset:0;display:flex;
  align-items:center;justify-content:center;z-index:10;
}
.dz-card{
  background:var(--surface);border:2px dashed var(--border2);
  border-radius:20px;padding:48px 64px;
  display:flex;flex-direction:column;align-items:center;gap:14px;
  cursor:pointer;transition:all .2s;text-align:center;
}
.dz-card:hover,.dz-card.over{border-color:var(--accent);background:rgba(79,138,255,.05);}
.dz-icon{opacity:.35;}
.dz-title{font-size:18px;font-weight:800;}
.dz-sub{font-size:13px;color:var(--muted);line-height:1.6;}

/* Drawing rect */
#draw-ghost{
  position:absolute;pointer-events:none;display:none;
  border:2px solid var(--accent2);background:rgba(0,229,204,.08);border-radius:3px;
}

/* Zoom HUD */
.zoom-hud{
  position:absolute;bottom:16px;right:16px;
  display:flex;flex-direction:column;align-items:center;gap:3px;
}
.zbtn{
  width:34px;height:34px;border-radius:8px;
  background:var(--card);border:1px solid var(--border2);
  color:var(--text);font-size:18px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.zbtn:hover{border-color:var(--accent);color:var(--accent);}
.zpct{font-family:var(--font-mono);font-size:10px;color:var(--muted);padding:2px;}

/* Coords HUD */
.coords-hud{
  position:absolute;bottom:16px;left:16px;
  font-family:var(--font-mono);font-size:10px;color:var(--muted);
  background:rgba(18,21,32,.7);padding:5px 10px;border-radius:6px;
  pointer-events:none;
}

/* ── SIDE PANEL ──────────────────────────────────── */
.side{
  width:340px;background:var(--surface);
  border-left:1px solid var(--border);
  display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;
}
.tabs{display:flex;border-bottom:1px solid var(--border);}
.tab{
  flex:1;padding:11px 6px;text-align:center;
  font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:var(--muted);cursor:pointer;
  border-bottom:2px solid transparent;transition:all .15s;
}
.tab.on{color:var(--accent2);border-bottom-color:var(--accent2);}
.tab-body{display:none;flex:1;overflow-y:auto;padding:14px;}
.tab-body.on{display:block;}

/* Empty state */
.es{display:flex;flex-direction:column;align-items:center;gap:10px;padding:32px 16px;text-align:center;color:var(--muted);}
.es-title{font-size:14px;font-weight:700;color:var(--text);opacity:.45;}
.es-sub{font-size:12px;line-height:1.6;}

/* Room list item */
.rli{
  display:flex;align-items:center;gap:8px;
  background:var(--card);border:1px solid var(--border);
  border-radius:9px;padding:9px 10px;margin-bottom:5px;
  cursor:pointer;transition:all .15s;
}
.rli:hover{border-color:var(--accent);}
.rli.on{border-color:var(--accent2);background:rgba(0,229,204,.06);}
.rli-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.rli-icon{width:20px;height:20px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.rli-icon svg{width:16px;height:16px;}
.rli-name{flex:1;font-size:13px;font-weight:600;}
.rli-cnt{font-family:var(--font-mono);font-size:10px;color:var(--muted);}
.rli-acts{display:flex;gap:2px;}
.ib{
  width:26px;height:26px;border-radius:6px;
  background:var(--card2);border:1px solid var(--border2);
  color:var(--muted);font-size:14px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.ib:hover{border-color:var(--accent);color:var(--accent);}
.ib.danger:hover{border-color:var(--warn);color:var(--warn);}

/* Editor */
.ed-title{font-size:14px;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.ed-close{
  width:24px;height:24px;margin-left:auto;border-radius:6px;
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:18px;transition:all .15s;
}
.ed-close:hover{background:rgba(255,95,87,.12);color:var(--warn);}
.fg{margin-bottom:14px;}
.lb{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;color:var(--muted);}
.inp,.txa{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:7px;padding:9px 11px;
  font-family:var(--font-display);font-size:13px;color:var(--text);
  transition:all .15s;
}
.inp:focus,.txa:focus{outline:none;border-color:var(--accent);background:var(--card2);}
.txa{min-height:70px;resize:vertical;font-family:var(--font-mono);font-size:11px;}
.sock-list{display:flex;flex-direction:column;gap:5px;margin-top:6px;}
.sock-it{
  display:flex;align-items:center;gap:6px;
  background:var(--card2);border:1px solid var(--border);
  border-radius:6px;padding:6px 8px;
}
.sock-name{flex:1;font-family:var(--font-mono);font-size:11px;}
.sock-del{
  width:22px;height:22px;border-radius:5px;
  background:transparent;border:none;color:var(--muted);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:14px;transition:all .15s;
}
.sock-del:hover{background:rgba(255,95,87,.15);color:var(--warn);}
.add-sock{
  display:flex;gap:4px;margin-top:6px;
}
.add-sock .inp{flex:1;}
.add-sock .btn{padding:8px 14px;}
.del-room-btn{width:100%;margin-top:8px;}

/* Check group */
.check-group{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.check-group input[type="checkbox"]{
  width:16px;height:16px;cursor:pointer;
  accent-color:var(--accent);
}
.check-group label{font-size:12px;cursor:pointer;}

/* Select */
.sel{
  width:100%;background:var(--card);border:1px solid var(--border2);
  border-radius:7px;padding:9px 11px;
  font-family:var(--font-display);font-size:13px;color:var(--text);
  cursor:pointer;transition:all .15s;
}
.sel:focus{outline:none;border-color:var(--accent);background:var(--card2);}

/* Move people list */
.move-people-list{display:flex;flex-direction:column;gap:5px;margin-top:6px;}
.move-person{
  display:flex;align-items:center;gap:6px;
  background:var(--card2);border:1px solid var(--border);
  border-radius:6px;padding:6px 8px;
}
.move-person-name{flex:1;font-size:12px;}
.move-person-pc{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted);}
.move-person-pc input{width:14px;height:14px;cursor:pointer;accent-color:var(--success);}
.add-person{display:flex;gap:4px;margin-top:6px;}
.add-person .inp{flex:1;}
.add-person .btn{padding:8px 14px;}

/* Stats cards */
.sc{
  display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;
}
.scard{
  background:var(--card);border:1px solid var(--border);
  border-radius:9px;padding:12px;text-align:center;
}
.scard-val{font-size:24px;font-weight:800;color:var(--accent2);}
.scard-lab{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-top:4px;}

/* Modal */
.modal{
  position:fixed;inset:0;z-index:300;
  background:rgba(11,13,18,.85);backdrop-filter:blur(8px);
  display:none;align-items:center;justify-content:center;
  animation:fadeIn .15s;
}
.modal.on{display:flex;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.md{
  background:var(--surface);border:1px solid var(--border2);
  border-radius:14px;padding:22px 24px;width:90%;max-width:420px;
  box-shadow:0 20px 60px rgba(0,0,0,.5);
}
.md-title{font-size:16px;font-weight:800;margin-bottom:14px;}
.md-acts{display:flex;gap:6px;margin-top:16px;}
.md-acts .btn{flex:1;justify-content:center;}

/* Tooltip */
#tt{
  position:absolute;z-index:250;pointer-events:none;
  background:var(--card);border:1px solid var(--border2);
  border-radius:9px;padding:10px 12px;opacity:0;
  transition:opacity .12s;box-shadow:0 8px 24px rgba(0,0,0,.4);
  max-width:240px;
}
#tt.on{opacity:1;}
.tt-floor{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:4px;}
.tt-room{font-size:13px;font-weight:700;margin-bottom:8px;}
.tt-socks{display:flex;flex-direction:column;gap:3px;}
.tt-sock{
  font-family:var(--font-mono);font-size:10px;
  background:var(--card2);border:1px solid var(--border);
  border-radius:5px;padding:4px 7px;
}
.tt-none{font-size:11px;font-style:italic;color:var(--muted);}
.tt-info{font-size:11px;color:var(--muted);margin-top:4px;}

/* Notif */
#notif{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--card);border:1px solid var(--accent);
  border-radius:10px;padding:12px 20px;
  font-size:13px;font-weight:700;color:var(--accent2);
  box-shadow:0 8px 24px rgba(0,0,0,.4);
  transition:transform .25s cubic-bezier(.34,1.56,.64,1);
  z-index:400;
}
#notif.on{transform:translateX(-50%) translateY(0);}

/* Progress */
#progress{
  position:fixed;top:0;left:0;width:100%;height:3px;
  background:var(--accent2);transform:scaleX(0);
  transform-origin:0 0;transition:transform .2s;z-index:500;
}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
    </div>
    <div class="logo-name">Modificateur de <em>plan</em></div>
  </div>
  <div class="header-right">
    <div class="chip" id="mode-chip">NAVIGATION</div>
  </div>
</header>

<!-- Toolbar -->
<div class="toolbar">
  <div class="tg">
    <button class="btn" id="btn-nav" onclick="setMode('nav')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
      Navigation
    </button>
    <button class="btn" id="btn-draw" onclick="setMode('draw')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
      Bureau
    </button>
    <button class="btn" id="btn-edit-shape" onclick="setMode('edit-shape')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m6.36 6.36l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m6.36-6.36l4.24-4.24"/></svg>
      Éditer forme
    </button>
    <button class="btn" id="btn-copier" onclick="setMode('copier')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="2" width="12" height="6" rx="1"/><path d="M18 8v10a2 2 0 01-2 2H8a2 2 0 01-2-2V8"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="18" y2="16"/></svg>
      Copieur
    </button>
    <button class="btn" id="btn-printer" onclick="setMode('printer')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
      Imprimante
    </button>
    <button class="btn" id="btn-meeting" onclick="setMode('meeting')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3h2v4M8 3H6v4"/></svg>
      Salle Réunion
    </button>
    <button class="btn" id="btn-move" onclick="setMode('move')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M9 22V12h6v10"/></svg>
      Déménagement
    </button>
  </div>
  <div class="tg">
    <button class="btn success" onclick="exportJSON()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      JSON
    </button>
    <button class="btn success" onclick="exportExcel()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Excel
    </button>
    <button class="btn success" onclick="exportPNG()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      PNG
    </button>
    <button class="btn success" onclick="exportPDF()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      PDF
    </button>
    <label class="btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Importer
      <input type="file" accept="application/json" style="display:none;" onchange="importJSON(event)">
    </label>
    <button class="btn" onclick="openLocationsModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
      Lieux
    </button>
    <button class="btn danger" onclick="clearFloor()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
      Vider
    </button>
  </div>
</div>

<!-- Floors bar -->
<div class="floors-bar" id="floors-bar"></div>

<!-- Main -->
<div class="main">
  <!-- Canvas -->
  <div class="canvas-area" id="canvas-area">
    <div id="drop-zone">
      <div class="dz-card" id="dz-card">
        <div class="dz-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
        </div>
        <div class="dz-title">Déposer un plan d'étage</div>
        <div class="dz-sub">ou cliquez pour choisir une image<br>(PNG, JPG, SVG)</div>
      </div>
    </div>
    <div id="canvas-root">
      <img id="plan-img">
      <svg id="svg-layer"></svg>
    </div>
    <div id="draw-ghost"></div>
    <div class="zoom-hud">
      <button class="zbtn" onclick="zoomIn()">+</button>
      <div class="zpct" id="zpct">100%</div>
      <button class="zbtn" onclick="zoomOut()">−</button>
      <button class="zbtn" onclick="zoomReset()" title="Réinitialiser">⊙</button>
    </div>
    <div class="coords-hud" id="coords">x:0 y:0</div>
  </div>

  <!-- Side panel -->
  <div class="side">
    <div class="tabs">
      <div class="tab on" id="tab-list-btn" onclick="switchTab('list')">Liste</div>
      <div class="tab" id="tab-edit-btn" onclick="switchTab('edit')">Édition</div>
      <div class="tab" id="tab-equip-btn" onclick="switchTab('equip')">Équipements</div>
      <div class="tab" id="tab-move-btn" onclick="switchTab('move')">Déménagements</div>
      <div class="tab" id="tab-stats-btn" onclick="switchTab('stats')">Stats</div>
    </div>

    <!-- Liste -->
    <div class="tab-body on" id="tab-list"></div>

    <!-- Édition -->
    <div class="tab-body" id="tab-edit"></div>

    <!-- Équipements -->
    <div class="tab-body" id="tab-equip"></div>

    <!-- Déménagements -->
    <div class="tab-body" id="tab-move"></div>

    <!-- Stats -->
    <div class="tab-body" id="tab-stats">
      <div class="sc">
        <div class="scard"><div class="scard-val" id="st-floors">0</div><div class="scard-lab">Étages</div></div>
        <div class="scard"><div class="scard-val" id="st-rooms">0</div><div class="scard-lab">Bureaux</div></div>
        <div class="scard"><div class="scard-val" id="st-copiers">0</div><div class="scard-lab">Copieurs</div></div>
      </div>
      <div class="sc">
        <div class="scard"><div class="scard-val" id="st-printers">0</div><div class="scard-lab">Imprimantes</div></div>
        <div class="scard"><div class="scard-val" id="st-meetings">0</div><div class="scard-lab">Salles</div></div>
      </div>
      <div id="st-detail"></div>
    </div>
  </div>
</div>

<!-- Modal Floor -->
<div class="modal" id="modal-floor">
  <div class="md">
    <div class="md-title">Nouvel étage</div>
    <div class="fg">
      <label class="lb">Sélectionner ou saisir un lieu</label>
      <select class="sel" id="modal-floor-select" onchange="handleFloorSelectChange()">
        <option value="">-- Choisir un lieu existant --</option>
      </select>
    </div>
    <div class="fg">
      <label class="lb">Ou saisir un nouveau lieu</label>
      <input type="text" class="inp" id="modal-floor-name" placeholder="ex: RDC, Étage 1...">
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelFloor()">Annuler</button>
      <button class="btn primary" onclick="confirmFloor()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Room -->
<div class="modal" id="modal-room">
  <div class="md">
    <div class="md-title">Nouveau bureau</div>
    <div class="fg">
      <label class="lb">Nom du bureau</label>
      <input type="text" class="inp" id="modal-room-name" placeholder="ex: Bureau 101">
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelRoom()">Annuler</button>
      <button class="btn primary" onclick="confirmRoom()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Copier -->
<div class="modal" id="modal-copier">
  <div class="md">
    <div class="md-title">Nouveau copieur</div>
    <div class="fg">
      <label class="lb">Nom du copieur</label>
      <input type="text" class="inp" id="modal-copier-name" placeholder="ex: Copieur RDC">
    </div>
    <div class="fg">
      <label class="lb">Informations réseau</label>
      <textarea class="txa" id="modal-copier-network" placeholder="IP, VLAN, etc."></textarea>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelCopier()">Annuler</button>
      <button class="btn primary" onclick="confirmCopier()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Printer -->
<div class="modal" id="modal-printer">
  <div class="md">
    <div class="md-title">Nouvelle imprimante</div>
    <div class="fg">
      <label class="lb">Nom de l'imprimante</label>
      <input type="text" class="inp" id="modal-printer-name" placeholder="ex: Imprimante Bureau 1">
    </div>
    <div class="fg">
      <label class="lb">Informations réseau</label>
      <textarea class="txa" id="modal-printer-network" placeholder="IP, VLAN, etc."></textarea>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelPrinter()">Annuler</button>
      <button class="btn primary" onclick="confirmPrinter()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Meeting Room -->
<div class="modal" id="modal-meeting">
  <div class="md">
    <div class="md-title">Nouvelle salle de réunion</div>
    <div class="fg">
      <label class="lb">Nom de la salle</label>
      <input type="text" class="inp" id="modal-meeting-name" placeholder="ex: Salle Réunion A">
    </div>
    <div class="fg">
      <label class="lb">Type d'écran</label>
      <div class="check-group">
        <input type="radio" name="screen-type" id="screen-tactile" value="tactile" checked>
        <label for="screen-tactile">Écran tactile</label>
      </div>
      <div class="check-group">
        <input type="radio" name="screen-type" id="screen-classic" value="classique">
        <label for="screen-classic">Écran classique</label>
      </div>
    </div>
    <div class="fg">
      <label class="lb">Taille de l'écran</label>
      <select class="sel" id="modal-meeting-size">
        <option value="49">49 pouces</option>
        <option value="55" selected>55 pouces</option>
        <option value="65">65 pouces</option>
        <option value="75">75 pouces</option>
        <option value="98">98 pouces</option>
      </select>
    </div>
    <div class="fg">
      <div class="check-group">
        <input type="checkbox" id="modal-meeting-mtr">
        <label for="modal-meeting-mtr">Équipement MTR (Microsoft Teams Rooms)</label>
      </div>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelMeeting()">Annuler</button>
      <button class="btn primary" onclick="confirmMeeting()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Move -->
<div class="modal" id="modal-move">
  <div class="md">
    <div class="md-title">Nouveau déménagement</div>
    <div class="fg">
      <label class="lb">Date du déménagement</label>
      <input type="date" class="inp" id="modal-move-date">
    </div>
    <div class="fg">
      <label class="lb">Personnes concernées</label>
      <div class="move-people-list" id="modal-move-people"></div>
      <div class="add-person">
        <input type="text" class="inp" id="modal-move-person-input" placeholder="Nom de la personne">
        <button class="btn" onclick="addMovePerson()">+</button>
      </div>
    </div>
    <div class="md-acts">
      <button class="btn" onclick="cancelMove()">Annuler</button>
      <button class="btn primary" onclick="confirmMove()">Créer</button>
    </div>
  </div>
</div>

<!-- Modal Locations -->
<div class="modal" id="modal-locations">
  <div class="md" style="max-width:520px;">
    <div class="md-title">Gérer les lieux</div>
    <div class="fg">
      <label class="lb">Lieux disponibles</label>
      <div id="locations-list" style="max-height:300px;overflow-y:auto;"></div>
      <div class="add-person" style="margin-top:10px;">
        <input type="text" class="inp" id="location-input" placeholder="Nouveau lieu (ex: Bureau Paris, Étage 2...)">
        <button class="btn" onclick="addLocation()">+</button>
      </div>
    </div>
    <div class="md-acts">
      <button class="btn primary" onclick="closeLocationsModal()">Fermer</button>
    </div>
  </div>
</div>

<div id="tt">
  <div class="tt-floor" id="tt-floor"></div>
  <div class="tt-room" id="tt-room"></div>
</div>

<div id="notif"></div>
<div id="progress"></div>

<script>
// ═══════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════
let _id = 1;
const S = {
  floors: [],
  locations: ['RDC', 'Étage 1', 'Étage 2', 'Étage 3'], // Liste des lieux disponibles
  activeFloor: null,
  selectedRoom: null,
  mode: 'nav',
  zoom: 1,
  pan: {x:0, y:0},
  drawing: null,
  dragging: null, // {type, id, startX, startY, origX, origY}
  editingShape: null, // {type, id, selectedPoint: null}
  tempMove: {people: []},
  tempCopierPos: null,
  tempPrinterPos: null,
  tempMeetingPos: null,
  tempMovePos: null
};

// ═══════════════════════════════════════════════════
//  FLOOR MANAGEMENT
// ═══════════════════════════════════════════════════
function activeFloor() { return S.floors.find(f => f.id === S.activeFloor) || null; }

function addFloor(name) {
  const f = {
    id: _id++, name,
    imageB64: null, imageW: 0, imageH: 0,
    rooms: [],
    copiers: [],
    printers: [],
    meetings: [],
    moves: []
  };
  S.floors.push(f);
  S.activeFloor = f.id;
  renderFloorsBar();
  renderCanvas();
  renderRoomsList();
  renderEquipmentsList();
  renderMovesList();
  editorOpen(null);
  updateStats();
}

// Convert old rectangle format to polygon format
function ensurePolygon(item) {
  if (!item.points && item.x !== undefined && item.w !== undefined) {
    // Convert rectangle to polygon
    item.points = [
      {x: item.x, y: item.y},
      {x: item.x + item.w, y: item.y},
      {x: item.x + item.w, y: item.y + item.h},
      {x: item.x, y: item.y + item.h}
    ];
    // Keep x, y, w, h for backward compatibility and bounds calculation
  }
  return item;
}

// Calculate bounds from points
function calculateBounds(points) {
  if (!points || points.length === 0) return {x: 0, y: 0, w: 0, h: 0};
  const xs = points.map(p => p.x);
  const ys = points.map(p => p.y);
  const minX = Math.min(...xs);
  const minY = Math.min(...ys);
  const maxX = Math.max(...xs);
  const maxY = Math.max(...ys);
  return {
    x: minX,
    y: minY,
    w: maxX - minX,
    h: maxY - minY
  };
}

function selectFloor(fid) {
  S.activeFloor = fid;
  S.selectedRoom = null;
  renderFloorsBar();
  renderCanvas();
  renderRoomsList();
  renderEquipmentsList();
  renderMovesList();
  editorOpen(null);
}

function removeFloor(fid) {
  const f = S.floors.find(x => x.id === fid);
  if (!f) return;
  if (!confirm(`Supprimer l'étage "${f.name}" ?`)) return;
  S.floors = S.floors.filter(x => x.id !== fid);
  if (S.activeFloor === fid) S.activeFloor = S.floors[0]?.id ?? null;
  S.selectedRoom = null;
  renderFloorsBar();
  renderCanvas();
  renderRoomsList();
  renderEquipmentsList();
  renderMovesList();
  editorOpen(null);
  updateStats();
  notify(`Étage "${f.name}" supprimé.`);
}

function editFloorName(fid, spanElement) {
  const f = S.floors.find(x => x.id === fid);
  if (!f) return;
  
  const input = document.createElement('input');
  input.type = 'text';
  input.value = f.name;
  input.style.cssText = 'background:var(--card2);border:1px solid var(--accent);color:var(--text);padding:4px 8px;border-radius:4px;font-size:12px;font-weight:700;font-family:var(--font-display);width:120px;';
  
  spanElement.replaceWith(input);
  input.focus();
  input.select();
  
  const save = () => {
    const newName = input.value.trim() || f.name;
    f.name = newName;
    renderFloorsBar();
    updateStats();
    notify(`Étage renommé en "${newName}"`);
  };
  
  input.onblur = save;
  input.onkeydown = (e) => {
    if (e.key === 'Enter') save();
    if (e.key === 'Escape') { f.name = f.name; renderFloorsBar(); }
  };
}

function renderFloorsBar() {
  const bar = document.getElementById('floors-bar');
  bar.innerHTML = '';
  S.floors.forEach(f => {
    const tab = document.createElement('div');
    tab.className = 'floor-tab';
    if (f.id === S.activeFloor) tab.classList.add('active');
    const span = document.createElement('span');
    span.textContent = f.name;
    span.onclick = () => selectFloor(f.id);
    span.ondblclick = (e) => { 
      e.stopPropagation(); 
      editFloorName(f.id, span); 
    };
    span.title = 'Double-cliquez pour renommer';
    tab.appendChild(span);
    if (S.floors.length > 1) {
      const del = document.createElement('button');
      del.className = 'ft-del'; del.textContent = '×';
      del.onclick = e => { e.stopPropagation(); removeFloor(f.id); };
      tab.appendChild(del);
    }
    bar.appendChild(tab);
  });
  const add = document.createElement('div');
  add.className = 'add-floor-btn';
  add.innerHTML = '<span>+</span><span>Ajouter</span>';
  add.onclick = openModalFloor;
  bar.appendChild(add);
}

// ═══════════════════════════════════════════════════
//  RENDER CANVAS
// ═══════════════════════════════════════════════════
function renderCanvas() {
  const f = activeFloor();
  const img = document.getElementById('plan-img');
  const svg = document.getElementById('svg-layer');
  const dz = document.getElementById('drop-zone');

  if (!f || !f.imageB64) {
    img.src = ''; img.style.display = 'none';
    svg.innerHTML = ''; dz.style.display = 'flex';
    return;
  }

  dz.style.display = 'none';
  img.src = f.imageB64;
  img.style.display = 'block';
  img.style.width = f.imageW + 'px';
  img.style.height = f.imageH + 'px';

  svg.setAttribute('width', f.imageW);
  svg.setAttribute('height', f.imageH);
  svg.innerHTML = '';

  // Draw rooms
  f.rooms.forEach((r,i) => {
    ensurePolygon(r);
    const col = roomColor(f.id, i);
    
    // Create polygon from points
    const pointsStr = r.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', col);
    poly.setAttribute('fill-opacity', S.selectedRoom === r.id ? '0.35' : '0.15');
    poly.setAttribute('stroke', col);
    poly.setAttribute('stroke-width', S.selectedRoom === r.id ? '3' : '2');
    poly.style.cursor = 'move';
    poly.setAttribute('data-type', 'room');
    poly.setAttribute('data-id', r.id);
    poly.addEventListener('click', (e) => { 
      e.stopPropagation();
      S.selectedRoom = r.id; 
      renderCanvas(); 
      renderRoomsList(); 
      editorOpen(r); 
    });
    poly.addEventListener('mouseenter', e => showTT(e.clientX, e.clientY, f, r));
    poly.addEventListener('mouseleave', hideTT);
    svg.appendChild(poly);
    
    // Update bounds
    const bounds = calculateBounds(r.points);
    r.x = bounds.x;
    r.y = bounds.y;
    r.w = bounds.w;
    r.h = bounds.h;
    
    // Add text info in room if big enough
    if (r.w > 80 && r.h > 40) {
      const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
      textG.style.pointerEvents = 'none';
      
      // Room name
      if (r.name) {
        const nameText = document.createElementNS('http://www.w3.org/2000/svg','text');
        nameText.setAttribute('x', r.x + r.w/2);
        nameText.setAttribute('y', r.y + r.h/2);
        nameText.setAttribute('text-anchor', 'middle');
        nameText.setAttribute('dominant-baseline', 'middle');
        nameText.setAttribute('fill', '#fff');
        nameText.setAttribute('font-size', '12');
        nameText.setAttribute('font-weight', '700');
        nameText.setAttribute('stroke', '#000');
        nameText.setAttribute('stroke-width', '3');
        nameText.setAttribute('paint-order', 'stroke');
        nameText.textContent = r.name.length > 15 ? r.name.substring(0,13)+'...' : r.name;
        textG.appendChild(nameText);
      }
      
      svg.appendChild(textG);
    }
  });

  // Draw copiers
  f.copiers.forEach(c => {
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.style.cursor = 'move';
    g.setAttribute('data-type', 'copier');
    g.setAttribute('data-id', c.id);
    g.addEventListener('click', (e) => { 
      e.stopPropagation();
      editCopier(c); 
    });
    
    const circ = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circ.setAttribute('cx', c.x);
    circ.setAttribute('cy', c.y);
    circ.setAttribute('r', '20');
    circ.setAttribute('fill', '#ff6b35');
    circ.setAttribute('fill-opacity', '0.2');
    circ.setAttribute('stroke', '#ff6b35');
    circ.setAttribute('stroke-width', '2');
    g.appendChild(circ);

    // SVG icon for copier/multifunction printer
    const icon = document.createElementNS('http://www.w3.org/2000/svg','g');
    icon.setAttribute('transform', `translate(${c.x-12}, ${c.y-12})`);
    
    // Top scanner part
    const topRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    topRect.setAttribute('x', '2');
    topRect.setAttribute('y', '2');
    topRect.setAttribute('width', '20');
    topRect.setAttribute('height', '5');
    topRect.setAttribute('fill', 'none');
    topRect.setAttribute('stroke', '#ff6b35');
    topRect.setAttribute('stroke-width', '1.5');
    topRect.setAttribute('rx', '1');
    icon.appendChild(topRect);
    
    // Middle printer part
    const midRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    midRect.setAttribute('x', '0');
    midRect.setAttribute('y', '8');
    midRect.setAttribute('width', '24');
    midRect.setAttribute('height', '8');
    midRect.setAttribute('fill', 'none');
    midRect.setAttribute('stroke', '#ff6b35');
    midRect.setAttribute('stroke-width', '1.5');
    midRect.setAttribute('rx', '1');
    icon.appendChild(midRect);
    
    // Bottom tray
    const bottomRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    bottomRect.setAttribute('x', '2');
    bottomRect.setAttribute('y', '17');
    bottomRect.setAttribute('width', '20');
    bottomRect.setAttribute('height', '5');
    bottomRect.setAttribute('fill', 'none');
    bottomRect.setAttribute('stroke', '#ff6b35');
    bottomRect.setAttribute('stroke-width', '1.5');
    bottomRect.setAttribute('rx', '1');
    icon.appendChild(bottomRect);
    
    // Paper lines
    const line1 = document.createElementNS('http://www.w3.org/2000/svg','line');
    line1.setAttribute('x1', '5');
    line1.setAttribute('y1', '11');
    line1.setAttribute('x2', '19');
    line1.setAttribute('y2', '11');
    line1.setAttribute('stroke', '#ff6b35');
    line1.setAttribute('stroke-width', '1.5');
    icon.appendChild(line1);
    
    const line2 = document.createElementNS('http://www.w3.org/2000/svg','line');
    line2.setAttribute('x1', '5');
    line2.setAttribute('y1', '13');
    line2.setAttribute('x2', '19');
    line2.setAttribute('y2', '13');
    line2.setAttribute('stroke', '#ff6b35');
    line2.setAttribute('stroke-width', '1.5');
    icon.appendChild(line2);
    
    g.appendChild(icon);

    // Label background
    if (c.name) {
      const labelBg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      labelBg.setAttribute('x', c.x - 35);
      labelBg.setAttribute('y', c.y + 25);
      labelBg.setAttribute('width', '70');
      labelBg.setAttribute('height', '18');
      labelBg.setAttribute('fill', '#ff6b35');
      labelBg.setAttribute('fill-opacity', '0.9');
      labelBg.setAttribute('rx', '4');
      g.appendChild(labelBg);

      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', c.x);
      label.setAttribute('y', c.y + 36);
      label.setAttribute('text-anchor', 'middle');
      label.setAttribute('dominant-baseline', 'middle');
      label.setAttribute('fill', '#fff');
      label.setAttribute('font-size', '10');
      label.setAttribute('font-weight', '600');
      label.textContent = c.name.length > 12 ? c.name.substring(0,10)+'...' : c.name;
      g.appendChild(label);
    }

    svg.appendChild(g);
  });

  // Draw printers
  f.printers.forEach(p => {
    const g = document.createElementNS('http://www.w3.org/2000/svg','g');
    g.style.cursor = 'move';
    g.setAttribute('data-type', 'printer');
    g.setAttribute('data-id', p.id);
    g.addEventListener('click', (e) => { 
      e.stopPropagation();
      editPrinter(p); 
    });
    
    const circ = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circ.setAttribute('cx', p.x);
    circ.setAttribute('cy', p.y);
    circ.setAttribute('r', '18');
    circ.setAttribute('fill', '#4f8aff');
    circ.setAttribute('fill-opacity', '0.2');
    circ.setAttribute('stroke', '#4f8aff');
    circ.setAttribute('stroke-width', '2');
    g.appendChild(circ);

    // SVG icon for printer
    const icon = document.createElementNS('http://www.w3.org/2000/svg','g');
    icon.setAttribute('transform', `translate(${p.x-10}, ${p.y-10})`);
    
    // Top paper part
    const topPath = document.createElementNS('http://www.w3.org/2000/svg','path');
    topPath.setAttribute('d', 'M4 2 L4 6 L16 6 L16 2');
    topPath.setAttribute('fill', 'none');
    topPath.setAttribute('stroke', '#4f8aff');
    topPath.setAttribute('stroke-width', '1.5');
    topPath.setAttribute('stroke-linecap', 'round');
    topPath.setAttribute('stroke-linejoin', 'round');
    icon.appendChild(topPath);
    
    // Main printer body
    const bodyRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    bodyRect.setAttribute('x', '1');
    bodyRect.setAttribute('y', '6');
    bodyRect.setAttribute('width', '18');
    bodyRect.setAttribute('height', '6');
    bodyRect.setAttribute('fill', 'none');
    bodyRect.setAttribute('stroke', '#4f8aff');
    bodyRect.setAttribute('stroke-width', '1.5');
    bodyRect.setAttribute('rx', '1');
    icon.appendChild(bodyRect);
    
    // Output tray
    const outputRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    outputRect.setAttribute('x', '4');
    outputRect.setAttribute('y', '12');
    outputRect.setAttribute('width', '12');
    outputRect.setAttribute('height', '6');
    outputRect.setAttribute('fill', 'none');
    outputRect.setAttribute('stroke', '#4f8aff');
    outputRect.setAttribute('stroke-width', '1.5');
    outputRect.setAttribute('rx', '1');
    icon.appendChild(outputRect);
    
    // Button indicator
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx', '15');
    circle.setAttribute('cy', '9');
    circle.setAttribute('r', '1');
    circle.setAttribute('fill', '#4f8aff');
    icon.appendChild(circle);
    
    g.appendChild(icon);

    // Label background
    if (p.name) {
      const labelBg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      labelBg.setAttribute('x', p.x - 35);
      labelBg.setAttribute('y', p.y + 23);
      labelBg.setAttribute('width', '70');
      labelBg.setAttribute('height', '18');
      labelBg.setAttribute('fill', '#4f8aff');
      labelBg.setAttribute('fill-opacity', '0.9');
      labelBg.setAttribute('rx', '4');
      g.appendChild(labelBg);

      const label = document.createElementNS('http://www.w3.org/2000/svg','text');
      label.setAttribute('x', p.x);
      label.setAttribute('y', p.y + 34);
      label.setAttribute('text-anchor', 'middle');
      label.setAttribute('dominant-baseline', 'middle');
      label.setAttribute('fill', '#fff');
      label.setAttribute('font-size', '10');
      label.setAttribute('font-weight', '600');
      label.textContent = p.name.length > 12 ? p.name.substring(0,10)+'...' : p.name;
      g.appendChild(label);
    }

    svg.appendChild(g);
  });

  // Draw meeting rooms
  f.meetings.forEach(m => {
    ensurePolygon(m);
    
    const pointsStr = m.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', '#3ddc97');
    poly.setAttribute('fill-opacity', '0.15');
    poly.setAttribute('stroke', '#3ddc97');
    poly.setAttribute('stroke-width', '2');
    poly.style.cursor = 'move';
    poly.setAttribute('data-type', 'meeting');
    poly.setAttribute('data-id', m.id);
    poly.addEventListener('click', (e) => { 
      e.stopPropagation();
      editMeeting(m); 
    });
    svg.appendChild(poly);
    
    // Update bounds
    const bounds = calculateBounds(m.points);
    m.x = bounds.x;
    m.y = bounds.y;
    m.w = bounds.w;
    m.h = bounds.h;

    // Add text info in meeting room
    const centerX = m.x + m.w / 2;
    const centerY = m.y + m.h / 2;
    
    const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
    textG.style.pointerEvents = 'none';
    
    // Room name
    if (m.name) {
      const nameText = document.createElementNS('http://www.w3.org/2000/svg','text');
      nameText.setAttribute('x', centerX);
      nameText.setAttribute('y', centerY - 8);
      nameText.setAttribute('text-anchor', 'middle');
      nameText.setAttribute('fill', '#3ddc97');
      nameText.setAttribute('font-size', '12');
      nameText.setAttribute('font-weight', '700');
      nameText.setAttribute('stroke', '#000');
      nameText.setAttribute('stroke-width', '3');
      nameText.setAttribute('paint-order', 'stroke');
      nameText.textContent = m.name.length > 18 ? m.name.substring(0,16)+'...' : m.name;
      textG.appendChild(nameText);
    }
    
    // Screen info
    const screenInfo = `${m.screenType==='tactile'?'Tactile':'Classique'} ${m.screenSize}"${m.hasMTR?' + MTR':''}`;
    const infoText = document.createElementNS('http://www.w3.org/2000/svg','text');
    infoText.setAttribute('x', centerX);
    infoText.setAttribute('y', centerY + 6);
    infoText.setAttribute('text-anchor', 'middle');
    infoText.setAttribute('fill', '#3ddc97');
    infoText.setAttribute('font-size', '9');
    infoText.setAttribute('opacity', '0.9');
    infoText.setAttribute('stroke', '#000');
    infoText.setAttribute('stroke-width', '2.5');
    infoText.setAttribute('paint-order', 'stroke');
    infoText.textContent = screenInfo;
    textG.appendChild(infoText);
    
    svg.appendChild(textG);
  });

  // Draw moves
  f.moves.forEach(mv => {
    ensurePolygon(mv);
    
    const pointsStr = mv.points.map(p => `${p.x},${p.y}`).join(' ');
    const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    poly.setAttribute('points', pointsStr);
    poly.setAttribute('fill', '#00e5cc');
    poly.setAttribute('fill-opacity', '0.15');
    poly.setAttribute('stroke', '#00e5cc');
    poly.setAttribute('stroke-width', '3');
    poly.setAttribute('stroke-dasharray', '8,4');
    poly.style.cursor = 'move';
    poly.setAttribute('data-type', 'move');
    poly.setAttribute('data-id', mv.id);
    poly.addEventListener('click', (e) => { 
      e.stopPropagation();
      editMove(mv); 
    });
    svg.appendChild(poly);
    
    // Update bounds
    const bounds = calculateBounds(mv.points);
    mv.x = bounds.x;
    mv.y = bounds.y;
    mv.w = bounds.w;
    mv.h = bounds.h;
    
    // Add text info in move zone
    if (mv.w > 100 && mv.h > 60) {
      const centerX = mv.x + mv.w / 2;
      const centerY = mv.y + mv.h / 2;
      
      const textG = document.createElementNS('http://www.w3.org/2000/svg','g');
      textG.style.pointerEvents = 'none';
      
      // Date
      if (mv.date) {
        const dateText = document.createElementNS('http://www.w3.org/2000/svg','text');
        dateText.setAttribute('x', centerX);
        dateText.setAttribute('y', centerY - 12);
        dateText.setAttribute('text-anchor', 'middle');
        dateText.setAttribute('fill', '#00e5cc');
        dateText.setAttribute('font-size', '11');
        dateText.setAttribute('font-weight', '700');
        dateText.setAttribute('stroke', '#000');
        dateText.setAttribute('stroke-width', '3');
        dateText.setAttribute('paint-order', 'stroke');
        dateText.textContent = new Date(mv.date).toLocaleDateString('fr-FR');
        textG.appendChild(dateText);
      }
      
      // People count
      if (mv.people.length > 0) {
        const peopleText = document.createElementNS('http://www.w3.org/2000/svg','text');
        peopleText.setAttribute('x', centerX);
        peopleText.setAttribute('y', centerY + 2);
        peopleText.setAttribute('text-anchor', 'middle');
        peopleText.setAttribute('fill', '#00e5cc');
        peopleText.setAttribute('font-size', '10');
        peopleText.setAttribute('opacity', '0.9');
        peopleText.setAttribute('stroke', '#000');
        peopleText.setAttribute('stroke-width', '2.5');
        peopleText.setAttribute('paint-order', 'stroke');
        const pcCount = mv.people.filter(p => p.needsPC).length;
        peopleText.textContent = `${mv.people.length} personne${mv.people.length>1?'s':''}`;
        textG.appendChild(peopleText);
        
        // PC count
        if (pcCount > 0) {
          const pcText = document.createElementNS('http://www.w3.org/2000/svg','text');
          pcText.setAttribute('x', centerX);
          pcText.setAttribute('y', centerY + 14);
          pcText.setAttribute('text-anchor', 'middle');
          pcText.setAttribute('fill', '#00e5cc');
          pcText.setAttribute('font-size', '9');
          pcText.setAttribute('opacity', '0.8');
          pcText.setAttribute('stroke', '#000');
          pcText.setAttribute('stroke-width', '2.5');
          pcText.setAttribute('paint-order', 'stroke');
          pcText.textContent = `${pcCount} PC`;
          textG.appendChild(pcText);
        }
      }
      
      svg.appendChild(textG);
    }
  });

  applyTransform();
  
  // Show anchor points in edit-shape mode
  if (S.mode === 'edit-shape' && S.editingShape) {
    const item = getEditableItem(S.editingShape.type, S.editingShape.id);
    if (item) {
      drawAnchorPoints(item, S.editingShape.type);
    }
  }
}

function roomColor(fid, idx) {
  const colors = ['#4f8aff','#00e5cc','#3ddc97','#ff6b35','#ff5f57','#9b87f5','#ffaa33','#ff4d9a'];
  return colors[(fid + idx) % colors.length];
}

// ═══════════════════════════════════════════════════
//  SHAPE EDITING
// ═══════════════════════════════════════════════════
function getEditableItem(type, id) {
  const f = activeFloor();
  if (!f) return null;
  
  if (type === 'room') return f.rooms.find(r => r.id === id);
  else if (type === 'meeting') return f.meetings.find(m => m.id === id);
  else if (type === 'move') return f.moves.find(m => m.id === id);
  return null;
}

function drawAnchorPoints(item, type) {
  const svg = document.getElementById('svg-layer');
  
  ensurePolygon(item);
  
  // Draw all polygon points
  item.points.forEach((pt, idx) => {
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx', pt.x);
    circle.setAttribute('cy', pt.y);
    circle.setAttribute('r', '7');
    circle.setAttribute('fill', '#fff');
    circle.setAttribute('stroke', '#4f8aff');
    circle.setAttribute('stroke-width', '2.5');
    circle.style.cursor = 'move';
    circle.setAttribute('data-anchor', idx);
    circle.setAttribute('data-point-type', 'vertex');
    
    const title = document.createElementNS('http://www.w3.org/2000/svg','title');
    title.textContent = `Point ${idx + 1} (clic droit pour supprimer)`;
    circle.appendChild(title);
    
    // Right-click to delete point
    circle.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      if (item.points.length > 3) {
        item.points.splice(idx, 1);
        renderCanvas();
        notify('Point supprimé');
      } else {
        notify('Minimum 3 points requis');
      }
    });
    
    svg.appendChild(circle);
  });
  
  // Draw midpoints for adding new points
  for (let i = 0; i < item.points.length; i++) {
    const p1 = item.points[i];
    const p2 = item.points[(i + 1) % item.points.length];
    const midX = (p1.x + p2.x) / 2;
    const midY = (p1.y + p2.y) / 2;
    
    const midCircle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    midCircle.setAttribute('cx', midX);
    midCircle.setAttribute('cy', midY);
    midCircle.setAttribute('r', '5');
    midCircle.setAttribute('fill', '#00e5cc');
    midCircle.setAttribute('stroke', '#4f8aff');
    midCircle.setAttribute('stroke-width', '2');
    midCircle.style.cursor = 'pointer';
    midCircle.setAttribute('data-midpoint', i);
    midCircle.setAttribute('data-point-type', 'midpoint');
    
    const midTitle = document.createElementNS('http://www.w3.org/2000/svg','title');
    midTitle.textContent = `Cliquer pour ajouter un point`;
    midCircle.appendChild(midTitle);
    
    // Click to add point
    midCircle.addEventListener('click', (e) => {
      e.stopPropagation();
      item.points.splice(i + 1, 0, {x: midX, y: midY});
      renderCanvas();
      notify('Point ajouté');
    });
    
    svg.appendChild(midCircle);
  }
}

function selectShapeForEditing(type, id) {
  S.editingShape = {type, id, selectedPoint: null};
  renderCanvas();
  notify(`Cliquez sur les points d'ancrage pour redimensionner`);
}

// ═══════════════════════════════════════════════════
//  ROOMS LIST
// ═══════════════════════════════════════════════════
function renderRoomsList() {
  const list = document.getElementById('tab-list');
  const f = activeFloor();
  if (!f || f.rooms.length === 0) {
    list.innerHTML = '<div class="es"><div class="es-title">Aucun bureau</div><div class="es-sub">Tracez des bureaux sur le plan</div></div>';
    return;
  }
  list.innerHTML = '';
  f.rooms.forEach((r,i) => {
    const col = roomColor(f.id, i);
    const d = document.createElement('div');
    d.className = 'rli';
    if (S.selectedRoom === r.id) d.classList.add('on');
    d.innerHTML = `
      <div class="rli-dot" style="background:${col}"></div>
      <div class="rli-name">${esc(r.name||'Bureau '+(i+1))}</div>
      <div class="rli-acts">
        <button class="ib" onclick="event.stopPropagation();editRoom(${r.id})" title="Modifier">✎</button>
        <button class="ib danger" onclick="event.stopPropagation();deleteRoom(${r.id})" title="Supprimer">×</button>
      </div>
    `;
    d.onclick = () => { S.selectedRoom = r.id; renderCanvas(); renderRoomsList(); editorOpen(r); };
    list.appendChild(d);
  });
}

// ═══════════════════════════════════════════════════
//  EQUIPMENTS LIST
// ═══════════════════════════════════════════════════
function renderEquipmentsList() {
  const list = document.getElementById('tab-equip');
  const f = activeFloor();
  if (!f || (f.copiers.length === 0 && f.printers.length === 0 && f.meetings.length === 0)) {
    list.innerHTML = '<div class="es"><div class="es-title">Aucun équipement</div><div class="es-sub">Ajoutez des copieurs, imprimantes ou salles de réunion</div></div>';
    return;
  }
  list.innerHTML = '';

  // Copiers
  if (f.copiers.length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:10px 0 8px;';
    h.textContent = 'COPIEURS';
    list.appendChild(h);

    f.copiers.forEach((c,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#ff6b35;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="6" y="2" width="12" height="6" rx="1"/><path d="M18 8v10a2 2 0 01-2 2H8a2 2 0 01-2-2V8"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="18" y2="16"/></svg>
        </div>
        <div class="rli-name">${esc(c.name||'Copieur '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editCopier(${JSON.stringify(c).replace(/"/g,'&quot;')})" title="Modifier">✎</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteCopier(${c.id})" title="Supprimer">×</button>
        </div>
      `;
      d.onclick = () => editCopier(c);
      list.appendChild(d);
    });
  }

  // Printers
  if (f.printers.length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'IMPRIMANTES';
    list.appendChild(h);

    f.printers.forEach((p,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#4f8aff;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        </div>
        <div class="rli-name">${esc(p.name||'Imprimante '+(i+1))}</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editPrinter(${JSON.stringify(p).replace(/"/g,'&quot;')})" title="Modifier">✎</button>
          <button class="ib danger" onclick="event.stopPropagation();deletePrinter(${p.id})" title="Supprimer">×</button>
        </div>
      `;
      d.onclick = () => editPrinter(p);
      list.appendChild(d);
    });
  }

  // Meeting rooms
  if (f.meetings.length > 0) {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:16px 0 8px;';
    h.textContent = 'SALLES DE RÉUNION';
    list.appendChild(h);

    f.meetings.forEach((m,i) => {
      const d = document.createElement('div');
      d.className = 'rli';
      d.innerHTML = `
        <div class="rli-icon" style="color:#3ddc97;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3h2v4M8 3H6v4"/></svg>
        </div>
        <div class="rli-name">${esc(m.name||'Salle '+(i+1))}</div>
        <div class="rli-cnt" style="font-size:9px;">${m.screenSize}"</div>
        <div class="rli-acts">
          <button class="ib" onclick="event.stopPropagation();editMeeting(${JSON.stringify(m).replace(/"/g,'&quot;')})" title="Modifier">✎</button>
          <button class="ib danger" onclick="event.stopPropagation();deleteMeeting(${m.id})" title="Supprimer">×</button>
        </div>
      `;
      d.onclick = () => editMeeting(m);
      list.appendChild(d);
    });
  }
}

// ═══════════════════════════════════════════════════
//  MOVES LIST
// ═══════════════════════════════════════════════════
function renderMovesList() {
  const list = document.getElementById('tab-move');
  const f = activeFloor();
  if (!f || f.moves.length === 0) {
    list.innerHTML = '<div class="es"><div class="es-title">Aucun déménagement</div><div class="es-sub">Créez des zones de déménagement</div></div>';
    return;
  }
  list.innerHTML = '';

  f.moves.forEach((mv,i) => {
    const d = document.createElement('div');
    d.className = 'rli';
    d.innerHTML = `
      <div class="rli-icon" style="color:#00e5cc;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M9 22V12h6v10"/></svg>
      </div>
      <div class="rli-name">${mv.date ? new Date(mv.date).toLocaleDateString('fr-FR') : 'Date non définie'}</div>
      <div class="rli-cnt">${mv.people.length}</div>
      <div class="rli-acts">
        <button class="ib" onclick="event.stopPropagation();editMove(${JSON.stringify(mv).replace(/"/g,'&quot;')})" title="Modifier">✎</button>
        <button class="ib danger" onclick="event.stopPropagation();deleteMove(${mv.id})" title="Supprimer">×</button>
      </div>
    `;
    d.onclick = () => editMove(mv);
    list.appendChild(d);
  });
}

// ═══════════════════════════════════════════════════
//  EDITOR PANEL
// ═══════════════════════════════════════════════════
function editorOpen(room) {
  const ed = document.getElementById('tab-edit');
  if (!room) {
    ed.innerHTML = '<div class="es"><div class="es-title">Aucune sélection</div><div class="es-sub">Sélectionnez un bureau pour le modifier</div></div>';
    return;
  }

  ed.innerHTML = `
    <div class="ed-title">
      Éditer bureau
      <button class="ed-close" onclick="editorClose()">×</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="ed-name" value="${esc(room.name||'')}" placeholder="Bureau 101">
    </div>
    <button class="btn danger del-room-btn" onclick="deleteRoom(${room.id})">Supprimer le bureau</button>
  `;

  document.getElementById('ed-name').oninput = e => { room.name = e.target.value; renderRoomsList(); renderCanvas(); };
}

function editorClose() {
  S.selectedRoom = null;
  renderCanvas();
  renderRoomsList();
  editorOpen(null);
}

function editRoom(rid) {
  const f = activeFloor(); if (!f) return;
  const r = f.rooms.find(x => x.id === rid); if (!r) return;
  S.selectedRoom = rid;
  renderCanvas();
  renderRoomsList();
  editorOpen(r);
  switchTab('edit');
}

function deleteRoom(rid) {
  const f = activeFloor(); if (!f) return;
  const r = f.rooms.find(x => x.id === rid); if (!r) return;
  if (!confirm(`Supprimer "${r.name || 'ce bureau'}" ?`)) return;
  f.rooms = f.rooms.filter(x => x.id !== rid);
  if (S.selectedRoom === rid) S.selectedRoom = null;
  renderCanvas();
  renderRoomsList();
  editorOpen(null);
  updateStats();
  notify('Bureau supprimé.');
}

// ═══════════════════════════════════════════════════
//  COPIER MANAGEMENT
// ═══════════════════════════════════════════════════
function editCopier(c) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">
      Éditer copieur
      <button class="ed-close" onclick="renderEquipmentsList()">×</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="edit-copier-name" value="${esc(c.name||'')}" placeholder="Copieur RDC">
    </div>
    <div class="fg">
      <label class="lb">Informations réseau</label>
      <textarea class="txa" id="edit-copier-network" placeholder="IP, VLAN, etc.">${esc(c.network||'')}</textarea>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveCopier(${c.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteCopier(${c.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  switchTab('equip');
}

function saveCopier(cid) {
  const f = activeFloor(); if (!f) return;
  const c = f.copiers.find(x => x.id === cid); if (!c) return;
  c.name = document.getElementById('edit-copier-name').value.trim();
  c.network = document.getElementById('edit-copier-network').value.trim();
  renderEquipmentsList();
  renderCanvas();
  updateStats();
  notify('Copieur mis à jour.');
}

function deleteCopier(cid) {
  const f = activeFloor(); if (!f) return;
  const c = f.copiers.find(x => x.id === cid); if (!c) return;
  if (!confirm(`Supprimer "${c.name || 'ce copieur'}" ?`)) return;
  f.copiers = f.copiers.filter(x => x.id !== cid);
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify('Copieur supprimé.');
}

// ═══════════════════════════════════════════════════
//  PRINTER MANAGEMENT
// ═══════════════════════════════════════════════════
function editPrinter(p) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">
      Éditer imprimante
      <button class="ed-close" onclick="renderEquipmentsList()">×</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="edit-printer-name" value="${esc(p.name||'')}" placeholder="Imprimante Bureau 1">
    </div>
    <div class="fg">
      <label class="lb">Informations réseau</label>
      <textarea class="txa" id="edit-printer-network" placeholder="IP, VLAN, etc.">${esc(p.network||'')}</textarea>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="savePrinter(${p.id})">Enregistrer</button>
      <button class="btn danger" onclick="deletePrinter(${p.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  switchTab('equip');
}

function savePrinter(pid) {
  const f = activeFloor(); if (!f) return;
  const p = f.printers.find(x => x.id === pid); if (!p) return;
  p.name = document.getElementById('edit-printer-name').value.trim();
  p.network = document.getElementById('edit-printer-network').value.trim();
  renderEquipmentsList();
  renderCanvas();
  updateStats();
  notify('Imprimante mise à jour.');
}

function deletePrinter(pid) {
  const f = activeFloor(); if (!f) return;
  const p = f.printers.find(x => x.id === pid); if (!p) return;
  if (!confirm(`Supprimer "${p.name || 'cette imprimante'}" ?`)) return;
  f.printers = f.printers.filter(x => x.id !== pid);
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify('Imprimante supprimée.');
}

// ═══════════════════════════════════════════════════
//  MEETING ROOM MANAGEMENT
// ═══════════════════════════════════════════════════
function editMeeting(m) {
  const ed = document.getElementById('tab-equip');
  const content = `
    <div class="ed-title">
      Éditer salle de réunion
      <button class="ed-close" onclick="renderEquipmentsList()">×</button>
    </div>
    <div class="fg">
      <label class="lb">Nom</label>
      <input type="text" class="inp" id="edit-meeting-name" value="${esc(m.name||'')}" placeholder="Salle Réunion A">
    </div>
    <div class="fg">
      <label class="lb">Type d'écran</label>
      <div class="check-group">
        <input type="radio" name="edit-screen-type" id="edit-screen-tactile" value="tactile" ${m.screenType==='tactile'?'checked':''}>
        <label for="edit-screen-tactile">Écran tactile</label>
      </div>
      <div class="check-group">
        <input type="radio" name="edit-screen-type" id="edit-screen-classic" value="classique" ${m.screenType==='classique'?'checked':''}>
        <label for="edit-screen-classic">Écran classique</label>
      </div>
    </div>
    <div class="fg">
      <label class="lb">Taille de l'écran</label>
      <select class="sel" id="edit-meeting-size">
        <option value="49" ${m.screenSize===49?'selected':''}>49 pouces</option>
        <option value="55" ${m.screenSize===55?'selected':''}>55 pouces</option>
        <option value="65" ${m.screenSize===65?'selected':''}>65 pouces</option>
        <option value="75" ${m.screenSize===75?'selected':''}>75 pouces</option>
        <option value="98" ${m.screenSize===98?'selected':''}>98 pouces</option>
      </select>
    </div>
    <div class="fg">
      <div class="check-group">
        <input type="checkbox" id="edit-meeting-mtr" ${m.hasMTR?'checked':''}>
        <label for="edit-meeting-mtr">Équipement MTR (Microsoft Teams Rooms)</label>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveMeeting(${m.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteMeeting(${m.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  switchTab('equip');
}

function saveMeeting(mid) {
  const f = activeFloor(); if (!f) return;
  const m = f.meetings.find(x => x.id === mid); if (!m) return;
  m.name = document.getElementById('edit-meeting-name').value.trim();
  m.screenType = document.querySelector('input[name="edit-screen-type"]:checked').value;
  m.screenSize = parseInt(document.getElementById('edit-meeting-size').value);
  m.hasMTR = document.getElementById('edit-meeting-mtr').checked;
  renderEquipmentsList();
  renderCanvas();
  updateStats();
  notify('Salle de réunion mise à jour.');
}

function deleteMeeting(mid) {
  const f = activeFloor(); if (!f) return;
  const m = f.meetings.find(x => x.id === mid); if (!m) return;
  if (!confirm(`Supprimer "${m.name || 'cette salle'}" ?`)) return;
  f.meetings = f.meetings.filter(x => x.id !== mid);
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify('Salle de réunion supprimée.');
}

// ═══════════════════════════════════════════════════
//  MOVE MANAGEMENT
// ═══════════════════════════════════════════════════
function editMove(mv) {
  const ed = document.getElementById('tab-move');
  const content = `
    <div class="ed-title">
      Éditer déménagement
      <button class="ed-close" onclick="renderMovesList()">×</button>
    </div>
    <div class="fg">
      <label class="lb">Date du déménagement</label>
      <input type="date" class="inp" id="edit-move-date" value="${mv.date||''}">
    </div>
    <div class="fg">
      <label class="lb">Personnes concernées</label>
      <div class="move-people-list" id="edit-move-people"></div>
      <div class="add-person">
        <input type="text" class="inp" id="edit-move-person-input" placeholder="Nom de la personne">
        <button class="btn" onclick="addEditMovePerson(${mv.id})">+</button>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn primary" onclick="saveMove(${mv.id})">Enregistrer</button>
      <button class="btn danger" onclick="deleteMove(${mv.id})">Supprimer</button>
    </div>
  `;
  ed.innerHTML = content;
  renderEditMovePeople(mv);
  switchTab('move');
  document.getElementById('edit-move-person-input').onkeydown = e => { if (e.key==='Enter') addEditMovePerson(mv.id); };
}

function renderEditMovePeople(mv) {
  const c = document.getElementById('edit-move-people');
  if (!c) return;
  c.innerHTML = '';
  if (mv.people.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune personne</div>';
    return;
  }
  mv.people.forEach((p,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `
      <div class="move-person-name">${esc(p.name)}</div>
      <div class="move-person-pc">
        <input type="checkbox" ${p.needsPC?'checked':''} onchange="toggleEditPersonPC(${mv.id},${i})">
        <span>PC</span>
      </div>
      <button class="sock-del" onclick="removeEditMovePerson(${mv.id},${i})">×</button>
    `;
    c.appendChild(d);
  });
}

function addEditMovePerson(mvid) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  const inp = document.getElementById('edit-move-person-input');
  const v = inp.value.trim(); if (!v) return;
  mv.people.push({name: v, needsPC: false});
  inp.value = '';
  renderEditMovePeople(mv);
  renderMovesList();
  updateStats();
}

function removeEditMovePerson(mvid, idx) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  mv.people.splice(idx, 1);
  renderEditMovePeople(mv);
  renderMovesList();
  updateStats();
}

function toggleEditPersonPC(mvid, idx) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  mv.people[idx].needsPC = !mv.people[idx].needsPC;
  updateStats();
}

function saveMove(mvid) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  mv.date = document.getElementById('edit-move-date').value;
  renderMovesList();
  renderCanvas();
  updateStats();
  notify('Déménagement mis à jour.');
}

function deleteMove(mvid) {
  const f = activeFloor(); if (!f) return;
  const mv = f.moves.find(x => x.id === mvid); if (!mv) return;
  if (!confirm('Supprimer ce déménagement ?')) return;
  f.moves = f.moves.filter(x => x.id !== mvid);
  renderCanvas();
  renderMovesList();
  updateStats();
  notify('Déménagement supprimé.');
}

// ═══════════════════════════════════════════════════
//  IMAGE UPLOAD
// ═══════════════════════════════════════════════════
function setupImageUpload() {
  const dz = document.getElementById('drop-zone');
  const card = document.getElementById('dz-card');

  card.onclick = () => {
    const inp = document.createElement('input');
    inp.type = 'file'; inp.accept = 'image/*';
    inp.onchange = e => { if (e.target.files[0]) loadImage(e.target.files[0]); };
    inp.click();
  };

  dz.ondragover = e => { e.preventDefault(); card.classList.add('over'); };
  dz.ondragleave = () => card.classList.remove('over');
  dz.ondrop = e => {
    e.preventDefault();
    card.classList.remove('over');
    if (e.dataTransfer.files[0]) loadImage(e.dataTransfer.files[0]);
  };
}

function loadImage(file) {
  const f = activeFloor(); if (!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      f.imageB64 = e.target.result;
      f.imageW = img.width;
      f.imageH = img.height;
      renderCanvas();
      notify('Plan chargé !');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ═══════════════════════════════════════════════════
//  DRAWING
// ═══════════════════════════════════════════════════
function setupDrawing() {
  const root = document.getElementById('canvas-root');
  const ghost = document.getElementById('draw-ghost');

  root.addEventListener('mousedown', e => {
    if (S.mode === 'edit-shape') {
      const target = e.target;
      
      // Check if clicking on a vertex point
      if (target.hasAttribute('data-anchor') && target.getAttribute('data-point-type') === 'vertex') {
        const anchor = parseInt(target.getAttribute('data-anchor'));
        S.editingShape.selectedPoint = anchor;
        const rect = document.getElementById('canvas-root').getBoundingClientRect();
        S.editingShape.startX = (e.clientX - rect.left) / S.zoom;
        S.editingShape.startY = (e.clientY - rect.top) / S.zoom;
        return;
      }
      
      // Midpoints are handled by their own click event
      
      // Check if clicking on a shape to select it
      if (target.hasAttribute('data-type')) {
        const type = target.getAttribute('data-type');
        const id = parseInt(target.getAttribute('data-id'));
        if (type === 'room' || type === 'meeting' || type === 'move') {
          selectShapeForEditing(type, id);
        }
        return;
      }
      
      return;
    }
    
    if (S.mode === 'draw') startDrawRoom(e);
    else if (S.mode === 'copier') placeCopier(e);
    else if (S.mode === 'printer') placePrinter(e);
    else if (S.mode === 'meeting') placeMeeting(e);
    else if (S.mode === 'move') startDrawMove(e);
  });

  root.addEventListener('mousemove', e => {
    if (S.mode === 'edit-shape' && S.editingShape?.selectedPoint !== null && S.editingShape?.selectedPoint !== undefined) {
      const rect = document.getElementById('canvas-root').getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / S.zoom;
      const mouseY = (e.clientY - rect.top) / S.zoom;
      
      const item = getEditableItem(S.editingShape.type, S.editingShape.id);
      if (!item || !item.points) return;
      
      const pointIdx = S.editingShape.selectedPoint;
      if (pointIdx >= 0 && pointIdx < item.points.length) {
        item.points[pointIdx].x = mouseX;
        item.points[pointIdx].y = mouseY;
        renderCanvas();
      }
      return;
    }
    
    if (S.mode === 'draw' && S.drawing) continueDrawRoom(e);
    else if (S.mode === 'meeting' && S.drawing) continueDrawMeeting(e);
    else if (S.mode === 'move' && S.drawing) continueDrawMove(e);
  });

  root.addEventListener('mouseup', e => {
    if (S.mode === 'edit-shape' && S.editingShape?.selectedPoint !== null && S.editingShape?.selectedPoint !== undefined) {
      S.editingShape.selectedPoint = null;
      notify('Point déplacé !');
      return;
    }
    
    if (S.mode === 'draw' && S.drawing) endDrawRoom(e);
    else if (S.mode === 'meeting' && S.drawing) endDrawMeeting(e);
    else if (S.mode === 'move' && S.drawing) endDrawMove(e);
  });
}

function startDrawRoom(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  S.drawing = {x0:x, y0:y};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = x+'px';
  ghost.style.top = y+'px';
  ghost.style.width = '0px';
  ghost.style.height = '0px';
}

function continueDrawRoom(e) {
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  const ghost = document.getElementById('draw-ghost');
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  ghost.style.left = l+'px';
  ghost.style.top = t+'px';
  ghost.style.width = w+'px';
  ghost.style.height = h+'px';
}

function endDrawRoom(e) {
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  
  document.getElementById('draw-ghost').style.display = 'none';
  S.drawing = null;

  if (w < 10 || h < 10) return;

  S.tempRoom = {x:l, y:t, w, h};
  openModalRoom();
}

function placeCopier(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  S.tempCopierPos = {x, y};
  openModalCopier();
}

function placePrinter(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  S.tempPrinterPos = {x, y};
  openModalPrinter();
}

function placeMeeting(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  S.drawing = {x0:x, y0:y};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = x+'px';
  ghost.style.top = y+'px';
  ghost.style.width = '0px';
  ghost.style.height = '0px';
  ghost.style.borderColor = '#3ddc97';
  ghost.style.background = 'rgba(61,220,151,.08)';
}

function startDrawMove(e) {
  const f = activeFloor(); if (!f || !f.imageB64) return;
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  S.drawing = {x0:x, y0:y};
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'block';
  ghost.style.left = x+'px';
  ghost.style.top = y+'px';
  ghost.style.width = '0px';
  ghost.style.height = '0px';
  ghost.style.borderColor = 'var(--accent2)';
  ghost.style.borderStyle = 'dashed';
  ghost.style.background = 'rgba(0,229,204,.08)';
}

function continueDrawMeeting(e) {
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  const ghost = document.getElementById('draw-ghost');
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  ghost.style.left = l+'px';
  ghost.style.top = t+'px';
  ghost.style.width = w+'px';
  ghost.style.height = h+'px';
}

function endDrawMeeting(e) {
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'none';
  ghost.style.borderColor = 'var(--accent2)';
  ghost.style.borderStyle = 'solid';
  ghost.style.background = 'rgba(0,229,204,.08)';
  S.drawing = null;

  if (w < 30 || h < 30) return;

  S.tempMeetingPos = {x:l, y:t, w, h};
  openModalMeeting();
}

function continueDrawMove(e) {
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  const ghost = document.getElementById('draw-ghost');
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  ghost.style.left = l+'px';
  ghost.style.top = t+'px';
  ghost.style.width = w+'px';
  ghost.style.height = h+'px';
}

function endDrawMove(e) {
  const rect = document.getElementById('canvas-root').getBoundingClientRect();
  const x = (e.clientX - rect.left) / S.zoom;
  const y = (e.clientY - rect.top) / S.zoom;
  const w = Math.abs(x - S.drawing.x0);
  const h = Math.abs(y - S.drawing.y0);
  const l = Math.min(x, S.drawing.x0);
  const t = Math.min(y, S.drawing.y0);
  
  const ghost = document.getElementById('draw-ghost');
  ghost.style.display = 'none';
  ghost.style.borderColor = 'var(--accent2)';
  ghost.style.borderStyle = 'solid';
  S.drawing = null;

  if (w < 30 || h < 30) return;

  S.tempMovePos = {x:l, y:t, w, h};
  S.tempMove = {people: []};
  openModalMove();
}

// ═══════════════════════════════════════════════════
//  ZOOM & PAN
// ═══════════════════════════════════════════════════
function applyTransform() {
  const root = document.getElementById('canvas-root');
  root.style.transform = `scale(${S.zoom}) translate(${S.pan.x}px, ${S.pan.y}px)`;
  document.getElementById('zpct').textContent = Math.round(S.zoom*100)+'%';
}

function zoomIn() { S.zoom = Math.min(S.zoom*1.2, 5); applyTransform(); }
function zoomOut() { S.zoom = Math.max(S.zoom/1.2, 0.2); applyTransform(); }
function zoomReset() { S.zoom=1; S.pan={x:0,y:0}; applyTransform(); }

function setupPan() {
  const area = document.getElementById('canvas-area');
  let dragging = false, ox, oy;

  area.addEventListener('mousedown', e => {
    // Check if clicking on an element to drag
    const target = e.target;
    if (target.hasAttribute && (target.hasAttribute('data-type') || target.parentElement?.hasAttribute('data-type'))) {
      const elem = target.hasAttribute('data-type') ? target : target.parentElement;
      const type = elem.getAttribute('data-type');
      const id = parseInt(elem.getAttribute('data-id'));
      
      if (S.mode === 'nav') {
        e.stopPropagation();
        const f = activeFloor();
        if (!f) return;
        
        const rect = document.getElementById('canvas-root').getBoundingClientRect();
        const mouseX = (e.clientX - rect.left) / S.zoom;
        const mouseY = (e.clientY - rect.top) / S.zoom;
        
        let item = null;
        if (type === 'room') item = f.rooms.find(r => r.id === id);
        else if (type === 'copier') item = f.copiers.find(c => c.id === id);
        else if (type === 'printer') item = f.printers.find(p => p.id === id);
        else if (type === 'meeting') item = f.meetings.find(m => m.id === id);
        else if (type === 'move') item = f.moves.find(m => m.id === id);
        
        if (item) {
          S.dragging = {
            type,
            id,
            startX: mouseX,
            startY: mouseY,
            origX: item.x,
            origY: item.y
          };
        }
        return;
      }
    }
    
    if (S.mode !== 'nav') return;
    dragging = true; 
    ox = e.clientX - S.pan.x; 
    oy = e.clientY - S.pan.y;
    area.style.cursor = 'grabbing';
  });

  area.addEventListener('mousemove', e => {
    if (S.dragging) {
      const f = activeFloor();
      if (!f) return;
      
      const rect = document.getElementById('canvas-root').getBoundingClientRect();
      const mouseX = (e.clientX - rect.left) / S.zoom;
      const mouseY = (e.clientY - rect.top) / S.zoom;
      
      const dx = mouseX - S.dragging.startX;
      const dy = mouseY - S.dragging.startY;
      
      let item = null;
      if (S.dragging.type === 'room') item = f.rooms.find(r => r.id === S.dragging.id);
      else if (S.dragging.type === 'copier') item = f.copiers.find(c => c.id === S.dragging.id);
      else if (S.dragging.type === 'printer') item = f.printers.find(p => p.id === S.dragging.id);
      else if (S.dragging.type === 'meeting') item = f.meetings.find(m => m.id === S.dragging.id);
      else if (S.dragging.type === 'move') item = f.moves.find(m => m.id === S.dragging.id);
      
      if (item) {
        item.x = S.dragging.origX + dx;
        item.y = S.dragging.origY + dy;
        renderCanvas();
      }
      return;
    }
    
    if (dragging) {
      S.pan.x = e.clientX - ox;
      S.pan.y = e.clientY - oy;
      applyTransform();
    }
    const rect = document.getElementById('canvas-root').getBoundingClientRect();
    const x = Math.round((e.clientX - rect.left) / S.zoom);
    const y = Math.round((e.clientY - rect.top) / S.zoom);
    document.getElementById('coords').textContent = `x:${x} y:${y}`;
  });

  area.addEventListener('mouseup', () => {
    if (S.dragging) {
      S.dragging = null;
      notify('Élément déplacé !');
    }
    if (dragging) { 
      dragging = false; 
      area.style.cursor = ''; 
    }
  });

  area.addEventListener('wheel', e => {
    e.preventDefault();
    if (e.deltaY < 0) zoomIn(); else zoomOut();
  });
}

// ═══════════════════════════════════════════════════
//  MODALS
// ═══════════════════════════════════════════════════
function openModalRoom() {
  document.getElementById('modal-room-name').value = '';
  document.getElementById('modal-room').classList.add('on');
  setTimeout(() => { const i = document.getElementById('modal-room-name'); i.focus(); }, 60);
}
function confirmRoom() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-room-name').value.trim();
  const r = {
    id: _id++, 
    name, 
    x: S.tempRoom.x, 
    y: S.tempRoom.y, 
    w: S.tempRoom.w, 
    h: S.tempRoom.h,
    points: [
      {x: S.tempRoom.x, y: S.tempRoom.y},
      {x: S.tempRoom.x + S.tempRoom.w, y: S.tempRoom.y},
      {x: S.tempRoom.x + S.tempRoom.w, y: S.tempRoom.y + S.tempRoom.h},
      {x: S.tempRoom.x, y: S.tempRoom.y + S.tempRoom.h}
    ],
    sockets: []
  };
  f.rooms.push(r);
  document.getElementById('modal-room').classList.remove('on');
  S.tempRoom = null;
  renderCanvas();
  renderRoomsList();
  updateStats();
  notify(`Bureau "${name||'sans nom'}" créé !`);
}
function cancelRoom() { document.getElementById('modal-room').classList.remove('on'); S.tempRoom = null; }

function openModalCopier() {
  document.getElementById('modal-copier-name').value = '';
  document.getElementById('modal-copier-network').value = '';
  document.getElementById('modal-copier').classList.add('on');
  setTimeout(() => { document.getElementById('modal-copier-name').focus(); }, 60);
}
function confirmCopier() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-copier-name').value.trim();
  const network = document.getElementById('modal-copier-network').value.trim();
  const c = {id: _id++, name, network, x:S.tempCopierPos.x, y:S.tempCopierPos.y};
  f.copiers.push(c);
  document.getElementById('modal-copier').classList.remove('on');
  S.tempCopierPos = null;
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify(`Copieur "${name||'sans nom'}" créé !`);
}
function cancelCopier() { document.getElementById('modal-copier').classList.remove('on'); S.tempCopierPos = null; }

function openModalPrinter() {
  document.getElementById('modal-printer-name').value = '';
  document.getElementById('modal-printer-network').value = '';
  document.getElementById('modal-printer').classList.add('on');
  setTimeout(() => { document.getElementById('modal-printer-name').focus(); }, 60);
}
function confirmPrinter() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-printer-name').value.trim();
  const network = document.getElementById('modal-printer-network').value.trim();
  const p = {id: _id++, name, network, x:S.tempPrinterPos.x, y:S.tempPrinterPos.y};
  f.printers.push(p);
  document.getElementById('modal-printer').classList.remove('on');
  S.tempPrinterPos = null;
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify(`Imprimante "${name||'sans nom'}" créée !`);
}
function cancelPrinter() { document.getElementById('modal-printer').classList.remove('on'); S.tempPrinterPos = null; }

function openModalMeeting() {
  document.getElementById('modal-meeting-name').value = '';
  document.getElementById('screen-tactile').checked = true;
  document.getElementById('modal-meeting-size').value = '55';
  document.getElementById('modal-meeting-mtr').checked = false;
  document.getElementById('modal-meeting').classList.add('on');
  setTimeout(() => { document.getElementById('modal-meeting-name').focus(); }, 60);
}
function confirmMeeting() {
  const f = activeFloor(); if (!f) return;
  const name = document.getElementById('modal-meeting-name').value.trim();
  const screenType = document.querySelector('input[name="screen-type"]:checked').value;
  const screenSize = parseInt(document.getElementById('modal-meeting-size').value);
  const hasMTR = document.getElementById('modal-meeting-mtr').checked;
  const m = {
    id: _id++, 
    name, 
    screenType, 
    screenSize, 
    hasMTR,
    x: S.tempMeetingPos.x, 
    y: S.tempMeetingPos.y,
    w: S.tempMeetingPos.w,
    h: S.tempMeetingPos.h,
    points: [
      {x: S.tempMeetingPos.x, y: S.tempMeetingPos.y},
      {x: S.tempMeetingPos.x + S.tempMeetingPos.w, y: S.tempMeetingPos.y},
      {x: S.tempMeetingPos.x + S.tempMeetingPos.w, y: S.tempMeetingPos.y + S.tempMeetingPos.h},
      {x: S.tempMeetingPos.x, y: S.tempMeetingPos.y + S.tempMeetingPos.h}
    ]
  };
  f.meetings.push(m);
  document.getElementById('modal-meeting').classList.remove('on');
  S.tempMeetingPos = null;
  renderCanvas();
  renderEquipmentsList();
  updateStats();
  notify(`Salle de réunion "${name||'sans nom'}" créée !`);
}
function cancelMeeting() { document.getElementById('modal-meeting').classList.remove('on'); S.tempMeetingPos = null; }

function openModalMove() {
  document.getElementById('modal-move-date').value = '';
  document.getElementById('modal-move-people').innerHTML = '';
  S.tempMove.people = [];
  document.getElementById('modal-move').classList.add('on');
  setTimeout(() => { document.getElementById('modal-move-date').focus(); }, 60);
}
function confirmMove() {
  const f = activeFloor(); if (!f) return;
  const date = document.getElementById('modal-move-date').value;
  const mv = {
    id: _id++,
    date,
    people: S.tempMove.people,
    x: S.tempMovePos.x,
    y: S.tempMovePos.y,
    w: S.tempMovePos.w,
    h: S.tempMovePos.h,
    points: [
      {x: S.tempMovePos.x, y: S.tempMovePos.y},
      {x: S.tempMovePos.x + S.tempMovePos.w, y: S.tempMovePos.y},
      {x: S.tempMovePos.x + S.tempMovePos.w, y: S.tempMovePos.y + S.tempMovePos.h},
      {x: S.tempMovePos.x, y: S.tempMovePos.y + S.tempMovePos.h}
    ]
  };
  f.moves.push(mv);
  document.getElementById('modal-move').classList.remove('on');
  S.tempMovePos = null;
  S.tempMove = {people: []};
  renderCanvas();
  renderMovesList();
  updateStats();
  notify('Déménagement créé !');
}
function cancelMove() { 
  document.getElementById('modal-move').classList.remove('on'); 
  S.tempMovePos = null;
  S.tempMove = {people: []};
}

function renderModalMovePeople() {
  const c = document.getElementById('modal-move-people');
  c.innerHTML = '';
  if (S.tempMove.people.length === 0) {
    c.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;">Aucune personne</div>';
    return;
  }
  S.tempMove.people.forEach((p,i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.innerHTML = `
      <div class="move-person-name">${esc(p.name)}</div>
      <div class="move-person-pc">
        <input type="checkbox" ${p.needsPC?'checked':''} onchange="toggleMovePerson(${i})">
        <span>PC</span>
      </div>
      <button class="sock-del" onclick="removeMovePerson(${i})">×</button>
    `;
    c.appendChild(d);
  });
}

function addMovePerson() {
  const inp = document.getElementById('modal-move-person-input');
  const v = inp.value.trim(); if (!v) return;
  S.tempMove.people.push({name: v, needsPC: false});
  inp.value = '';
  renderModalMovePeople();
}

function removeMovePerson(idx) {
  S.tempMove.people.splice(idx, 1);
  renderModalMovePeople();
}

function toggleMovePerson(idx) {
  S.tempMove.people[idx].needsPC = !S.tempMove.people[idx].needsPC;
}

// ═══════════════════════════════════════════════════
//  LOCATIONS MANAGEMENT
// ═══════════════════════════════════════════════════
function openLocationsModal() {
  renderLocationsList();
  document.getElementById('modal-locations').classList.add('on');
  setTimeout(() => { document.getElementById('location-input').focus(); }, 60);
}

function closeLocationsModal() {
  document.getElementById('modal-locations').classList.remove('on');
}

function renderLocationsList() {
  const list = document.getElementById('locations-list');
  list.innerHTML = '';
  
  if (S.locations.length === 0) {
    list.innerHTML = '<div style="font-size:11px;color:var(--muted);font-style:italic;padding:10px;">Aucun lieu défini</div>';
    return;
  }
  
  S.locations.forEach((loc, i) => {
    const d = document.createElement('div');
    d.className = 'move-person';
    d.style.marginBottom = '5px';
    d.innerHTML = `
      <div class="move-person-name" style="flex:1;">${esc(loc)}</div>
      <button class="sock-del" onclick="removeLocation(${i})">×</button>
    `;
    list.appendChild(d);
  });
}

function addLocation() {
  const inp = document.getElementById('location-input');
  const v = inp.value.trim();
  if (!v) return;
  if (S.locations.includes(v)) {
    notify('Ce lieu existe déjà !');
    return;
  }
  S.locations.push(v);
  inp.value = '';
  renderLocationsList();
  notify(`Lieu "${v}" ajouté !`);
}

function removeLocation(idx) {
  const loc = S.locations[idx];
  if (!confirm(`Supprimer le lieu "${loc}" ?`)) return;
  S.locations.splice(idx, 1);
  renderLocationsList();
  notify(`Lieu "${loc}" supprimé.`);
}

function handleFloorSelectChange() {
  const sel = document.getElementById('modal-floor-select');
  const inp = document.getElementById('modal-floor-name');
  if (sel.value) {
    inp.value = sel.value;
  }
}

function openModalFloor() {
  const sel = document.getElementById('modal-floor-select');
  sel.innerHTML = '<option value="">-- Choisir un lieu existant --</option>';
  S.locations.forEach(loc => {
    const opt = document.createElement('option');
    opt.value = loc;
    opt.textContent = loc;
    sel.appendChild(opt);
  });
  document.getElementById('modal-floor-name').value = '';
  document.getElementById('modal-floor').classList.add('on');
  setTimeout(() => { document.getElementById('modal-floor-name').focus(); }, 60);
}

function confirmFloor() {
  const name = document.getElementById('modal-floor-name').value.trim();
  if (!name) {
    notify('Veuillez saisir un nom de lieu !');
    return;
  }
  // Add to locations if it's new
  if (!S.locations.includes(name)) {
    S.locations.push(name);
  }
  document.getElementById('modal-floor').classList.remove('on');
  addFloor(name);
  notify(`Étage "${name}" créé !`);
}

function cancelFloor() { 
  document.getElementById('modal-floor').classList.remove('on'); 
}

// Escape key closes modals
document.addEventListener('keydown', e => {
  if (e.key==='Escape') { 
    cancelRoom(); 
    cancelFloor(); 
    cancelCopier(); 
    cancelPrinter(); 
    cancelMeeting(); 
    cancelMove();
    closeLocationsModal();
  }
});

// Click overlay closes
['modal-room','modal-floor','modal-copier','modal-printer','modal-meeting','modal-move','modal-locations'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => {
    if (e.target === e.currentTarget) {
      if (id==='modal-room') cancelRoom();
      else if (id==='modal-floor') cancelFloor();
      else if (id==='modal-copier') cancelCopier();
      else if (id==='modal-printer') cancelPrinter();
      else if (id==='modal-meeting') cancelMeeting();
      else if (id==='modal-move') cancelMove();
      else if (id==='modal-locations') closeLocationsModal();
    }
  });
});

// ═══════════════════════════════════════════════════
//  TOOLTIP
// ═══════════════════════════════════════════════════
function showTT(cx, cy, f, room) {
  const tt = document.getElementById('tt');
  document.getElementById('tt-floor').textContent = f.name.toUpperCase();
  document.getElementById('tt-room').textContent = room.name || '(sans nom)';
  tt.classList.add('on');
  let lx = cx+16, ly = cy+16;
  tt.style.left = lx+'px'; tt.style.top = ly+'px';
  const tr = tt.getBoundingClientRect();
  if (tr.right > window.innerWidth-10) lx = cx-tr.width-12;
  if (tr.bottom > window.innerHeight-10) ly = cy-tr.height-12;
  tt.style.left = lx+'px'; tt.style.top = ly+'px';
}
function hideTT() { document.getElementById('tt').classList.remove('on'); }

// ═══════════════════════════════════════════════════
//  MODE
// ═══════════════════════════════════════════════════
function setMode(m) {
  S.mode = m;
  ['nav','draw','edit-shape','copier','printer','meeting','move'].forEach(mode => {
    const btn = document.getElementById('btn-'+mode);
    if (btn) btn.classList.toggle('active', m===mode);
  });
  document.getElementById('canvas-area').className = 'canvas-area mode-'+m;
  
  const modeLabels = {
    nav: 'NAVIGATION',
    draw: 'TRACER BUREAU',
    'edit-shape': 'ÉDITER FORME',
    copier: 'PLACER COPIEUR',
    printer: 'PLACER IMPRIMANTE',
    meeting: 'PLACER SALLE RÉUNION',
    move: 'ZONE DÉMÉNAGEMENT'
  };
  document.getElementById('mode-chip').textContent = modeLabels[m] || 'NAVIGATION';
  
  // Reset editing shape when leaving edit-shape mode
  if (m !== 'edit-shape') {
    S.editingShape = null;
    renderCanvas();
  }
}

// ═══════════════════════════════════════════════════
//  TABS
// ═══════════════════════════════════════════════════
function switchTab(t) {
  ['list','edit','equip','move','stats'].forEach(n => {
    document.getElementById('tab-'+n).classList.toggle('on', n===t);
    document.getElementById('tab-'+n+'-btn').classList.toggle('on', n===t);
  });
}

// ═══════════════════════════════════════════════════
//  STATS
// ═══════════════════════════════════════════════════
function updateStats() {
  document.getElementById('st-floors').textContent = S.floors.length;
  const totalR = S.floors.reduce((a,f) => a+f.rooms.length, 0);
  const totalC = S.floors.reduce((a,f) => a+f.copiers.length, 0);
  const totalP = S.floors.reduce((a,f) => a+f.printers.length, 0);
  const totalM = S.floors.reduce((a,f) => a+f.meetings.length, 0);
  
  document.getElementById('st-rooms').textContent = totalR;
  document.getElementById('st-copiers').textContent = totalC;
  document.getElementById('st-printers').textContent = totalP;
  document.getElementById('st-meetings').textContent = totalM;

  const det = document.getElementById('st-detail');
  det.innerHTML = '';
  S.floors.forEach(f => {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin:10px 0 5px';
    h.textContent = f.name;
    det.appendChild(h);
    
    if (f.rooms.length === 0 && f.copiers.length === 0 && f.printers.length === 0 && f.meetings.length === 0) {
      const e = document.createElement('div');
      e.style.cssText = 'font-size:11px;color:var(--muted);font-style:italic;margin-bottom:6px;';
      e.textContent = 'Aucun élément';
      det.appendChild(e);
    }
    
    f.rooms.forEach((r,i) => {
      const col = roomColor(f.id, i);
      const d = document.createElement('div');
      d.className = 'rli'; d.style.cursor='default';
      d.innerHTML = `
        <div class="rli-dot" style="background:${col}"></div>
        <div class="rli-name" style="font-size:12px">${esc(r.name||'(sans nom)')}</div>
      `;
      det.appendChild(d);
    });
  });
}

// ═══════════════════════════════════════════════════
//  FLOOR ACTIONS
// ═══════════════════════════════════════════════════
function clearFloor() {
  const f = activeFloor(); if (!f) return;
  if (!confirm(`Vider l'étage "${f.name}" (bureaux + plan) ?`)) return;
  f.rooms = []; 
  f.copiers = [];
  f.printers = [];
  f.meetings = [];
  f.moves = [];
  f.imageB64 = null; 
  f.imageW = 0; 
  f.imageH = 0;
  S.selectedRoom = null;
  renderCanvas(); 
  renderRoomsList(); 
  renderEquipmentsList();
  renderMovesList();
  editorOpen(null); 
  updateStats();
  notify('Étage vidé.');
}

// ═══════════════════════════════════════════════════
//  EXPORT EXCEL
// ═══════════════════════════════════════════════════
function exportExcel() {
  const wb = XLSX.utils.book_new();
  
  // Feuille récapitulatif général
  const summaryData = [
    ['Modificateur de plan - Récapitulatif'],
    [''],
    ['Nombre d\'étages', S.floors.length],
    ['Nombre de lieux', S.locations.length],
    [''],
    ['Statistiques globales'],
    ['Bureaux', S.floors.reduce((a,f) => a+f.rooms.length, 0)],
    ['Copieurs', S.floors.reduce((a,f) => a+f.copiers.length, 0)],
    ['Imprimantes', S.floors.reduce((a,f) => a+f.printers.length, 0)],
    ['Salles de réunion', S.floors.reduce((a,f) => a+f.meetings.length, 0)],
    ['Zones de déménagement', S.floors.reduce((a,f) => a+f.moves.length, 0)]
  ];
  const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, ws1, 'Récapitulatif');
  
  // Feuille par étage
  S.floors.forEach(f => {
    const floorData = [
      [f.name],
      [''],
      ['BUREAUX'],
      ['Nom']
    ];
    
    f.rooms.forEach(r => {
      floorData.push([
        r.name || '(sans nom)'
      ]);
    });
    
    floorData.push(['']);
    floorData.push(['COPIEURS']);
    floorData.push(['Nom', 'Informations réseau']);
    f.copiers.forEach(c => {
      floorData.push([c.name || '(sans nom)', c.network || '']);
    });
    
    floorData.push(['']);
    floorData.push(['IMPRIMANTES']);
    floorData.push(['Nom', 'Informations réseau']);
    f.printers.forEach(p => {
      floorData.push([p.name || '(sans nom)', p.network || '']);
    });
    
    floorData.push(['']);
    floorData.push(['SALLES DE RÉUNION']);
    floorData.push(['Nom', 'Type écran', 'Taille', 'MTR']);
    f.meetings.forEach(m => {
      floorData.push([
        m.name || '(sans nom)',
        m.screenType === 'tactile' ? 'Tactile' : 'Classique',
        m.screenSize + '"',
        m.hasMTR ? 'Oui' : 'Non'
      ]);
    });
    
    floorData.push(['']);
    floorData.push(['DÉMÉNAGEMENTS']);
    floorData.push(['Date', 'Personnes', 'Personnes avec PC']);
    f.moves.forEach(mv => {
      const withPC = mv.people.filter(p => p.needsPC).map(p => p.name).join(', ');
      floorData.push([
        mv.date || 'Non définie',
        mv.people.map(p => p.name).join(', '),
        withPC || 'Aucune'
      ]);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(floorData);
    const sheetName = f.name.substring(0, 31); // Excel limite à 31 caractères
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
  });
  
  XLSX.writeFile(wb, 'plan-reseau-export.xlsx');
  notify('Export Excel réussi !');
}

// ═══════════════════════════════════════════════════
//  EXPORT PNG
// ═══════════════════════════════════════════════════
async function exportPNG() {
  const f = activeFloor();
  if (!f || !f.imageB64) {
    alert('Veuillez charger un plan avant d\'exporter en PNG.');
    return;
  }
  
  notify('Génération du PNG en cours...');
  
  try {
    // Create a temporary canvas
    const canvas = document.createElement('canvas');
    canvas.width = f.imageW;
    canvas.height = f.imageH;
    const ctx = canvas.getContext('2d');
    
    // Draw background image
    const img = new Image();
    img.onload = async () => {
      ctx.drawImage(img, 0, 0);
      
      // Get SVG and convert to image
      const svgElement = document.getElementById('svg-layer');
      const svgData = new XMLSerializer().serializeToString(svgElement);
      const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
      const svgUrl = URL.createObjectURL(svgBlob);
      
      const svgImg = new Image();
      svgImg.onload = () => {
        ctx.drawImage(svgImg, 0, 0);
        URL.revokeObjectURL(svgUrl);
        
        // Export as PNG
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.download = `plan-${f.name.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.png`;
          link.href = url;
          link.click();
          URL.revokeObjectURL(url);
          notify('Export PNG réussi !');
        }, 'image/png');
      };
      svgImg.onerror = () => {
        notify('Erreur lors de la conversion SVG');
        console.error('SVG conversion failed');
      };
      svgImg.src = svgUrl;
    };
    img.onerror = () => {
      notify('Erreur lors du chargement de l\'image');
    };
    img.src = f.imageB64;
    
  } catch (err) {
    console.error('Export PNG error:', err);
    alert('Erreur lors de l\'export PNG: ' + err.message);
  }
}

// ═══════════════════════════════════════════════════
//  EXPORT PDF
// ═══════════════════════════════════════════════════
async function exportPDF() {
  const f = activeFloor();
  if (!f || !f.imageB64) {
    alert('Veuillez charger un plan avant d\'exporter en PDF.');
    return;
  }
  
  notify('Génération du PDF en cours...');
  
  try {
    // Create a temporary canvas
    const canvas = document.createElement('canvas');
    canvas.width = f.imageW;
    canvas.height = f.imageH;
    const ctx = canvas.getContext('2d');
    
    // Draw background image
    const img = new Image();
    img.onload = async () => {
      ctx.drawImage(img, 0, 0);
      
      // Get SVG and convert to image
      const svgElement = document.getElementById('svg-layer');
      const svgData = new XMLSerializer().serializeToString(svgElement);
      const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
      const svgUrl = URL.createObjectURL(svgBlob);
      
      const svgImg = new Image();
      svgImg.onload = () => {
        ctx.drawImage(svgImg, 0, 0);
        URL.revokeObjectURL(svgUrl);
        
        // Create PDF
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        
        // Calculate dimensions for A4
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const ratio = imgWidth / imgHeight;
        
        let pdfWidth, pdfHeight;
        if (ratio > 1.414) {
          // Landscape - fit to A4 landscape
          pdfWidth = 297;
          pdfHeight = pdfWidth / ratio;
          if (pdfHeight > 210) {
            pdfHeight = 210;
            pdfWidth = pdfHeight * ratio;
          }
        } else {
          // Portrait - fit to A4 portrait
          pdfHeight = 297;
          pdfWidth = pdfHeight * ratio;
          if (pdfWidth > 210) {
            pdfWidth = 210;
            pdfHeight = pdfWidth / ratio;
          }
        }
        
        const pdf = new jsPDF({
          orientation: ratio > 1 ? 'landscape' : 'portrait',
          unit: 'mm',
          format: 'a4'
        });
        
        // Center the image
        const xOffset = (pdf.internal.pageSize.getWidth() - pdfWidth) / 2;
        const yOffset = (pdf.internal.pageSize.getHeight() - pdfHeight) / 2;
        
        pdf.addImage(imgData, 'PNG', xOffset, yOffset, pdfWidth, pdfHeight);
        pdf.save(`plan-${f.name.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}.pdf`);
        
        notify('Export PDF réussi !');
      };
      svgImg.onerror = () => {
        notify('Erreur lors de la conversion SVG');
        console.error('SVG conversion failed');
      };
      svgImg.src = svgUrl;
    };
    img.onerror = () => {
      notify('Erreur lors du chargement de l\'image');
    };
    img.src = f.imageB64;
    
  } catch (err) {
    console.error('Export PDF error:', err);
    alert('Erreur lors de l\'export PDF: ' + err.message);
  }
}

// ═══════════════════════════════════════════════════
//  EXPORT / IMPORT JSON
// ═══════════════════════════════════════════════════
async function exportJSON() {
  const prog = document.getElementById('progress');
  prog.style.transform = 'scaleX(0.3)';
  await new Promise(r => setTimeout(r, 80));
  prog.style.transform = 'scaleX(0.7)';
  await new Promise(r => setTimeout(r, 80));

  const data = {
    version: 4,
    exported: new Date().toISOString(),
    locations: S.locations,
    floors: S.floors.map(f => ({
      id: f.id, name: f.name,
      imageB64: f.imageB64,
      imageW: f.imageW, imageH: f.imageH,
      rooms: f.rooms,
      copiers: f.copiers || [],
      printers: f.printers || [],
      meetings: f.meetings || [],
      moves: f.moves || []
    }))
  };

  prog.style.transform = 'scaleX(1)';
  await new Promise(r => setTimeout(r, 120));
  prog.style.transform = 'scaleX(0)';

  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'plan-reseau.json'; a.click();
  URL.revokeObjectURL(url);
  notify('Export JSON réussi — tout inclus !');
}

function importJSON(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.floors) throw new Error('Format invalide');
      
      // Import locations
      S.locations = data.locations || ['RDC', 'Étage 1', 'Étage 2', 'Étage 3'];
      
      S.floors = data.floors.map(f => ({
        id: f.id, name: f.name,
        imageB64: f.imageB64 || null,
        imageW: f.imageW || 0, imageH: f.imageH || 0,
        rooms: f.rooms || [],
        copiers: f.copiers || [],
        printers: f.printers || [],
        meetings: f.meetings || [],
        moves: f.moves || []
      }));
      _id = Math.max(...S.floors.flatMap(f => [
        f.id, 
        ...f.rooms.map(r=>r.id),
        ...(f.copiers||[]).map(c=>c.id),
        ...(f.printers||[]).map(p=>p.id),
        ...(f.meetings||[]).map(m=>m.id),
        ...(f.moves||[]).map(m=>m.id)
      ]), 0) + 1;
      S.activeFloor = S.floors[0]?.id ?? null;
      S.selectedRoom = null;
      renderFloorsBar(); 
      renderCanvas(); 
      renderRoomsList(); 
      renderEquipmentsList();
      renderMovesList();
      editorOpen(null); 
      updateStats();
      notify('Plan importé avec succès !');
    } catch(err) { alert('Fichier JSON invalide : ' + err.message); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ═══════════════════════════════════════════════════
//  UTILS
// ═══════════════════════════════════════════════════
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

let _notifTimer;
function notify(msg) {
  const n = document.getElementById('notif');
  n.textContent = msg; n.classList.add('on');
  clearTimeout(_notifTimer);
  _notifTimer = setTimeout(() => n.classList.remove('on'), 2600);
}

// ═══════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════
addFloor('RDC');
setMode('nav');
setupImageUpload();
setupDrawing();
setupPan();

// Setup enter key for move person input in modal
document.getElementById('modal-move-person-input').onkeydown = e => { 
  if (e.key==='Enter') addMovePerson(); 
};

// Setup enter key for location input in modal
document.getElementById('location-input').onkeydown = e => { 
  if (e.key==='Enter') addLocation(); 
};
</script>
</body>
</html>
